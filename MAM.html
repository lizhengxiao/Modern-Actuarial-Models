<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>ç°ä»£ç²¾ç®—ç»Ÿè®¡æ¨¡å‹</title>
  <meta name="description" content="The output format is bookdown::gitbook." />
  <meta name="generator" content="bookdown #bookdown:version# and GitBook 2.6.7" />

  <meta property="og:title" content="ç°ä»£ç²¾ç®—ç»Ÿè®¡æ¨¡å‹" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="The output format is bookdown::gitbook." />
  <meta name="github-repo" content="sxpyggy/Modern-Actuarial-Models" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="ç°ä»£ç²¾ç®—ç»Ÿè®¡æ¨¡å‹" />
  
  <meta name="twitter:description" content="The output format is bookdown::gitbook." />
  

<meta name="author" content="Modern Actuarial Models" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">ç°ä»£ç²¾ç®—ç»Ÿè®¡æ¨¡å‹</h1>
<p class="author"><em>Modern Actuarial Models</em></p>
<p class="date"><em>2021-01-10 15:04:13</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#æ¬¢è¿">ğŸ‘¨â€ğŸ« æ¬¢è¿</a><ul>
<li><a href="#ç­”ç–‘">ğŸ¤” ç­”ç–‘</a></li>
<li><a href="#è¯¾ç¨‹å®‰æ’">ğŸ—“ï¸ è¯¾ç¨‹å®‰æ’</a></li>
</ul></li>
<li><a href="#intro">ç®€ä»‹</a></li>
<li><a href="#pre"><span class="toc-section-number">1</span> å‡†å¤‡å·¥ä½œ</a><ul>
<li><a href="#å¸¸ç”¨é“¾æ¥"><span class="toc-section-number">1.1</span> å¸¸ç”¨é“¾æ¥</a></li>
<li><a href="#å…‹éš†ä»£ç "><span class="toc-section-number">1.2</span> å…‹éš†ä»£ç </a></li>
<li><a href="#r-interface-to-keras"><span class="toc-section-number">1.3</span> R interface to Keras</a><ul>
<li><a href="#rè‡ªåŠ¨å®‰è£…"><span class="toc-section-number">1.3.1</span> Rè‡ªåŠ¨å®‰è£…</a></li>
<li><a href="#ä½¿ç”¨reticulateå…³è”condaç¯å¢ƒ"><span class="toc-section-number">1.3.2</span> ä½¿ç”¨reticulateå…³è”condaç¯å¢ƒ</a></li>
<li><a href="#æŒ‡å®šcondaå®‰è£…"><span class="toc-section-number">1.3.3</span> æŒ‡å®šcondaå®‰è£…</a></li>
<li><a href="#ä½¿ç”¨reticulateå®‰è£…"><span class="toc-section-number">1.3.4</span> ä½¿ç”¨reticulateå®‰è£…</a></li>
</ul></li>
<li><a href="#r-interface-to-python"><span class="toc-section-number">1.4</span> R interface to Python</a><ul>
<li><a href="#reticulate-å¸¸è§å‘½ä»¤"><span class="toc-section-number">1.4.1</span> reticulate å¸¸è§å‘½ä»¤</a></li>
<li><a href="#åˆ‡æ¢rå…³è”çš„condaç¯å¢ƒ"><span class="toc-section-number">1.4.2</span> åˆ‡æ¢Rå…³è”çš„condaç¯å¢ƒ</a></li>
</ul></li>
<li><a href="#python"><span class="toc-section-number">1.5</span> Python</a><ul>
<li><a href="#condaç¯å¢ƒ"><span class="toc-section-number">1.5.1</span> Condaç¯å¢ƒ</a></li>
<li><a href="#å¸¸ç”¨çš„condaå‘½ä»¤"><span class="toc-section-number">1.5.2</span> å¸¸ç”¨çš„Condaå‘½ä»¤</a></li>
<li><a href="#tensorflowpytorch-gpu-version"><span class="toc-section-number">1.5.3</span> Tensorflow/Pytorch GPU version</a></li>
</ul></li>
</ul></li>
<li><a href="#french"><span class="toc-section-number">2</span> è½¦é™©ç´¢èµ”é¢‘ç‡é¢„æµ‹</a><ul>
<li><a href="#èƒŒæ™¯ä»‹ç»"><span class="toc-section-number">2.1</span> èƒŒæ™¯ä»‹ç»</a></li>
<li><a href="#é¢„æµ‹æ¨¡å‹æ¦‚è¿°"><span class="toc-section-number">2.2</span> é¢„æµ‹æ¨¡å‹æ¦‚è¿°</a></li>
<li><a href="#ç‰¹å¾å·¥ç¨‹"><span class="toc-section-number">2.3</span> ç‰¹å¾å·¥ç¨‹</a><ul>
<li><a href="#æˆªæ–­"><span class="toc-section-number">2.3.1</span> æˆªæ–­</a></li>
<li><a href="#ç¦»æ•£åŒ–"><span class="toc-section-number">2.3.2</span> ç¦»æ•£åŒ–</a></li>
<li><a href="#è®¾å®šåŸºç¡€æ°´å¹³"><span class="toc-section-number">2.3.3</span> è®¾å®šåŸºç¡€æ°´å¹³</a></li>
<li><a href="#åå˜é‡å˜å½¢"><span class="toc-section-number">2.3.4</span> åå˜é‡å˜å½¢</a></li>
</ul></li>
<li><a href="#è®­ç»ƒé›†-éªŒè¯é›†-æµ‹è¯•é›†"><span class="toc-section-number">2.4</span> è®­ç»ƒé›†-éªŒè¯é›†-æµ‹è¯•é›†</a></li>
<li><a href="#æ³Šæ¾åå·®æŸå¤±å‡½æ•°"><span class="toc-section-number">2.5</span> æ³Šæ¾åå·®æŸå¤±å‡½æ•°</a></li>
<li><a href="#æ³Šæ¾å›å½’æ¨¡å‹"><span class="toc-section-number">2.6</span> æ³Šæ¾å›å½’æ¨¡å‹</a></li>
<li><a href="#æ³Šæ¾å¯åŠ æ¨¡å‹"><span class="toc-section-number">2.7</span> æ³Šæ¾å¯åŠ æ¨¡å‹</a></li>
<li><a href="#æ³Šæ¾å›å½’æ ‘"><span class="toc-section-number">2.8</span> æ³Šæ¾å›å½’æ ‘</a></li>
<li><a href="#éšæœºæ£®æ—"><span class="toc-section-number">2.9</span> éšæœºæ£®æ—</a></li>
<li><a href="#æ³Šæ¾æå‡æ ‘"><span class="toc-section-number">2.10</span> æ³Šæ¾æå‡æ ‘</a></li>
<li><a href="#æ¨¡å‹æ¯”è¾ƒ"><span class="toc-section-number">2.11</span> æ¨¡å‹æ¯”è¾ƒ</a></li>
</ul></li>
<li><a href="#nn"><span class="toc-section-number">3</span> ç¥ç»ç½‘ç»œ</a><ul>
<li><a href="#å»ºç«‹ç¥ç»ç½‘ç»œçš„ä¸€èˆ¬æ­¥éª¤"><span class="toc-section-number">3.1</span> å»ºç«‹ç¥ç»ç½‘ç»œçš„ä¸€èˆ¬æ­¥éª¤</a><ul>
<li><a href="#æ˜ç¡®ç›®æ ‡å’Œæ•°æ®ç±»å‹"><span class="toc-section-number">3.1.1</span> æ˜ç¡®ç›®æ ‡å’Œæ•°æ®ç±»å‹</a></li>
<li><a href="#æ•°æ®é¢„å¤„ç†"><span class="toc-section-number">3.1.2</span> æ•°æ®é¢„å¤„ç†</a></li>
<li><a href="#é€‰å–åˆé€‚çš„ç¥ç»ç½‘ç»œç±»å‹"><span class="toc-section-number">3.1.3</span> é€‰å–åˆé€‚çš„ç¥ç»ç½‘ç»œç±»å‹</a></li>
<li><a href="#å»ºç«‹ç¥ç»ç½‘ç»œå…¨è¿æ¥ç¥ç»ç½‘ç»œ"><span class="toc-section-number">3.1.4</span> å»ºç«‹ç¥ç»ç½‘ç»œï¼ˆå…¨è¿æ¥ç¥ç»ç½‘ç»œï¼‰</a></li>
<li><a href="#è®­ç»ƒç¥ç»ç½‘ç»œ"><span class="toc-section-number">3.1.5</span> è®­ç»ƒç¥ç»ç½‘ç»œ</a></li>
<li><a href="#è°ƒå‚"><span class="toc-section-number">3.1.6</span> è°ƒå‚</a></li>
</ul></li>
<li><a href="#æ•°æ®é¢„å¤„ç†-1"><span class="toc-section-number">3.2</span> æ•°æ®é¢„å¤„ç†</a></li>
<li><a href="#ç¥ç»ç½‘ç»œæå‡æ¨¡å‹-combined-actuarial-neural-network"><span class="toc-section-number">3.3</span> ç¥ç»ç½‘ç»œæå‡æ¨¡å‹ ï¼ˆcombined actuarial neural networkï¼‰</a></li>
<li><a href="#ç¥ç»ç½‘ç»œç»“æ„"><span class="toc-section-number">3.4</span> ç¥ç»ç½‘ç»œç»“æ„</a><ul>
<li><a href="#ç»“æ„å‚æ•°"><span class="toc-section-number">3.4.1</span> ç»“æ„å‚æ•°</a></li>
<li><a href="#è¾“å…¥å±‚"><span class="toc-section-number">3.4.2</span> è¾“å…¥å±‚</a></li>
<li><a href="#embedding-layer"><span class="toc-section-number">3.4.3</span> Embedding layer</a></li>
<li><a href="#éšè—å±‚"><span class="toc-section-number">3.4.4</span> éšè—å±‚</a></li>
<li><a href="#è¾“å‡ºå±‚"><span class="toc-section-number">3.4.5</span> è¾“å‡ºå±‚</a></li>
</ul></li>
<li><a href="#è®­ç»ƒç¥ç»ç½‘ç»œ-1"><span class="toc-section-number">3.5</span> è®­ç»ƒç¥ç»ç½‘ç»œ</a></li>
<li><a href="#æ€»ç»“"><span class="toc-section-number">3.6</span> æ€»ç»“</a></li>
<li><a href="#å…¶å®ƒæ¨¡å‹"><span class="toc-section-number">3.7</span> å…¶å®ƒæ¨¡å‹</a></li>
</ul></li>
<li><a href="#boosting"><span class="toc-section-number">4</span> æå‡æ–¹æ³• (Boosting)</a><ul>
<li><a href="#adaboost"><span class="toc-section-number">4.1</span> AdaBoost</a></li>
<li><a href="#logit-boost-real-discrete-gentle-adaboost"><span class="toc-section-number">4.2</span> Logit Boost (real, discrete, gentle AdaBoost)</a></li>
<li><a href="#adaboost.m1"><span class="toc-section-number">4.3</span> AdaBoost.M1</a></li>
<li><a href="#samme-stage-wise-additive-modeling-using-a-multi-class-exponential-loss-function"><span class="toc-section-number">4.4</span> SAMME (Stage-wise Additive Modeling using a Multi-class Exponential loss function)</a></li>
<li><a href="#samme.r-multi-class-real-adaboost"><span class="toc-section-number">4.5</span> SAMME.R (multi-class real AdaBoost)</a></li>
<li><a href="#gradient-boosting"><span class="toc-section-number">4.6</span> Gradient Boosting</a></li>
<li><a href="#newton-boosting"><span class="toc-section-number">4.7</span> Newton Boosting</a></li>
<li><a href="#xgboost"><span class="toc-section-number">4.8</span> XGBoost</a></li>
<li><a href="#case-study"><span class="toc-section-number">4.9</span> Case study</a><ul>
<li><a href="#æ•°æ®æè¿°"><span class="toc-section-number">4.9.1</span> æ•°æ®æè¿°</a></li>
<li><a href="#æ•°æ®é¢„å¤„ç†-2"><span class="toc-section-number">4.9.2</span> æ•°æ®é¢„å¤„ç†</a></li>
<li><a href="#ç‰¹å¾å·¥ç¨‹-1"><span class="toc-section-number">4.9.3</span> ç‰¹å¾å·¥ç¨‹</a></li>
<li><a href="#å»ºæ¨¡æµç¨‹"><span class="toc-section-number">4.9.4</span> å»ºæ¨¡æµç¨‹</a></li>
<li><a href="#æ¨¡å‹åº¦é‡giniç³»æ•°"><span class="toc-section-number">4.9.5</span> æ¨¡å‹åº¦é‡â€”â€”Giniç³»æ•°</a></li>
<li><a href="#å»ºç«‹adaboostæ¨¡å‹"><span class="toc-section-number">4.9.6</span> å»ºç«‹AdaBoostæ¨¡å‹</a></li>
<li><a href="#å»ºç«‹xgboostæ¨¡å‹"><span class="toc-section-number">4.9.7</span> å»ºç«‹XGBoostæ¨¡å‹</a></li>
<li><a href="#ç»“è®º"><span class="toc-section-number">4.9.8</span> ç»“è®º</a></li>
</ul></li>
<li><a href="#appendix-commonly-used-python-code-for-py-beginners"><span class="toc-section-number">4.10</span> Appendix: Commonly used Python code (for py-beginners)</a><ul>
<li><a href="#pythonæ ‡å‡†æ•°æ®ç±»å‹"><span class="toc-section-number">4.10.1</span> Pythonæ ‡å‡†æ•°æ®ç±»å‹</a></li>
<li><a href="#pythonå†…ç½®å‡½æ•°"><span class="toc-section-number">4.10.2</span> Pythonå†…ç½®å‡½æ•°</a></li>
<li><a href="#numpyåŒ…"><span class="toc-section-number">4.10.3</span> numpyåŒ…</a></li>
<li><a href="#pandasåŒ…"><span class="toc-section-number">4.10.4</span> pandasåŒ…</a></li>
<li><a href="#matplotlibåŒ…"><span class="toc-section-number">4.10.5</span> MatplotlibåŒ…</a></li>
<li><a href="#å¸¸ç”¨æ•™ç¨‹ç½‘å€"><span class="toc-section-number">4.10.6</span> å¸¸ç”¨æ•™ç¨‹ç½‘å€</a></li>
</ul></li>
</ul></li>
<li><a href="#unsupervised-learning"><span class="toc-section-number">5</span> æ— ç›‘ç£å­¦ä¹ æ–¹æ³•</a><ul>
<li><a href="#æ•°æ®é¢„å¤„ç†-3"><span class="toc-section-number">5.1</span> æ•°æ®é¢„å¤„ç†</a></li>
<li><a href="#ä¸»æˆåˆ†åˆ†æ"><span class="toc-section-number">5.2</span> ä¸»æˆåˆ†åˆ†æ</a></li>
<li><a href="#è‡ªç¼–ç "><span class="toc-section-number">5.3</span> è‡ªç¼–ç </a><ul>
<li><a href="#æ¨¡å‹è®­ç»ƒ"><span class="toc-section-number">5.3.1</span> æ¨¡å‹è®­ç»ƒ</a></li>
</ul></li>
<li><a href="#k-means-clustering"><span class="toc-section-number">5.4</span> K-means clustering</a></li>
<li><a href="#k-medoids-clustering-pam"><span class="toc-section-number">5.5</span> K-medoids clustering (PAM)</a></li>
<li><a href="#gaussian-mixture-modelsgmms"><span class="toc-section-number">5.6</span> Gaussian mixture models(GMMs)</a></li>
<li><a href="#ä¸‰ç§èšç±»æ–¹æ³•è¯„ä»·"><span class="toc-section-number">5.7</span> ä¸‰ç§èšç±»æ–¹æ³•è¯„ä»·</a></li>
<li><a href="#t-sne"><span class="toc-section-number">5.8</span> t-SNE</a></li>
<li><a href="#umap"><span class="toc-section-number">5.9</span> UMAP</a></li>
<li><a href="#som"><span class="toc-section-number">5.10</span> SOM</a></li>
</ul></li>
<li><a href="#rnn"><span class="toc-section-number">6</span> å¾ªç¯ç¥ç»ç½‘ç»œä¸æ­»äº¡ç‡é¢„æµ‹</a><ul>
<li><a href="#lee-carter-model"><span class="toc-section-number">6.1</span> Lee-Carter Model</a></li>
<li><a href="#æ™®é€šå¾ªç¯ç¥ç»ç½‘ç»œrecurrent-neural-network"><span class="toc-section-number">6.2</span> æ™®é€šå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆrecurrent neural networkï¼‰</a></li>
<li><a href="#é•¿çŸ­æœŸè®°å¿†ç¥ç»ç½‘ç»œlong-short-term-memory"><span class="toc-section-number">6.3</span> é•¿çŸ­æœŸè®°å¿†ç¥ç»ç½‘ç»œï¼ˆLong short-term memoryï¼‰</a><ul>
<li><a href="#æ¿€æ´»å‡½æ•°activation-functions"><span class="toc-section-number">6.3.1</span> æ¿€æ´»å‡½æ•°ï¼ˆActivation functionsï¼‰</a></li>
<li><a href="#gates-and-cell-state"><span class="toc-section-number">6.3.2</span> Gates and cell state</a></li>
<li><a href="#output-function"><span class="toc-section-number">6.3.3</span> Output Function</a></li>
<li><a href="#time-distributed-layer"><span class="toc-section-number">6.3.4</span> Time-distributed Layer</a></li>
</ul></li>
<li><a href="#é—¨æ§å¾ªç¯ç¥ç»ç½‘ç»œgated-recurrent-unit"><span class="toc-section-number">6.4</span> é—¨æ§å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆGated Recurrent Unitï¼‰</a><ul>
<li><a href="#gates"><span class="toc-section-number">6.4.1</span> Gates</a></li>
<li><a href="#neuron-activations"><span class="toc-section-number">6.4.2</span> Neuron Activations</a></li>
</ul></li>
<li><a href="#æ¡ˆä¾‹åˆ†æcase-study"><span class="toc-section-number">6.5</span> æ¡ˆä¾‹åˆ†æï¼ˆCase studyï¼‰</a><ul>
<li><a href="#æ•°æ®æè¿°-1"><span class="toc-section-number">6.5.1</span> æ•°æ®æè¿°</a></li>
<li><a href="#æ­»äº¡ç‡çƒ­åŠ›å›¾"><span class="toc-section-number">6.5.2</span> æ­»äº¡ç‡çƒ­åŠ›å›¾</a></li>
<li><a href="#lee-carter-æ¨¡å‹"><span class="toc-section-number">6.5.3</span> Lee-Carter æ¨¡å‹</a></li>
<li><a href="#åˆè¯•rnn"><span class="toc-section-number">6.5.4</span> åˆè¯•RNN</a></li>
<li><a href="#rnn-1"><span class="toc-section-number">6.5.5</span> RNN</a></li>
<li><a href="#å¼•å…¥æ€§åˆ«åå˜é‡"><span class="toc-section-number">6.5.6</span> å¼•å…¥æ€§åˆ«åå˜é‡</a></li>
<li><a href="#ç¨³å¥æ€§"><span class="toc-section-number">6.5.7</span> ç¨³å¥æ€§</a></li>
<li><a href="#é¢„æµ‹ç»“æœå›¾"><span class="toc-section-number">6.5.8</span> é¢„æµ‹ç»“æœå›¾</a></li>
</ul></li>
</ul></li>
<li><a href="#nlp"><span class="toc-section-number">7</span> è‡ªç„¶è¯­è¨€å¤„ç†</a><ul>
<li><a href="#é¢„å¤„ç†"><span class="toc-section-number">7.1</span> é¢„å¤„ç†</a></li>
<li><a href="#bag-of-words"><span class="toc-section-number">7.2</span> Bag of words</a></li>
<li><a href="#bag-of-part-of-speech"><span class="toc-section-number">7.3</span> Bag of part-of-speech</a></li>
<li><a href="#word-embeddings"><span class="toc-section-number">7.4</span> Word embeddings</a><ul>
<li><a href="#pre-trained-word-embeddings"><span class="toc-section-number">7.4.1</span> Pre-trained word embeddings</a></li>
</ul></li>
<li><a href="#æœºå™¨å­¦ä¹ ç®—æ³•"><span class="toc-section-number">7.5</span> æœºå™¨å­¦ä¹ ç®—æ³•</a></li>
<li><a href="#ç¥ç»ç½‘ç»œ"><span class="toc-section-number">7.6</span> ç¥ç»ç½‘ç»œ</a><ul>
<li><a href="#æ•°æ®é¢„å¤„ç†-4"><span class="toc-section-number">7.6.1</span> æ•°æ®é¢„å¤„ç†</a></li>
</ul></li>
<li><a href="#case-study-1"><span class="toc-section-number">7.7</span> Case study</a><ul>
<li><a href="#å‡½æ•°è¯´æ˜"><span class="toc-section-number">7.7.1</span> å‡½æ•°è¯´æ˜</a></li>
<li><a href="#å¯èƒ½é‡åˆ°çš„é—®é¢˜"><span class="toc-section-number">7.7.2</span> å¯èƒ½é‡åˆ°çš„é—®é¢˜</a></li>
<li><a href="#ç»“æœæ¯”è¾ƒ"><span class="toc-section-number">7.7.3</span> ç»“æœæ¯”è¾ƒ</a></li>
</ul></li>
<li><a href="#ç»“è®º-1"><span class="toc-section-number">7.8</span> ç»“è®º</a></li>
</ul></li>
<li><a href="#flashlight"><span class="toc-section-number">8</span> é€šç”¨æ¨¡å‹è§£é‡Šæ–¹æ³•</a><ul>
<li><a href="#æ•°æ®"><span class="toc-section-number">8.1</span> æ•°æ®</a></li>
<li><a href="#æ¨¡å‹"><span class="toc-section-number">8.2</span> æ¨¡å‹</a><ul>
<li><a href="#glm"><span class="toc-section-number">8.2.1</span> GLM</a></li>
<li><a href="#xgboost-1"><span class="toc-section-number">8.2.2</span> XGBoost</a></li>
<li><a href="#ç¥ç»ç½‘ç»œ-1"><span class="toc-section-number">8.2.3</span> ç¥ç»ç½‘ç»œ</a></li>
</ul></li>
<li><a href="#æ¨¡å‹æ•´ä½“è¡¨ç°-model-performance"><span class="toc-section-number">8.3</span> æ¨¡å‹æ•´ä½“è¡¨ç° ï¼ˆmodel performanceï¼‰</a></li>
<li><a href="#å˜é‡é‡è¦æ€§variable-importance"><span class="toc-section-number">8.4</span> å˜é‡é‡è¦æ€§ï¼ˆvariable importanceï¼‰</a><ul>
<li><a href="#permutation-importance"><span class="toc-section-number">8.4.1</span> Permutation importance</a></li>
</ul></li>
<li><a href="#è¾¹ç¼˜æ•ˆåº”ä¸»æ•ˆåº”"><span class="toc-section-number">8.5</span> è¾¹ç¼˜æ•ˆåº”ï¼ˆä¸»æ•ˆåº”ï¼‰</a><ul>
<li><a href="#individual-conditional-expectationsice"><span class="toc-section-number">8.5.1</span> Individual conditional expectationsï¼ˆICEï¼‰</a></li>
<li><a href="#partial-dependence-profiles"><span class="toc-section-number">8.5.2</span> Partial dependence profiles</a></li>
<li><a href="#accumulated-local-effects-profiles-ale"><span class="toc-section-number">8.5.3</span> Accumulated local effects profiles (ALE)</a></li>
</ul></li>
<li><a href="#äº¤äº’æ•ˆåº”"><span class="toc-section-number">8.6</span> äº¤äº’æ•ˆåº”</a></li>
<li><a href="#å…¨å±€ä»£ç†æ¨¡å‹global-surrogate-models"><span class="toc-section-number">8.7</span> å…¨å±€ä»£ç†æ¨¡å‹ï¼ˆGlobal surrogate modelsï¼‰</a></li>
<li><a href="#å±€éƒ¨è§£é‡Šæ ·æœ¬è§£é‡Š"><span class="toc-section-number">8.8</span> å±€éƒ¨è§£é‡Šï¼ˆæ ·æœ¬è§£é‡Šï¼Ÿï¼‰</a><ul>
<li><a href="#limeå’Œlive"><span class="toc-section-number">8.8.1</span> LIMEå’ŒLIVE</a></li>
<li><a href="#shapshapley-additive-explanations"><span class="toc-section-number">8.8.2</span> SHAP(Shapley Additive Explanations)</a></li>
<li><a href="#breakdown-and-approximate-shap"><span class="toc-section-number">8.8.3</span> Breakdown and approximate SHAP</a></li>
<li><a href="#from-local-to-global-properties"><span class="toc-section-number">8.8.4</span> From local to global properties</a></li>
</ul></li>
<li><a href="#improving-the-glm-by-interpretable-machine-learning"><span class="toc-section-number">8.9</span> Improving the GLM by interpretable machine learning</a></li>
<li><a href="#æ¡ˆä¾‹åˆ†æ"><span class="toc-section-number">8.10</span> æ¡ˆä¾‹åˆ†æ</a><ul>
<li><a href="#å¯¼å…¥åŒ…"><span class="toc-section-number">8.10.1</span> å¯¼å…¥åŒ…</a></li>
<li><a href="#é¢„å¤„ç†-1"><span class="toc-section-number">8.10.2</span> é¢„å¤„ç†</a></li>
<li><a href="#æè¿°æ€§ç»Ÿè®¡"><span class="toc-section-number">8.10.3</span> æè¿°æ€§ç»Ÿè®¡</a></li>
<li><a href="#å»ºæ¨¡"><span class="toc-section-number">8.10.4</span> å»ºæ¨¡</a></li>
<li><a href="#è§£é‡Š"><span class="toc-section-number">8.10.5</span> è§£é‡Š</a></li>
<li><a href="#å±€éƒ¨æ€§è´¨"><span class="toc-section-number">8.10.6</span> å±€éƒ¨æ€§è´¨</a></li>
<li><a href="#æ”¹è¿›glm"><span class="toc-section-number">8.10.7</span> æ”¹è¿›glm</a></li>
</ul></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ç°ä»£ç²¾ç®—ç»Ÿè®¡æ¨¡å‹</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="æ¬¢è¿" class="section level1 unnumbered">
<h1>ğŸ‘¨â€ğŸ« æ¬¢è¿</h1>
<p>ã€Šç°ä»£ç²¾ç®—ç»Ÿè®¡æ¨¡å‹ã€‹ä¸»è¦è®²è¿°å¦‚ä½•ä½¿ç”¨ç»Ÿè®¡å­¦ä¹ å’Œæœºå™¨å­¦ä¹ ç®—æ³•ï¼Œæå‡ä¼ ç»Ÿçš„ç²¾ç®—ç»Ÿè®¡æ¨¡å‹æˆ–è€…è§£å†³æ–°çš„ç²¾ç®—é—®é¢˜ã€‚è¿™é—¨è¯¾ä¸»è¦å‚è€ƒç‘å£«ç²¾ç®—å¸ˆåä¼šå‘å¸ƒçš„<a href="https://actuarialdatascience.org">â€œç²¾ç®—æ•°æ®ç§‘å­¦â€</a>ï¼Œè¯¥æ•™ç¨‹çš„ä¸»è¦ç›®çš„æ˜¯â€œä¸ºç²¾ç®—å¸ˆæä¾›ä¸€ä¸ªå¯¹æ•°æ®ç§‘å­¦å…¨é¢ä¸”æ˜“æ‡‚çš„ä»‹ç»â€ï¼Œè¯¥æ•™ç¨‹æä¾›äº†å¤šç¯‡æ–¹æ³•æ€§æ–‡ç« å¹¶å¼€æºä»£ç ï¼Œè¿™æ ·â€œè¯»è€…å¯ä»¥ç›¸å¯¹å®¹æ˜“åœ°æŠŠè¿™äº›æ•°æ®ç§‘å­¦æ–¹æ³•ç”¨åœ¨è‡ªå·±çš„æ•°æ®ä¸Šâ€ã€‚</p>
<p>æˆ‘ä»¬å»ºè®®å¤§å®¶ä»”ç»†é˜…è¯»ä»¥ä¸‹æ–‡çŒ®ï¼Œå°è¯•å¹¶ç†è§£<a href="https://github.com/JSchelldorfer/ActuarialDataScience">æ‰€æœ‰ä»£ç </a>ã€‚æ­¤ç½‘ç«™å°†ä½œä¸ºè¯¥è¯¾ç¨‹çš„è¾…åŠ©ï¼Œä¸ºå¤§å®¶ç­”ç–‘ï¼Œæ€»ç»“æ–‡çŒ®ï¼Œå¹¶å¯¹æ–‡çŒ®ä¸­çš„æ–¹æ³•åšæ‰©å±•ã€‚è¯¥ç½‘ç«™ç”±æˆè¯¾è€å¸ˆé«˜å…‰è¿œå’ŒåŠ©æ•™å¼ ç®é’°ç®¡ç†ï¼Œæ¬¢è¿å¤§å®¶åé¦ˆæ„è§åˆ°åŠ©æ•™ã€å¾®ä¿¡ç¾¤ã€æˆ–é‚®ç®± <a href="mailto:guangyuan.gao@ruc.edu.cn" class="email">guangyuan.gao@ruc.edu.cn</a>ã€‚</p>
<div id="ç­”ç–‘" class="section level2 unnumbered">
<h2>ğŸ¤” ç­”ç–‘</h2>
<p>æˆ‘å®šæœŸæŠŠåŒå­¦ä»¬çš„æ™®éç–‘é—®åœ¨è¿™é‡Œè§£ç­”ï¼Œæ¬¢è¿æé—®ï¼</p>
<p><strong>ğŸ‘‰ Tensorflow for Apple M1</strong> (2020/12/23)</p>
<p>è´­ä¹°Apple M1çš„åŒå­¦éœ€è¦ç”¨è¿™ä¸ª<a href="https://github.com/apple/tensorflow_macos">pre-release tensorflow</a>ï¼Œä»pypiä¸‹è½½çš„tensorflowæš‚ä¸æ”¯æŒApple M1</p>
<p><strong>ğŸ‘‰ NLP</strong> (2020/12/18)</p>
<p>æ•°æ®</p>
<p><img src="./plots/7/data.png" width="50%" style="display: block; margin: auto;" /></p>
<p>è¿™ä¸ªæ•°æ®ç¬¬<span class="math inline">\(i\)</span>è¡Œ<span class="math inline">\(j\)</span>åˆ—è¡¨ç¤ºï¼Œåœ¨ç¬¬<span class="math inline">\(i\)</span>ä¸ªè¯„è®ºä¸­ç¬¬<span class="math inline">\(j\)</span>ä¸ªè¯çš„æ’å(ä¾ç…§æ€»å‡ºç°é¢‘ç‡)ï¼Œæ‰€ä»¥æ¯ä¸€è¡Œè¿˜ä¿æŒäº†å¥å­ä¸­è¯è¯­çš„å…ˆåé¡ºåºã€‚æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®ï¼ˆæ ·æœ¬ï¼‰ã€‚</p>
<p>LSTM</p>
<p><img src="./plots/7/lstm.png" width="50%"  style="display: block; margin: auto;" /></p>
<ul>
<li><p><code>input</code>ç»´åº¦æ˜¯<code>batch size * length * 1</code>ï¼Œå³ä»¥ä¸Šæ‰€ç¤ºçš„.csvçŸ©é˜µæ–‡æ¡£ã€‚</p></li>
<li><p><code>embedding_3</code> ä½œç”¨å°±æ˜¯æŠŠ<code>input</code>çš„æœ€åä¸€ä¸ªç»´åº¦çˆ†ç‚¸åˆ°256ï¼Œå‚æ•°ä¸ªæ•°ä¸º<code>vocab_size* embedding dimension</code>ï¼Œå¯ä»¥çœ‹ä½œæŠŠ400ä¸ªé«˜é¢‘è¯æ˜ å°„åˆ°256ç»´ç©ºé—´ã€‚</p></li>
<li><p><code>embedding_3</code>å’Œ<code>lstm_2</code>è¾“å‡ºç»´åº¦ä¸­ï¼Œæœ‰ä¸¤ä¸ª<code>none</code>,å…¶ä¸­ç¬¬ä¸€ä¸ªè¡¨ç¤º<code>batch size</code>, ç¬¬äºŒä¸ªè¡¨ç¤º<code>sequence length</code>ã€‚å› ä¸ºLSTMåœ¨æ—¶é—´ç»´åº¦ä¸Šå¾ªç¯ä½¿ç”¨å‚æ•°ï¼Œæ‰€ä»¥<code>sequence length</code>ä¸å½±å“å‚æ•°çš„ä¸ªæ•°ã€‚</p></li>
<li><p><code>sequence length</code>ä¸å½±å“å‚æ•°ä¸ªæ•°ï¼Œå¯¹äºä¸åŒçš„å¥å­é•¿åº¦å¦‚100æˆ–è€…150ï¼Œè¯¥æ¨¡å‹éƒ½ä¸éœ€è¦è°ƒæ•´ï¼Œ(åº”è¯¥)å¯ä»¥ç›´æ¥è½½å…¥æ•°æ®è®­ç»ƒã€‚</p></li>
<li><p><code>lstm_3</code> åªæœ‰ä¸€ä¸ª<code>none</code>, è¡¨ç¤º<code>batch size</code>, æˆ‘ä»¬è¦æ±‚<code>lstm_3</code>ä¸è¿”å›æ•´ä¸ªsequenceåªçœ‹æœ€è¿‘çš„çŠ¶æ€ã€‚</p></li>
</ul>
<p><strong>ğŸ‘‰ Reproducible results using Keras</strong> (2020/12/11)</p>
<p>ä½¿ç”¨Keraså¤ç°ç»“æœçš„æ–¹æ³•ã€‚</p>
<p><a href="https://cran.r-project.org/web/packages/keras/vignettes/faq.html" class="uri">https://cran.r-project.org/web/packages/keras/vignettes/faq.html</a></p>
<p><img src="./plots/reproducible.png" width="50%"  style="display: block; margin: auto;" /></p>
<p><strong>ğŸ‘‰ ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨reluè§£å†³vanishing gradient è€Œè®¾è®¡å¤æ‚çš„lstm gru</strong> (2020/12/11)</p>
<ul>
<li><p>reluå€¼åŸŸåœ¨0åˆ°æ— ç©·ï¼Œä¸å¦‚tanhå’Œsigmoidç¨³å¥ï¼Œåä¸¤ç§å¯ä»¥è®¤ä¸ºæŠŠæå¤§æå°å€¼éƒ½æˆªæ–­äº†ã€‚</p></li>
<li><p>reluæ˜¯çº¿æ€§å˜æ¢ï¼Œå¯èƒ½æè¿°ä¸äº†éçº¿æ€§æ•ˆåº”ã€‚æˆ‘æœ€å¸¸ç”¨tanhã€‚</p></li>
<li><p>å½“ç„¶ï¼Œä½¿ç”¨reluä¼šæ˜æ˜¾æå‡è®¡ç®—é€Ÿåº¦ï¼Œå› ä¸ºreluçš„å¯¼æ•°å®¹æ˜“è®¡ç®—ã€‚</p></li>
</ul>
<p>å¦å‚è§<a href="https://datascience.stackexchange.com/questions/61358/relu-for-combating-the-problem-of-vanishing-gradient-in-rnn#:~:text=For%20solving%20the%20problem%20of%20vanishing%20gradients%20in,In%20both%20of%20these%2C%20activation%20function%20is%20tanh.">stackexchange</a></p>
<p><strong>ğŸ‘‰ xaringan</strong> (2020/12/06)</p>
<p>htmlæ ¼å¼çš„slidesï¼š
<a href="https://slides.yihui.org/xaringan/zh-CN.html#1" class="uri">https://slides.yihui.org/xaringan/zh-CN.html#1</a></p>
<p><strong>ğŸ‘‰ samme.r</strong> (2020/11/27)</p>
<p>å…³äºsamme.rç®—æ³•, è¯·å‚è€ƒä¸‹é¢æ–‡ç« ä¸­çš„exponential loss function.
<a href="https://web.stanford.edu/~hastie/Papers/samme.pdf" class="uri">https://web.stanford.edu/~hastie/Papers/samme.pdf</a></p>
<p>ç®—æ³•samme.rä»…åœ¨ä»¥ä¸Šdraftä¸­å‡ºç°ï¼Œæ­£å¼å‘è¡¨æ—¶samme.rè¢«åˆ æ‰äº†ï¼Œæ¨æµ‹å®¡ç¨¿äººæœ‰å¼‚è®®ã€‚æ­£å¼æ–‡ç« å‚è€ƒ
<a href="http://ww.web.stanford.edu/~hastie/Papers/SII-2-3-A8-Zhu.pdf" class="uri">http://ww.web.stanford.edu/~hastie/Papers/SII-2-3-A8-Zhu.pdf</a></p>
<p><strong>ğŸ‘‰ éšæœºç§å­æ•°</strong> (2020/11/20)</p>
<p>è¾“å…¥<code>RNGversion("3.5.0"); set.seed(100)</code>ï¼Œä½¿å¾—ä½ çš„éšæœºç§å­æ•°å’Œpaperçš„ç›¸åŒï¼Œæ¨¡å‹ç»“æœç›¸è¿‘ã€‚</p>
<p><strong>ğŸ‘‰ MAC OS, Linux, WIN</strong> (2020/11/16)</p>
<p>æ®è§‚å¯Ÿï¼Œåœ¨MAC OSå’ŒLinuxç³»ç»Ÿä¸‹å®‰è£…<code>keras</code>æˆåŠŸçš„æ¯”ä¾‹è¾ƒé«˜ã€‚WINç³»ç»Ÿä¸‹ï¼ŒPythonå„ä¸ªåŒ…çš„ä¾èµ–ä»¥åŠå’ŒRåŒ…çš„åŒ¹é…æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œä»Šå¤©æ˜¯é€šè¿‡æ›´æ¢é•œåƒæºè§£å†³äº†Rä¸­æ— æ³•åŠ è½½<code>tensorflow.keras</code>æ¨¡å—çš„é—®é¢˜ï¼Œæ¨æµ‹æ˜¯TUNAæºä¸­WINåŒ…ä¾èµ–å…³ç³»æ²¡æœ‰åŠæ—¶æ›´æ–°ã€‚</p>
<p>ä¸ºäº†è§£å†³é•œåƒæºæ›´æ–°å»¶è¿Ÿã€æˆ–è€…tensorflowç‰ˆæœ¬è¿‡ä½çš„é—®é¢˜ï¼Œè¿™é‡Œå…±äº«WINä¸‹ç»æµ‹è¯•çš„<a href="https://www.jianguoyun.com/p/DcwPgUgQ3cTHBhi1-s0D">condaç¯å¢ƒ</a>é…ç½®ã€‚ä¸‹è½½è¯¥æ–‡æ¡£ï¼Œä»è¯¥æ–‡æ¡£æ‰€åœ¨æ–‡ä»¶å¤¹å¯åŠ¨å‘½ä»¤è¡Œï¼Œä½¿ç”¨å‘½ä»¤<code>conda env create --name &lt;env&gt; --file filename.yaml</code>ï¼Œå®‰è£…è¯¥condaç¯å¢ƒã€‚åœ¨Rä¸­ä½¿ç”¨<code>reticulate::use_condaenv("&lt;env&gt;",required=T)</code>å…³è”è¯¥ç¯å¢ƒã€‚</p>
<p>å¦å¤–ï¼Œå¯ä¸‹è½½MAC OSç³»ç»Ÿä¸‹ç»æµ‹è¯•çš„<a href="https://www.jianguoyun.com/p/DYethK4Q3cTHBhjr4s0D">condaç¯å¢ƒ</a>é…ç½®ã€‚å¯é€šè¿‡<code>conda env create --name &lt;env&gt; --file filename.yaml</code>å®‰è£…ã€‚</p>
<p><strong>ğŸ‘‰ CASdatasets</strong> (2020/11/13)</p>
<p>æºæ–‡ä»¶åœ¨<a href="http://cas.uqam.ca/" class="uri">http://cas.uqam.ca/</a>ï¼Œä½†ä¸‹è½½é€Ÿåº¦å¾ˆæ…¢ï¼Œæˆ‘æŠŠå®ƒæ”¾åœ¨<a href="https://www.jianguoyun.com/p/DdFyh74Q3cTHBhio2M0D">åšæœäº‘å…±äº«</a>ã€‚ä¸‹è½½åé€‰æ‹©install from local archive fileã€‚</p>
<p><strong>ğŸ‘‰ å¾®ä¿¡ç¾¤</strong> (2020/11/08)</p>
<p><img src="./plots/wechat.png" width="30%"  style="display: block; margin: auto;" /></p>
</div>
<div id="è¯¾ç¨‹å®‰æ’" class="section level2 unnumbered">
<h2>ğŸ—“ï¸ è¯¾ç¨‹å®‰æ’</h2>
<p><img src="./plots/plan.png" width="90%"  style="display: block; margin: auto;" /></p>
<p>ä»¥ä¸‹å®‰æ’ä¸ºåˆæ­¥è®¡åˆ’ï¼Œæ ¹æ®å¤§å®¶çš„éœ€æ±‚å’ŒèƒŒæ™¯ï¼Œæˆ‘ä»¬å¯èƒ½è¦èŠ±æ›´å¤šçš„æ—¶é—´åœ¨æŸäº›é‡è¦çš„æ–¹æ³•åŠå…¶åœ¨ç²¾ç®—ä¸Šçš„åº”ç”¨ã€‚</p>
<ul>
<li><p>ç¬¬10å‘¨ï¼š</p>
<p>å‡†å¤‡å·¥ä½œã€‚</p></li>
<li><p>ç¬¬11å‘¨:</p>
<p>1 - French Motor Third-Party Liability Claims</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3164764" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3164764</a></p></li>
<li><p>æœºåŠ¨</p>
<p>2 - Inisghts from Inside Neural Networks</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3226852" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3226852</a></p>
<p>3 - Nesting Classical Actuarial Models into Neural Networks</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3320525" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3320525</a></p></li>
<li><p>ç¬¬12å‘¨ï¼š</p>
<p>4 - On Boosting: Theory and Applications</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3402687" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3402687</a></p></li>
<li><p>ç¬¬13å‘¨ï¼š</p>
<p>5 - Unsupervised Learning: What is a Sports Car</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3439358" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3439358</a></p></li>
<li><p>ç¬¬14å‘¨ï¼š</p>
<p>6 - Lee and Carter go Machine Learning: Recurrent Neural Networks</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3441030" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3441030</a></p></li>
<li><p>ç¬¬15å‘¨ï¼š</p>
<p>7 - The Art of Natural Language Processing: Classical, Modern and Contemporary Approaches to Text Document Classification</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3547887" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3547887</a></p></li>
<li><p>ç¬¬16å‘¨ï¼š</p>
<p>8 - Peeking into the Black Box: An Actuarial Case Study for Interpretable Machine Learning</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3595944" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3595944</a></p></li>
<li><p>ç¬¬17å‘¨ï¼š</p>
<p>9 - Convolutional neural network case studies: (1) Anomalies in Mortality Rates (2) Image Recognition</p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3656210" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3656210</a></p></li>
</ul>
<!--chapter:end:index.Rmd-->
</div>
</div>
<div id="intro" class="section level1 unnumbered">
<h1>ç®€ä»‹</h1>
<p>ä¿é™©å…¬å¸ä¸ºç¤¾ä¼šä¸­æŸäº›ä¸å¯é¢„çŸ¥çš„ç»æµæŸå¤±å¸¦æ¥äº†ä¿éšœã€‚ä¿é™©å…¬å¸æ‰¿æ‹…äº†è¢«ä¿é™©äººçš„ä¸ç¡®å®šç»æµæŸå¤±çš„é£é™©ï¼Œè¢«ä¿é™©äººè·å¾—äº†ä¿éšœï¼Œä¿é™©å…¬å¸è·å¾—äº†ä¿è´¹ã€‚</p>
<p>é€šå¸¸ï¼Œä¿é™©å…¬å¸éœ€è¦åœ¨ä¿å•çš„ä¿é™©æœŸé™å¼€å§‹æ—¶ç¡®å®šä¿è´¹ï¼Œå³åœ¨ä¿é™©æŸå¤±è¿˜æœªå‘ç”Ÿæ—¶ç¡®å®šä¿è´¹ã€‚ç”±äºè¿™ç§å®šä»·æ–¹å¼ï¼Œä¿é™©äº§å“å’Œä¸€èˆ¬æ¶ˆè´¹äº§å“çš„ç”Ÿäº§å‘¨æœŸç›¸åï¼Œæœä»é€†ç”Ÿäº§å‘¨æœŸã€‚</p>
<p>å› æ­¤ï¼Œ<strong>é¢„æµ‹æ¨¡å‹</strong>åœ¨ä¿é™©äº§å“çš„å®šä»·ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚</p>
<p>è®¡ç®—æœºæŠ€æœ¯çš„å‘å±•å¸¦æ¥äº†è®¡ç®—é€Ÿåº¦çš„æå¤§æå‡å’Œå­˜å‚¨èƒ½åŠ›çš„æå¤§æé«˜ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰å¾ˆå¤šé¢†åŸŸçš„å‘å±•éƒ½å’Œè®¡ç®—æœºæŠ€æœ¯çš„é©æ–°å¯†åˆ‡ç›¸å…³ã€‚</p>
<p><strong>æœºå™¨å­¦ä¹ ç®—æ³•</strong>ä½œä¸ºä¸€ç§é¢„æµ‹æ¨¡å‹ï¼Œç»™ä¼ ç»Ÿçš„<strong>ç²¾ç®—å›å½’æ¨¡å‹</strong>å¸¦æ¥äº†æŒ‘æˆ˜å’Œæœºé‡ã€‚</p>
<ol style="list-style-type: decimal">
<li><p>æœºå™¨å­¦ä¹ ç®—æ³•çš„é¢„æµ‹èƒ½åŠ›ç›¸è¾ƒäºä¼ ç»Ÿå›å½’æ¨¡å‹æ›´é«˜;</p></li>
<li><p>æœºå™¨å­¦ä¹ ç®—æ³•çš„è§£é‡Šæ€§æ¯”è¾ƒå·®ã€‚</p></li>
</ol>
<p>åŸºäºæœºå™¨å­¦ä¹ ç®—æ³•çš„å®šä»·æ¨¡å‹æœ‰åŠ©äºä¿é™©å…¬å¸<strong>ç»†åˆ†é£é™©</strong>ï¼Œç²¾ç¡®å®šä»·ï¼Œå‡å°‘<em>é€†é€‰æ‹©</em>é£é™©ã€‚</p>
<ul>
<li><p>å‡è®¾ä¿é™©å…¬å¸Aåœ¨å®šä»·ä¸­æ²¡æœ‰è€ƒè™‘åˆ°æŸä¸ªé‡è¦çš„é£é™©å› å­ï¼Œå³å¯¹äºæ˜¯å¦æœ‰è¯¥ç±»é£é™©çš„è¢«ä¿é™©äººéƒ½æ”¶å–ç›¸åŒä¿è´¹ï¼›è€Œä¿é™©å…¬å¸Båœ¨å®šä»·ä¸­è€ƒè™‘åˆ°è¯¥é£é™©å› å­ã€‚</p></li>
<li><p>ä¿é™©å…¬å¸Bä¼šå‡­å€Ÿä½ä¿è´¹å¸å¼•ä½é£é™©å®¢æˆ·ï¼Œå‡­å€Ÿé«˜ä¿è´¹ä½¿å¾—é«˜é£é™©å®¢æˆ·ç•™åœ¨ä¿é™©å…¬å¸Aã€‚</p></li>
<li><p>ç”±äºè¢«ä¿é™©äººçš„é€‰æ‹©æ•ˆåº”ï¼Œæœ€ç»ˆä¿é™©å…¬å¸Aæ”¶å–çš„ä¿è´¹ä¸è¶³ä»¥æ”¯ä»˜è¢«ä¿é™©äººçš„æŸå¤±ï¼Œæˆ–è€…éš¾ä»¥è·å–é¢„æœŸçš„ä¿é™©æ”¶ç›Šã€‚</p></li>
</ul>
<p>å¦ä¸€æ–¹é¢ï¼Œä¿é™©å…¬å¸æ‰¿æ‹…ç€é£é™©è½¬ç§»å’Œé£é™©å…±æ‹…çš„ç¤¾ä¼šè§’è‰²ï¼Œè¿‡åº¦çš„ç»†åˆ†é£é™©ä¼šé€ æˆé£é™©ä¸ªä½“åŒ–ï¼Œä½¿å¾—ä¿é™©å…¬å¸çš„é£é™©è½¬ç§»å’Œå…±æ‹…çš„ä½œç”¨æ¶ˆå¤±ã€‚
æ¯”å¦‚ï¼ŒåŸºäºè¢«ä¿é™©äººçš„é«˜é£é™©ç‰¹å¾ï¼Œä¿é™©å…¬å¸ä¼šæ”¶å–æé«˜çš„ä¿è´¹ï¼Œä½¿å¾—è¢«ä¿é™©äººçš„é£é™©è½¬ç§»ä»·å€¼è¡ç„¶æ— å­˜ï¼Œä¹Ÿæ²¡æœ‰è´­ä¹°ä¿é™©çš„åŠ¨åŠ›ã€‚
æ‰€ä»¥ï¼Œä¿é™©å…¬å¸éœ€è¦å¹³è¡¡<strong>é£é™©ç»†åˆ†å’Œé£é™©å…±æ‹…</strong>ï¼Œä½¿å¾—ä¿é™©å…¬å¸æ—¢å¯ä»¥é¿å…é€†é€‰æ‹©ï¼Œä¹Ÿèƒ½æä¾›æœ‰æ•ˆçš„é£é™©è½¬ç§»çš„ä¿é™©äº§å“ã€‚</p>
<p>ä¸€èˆ¬åœ°ï¼Œä¿é™©å®šä»·æ¨¡å‹å—åˆ°ä¿é™©ç›‘ç®¡æœºæ„çš„ä¸¥æ ¼çº¦æŸï¼Œè¿™äº›æ¨¡å‹åœ¨åº”ç”¨åˆ°å®é™…ä¸­æ—¶ï¼Œå¿…é¡»æ»¡è¶³ä¸€å®šçš„æ¡ä»¶ã€‚è¿™ç»™æœºå™¨å­¦ä¹ ç®—æ³•åœ¨ä¿é™©å®šä»·ä¸­çš„åº”ç”¨å¸¦æ¥äº†å¾ˆå¤šé˜»ç¢ã€‚</p>
<ul>
<li><p>åœ¨ä¸­å›½ï¼Œä¿ç›‘ä¼šé™å®šäº†å•†ä¸šè½¦é™©ä¿è´¹çš„åŒºé—´ï¼Œéšç€å•†ä¸šè½¦é™©è´¹ç‡æ”¹é©ï¼Œè¿™ä¸ªåŒºé—´åœ¨ä¸æ–­æ‰©å¤§ï¼Œä¿é™©å…¬å¸çš„å®šä»·æ¨¡å‹å‘æŒ¥çš„ä½œç”¨è¶Šæ¥è¶Šå¤§ã€‚</p></li>
<li><p>European Unionâ€™s General Data Protection Regulation (2018) å»ºç«‹äº†algorithmic accountability of decision-making machine algorithmsåˆ¶åº¦ï¼Œè¯¥åˆ¶åº¦èµ‹äºˆäº†å‚ä¸è€…å¯¹äºæœºå™¨å­¦ä¹ ç®—æ³•èƒŒåé€»è¾‘çš„çŸ¥æƒ…æƒã€‚</p></li>
</ul>
<p>æ€»ä¹‹ï¼Œå®šä»·æ¨¡å‹å¿…é¡»åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è§£é‡Šç»™è¢«ä¿é™©äººã€ä¿é™©ç›‘ç®¡æœºæ„ç­‰ã€‚ä»è¢«ä¿é™©äººå’Œä¿é™©ç›‘ç®¡çš„è§’åº¦å‡ºå‘ï¼Œä»–ä»¬ä¹Ÿå¸Œæœ›äº§å“å®šä»·å’Œé£é™©ç®¡ç†æ˜¯å»ºç«‹åœ¨ä¸€ä¸ªè¾ƒé€æ˜çš„æ¨¡å‹è€Œä¸æ˜¯ä¸€ä¸ªé»‘ç›’å­ï¼Œè¿™æ ·æœ‰åˆ©äºç»´æŠ¤å¸‚åœºå…¬å¹³ã€ä¿éšœè¢«ä¿é™©äººçš„åˆ©ç›Šã€æ£€æµ‹é‡è¦é£é™©å› å­ã€å»ºç«‹é˜²èŒƒé£é™©æªæ–½ã€‚</p>
<!--chapter:end:00-introduction.Rmd-->
</div>
<div id="pre" class="section level1">
<h1><span class="header-section-number">1</span> å‡†å¤‡å·¥ä½œ</h1>
<p>â€œå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚â€</p>
<p>åœ¨ä»¥ä¸‹æ­¥éª¤ä¸­ï¼Œå½“ä½ å‘ç°å®‰è£…éå¸¸æ…¢æ—¶ï¼Œå¯ä»¥å°è¯•4Gç½‘ç»œï¼Œå°è¯•VPNï¼Œå°è¯•æ”¹å˜CRANçš„é•œåƒæºï¼Œæˆ–å°è¯•æ”¹å˜condaçš„é•œåƒæºã€‚condaé•œåƒæºé€šè¿‡ä¿®æ”¹ç”¨æˆ·ç›®å½•ä¸‹çš„<code>.condarc</code>æ–‡ä»¶ä½¿ç”¨<a href="https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/">TUNAé•œåƒæº</a>ï¼Œä½†è¯¥é•œåƒæºå¯èƒ½æœ‰æ›´æ–°å»¶è¿Ÿã€‚</p>
<div id="å¸¸ç”¨é“¾æ¥" class="section level2">
<h2><span class="header-section-number">1.1</span> å¸¸ç”¨é“¾æ¥</h2>
<p>å‡†å¤‡å·¥ä½œä¸­å¸¸ç”¨çš„é“¾æ¥æœ‰</p>
<ul>
<li><p><a href="https://github.com/JSchelldorfer/ActuarialDataScience">GitHub</a></p></li>
<li><p><a href="https://git-scm.com/">Git</a></p></li>
<li><p><a href="https://docs.github.com/cn/free-pro-team@latest/github/authenticating-to-github/connecting-to-github-with-ssh">SSH key</a></p></li>
<li><p><a href="https://resources.github.com/whitepapers/github-and-rstudio/">GitHub and RStudio</a></p></li>
<li><p><a href="https://jupyter.org/">Jupyter Notebook</a></p></li>
<li><p><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/">Anaconda</a></p></li>
<li><p><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/?C=N&amp;O=D">Miniconda</a></p></li>
<li><p><a href="https://docs.conda.io/projects/conda/en/latest/commands.html#">å¸¸ç”¨Condaå‘½ä»¤</a></p></li>
<li><p><a href="https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/">TUNAé•œåƒæº</a></p></li>
<li><p><a href="https://keras.rstudio.com/">R interface to Tensorflow and Keras</a></p></li>
<li><p><a href="https://cran.r-project.org/web/packages/reticulate/">reticulate</a></p></li>
<li><p><a href="https://tensorflow.google.cn/">Tensorflow</a></p></li>
<li><p><a href="https://pytorch.apachecn.org/">Pytorch</a></p></li>
<li><p><a href="https://cc.ruc.edu.cn/home">æ ¡çº§è®¡ç®—äº‘</a></p></li>
<li><p><a href="https://developer.nvidia.com/cuda-toolkit-archivE">CUDA</a></p></li>
<li><p><a href="https://developer.nvidia.com/rdp/form/cudnn-download-survey">cuDNN</a></p></li>
</ul>
</div>
<div id="å…‹éš†ä»£ç " class="section level2">
<h2><span class="header-section-number">1.2</span> å…‹éš†ä»£ç </h2>
<p><a href="https://github.com/">GitHub</a>æä¾›äº†å¤§é‡å¼€æºä»£ç ï¼Œè¿™é—¨è¯¾çš„ä»£ç ä¸»è¦æ¥è‡ª<a href="https://github.com/JSchelldorfer/ActuarialDataScience">æ­¤é“¾æ¥</a>ã€‚é€šå¸¸ï¼Œä½¿ç”¨GitHubå¼€æºä»£ç æœ€æ–¹ä¾¿çš„æ˜¯<code>fork</code>åˆ°è‡ªå·±GitHubè´¦æˆ·ä¸‹ï¼Œç„¶å<code>clone</code>åˆ°æœ¬åœ°ã€‚å…·ä½“è€Œè¨€ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol style="list-style-type: decimal">
<li><p>æ³¨å†ŒGitHubè´¦æˆ·ã€‚</p></li>
<li><p><code>Fork</code><a href="https://github.com/JSchelldorfer/ActuarialDataScience">æ­¤é“¾æ¥</a>åˆ°è‡ªå·±è´¦æˆ·ä¸‹çš„æ–°ä»“åº“,å¯é‡æ–°å‘½åä¸ºå¦‚<code>Modern-Actuarial-Models</code>æˆ–å…¶ä»–åç§°ã€‚</p></li>
<li><p>å®‰è£…<a href="https://git-scm.com/">git</a>ã€‚åœ¨å‘½ä»¤çª—å£ä½¿ç”¨<code>$ git config --global user.name "Your Name"</code> å’Œ <code>$ git config --global user.email "youremail@yourdomain.com"</code> é…ç½®gitçš„ç”¨æˆ·åå’Œé‚®ç®±åˆ†åˆ«ä¸ºGitHubè´¦æˆ·çš„ç”¨æˆ·åå’Œé‚®ç®±ã€‚æœ€åå¯ä½¿ç”¨<code>$ git config --list</code>æŸ¥çœ‹é…ç½®ä¿¡æ¯ã€‚</p></li>
<li><p>(é€‰åš)åœ¨æœ¬åœ°ç”µè„‘åˆ›å»ºssh public keyï¼Œå¹¶æ‹·è´åˆ°GitHubä¸­<code>Setting</code>ä¸‹<code>SSH and GPG keys</code>ã€‚ssh public keyä¸€èˆ¬ä¿å­˜åœ¨æœ¬äººç›®å½•ä¸‹çš„éšè—æ–‡ä»¶å¤¹.sshä¸­ï¼Œæ‰©å±•åä¸º.pubã€‚è¯¦è§<a href="https://docs.github.com/cn/free-pro-team@latest/github/authenticating-to-github/connecting-to-github-with-ssh">é“¾æ¥</a>ã€‚è®¾ç«‹SSHå¯ä»¥é¿å…åç»­<code>push</code>ä»£ç åˆ°äº‘ç«¯æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦è¾“å…¥å¯†ç çš„éº»çƒ¦</p></li>
<li><p>ç”µè„‘è¿æ¥æ‰‹æœº4Gçƒ­ç‚¹ã€‚ä¸€èˆ¬åœ°ï¼Œåœ¨æ‰‹æœº4Gç½‘ç»œä¸‹å…‹éš†çš„é€Ÿåº¦æ¯”è¾ƒå¿«ã€‚</p></li>
<li><p>åœ¨RStudioä¸­åˆ›å»ºæ–°çš„é¡¹ç›®ï¼Œé€‰æ‹©Version Controlï¼Œç„¶åGitï¼Œåœ¨Repository URLä¸­è¾“å…¥ä½ çš„GitHubä¸­åˆšæ‰<code>fork</code>çš„æ–°ä»“åº“åœ°å€ï¼ˆåœ¨<code>Code</code>ä¸‹èƒ½æ‰¾åˆ°å…‹éš†åœ°å€ï¼Œå¦‚æœç¬¬4æ­¥å®Œæˆå¯ä»¥é€‰æ‹©SSHåœ°å€ï¼Œå¦‚æœç¬¬4æ­¥æ²¡å®Œæˆå¿…é¡»é€‰æ‹©HTTPSåœ°å€ï¼‰ï¼Œè¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼Œé€‰æ‹©å­˜æ”¾ä½ç½®ï¼Œç‚¹å‡»<code>create project</code>ï¼ŒRStudioå¼€å§‹å…‹éš†GitHubä¸Šè¯¥ä»“åº“çš„æ‰€æœ‰å†…å®¹ã€‚</p></li>
<li><p>æ­¤æ—¶ï¼Œä½ åœ¨GitHubä¸Šä»“åº“çš„å†…å®¹å…¨éƒ¨å…‹éš†åˆ°äº†æœ¬åœ°ï¼Œä¸”æ”¾åœ¨äº†ä¸€ä¸ªR Projectä¸­ã€‚åœ¨è¯¥Projectä¸­ï¼Œä¼šå¤šä¸¤ä¸ªæ–‡ä»¶ï¼Œ.Rprojå’Œ.gitignoreï¼Œç¬¬ä¸€ä¸ªæ–‡ä»¶ä¿å­˜äº†Projectçš„è®¾ç½®ï¼Œç¬¬äºŒæ–‡ä»¶å‘Šè¯‰gitåœ¨<code>push</code>æœ¬åœ°æ–‡ä»¶åˆ°GitHubæ—¶å“ªäº›æ–‡ä»¶è¢«å¿½ç•¥ã€‚</p></li>
<li><p>å¦‚æœä½ ä¿®æ”¹äº†æœ¬åœ°æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡Rä¸­å†…åµŒçš„Gitä¸Šä¼ åˆ°GitHubï¼ˆå…ˆ<code>commit</code>å†<code>push</code>ï¼‰ï¼Œè¿™æ ·æ–¹ä¾¿åœ¨ä¸åŒç”µè„‘ä¸ŠåŒæ­¥æ–‡ä»¶ã€‚gitæ˜¯ä»£ç ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œåœ¨<code>push</code>ä¹‹å‰ï¼Œä½ å¯ä»¥æ¯”è¾ƒå’Œä¸Šä¸ªä»£ç ç‰ˆæœ¬çš„å·®å¼‚ã€‚GitHubè®°å½•äº†ä½ æ¯æ¬¡<code>push</code>çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¸”å­˜æ”¾åœ¨æœ¬åœ°æ–‡ä»¶å¤¹.gitä¸­ã€‚åŒæ—¶ï¼Œå¦‚æœGitHubä¸Šä»£ç æœ‰å˜åŒ–ï¼Œä½ å¯ä»¥<code>pull</code>åˆ°æœ¬åœ°ã€‚å¦‚æœç»å¸¸åœ¨ä¸åŒç”µè„‘ä¸Šä½¿ç”¨æœ¬ä»“åº“ï¼Œä¸€èˆ¬éœ€è¦å…ˆ<code>pull</code>æˆæœ€æ–°ç‰ˆæœ¬ï¼Œç„¶åå†ç¼–è¾‘ä¿®æ”¹ï¼Œæœ€å<code>commit-push</code>åˆ°GitHubã€‚</p></li>
<li><p>(é€‰åš) ä½ å¯ä»¥å»ºç«‹æ–°çš„<code>branch</code>ï¼Œä½¿è‡ªå·±çš„ä¿®æ”¹å’Œæºä»£ç åˆ†å¼€ã€‚å…·ä½“æ“ä½œå¯å‚è€ƒ<a href="https://resources.github.com/whitepapers/github-and-rstudio/">é“¾æ¥</a>ï¼Œæˆ–è€…å‚è€ƒè´¦æˆ·å»ºç«‹æ—¶è‡ªåŠ¨äº§ç”Ÿçš„<code>getting-started</code>ä»“åº“ã€‚</p></li>
<li><p>(é€‰åš) ä½ å¯ä»¥å°è¯•<a href="https://desktop.github.com/">Github Desktop</a>æˆ–è€…<a href="https://jupyter.org/">Jupyter Lab</a>ï¼ˆåŠ è½½git extensionï¼‰ç®¡ç†ï¼Œä½†å¯¹äºè¿™é—¨è¯¾ï¼Œè¿™ä¸¤ç§æ–¹å¼ä¸æ˜¯æœ€ä¼˜ã€‚</p></li>
</ol>
<p>ç†è®ºä¸Šï¼ŒGitHubä¸Šæ‰€æœ‰ä»“åº“éƒ½å¯ä»¥é‡‡ç”¨ä»¥ä¸Šæ–¹æ³•åœ¨RStudioä¸­ç®¡ç†ï¼Œå½“ç„¶ï¼ŒRStudioå¯¹äºRä»£ç ä»“åº“ç®¡ç†æœ€æœ‰æ•ˆï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨RStudioä¸­è¿è¡Œä»“åº“ä¸­çš„ä»£ç ã€‚</p>
</div>
<div id="r-interface-to-keras" class="section level2">
<h2><span class="header-section-number">1.3</span> R interface to Keras</h2>
<p>è¿™é‡Œä¸»è¦è¯´æ˜<code>keras</code>åŒ…çš„å®‰è£…å’Œä½¿ç”¨ã€‚<a href="https://keras.rstudio.com/">Keras</a>æ˜¯tensorflowçš„APIï¼Œåœ¨kerasä¸­å»ºç«‹çš„ç¥ç»ç½‘ç»œæ¨¡å‹éƒ½ç”±tensorflowè®­ç»ƒã€‚å®‰è£…<code>keras</code>åŒ…ä¸»è¦æ˜¯å®‰è£…Pythonåº“tensorflowï¼Œå¹¶è®©Rä¸ä¹‹ç›¸å…³è”ã€‚</p>
<div id="rè‡ªåŠ¨å®‰è£…" class="section level3">
<h3><span class="header-section-number">1.3.1</span> Rè‡ªåŠ¨å®‰è£…</h3>
<p>æœ€ç®€å•çš„å®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>ä½¿ç”¨<code>install.packages("tensorflow")</code>å®‰è£…æ‰€æœ‰ç›¸å…³çš„åŒ…ï¼Œç„¶å<code>library("tensorflow")</code>ã€‚</p></li>
<li><p><code>install_tensorflow()</code></p>
<p>è¿™æ—¶å¤§æ¦‚ç‡ä¼šå‡ºç°</p>
<pre><code>No non-system installation of Python could be found.
Would you like to download and install Miniconda?
Miniconda is an open source environment management system for Python.
See https://docs.conda.io/en/latest/miniconda.html for more details.
Would you like to install Miniconda? [Y/n]:</code></pre>
<p>è™½ç„¶ä½ å¯èƒ½å·²ç»æœ‰Anacondaå’ŒPythonï¼Œä½†Ræ²¡æœ‰â€œæ™ºèƒ½â€åœ°è¯†åˆ«å‡ºæ¥ï¼Œè¿™æ—¶ä»å»ºè®®ä½ é€‰<code>Y</code>ï¼Œè®©Rè‡ªå·±è£…ä¸€ä¸‹è‡ªå·±èƒ½æ›´å¥½è¯†åˆ«çš„<code>Miniconda</code>, è¿™ä¸ªå‘½ä»¤è¿˜ä¼šè‡ªåŠ¨å»ºç«‹ä¸€ä¸ªç‹¬ç«‹condaç¯å¢ƒ<code>r-reticulate</code>ï¼Œå¹¶åœ¨å…¶ä¸­è£…å¥½<code>tensorflow, keras</code>ç­‰ã€‚</p></li>
<li><p>ä¸Šæ­¥å¦‚æœæ­£å¸¸è¿è¡Œï¼Œç»“æŸåä¼šè‡ªåŠ¨é‡å¯Rã€‚è¿™æ—¶ä½ è¿è¡Œ<code>library(tensorflow)</code>ç„¶å<code>tf$constant("Hellow Tensorflow")</code>ï¼Œå¦‚æœæ²¡æŠ¥é”™ï¼Œé‚£ç»§ç»­<code>install_packages("keras")</code>,<code>library("keras")</code>ã€‚</p>
<p>ç”¨ä»¥ä¸‹ä»£ç éªŒè¯å®‰è£…æˆåŠŸ</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model_sequential</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">layer_flatten</span>(<span class="dt">input_shape =</span> <span class="kw">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">layer_dropout</span>(<span class="fl">0.2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">layer_dense</span>(<span class="dv">10</span>, <span class="dt">activation =</span> <span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">summary</span>(model)</span></code></pre></div>
<p>å¦‚æœå‡ºç°ä»¥ä¸‹é”™è¯¯</p>
<pre><code>é”™è¯¯: Installation of TensorFlow not found.
Python environments searched for &#39;tensorflow&#39; package:
C:\Users\...\AppData\Local\r-miniconda\envs\r-reticulate\python.exe
You can install TensorFlow using the install_tensorflow() function.</code></pre>
<p>è¿™ä¸ªé”™è¯¯é€šå¸¸æ˜¯ç”±äº<code>r-reticulate</code>ä¸­<code>tensorflow</code>å’Œå…¶ä»–åŒ…çš„ä¾èµ–å…³ç³»å‘ç”Ÿé”™è¯¯ï¼Œæˆ–è€…<code>tensorflow</code>ç‰ˆæœ¬å¤ªä½ï¼Œä½ å¯ä»¥æ›´æ¢é•œåƒæºã€ä½¿ç”¨conda/pip installè°ƒæ•´è¯¥ç¯å¢ƒä¸­çš„<code>tensorflow</code>ç‰ˆæœ¬å’Œä¾èµ–å…³ç³»ã€‚</p>
<p>æ›´å¥½çš„æ–¹å¼æ˜¯åœ¨condaä¸‹å®‰è£…å¥½æŒ‡å®šç‰ˆæœ¬çš„<code>tensorflow</code>ç„¶åå…³è”åˆ°Rï¼Œæˆ–è€…ç”¨å…¶ä»–æ–¹å¼è®©Ræ‰¾åˆ°å…¶ä»–æ–¹å¼å®‰è£…çš„<code>tensorflow</code>ã€‚è¿™æ—¶ï¼Œä½ å…ˆæŠŠä¹‹å‰å¤±è´¥çš„å®‰è£…<code>C:\Users\...\AppData\Local\r-miniconda</code>ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å®Œå…¨åˆ æ‰ã€‚ç„¶åå‚è€ƒä»¥ä¸‹å®‰è£…æ­¥éª¤ã€‚</p></li>
</ol>
</div>
<div id="ä½¿ç”¨reticulateå…³è”condaç¯å¢ƒ" class="section level3">
<h3><span class="header-section-number">1.3.2</span> ä½¿ç”¨reticulateå…³è”condaç¯å¢ƒ</h3>
<ol style="list-style-type: decimal">
<li><p>ä¸‹è½½å¹¶å®‰è£…<a href="https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/">Anaconda</a>æˆ–è€…<a href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a>ã€‚</p></li>
<li><p>è¿è¡Œ<code>Anaconda Prompt</code>æˆ–è€…<code>Anaconda Powershell Prompt</code>ï¼Œåœ¨å‘½ä»¤è¡Œè¾“å…¥<code>conda create -n r-tensorflow tensorflow=2.1.0</code>ï¼Œcondaä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„<code>r-tensorflow</code>ç¯å¢ƒï¼Œå¹¶åœ¨å…¶ä¸­å®‰è£…<code>tensorflow</code>åŒ…ã€‚</p></li>
<li><p>ç»§ç»­åœ¨å‘½ä»¤è¡Œè¿è¡Œ<code>conda activate r-tensorflow</code>åŠ è½½åˆšåˆšå®‰è£…çš„ç¯å¢ƒï¼Œå¹¶<code>pip install h5py pyyaml requests Pillow scipy</code>åœ¨è¯¥ç¯å¢ƒä¸‹å®‰è£…<code>keras</code>ä¾èµ–çš„åŒ…ã€‚è‡³æ­¤ï¼ŒRéœ€è¦çš„tensorflowç¯å¢ƒå·²ç»å‡†å¤‡å¥½ï¼Œæ¥ä¸‹æ¥è®©Rå…³è”æ­¤ç¯å¢ƒã€‚</p></li>
<li><p>é‡å¯Rï¼Œ<code>library("reticulate")</code>ç„¶å<code>use_condaenv("r-tensorflow",required=T)</code>,è¿™æ—¶Rå°±å’Œä¸Šé¢å»ºç«‹çš„ç¯å¢ƒå…³è”å¥½ã€‚</p></li>
<li><p><code>library("kerasâ€œ)</code>ã€‚è¿™é‡Œå‡è®¾ä½ å·²ç»è£…å¥½<code>tensorflow</code>å’Œ<code>keras</code>åŒ…ã€‚</p>
<p>ç”¨ä»¥ä¸‹ä»£ç éªŒè¯å®‰è£…æˆåŠŸ</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model_sequential</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">layer_flatten</span>(<span class="dt">input_shape =</span> <span class="kw">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">layer_dropout</span>(<span class="fl">0.2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">layer_dense</span>(<span class="dv">10</span>, <span class="dt">activation =</span> <span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw">summary</span>(model)</span></code></pre></div></li>
</ol>
</div>
<div id="æŒ‡å®šcondaå®‰è£…" class="section level3">
<h3><span class="header-section-number">1.3.3</span> æŒ‡å®šcondaå®‰è£…</h3>
<ol style="list-style-type: decimal">
<li><p>ä¸‹è½½å¹¶å®‰è£…<a href="https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/">Anaconda</a>æˆ–è€…<a href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a>ã€‚</p></li>
<li><p>å‘½ä»¤è¡Œè¾“å…¥<code>which -a python</code>ï¼Œæ‰¾åˆ°Anacondaä¸­Pythonçš„è·¯å¾„è®°ä¸º<code>anapy</code>ã€‚</p></li>
<li><p>Rä¸­<code>install_packages("tensorflow")</code>ï¼Œç„¶å</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">install_tensorflow</span>(<span class="dt">method =</span> <span class="st">&quot;conda&quot;</span>, <span class="dt">conda =</span> <span class="st">&quot;anapy&quot;</span>, <span class="dt">envname =</span> <span class="st">&quot;r-tensorflow&quot;</span>, <span class="dt">version =</span> <span class="st">&quot;2.1.0&quot;</span>)</span></code></pre></div>
<p>æ­¤å‘½ä»¤ä¼šåœ¨condaä¸‹åˆ›å»º<code>r-tensorflow</code>çš„ç¯å¢ƒå¹¶è£…å¥½tensorflowåŒ…ã€‚</p></li>
<li><p><code>install_packages("keras"); library("keras")</code></p>
<p>ç”¨ä»¥ä¸‹ä»£ç éªŒè¯å®‰è£…æˆåŠŸ</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model_sequential</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">layer_flatten</span>(<span class="dt">input_shape =</span> <span class="kw">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw">layer_dropout</span>(<span class="fl">0.2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">layer_dense</span>(<span class="dv">10</span>, <span class="dt">activation =</span> <span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="kw">summary</span>(model)</span></code></pre></div></li>
</ol>
</div>
<div id="ä½¿ç”¨reticulateå®‰è£…" class="section level3">
<h3><span class="header-section-number">1.3.4</span> ä½¿ç”¨reticulateå®‰è£…</h3>
<ol style="list-style-type: decimal">
<li><p>é‡å¯Rï¼Œ<code>library("reticulate")</code>ã€‚</p></li>
<li><p><code>options(timeout=300)</code>ï¼Œé˜²æ­¢ä¸‹è½½æ—¶é—´è¿‡é•¿ä¸­æ–­ã€‚</p></li>
<li><p><code>install_miniconda()</code>ï¼Œå°†ä¼šå®‰è£…<code>miniconda</code>å¹¶åˆ›å»ºä¸€ä¸ª<code>r-reticulate</code>condaç¯å¢ƒã€‚æ­¤ç¯å¢ƒä¸ºRé»˜è®¤è°ƒç”¨çš„Pythonç¯å¢ƒã€‚</p></li>
<li><p>ï¼ˆé‡å¯Rï¼‰<code>library("tensorflow"); install_tensorflow(version="2.1.0")</code>ï¼Œå°†ä¼šåœ¨<code>r-reticulate</code>å®‰è£…<code>tensorflow</code>ã€‚</p></li>
<li><p><code>install_packages("keras"); library("keras")</code></p>
<p>ç”¨ä»¥ä¸‹ä»£ç éªŒè¯å®‰è£…æˆåŠŸ</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model_sequential</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">layer_flatten</span>(<span class="dt">input_shape =</span> <span class="kw">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw">layer_dropout</span>(<span class="fl">0.2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="kw">layer_dense</span>(<span class="dv">10</span>, <span class="dt">activation =</span> <span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="kw">summary</span>(model)</span></code></pre></div></li>
</ol>
</div>
</div>
<div id="r-interface-to-python" class="section level2">
<h2><span class="header-section-number">1.4</span> R interface to Python</h2>
<p>RåŒ…<code>reticulate</code>ä¸º<code>tensorflow</code>çš„ä¾èµ–åŒ…ï¼Œå½“ä½ è£…<code>tensorflow</code>å®ƒä¹Ÿè¢«è‡ªåŠ¨å®‰è£…ã€‚å®ƒå¯ä»¥å»ºç«‹Rä¸Pythonçš„äº¤äº’ã€‚</p>
<div id="reticulate-å¸¸è§å‘½ä»¤" class="section level3">
<h3><span class="header-section-number">1.4.1</span> reticulate å¸¸è§å‘½ä»¤</h3>
<ul>
<li><p><code>conda_list()</code>åˆ—å‡ºå·²å®‰è£…çš„condaç¯å¢ƒ</p></li>
<li><p><code>virtualenv_list()</code>åˆ—å‡ºå·²å­˜åœ¨çš„è™šæ‹Ÿç¯å¢ƒ</p></li>
<li><p><code>use_python, use_condaenv, use_virtualenv</code>å¯ä»¥æŒ‡å®šä¸Rå…³è”çš„pythonã€‚</p></li>
<li><p><code>py_config()</code>å¯ä»¥æŸ¥çœ‹å½“å‰Pythonå…³è”ä¿¡æ¯ã€‚</p></li>
</ul>
<p>å¾ˆå¤šæ—¶å€™ï¼ŒRä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹condaç¯å¢ƒ<code>r-miniconda/envs/r-reticulate</code>ã€‚</p>
</div>
<div id="åˆ‡æ¢rå…³è”çš„condaç¯å¢ƒ" class="section level3">
<h3><span class="header-section-number">1.4.2</span> åˆ‡æ¢Rå…³è”çš„condaç¯å¢ƒ</h3>
<p>æ ¹æ®éœ€è¦ï¼Œä½ å¯ä»¥åˆ‡æ¢Rå…³è”çš„condaç¯å¢ƒã€‚å…·ä½“æ­¥éª¤ä¸º</p>
<ol style="list-style-type: decimal">
<li><p>é‡å¯R</p></li>
<li><p><code>library("reticulate")</code></p></li>
<li><p><code>conda_list()</code>åˆ—å‡ºå¯ä»¥å…³è”çš„ç¯å¢ƒå’Œè·¯å¾„ã€‚</p></li>
<li><p><code>use_condaenv("env-name")</code>ã€‚<code>env-name</code>ä¸ºå…³è”çš„condaç¯å¢ƒã€‚</p></li>
<li><p><code>py_config</code>æŸ¥çœ‹æ˜¯å¦å…³è”æˆåŠŸã€‚</p></li>
</ol>
</div>
</div>
<div id="python" class="section level2">
<h2><span class="header-section-number">1.5</span> Python</h2>
<p>ä¸€èˆ¬åœ¨æ¯ä¸ªPythonï¼ˆCondaï¼‰ç¯å¢ƒéƒ½éœ€è¦å®‰è£…ä¸€ä¸ªJupyter Notebook (conda install notebook)ã€‚</p>
<div id="condaç¯å¢ƒ" class="section level3">
<h3><span class="header-section-number">1.5.1</span> Condaç¯å¢ƒ</h3>
<p>Pythonï¼ˆcondaï¼‰ç¯å¢ƒå»ºç«‹æ¯”è¾ƒç®€å•ï¼Œåœ¨<code>ä½¿ç”¨reticulateå…³è”condaç¯å¢ƒ</code>æˆ‘ä»¬å·²ç»å»ºç«‹è¿‡ä¸€ä¸ªç¯å¢ƒ<code>r-tensorflow</code>ã€‚å…·ä½“æ“ä½œå¦‚ä¸‹:</p>
<ol style="list-style-type: decimal">
<li><p>å»ºç«‹ç‹¬ç«‹ç¯å¢ƒ<code>conda create -n env-name python=3.8 tensorflow=2.1.0 notebook</code>ã€‚è¯¥å‘½ä»¤ä¼šå»ºç«‹<code>env-name</code>çš„ç¯å¢ƒï¼Œå¹¶åœ¨å…¶ä¸­å®‰è£…<code>python=3.8</code>,<code>tensorflow</code>ï¼Œ<code>notebook</code>åŒ…åŠå…¶ä¾èµ–åŒ…ã€‚</p></li>
<li><p>æ¿€æ´»ç¯å¢ƒ<code>conda activate env-name</code>.</p></li>
<li><p>cd åˆ°ä½ çš„å·¥ä½œç›®å½•ã€‚</p></li>
<li><p>å¯åŠ¨jupyter notebook <code>jupyter notebook</code>ã€‚</p></li>
<li><p>å¦‚é‡åˆ°ç¼ºå°‘çš„åŒ…ï¼Œåœ¨è¯¥ç¯å¢ƒ<code>env-name</code>ä¸‹ä½¿ç”¨<code>conda install ***</code>å®‰è£…ç¼ºå°‘çš„åŒ…ã€‚</p></li>
</ol>
</div>
<div id="å¸¸ç”¨çš„condaå‘½ä»¤" class="section level3">
<h3><span class="header-section-number">1.5.2</span> å¸¸ç”¨çš„Condaå‘½ä»¤</h3>
<ul>
<li><p><code>conda create -n env-name2 --clone env-name1</code>:å¤åˆ¶ç¯å¢ƒ</p></li>
<li><p><code>conda env list</code>ï¼šåˆ—å‡ºæ‰€æœ‰ç¯å¢ƒ</p></li>
<li><p><code>conda deactivate</code>ï¼šé€€å‡ºå½“å‰ç¯å¢ƒ</p></li>
<li><p><code>conda remove -n env-name --all</code>ï¼šåˆ é™¤ç¯å¢ƒ<code>env-name</code>ä¸­çš„æ‰€æœ‰åŒ…</p></li>
<li><p><code>conda list -n env-name</code>: åˆ—å‡ºç¯å¢ƒ<code>env-name</code>æ‰€å®‰è£…çš„åŒ…</p></li>
<li><p><code>conda clean -p</code>ï¼šåˆ é™¤ä¸ä½¿ç”¨çš„åŒ…</p></li>
<li><p><code>conda clean -t</code>ï¼šåˆ é™¤ä¸‹è½½çš„åŒ…</p></li>
<li><p><code>conda clean -a</code>ï¼šåˆ é™¤æ‰€æœ‰ä¸å¿…è¦çš„åŒ…</p></li>
<li><p><code>pip freeze &gt; pip_pkg.txt</code>, <code>pip install -r pip_pkg.txt</code> ä¿å­˜å½“å‰ç¯å¢ƒPyPIåŒ…ç‰ˆæœ¬ï¼Œä»æ–‡ä»¶å®‰è£…PyPIåŒ…ï¼ˆéœ€åŒç³»ç»Ÿï¼‰</p></li>
<li><p><code>conda env export &gt; conda_pkg.yaml</code>, <code>conda env export --name env_name &gt; conda_pkg.yaml</code>, <code>conda env create --name env-name2 --file conda_pkg.yaml</code> ä¿å­˜å½“å‰/env-nameç¯å¢ƒæ‰€æœ‰åŒ…ï¼Œä»æ–‡ä»¶å®‰è£…æ‰€æœ‰åŒ…ï¼ˆéœ€åŒç³»ç»Ÿï¼‰</p></li>
<li><p><code>conda list --explicit &gt; spec-list.txt</code>, <code>conda create --name env-name2 --file spec-list.txt</code> ä¿å­˜å½“å‰ç¯å¢ƒCondaåŒ…ä¸‹è½½åœ°å€ï¼Œä»æ–‡ä»¶å®‰è£…CondaåŒ…ï¼ˆéœ€åŒç³»ç»Ÿï¼‰</p></li>
<li><p><code>conda list --export &gt; spec-list.txt</code>, <code>conda create --name env-name2 --file spec-list.txt</code> ä¿å­˜å½“å‰ç¯å¢ƒæ‰€æœ‰åŒ…ï¼ˆç±»ä¼¼<code>conda env export</code>ï¼‰ï¼Œä»æ–‡ä»¶å®‰è£…æ‰€æœ‰åŒ…ï¼ˆéœ€åŒç³»ç»Ÿï¼‰</p></li>
</ul>
</div>
<div id="tensorflowpytorch-gpu-version" class="section level3">
<h3><span class="header-section-number">1.5.3</span> Tensorflow/Pytorch GPU version</h3>
<p><code>Tensorflow</code>å¯ä»¥ç»¼åˆä½¿ç”¨CPUå’ŒGPUè¿›è¡Œè®¡ç®—ï¼ŒGPUçš„ç¡¬ä»¶ç»“æ„é€‚è¿›è¡Œå·ç§¯è¿ç®—ï¼Œæ‰€ä»¥é€‚äºCNNï¼ŒRNNç­‰æ¨¡å‹çš„æ±‚è§£ã€‚</p>
<p>ä½ å¯ä»¥ç”³è¯·ä½¿ç”¨<a href="https://cc.ruc.edu.cn/home">æ ¡çº§è®¡ç®—äº‘</a>æˆ–è€…ä½¿ç”¨å­¦é™¢è®¡ç®—äº‘ï¼Œå®ƒä»¬çš„æœåŠ¡å™¨éƒ½é…ç½®äº†GPUï¼Œå¹¶è£…å¥½äº†å¯ä»¥ä½¿ç”¨GPUçš„Tensorflowæˆ–è€…Pytorchã€‚ä½¿ç”¨<a href="https://cc.ruc.edu.cn/home">æ ¡çº§è®¡ç®—äº‘</a>æ—¶ï¼Œä½ é€šå¸¸åªéœ€è¦è¿è¡ŒJupyter Notebookå°±å¯ä»¥ä½¿ç”¨äº‘ç«¯GPUè¿›è¡Œè®¡ç®—ã€‚ä½¿ç”¨å­¦é™¢è®¡ç®—äº‘æ—¶ï¼Œä½ é€šå¸¸éœ€è¦çŸ¥é“ä¸€äº›å¸¸ç”¨çš„<a href="https://www.linuxcool.com/">Linuxå‘½ä»¤</a>ï¼Œä½ ä¹Ÿå¯ä»¥å®‰è£…<a href="https://ubuntu.com/">Ubuntu</a>æ¥ç†Ÿæ‚‰Linuxç³»ç»Ÿã€‚</p>
<p><a href="https://cc.ruc.edu.cn/home">æ ¡çº§è®¡ç®—äº‘</a>å’Œå­¦é™¢è®¡ç®—äº‘æœ‰ä¸“é—¨çš„ITäººå‘˜å¸®ä½ è§£å†³å¦‚æœ¬é¡µæ‰€ç¤ºçš„å¤§éƒ¨åˆ†ITé—®é¢˜ã€‚</p>
<p>ä½ çš„æœºå™¨å¦‚æœæœ‰GPUï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹æ­¥éª¤è®©GPUå‘æŒ¥å®ƒçš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ï¼Œå…³é”®ç‚¹æ˜¯è®©GPUå‹å·ã€GPUé©±åŠ¨ã€CUDAç‰ˆæœ¬ã€Tensorflowæˆ–Pytorchç‰ˆæœ¬å½¼æ­¤åŒ¹é…ï¼Œä¸”å½¼æ­¤â€œç›¸è¿â€ã€‚ç™¾åº¦æˆ–è€…å¿…åº”ä¸Šæœ‰å¾ˆå¤šç›¸å…³èµ„æ–™å¯ä»¥ä½œä¸ºå‚è€ƒã€‚</p>
<ol style="list-style-type: decimal">
<li><p>æŸ¥çœ‹ç”µè„‘GPUå’Œé©±åŠ¨ï¼Œä»¥åŠæ”¯æŒçš„<a href="https://developer.nvidia.com/cuda-gpus">CUDAç‰ˆæœ¬</a>ã€‚ æˆ–è€…åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼šnvidia-smiï¼ŒæŸ¥çœ‹ä½ çš„NVIDIAæ˜¾å¡é©±åŠ¨æ”¯æŒçš„CUDAç‰ˆæœ¬ã€‚</p></li>
<li><p>æŸ¥çœ‹å„ä¸ª<a href="https://tensorflow.google.cn/install/source?hl=zh-cn#linux">Tensorflowç‰ˆæœ¬</a>ï¼Œ<a href="https://pytorch.org/get-started/locally/">Pytorchç‰ˆæœ¬</a>å¯¹åº”çš„CUDAå’ŒcuDNN.</p></li>
<li><p>ä¸‹è½½å¹¶å®‰è£…æ­£ç¡®ç‰ˆæœ¬çš„<a href="https://developer.nvidia.com/cuda-toolkit-archivE">CUDA</a>ã€‚æ³¨å†Œã€ä¸‹è½½å¹¶å®‰è£…æ­£ç¡®ç‰ˆæœ¬çš„<a href="https://developer.nvidia.com/rdp/form/cudnn-download-survey">cuDNN</a></p></li>
<li><p>é…ç½®CUDAå’ŒcuDNN.</p></li>
<li><p>å®‰è£…<a href="https://tensorflow.google.cn/install">Tensorflow</a>æˆ–è€…<a href="https://pytorch.org/get-started/locally/">Pytorch</a>.</p></li>
</ol>
<!--chapter:end:01-env-set-up.Rmd-->
</div>
</div>
</div>
<div id="french" class="section level1">
<h1><span class="header-section-number">2</span> è½¦é™©ç´¢èµ”é¢‘ç‡é¢„æµ‹</h1>
<p>â€œè§å¤šè¯†å¹¿ã€éšæœºåº”å˜â€</p>
<div id="èƒŒæ™¯ä»‹ç»" class="section level2">
<h2><span class="header-section-number">2.1</span> èƒŒæ™¯ä»‹ç»</h2>
<p>è½¦é™©æ•°æ®é‡å¤§ï¼Œé£é™©ç‰¹å¾å¤šï¼Œå¯¹è½¦é™©æ•°æ®åˆ†ææ—¶å¯ä»¥ä½“ç°å‡ºæœºå™¨å­¦ä¹ ç®—æ³•çš„ä¼˜åŠ¿ï¼Œå³ä½¿ç”¨ç®—æ³•ä»å¤§æ•°æ®ä¸­æŒ–æ˜æœ‰ç”¨ä¿¡æ¯ã€æå–ç‰¹å¾ã€‚</p>
<p>åœ¨ç²¾ç®—ä¸­ï¼Œå¸¸å¸¸ä½¿ç”¨è½¦é™©ä¿å•æ•°æ®å’Œå†å²ç´¢èµ”æ•°æ®è¿›è¡Œé£é™©åˆ†æã€è½¦é™©å®šä»·ç­‰ã€‚ä¿å•æ•°æ®åº“æ˜¯åœ¨æ‰¿ä¿çš„æ—¶å€™å»ºç«‹çš„ï¼Œç´¢èµ”æ•°æ®åº“æ˜¯åœ¨ç´¢èµ”å‘ç”Ÿæ—¶å»ºç«‹çš„ï¼Œå¤§éƒ¨åˆ†ä¿å•æ²¡æœ‰å‘ç”Ÿç´¢èµ”ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šåœ¨ç´¢èµ”æ•°æ®åº“ä¸­ä½“ç°ã€‚</p>
<p>ä¿å•æ•°æ®åº“è®°å½•äº†è½¦é™©çš„é£é™©ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>é©¾é©¶å‘˜ç‰¹å¾ï¼šå¹´é¾„ã€æ€§åˆ«ã€å·¥ä½œã€å©šå§»ã€åœ°å€ç­‰</p></li>
<li><p>è½¦è¾†ç‰¹å¾ï¼šå“ç‰Œã€è½¦åº§æ•°ã€è½¦é¾„ã€ä»·æ ¼ã€é©¬åŠ›ç­‰</p></li>
<li><p>ä¿å•ä¿¡æ¯ï¼šä¿å•ç¼–å·ã€æ‰¿ä¿æ—¥æœŸã€åˆ°æœŸæ—¥æœŸ</p></li>
<li><p>å¥–æƒ©ç³»æ•°</p></li>
</ol>
<p>ç´¢èµ”æ•°æ®åº“è®°å½•äº†ä¿å•çš„ç´¢èµ”ä¿¡æ¯ï¼Œå¯ä»¥å¾—åˆ°ç´¢èµ”æ¬¡æ•°<span class="math inline">\(N\)</span>å’Œæ¯æ¬¡çš„ç´¢èµ”é‡‘é¢<span class="math inline">\(Y_l,l=1,\ldots,N\)</span>ã€‚ç†è®ºä¸Šï¼Œè½¦é™©çš„çº¯ä¿è´¹ä¸ºä»¥ä¸‹éšæœºå’Œçš„æœŸæœ›</p>
<p><span class="math display">\[S=\sum_{l=1}^N Y_l\]</span>
å‡è®¾ç´¢èµ”æ¬¡æ•°<span class="math inline">\(N\)</span>å’Œç´¢èµ”é‡‘é¢<span class="math inline">\(Y_l\)</span>ç‹¬ç«‹ä¸”<span class="math inline">\(Y_l\)</span>æœä»ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œåˆ™
<span class="math display">\[\mathbf{E}(S)=\mathbf{E}(N)\times\mathbf{E}(Y)\]</span></p>
<p>æ‰€ä»¥ï¼Œè½¦é™©å®šä»·é—®é¢˜å¾ˆå¤šæ—¶å€™éƒ½è½¬åŒ–ä¸ºä¸¤ä¸ªç‹¬ç«‹æ¨¡å‹ï¼šç´¢èµ”æ¬¡æ•°ï¼ˆé¢‘ç‡ï¼‰æ¨¡å‹å’Œç´¢èµ”é‡‘é¢ï¼ˆå¼ºåº¦ï¼‰æ¨¡å‹ã€‚å¯¹äºç´¢èµ”æ¬¡æ•°æ¨¡å‹ï¼Œé€šå¸¸å‡è®¾å› å˜é‡æœä»æ³Šæ¾åˆ†å¸ƒï¼Œå»ºç«‹æ³Šæ¾å›å½’æ¨¡å‹ï¼Œä½¿ç”¨çš„æ•°æ®é‡ç­‰äºä¿å•æ•°ï¼›å¯¹äºç´¢èµ”é‡‘é¢æ¨¡å‹ï¼Œé€šå¸¸å‡è®¾å› å˜é‡æœä»ä¼½é©¬åˆ†å¸ƒï¼Œå»ºç«‹ä¼½é©¬å›å½’æ¨¡å‹ï¼Œä½¿ç”¨çš„æ•°æ®é‡ç­‰äºå‘ç”Ÿç´¢èµ”çš„ä¿å•æ•°ã€‚é€šå¸¸ï¼Œåœ¨æ•°æ®é‡ä¸å¤§æ—¶ï¼Œç´¢èµ”é‡‘é¢æ¨¡å‹çš„å»ºç«‹éš¾äºç´¢èµ”æ¬¡æ•°æ¨¡å‹ï¼Œå› ä¸ºåªæœ‰å‘ç”Ÿç´¢èµ”çš„ä¿å•æ‰èƒ½ç”¨äºç´¢èµ”é‡‘é¢æ¨¡å‹çš„å»ºç«‹ã€‚</p>
<p>è®°ç¬¬<span class="math inline">\(i\)</span>ä¸ªä¿å•çš„é£é™©ä¿¡æ¯ä¸º<span class="math inline">\(x_i\in\mathcal{X}\)</span>ï¼Œä¿é™©å…¬å¸å®šä»·çš„ç›®æ ‡å°±æ˜¯æ‰¾åˆ°ä¸¤ä¸ªï¼ˆæœ€ä¼˜ï¼‰å›å½’æ–¹ç¨‹ï¼ˆæ˜ å°„ï¼‰ï¼Œä½¿ä¹‹å°½å¯èƒ½å‡†ç¡®åœ°é¢„æµ‹ç´¢èµ”é¢‘ç‡å’Œç´¢èµ”å¼ºåº¦:</p>
<p><span class="math display">\[\lambda: \mathcal{X}\rightarrow \mathbf{R}_+, ~~~ x \mapsto \lambda(x_i)\]</span>
<span class="math display">\[\mu: \mathcal{X}\rightarrow \mathbf{R}_+, ~~~ x \mapsto \mu(x_i)\]</span></p>
<p>è¿™é‡Œï¼Œ<span class="math inline">\(\lambda(x_i)\)</span>æ˜¯å¯¹<span class="math inline">\(N\)</span>çš„æœŸæœ›çš„ä¼°è®¡ï¼Œ<span class="math inline">\(\mu(x_i)\)</span>æ˜¯å¯¹<span class="math inline">\(Y\)</span>çš„æœŸæœ›çš„ä¼°è®¡ã€‚åŸºäºè¿™ä¸¤ä¸ªæ¨¡å‹ï¼Œçº¯ä¿è´¹ä¼°è®¡ä¸º<span class="math inline">\(\lambda(x_i)\mu(x_i)\)</span>ã€‚</p>
</div>
<div id="é¢„æµ‹æ¨¡å‹æ¦‚è¿°" class="section level2">
<h2><span class="header-section-number">2.2</span> é¢„æµ‹æ¨¡å‹æ¦‚è¿°</h2>
<p>å¦‚ä½•å¾—åˆ°ä¸€ä¸ªå¥½çš„é¢„æµ‹æ¨¡å‹å‘¢ï¼Ÿå¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢è€ƒè™‘ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>è®©é£é™©ä¿¡æ¯ç©ºé—´<span class="math inline">\(\mathcal{X}\)</span>ä¸°å¯Œï¼Œä¹Ÿç§°ä¸ºç‰¹å¾å·¥ç¨‹ï¼Œæ¯”å¦‚åŒ…å«<span class="math inline">\(x,x^2,\ln x\)</span>ã€æˆ–è€…åŠ å…¥è½¦è”ç½‘ä¿¡æ¯ã€‚</p></li>
<li><p>è®©æ˜ å°„ç©ºé—´<span class="math inline">\(\lambda\in{\Lambda},\mu\in M\)</span>ä¸°å¯Œï¼Œå¦‚GLMåªåŒ…å«çº¿æ€§æ•ˆåº”ã€ç›¸åŠ æ•ˆåº”ï¼Œæ˜ å°„ç©ºé—´è¾ƒå°ï¼Œç¥ç»ç½‘ç»œåŒ…å«éçº¿æ€§æ•ˆåº”ã€äº¤äº’ä½œç”¨ï¼Œæ˜ å°„ç©ºé—´è¾ƒå¤§ã€‚</p></li>
</ol>
<p>å½“ä½ é€‰å–äº†æ˜ å°„ç©ºé—´è¾ƒå°çš„GLMï¼Œé€šå¸¸éœ€è¦è¿›è¡Œä»”ç»†çš„ç‰¹å¾å·¥ç¨‹ï¼Œä½¿å¾—é£é™©ä¿¡æ¯ç©ºé—´é€‚äºGLMï¼›å½“ä½ é€‰å–äº†æ˜ å°„ç©ºé—´è¾ƒå¤§çš„ç¥ç»ç½‘ç»œï¼Œé€šå¸¸ä¸éœ€è¦è¿›è¡Œç‰¹åˆ«ä»”ç»†çš„ç‰¹å¾å·¥ç¨‹ï¼Œç¥ç»ç½‘ç»œå¯ä»¥è‡ªåŠ¨è¿›è¡Œç‰¹å¾å·¥ç¨‹ï¼Œå‘æ˜é£é™©ä¿¡æ¯ä¸­çš„æœ‰ç”¨ç‰¹å¾ã€‚</p>
<ul>
<li><p>å¯¹äºä¼ ç»Ÿçš„ç»Ÿè®¡å›å½’æ¨¡å‹ï¼ŒGLMï¼ŒGAMï¼ŒMARSï¼Œæˆ‘ä»¬ä½¿ç”¨æå¤§ä¼¼ç„¶æ–¹æ³•åœ¨æ˜ å°„ç©ºé—´ä¸­æ‰¾åˆ°æœ€ä¼˜çš„å›å½’æ–¹ç¨‹ï¼Œåœ¨æå¤§ä¼¼ç„¶ä¸­ä½¿ç”¨çš„æ•°æ®é›†ç§°ä¸ºå­¦ä¹ é›†ï¼ˆlearning data setï¼‰ã€‚ä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œåå˜é‡é€‰æ‹©ï¼Œå¯ä»¥åˆ æ‰ä¸æ˜¾è‘—çš„åå˜é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€æ­¥å›å½’ã€æœ€ä¼˜å­é›†ã€LASSOç­‰ï¼Œåˆ¤æ–­æ ‡å‡†ä¸ºAICç­‰ã€‚</p></li>
<li><p>å¯¹äºæ ‘æ¨¡å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ recursive partitioning by binary splits ç®—æ³•å¯¹é£é™©ç©ºé—´è¿›è¡Œåˆ’åˆ†ï¼Œä½¿å¾—å„å­ç©ºé—´å†…çš„åº”å˜é‡å·®å¼‚æœ€å°ï¼Œå·®å¼‚é€šå¸¸ä½¿ç”¨åå·®æŸå¤±ï¼ˆdeviance lossï¼‰åº¦é‡ã€‚ä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œé€šå¸¸ä½¿ç”¨äº¤å‰éªŒè¯å¯¹æ ‘çš„æ·±åº¦è¿›è¡Œæ§åˆ¶ã€‚æ ‘æ¨¡å‹è®­ç»ƒä½¿ç”¨çš„æ•°æ®ä¸ºå­¦ä¹ é›†ã€‚</p></li>
<li><p>æ ‘æ¨¡å‹çš„æ‰©å±•ä¸ºbootstrap aggregationï¼ˆbaggingï¼‰å’Œrandom forestã€‚ç¬¬ä¸€ç§ç®—æ³•æ˜¯å¯¹æ¯ä¸ªbootstrapæ ·æœ¬å»ºç«‹æ ‘æ¨¡å‹ï¼Œç„¶åå¹³å‡æ¯ä¸ªæ ‘æ¨¡å‹çš„é¢„æµ‹ï¼›ç¬¬äºŒç§ç®—æ³•ç±»ä¼¼ç¬¬ä¸€ç§ï¼Œä½†åœ¨å»ºç«‹æ ‘æ¨¡å‹æ—¶ï¼Œè¦æ±‚åªåœ¨æŸäº›éšæœºé€‰å®šçš„åå˜é‡ä¸Šåˆ†æ”¯ã€‚è¿™ä¸¤ç§æ‰©å±•éƒ½å±äºé›†æˆå­¦ä¹ ï¼ˆensemble learningï¼‰ã€‚</p></li>
<li><p>æå‡ç®—æ³•æœ‰å¤šç§ä¸åŒå½¢å¼ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³ç±»ä¼¼é€æ­¥å›å½’ï¼ŒåŒºåˆ«æ˜¯æ¯æ­¥å›å½’ä¸­éœ€è¦ä¾æ®ä¸Šæ­¥çš„é¢„æµ‹ç»“æœè°ƒæ•´å„ä¸ªæ ·æœ¬çš„æƒé‡ï¼Œè®©ä¸Šæ­¥é¢„æµ‹ç»“æœå·®çš„æ ·æœ¬åœ¨ä¸‹æ­¥å›å½’ä¸­å çš„æƒé‡è¾ƒå¤§ã€‚é€šå¸¸ï¼Œæ¯æ­¥å›å½’ä½¿ç”¨çš„æ¨¡å‹æ¯”è¾ƒç®€å•ï¼Œå¦‚æ·±åº¦ä¸º3çš„æ ‘æ¨¡å‹ã€‚æå‡ç®—æ³•ä¹Ÿå±äºé›†æˆå­¦ä¹ ï¼Œå’Œå‰é¢ä¸åŒæ˜¯å®ƒçš„å¼±å­¦ä¹ å™¨ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œbaggingå’Œrandom forestçš„å¼±å­¦ä¹ å™¨æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ã€‚</p></li>
<li><p>å¯¹äºé›†æˆç®—æ³•ï¼Œé€šå¸¸éœ€è¦è°ƒæ•´å¼±å­¦ä¹ å™¨çš„ç»“æ„å‚æ•°ï¼Œå¦‚æ ‘çš„æ·±åº¦ï¼Œä¹Ÿè¦åˆ¤æ–­å¼±å­¦ä¹ å™¨çš„ä¸ªæ•°ï¼Œè¿™äº›ç§°ä¸ºtuning parametersï¼Œé€šå¸¸é€šè¿‡æ¯”è¾ƒåœ¨éªŒè¯é›†ï¼ˆvalidationï¼‰çš„æŸå¤±è¿›è¡Œè°ƒå‚ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚å¼±å­¦ä¹ å™¨ä¸­çš„å‚æ•°é€šè¿‡åœ¨è®­ç»ƒé›†ï¼ˆtrainingï¼‰ä¸Šè®­ç»ƒæ¨¡å‹å¾—åˆ°ã€‚è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„å¹¶é›†ä¸ºå­¦ä¹ é›†ã€‚</p></li>
<li><p>å‰é¦ˆç¥ç»ç½‘ç»œçš„è¾“å…¥ç¥ç»å…ƒä¸ºé£é™©ä¿¡æ¯ï¼Œä¸‹ä¸€å±‚ç¥ç»å…ƒä¸ºä¸Šä¸€å±‚ç¥ç»å…ƒçš„çº¿æ€§ç»„åˆå¹¶é€šè¿‡æ¿€æ´»å‡½æ•°çš„éçº¿æ€§å˜æ¢ï¼Œæœ€åè¾“å‡ºç¥ç»å…ƒä¸ºç¥ç»ç½‘ç»œå¯¹å› å˜é‡æœŸæœ›çš„é¢„æµ‹ï¼Œé€šè¿‡å‡å°è¾“å‡ºç¥ç»å…ƒä¸å› å˜é‡è§‚å¯Ÿå€¼çš„å·®å¼‚ï¼Œè®­ç»ƒç¥ç»ç½‘ç»œä¸­çš„å‚æ•°ã€‚ç¥ç»ç½‘ç»œå«æœ‰éå¸¸å¤šçš„å‚æ•°ï¼Œå¾ˆéš¾æ‰¾åˆ°å…¨å±€æœ€ä¼˜è§£ï¼Œè€Œä¸”æœ€ä¼˜è§£å¿…ç„¶é€ æˆè¿‡æ‹Ÿåˆï¼Œæ‰€ä»¥ä¸€èˆ¬é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•å¯¹å‚æ•°è¿›è¡Œè¿­ä»£ï¼Œä½¿å¾—è®­ç»ƒé›†æŸå¤±åœ¨æ¯æ¬¡è¿­ä»£ä¸­éƒ½æœ‰ä¸‹é™è¶‹åŠ¿ã€‚é€šè¿‡æ¯”è¾ƒéªŒè¯é›†æŸå¤±ç¡®å®šè¿­ä»£æ¬¡æ•°å’Œç¥ç»ç½‘ç»œçš„ç»“æ„å‚æ•°ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</p></li>
</ul>
<p>å¦‚ä½•è¯„ä»·ä¸€ä¸ªé¢„æµ‹æ¨¡å‹çš„å¥½åå‘¢ï¼Ÿé€šå¸¸ç”¨æ ·æœ¬å¤–æŸå¤±ï¼ˆtest errorï¼‰è¯„ä»·ã€‚å¯¹äºç´¢èµ”é¢‘ç‡ï¼Œä½¿ç”¨æ³Šæ¾åå·®æŸå¤±ï¼Œå¯¹äºç´¢èµ”å¼ºåº¦ï¼Œä½¿ç”¨ä¼½é©¬åå·®æŸå¤±ï¼Œå¯ä»¥è¯æ˜è¿™ä¸¤ä¸ªæŸå¤±å‡½æ•°å’Œä¼¼ç„¶å‡½æ•°æˆè´Ÿç›¸å…³ã€‚å…¶ä¸­ï¼Œå¹³å‡æ³Šæ¾åå·®æŸå¤±ä¸ºï¼š</p>
<p><span class="math display">\[\mathcal{L}(\mathbf{N},\mathbf{\hat{N}})=\frac{2}{|\mathbf{N}|}\sum_{i}N_i\left[\frac{\hat{N}_i}{N_i}-1-\ln\left(\frac{\hat{N}_i}{N_i}\right)\right]\]</span></p>
<p>Kerasä¸­å®šä¹‰çš„æŸå¤±å‡½æ•°ä¸º</p>
<p><span class="math display">\[\tilde{\mathcal{L}}(\mathbf{N},\mathbf{\hat{N}})=\frac{1}{|\mathbf{N}|}\sum_{i}\left[\hat{N}_i-N_i\ln\left(\hat{N}_i\right)\right]\]</span></p>
</div>
<div id="ç‰¹å¾å·¥ç¨‹" class="section level2">
<h2><span class="header-section-number">2.3</span> ç‰¹å¾å·¥ç¨‹</h2>
<p>åŠ è½½åŒ…ã€‚</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">rm</span>(<span class="dt">list=</span><span class="kw">ls</span>())</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">library</span>(CASdatasets) <span class="co"># data</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co"># library(keras)  # neural network</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw">library</span>(data.table) <span class="co"># fread,fwrite</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">library</span>(glmnet) <span class="co"># lasso </span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">library</span>(plyr) <span class="co"># ddply</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="kw">library</span>(mgcv) <span class="co"># gam</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">library</span>(rpart) <span class="co"># tree</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co"># library(rpart.plot)</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="kw">library</span>(Hmisc) <span class="co"># error bar</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co"># devtools::install_github(&#39;henckr/distRforest&#39;)</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co"># library(distRforest) </span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="kw">library</span>(gbm) <span class="co"># boosting</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="kw">data</span>(freMTPL2freq)</span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="co">#data(freMTPL2sev)</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co"># textwidth&lt;-7.3 #inch</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co"># fwrite(freMTPL2freq,&quot;data/freMTPL2freq.txt&quot;)</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="co"># freMTPL2freq&lt;-fread(&quot;data/freMTPL2freq_mac.txt&quot;)</span></span></code></pre></div>
<pre><code>&#39;data.frame&#39;:   678013 obs. of  12 variables:
 $ IDpol     : num  1 3 5 10 11 13 15 17 18 21 ...
 $ ClaimNb   : &#39;table&#39; num [1:678013(1d)] 1 1 1 1 1 1 1 1 1 1 ...
 $ Exposure  : num  0.1 0.77 0.75 0.09 0.84 0.52 0.45 0.27 0.71 0.15 ...
 $ VehPower  : int  5 5 6 7 7 6 6 7 7 7 ...
 $ VehAge    : int  0 0 2 0 0 2 2 0 0 0 ...
 $ DrivAge   : int  55 55 52 46 46 38 38 33 33 41 ...
 $ BonusMalus: int  50 50 50 50 50 50 50 68 68 50 ...
 $ VehBrand  : Factor w/ 11 levels &quot;B1&quot;,&quot;B10&quot;,&quot;B11&quot;,..: 4 4 4 4 4 4 4 4 4 4 ...
 $ VehGas    : chr  &quot;Regular&quot; &quot;Regular&quot; &quot;Diesel&quot; &quot;Diesel&quot; ...
 $ Area      : Factor w/ 6 levels &quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,..: 4 4 2 2 2 5 5 3 3 2 ...
 $ Density   : int  1217 1217 54 76 76 3003 3003 137 137 60 ...
 $ Region    : Factor w/ 21 levels &quot;Alsace&quot;,&quot;Aquitaine&quot;,..: 21 21 18 2 2 16 16 13 13 17 ...</code></pre>
<div id="æˆªæ–­" class="section level3">
<h3><span class="header-section-number">2.3.1</span> æˆªæ–­</h3>
<ul>
<li><p>å‡å°‘outliers/influential points çš„å½±å“</p></li>
<li><p>éœ€æ ¹æ®æ¯ä¸ªå˜é‡çš„åˆ†å¸ƒç¡®å®šåœ¨å“ªé‡Œæˆªæ–­</p>
<ul>
<li><p>ç´¢èµ”æ¬¡æ•°åœ¨4æˆªæ–­</p></li>
<li><p>é£é™©æš´éœ²åœ¨1æˆªæ–­</p></li>
<li><p>é©¬åŠ›åœ¨9æˆªæ–­</p></li>
<li><p>è½¦é¾„åœ¨20æˆªæ–­</p></li>
<li><p>å¹´é¾„åœ¨90æˆªæ–­</p></li>
<li><p>å¥–æƒ©ç³»æ•°åœ¨150æˆªæ–­</p></li>
</ul></li>
</ul>
</div>
<div id="ç¦»æ•£åŒ–" class="section level3">
<h3><span class="header-section-number">2.3.2</span> ç¦»æ•£åŒ–</h3>
<ul>
<li><p>ç›®çš„æ˜¯ä¸ºäº†åˆ»ç”»éçº¿æ€§æ•ˆåº”</p></li>
<li><p>éœ€ç”»å‡ºåå˜é‡çš„è¾¹ç¼˜ç»éªŒç´¢èµ”é¢‘ç‡åˆ¤æ–­</p></li>
<li><p>ç¦»æ•£åŒ–é©¬åŠ›ã€è½¦é¾„ã€å¹´é¾„ <code>VehPowerFac, VehAgeFacï¼ŒDrivAgeFac</code></p></li>
</ul>
</div>
<div id="è®¾å®šåŸºç¡€æ°´å¹³" class="section level3">
<h3><span class="header-section-number">2.3.3</span> è®¾å®šåŸºç¡€æ°´å¹³</h3>
<ul>
<li><p>æ–¹ä¾¿å‡è®¾æ£€éªŒ</p></li>
<li><p>è®¾å®šå«æœ‰æœ€å¤šé£é™©æš´éœ²çš„æ°´å¹³ä¸ºåŸºå‡†æ°´å¹³</p></li>
</ul>
</div>
<div id="åå˜é‡å˜å½¢" class="section level3">
<h3><span class="header-section-number">2.3.4</span> åå˜é‡å˜å½¢</h3>
<ul>
<li><p>ç›®çš„æ˜¯ä¸ºäº†åˆ»ç”»éçº¿æ€§æ•ˆåº”</p></li>
<li><p>è€ƒè™‘åå˜é‡åˆ†å¸ƒï¼Œä½¿ä¹‹å˜å½¢åè¿‘ä¼¼æœä»å¯¹ç§°åˆ†å¸ƒ</p></li>
<li><p><code>DriveAgeLn/2/3/4, DensityLn</code></p></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>dat1 &lt;-<span class="st"> </span>freMTPL2freq</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># claim number</span></span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a>dat1<span class="op">$</span>ClaimNb &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>ClaimNb, <span class="dv">4</span>)   </span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co"># exposure</span></span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a>dat1<span class="op">$</span>Exposure &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>Exposure, <span class="dv">1</span>) </span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co"># vehicle power</span></span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a>dat1<span class="op">$</span>VehPowerFac &lt;-<span class="st"> </span><span class="kw">as.factor</span>(<span class="kw">pmin</span>(dat1<span class="op">$</span>VehPower,<span class="dv">9</span>))</span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>VehPowerFac),sum)</span>
<span id="cb10-15"><a href="#cb10-15"></a>dat1[,<span class="st">&quot;VehPowerFac&quot;</span>] &lt;-<span class="kw">relevel</span>(dat1[,<span class="st">&quot;VehPowerFac&quot;</span>], <span class="dt">ref=</span><span class="st">&quot;6&quot;</span>)</span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="co"># vehicle age</span></span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a>dat1<span class="op">$</span>VehAge &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>VehAge,<span class="dv">20</span>)</span>
<span id="cb10-20"><a href="#cb10-20"></a>VehAgeFac &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">110</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">2</span>,<span class="dv">5</span>), <span class="kw">rep</span>(<span class="dv">3</span>,<span class="dv">5</span>),<span class="kw">rep</span>(<span class="dv">4</span>,<span class="dv">5</span>), </span>
<span id="cb10-21"><a href="#cb10-21"></a>                               <span class="kw">rep</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">rep</span>(<span class="dv">6</span>,<span class="dv">111-21</span>)))</span>
<span id="cb10-22"><a href="#cb10-22"></a>dat1<span class="op">$</span>VehAgeFac &lt;-<span class="st"> </span><span class="kw">as.factor</span>(VehAgeFac[dat1<span class="op">$</span>VehAge<span class="op">+</span><span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>VehAgeFac),sum)</span>
<span id="cb10-24"><a href="#cb10-24"></a>dat1[,<span class="st">&quot;VehAgeFac&quot;</span>] &lt;-<span class="kw">relevel</span>(dat1[,<span class="st">&quot;VehAgeFac&quot;</span>], <span class="dt">ref=</span><span class="st">&quot;2&quot;</span>)</span>
<span id="cb10-25"><a href="#cb10-25"></a></span>
<span id="cb10-26"><a href="#cb10-26"></a><span class="co"># driver age</span></span>
<span id="cb10-27"><a href="#cb10-27"></a></span>
<span id="cb10-28"><a href="#cb10-28"></a>dat1<span class="op">$</span>DrivAge &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>DrivAge,<span class="dv">90</span>)</span>
<span id="cb10-29"><a href="#cb10-29"></a>DrivAgeFac &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">18</span><span class="op">:</span><span class="dv">100</span>), <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">21-18</span>), <span class="kw">rep</span>(<span class="dv">2</span>,<span class="dv">26-21</span>), <span class="kw">rep</span>(<span class="dv">3</span>,<span class="dv">31-26</span>), </span>
<span id="cb10-30"><a href="#cb10-30"></a>                  <span class="kw">rep</span>(<span class="dv">4</span>,<span class="dv">41-31</span>), <span class="kw">rep</span>(<span class="dv">5</span>,<span class="dv">51-41</span>), <span class="kw">rep</span>(<span class="dv">6</span>,<span class="dv">71-51</span>), <span class="kw">rep</span>(<span class="dv">7</span>,<span class="dv">101-71</span>)))</span>
<span id="cb10-31"><a href="#cb10-31"></a>dat1<span class="op">$</span>DrivAgeFac &lt;-<span class="st"> </span><span class="kw">as.factor</span>(DrivAgeFac[dat1<span class="op">$</span>DrivAge<span class="dv">-17</span>,<span class="dv">2</span>])</span>
<span id="cb10-32"><a href="#cb10-32"></a><span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>DrivAgeFac),sum)</span>
<span id="cb10-33"><a href="#cb10-33"></a>dat1[,<span class="st">&quot;DrivAgeFac&quot;</span>] &lt;-<span class="kw">relevel</span>(dat1[,<span class="st">&quot;DrivAgeFac&quot;</span>], <span class="dt">ref=</span><span class="st">&quot;6&quot;</span>)</span>
<span id="cb10-34"><a href="#cb10-34"></a>dat1<span class="op">$</span>DrivAgeLn&lt;-<span class="kw">log</span>(dat1<span class="op">$</span>DrivAge)</span>
<span id="cb10-35"><a href="#cb10-35"></a>dat1<span class="op">$</span>DrivAge2&lt;-dat1<span class="op">$</span>DrivAge<span class="op">^</span><span class="dv">2</span></span>
<span id="cb10-36"><a href="#cb10-36"></a>dat1<span class="op">$</span>DrivAge3&lt;-dat1<span class="op">$</span>DrivAge<span class="op">^</span><span class="dv">3</span></span>
<span id="cb10-37"><a href="#cb10-37"></a>dat1<span class="op">$</span>DrivAge4&lt;-dat1<span class="op">$</span>DrivAge<span class="op">^</span><span class="dv">4</span></span>
<span id="cb10-38"><a href="#cb10-38"></a></span>
<span id="cb10-39"><a href="#cb10-39"></a><span class="co"># bm</span></span>
<span id="cb10-40"><a href="#cb10-40"></a></span>
<span id="cb10-41"><a href="#cb10-41"></a>dat1<span class="op">$</span>BonusMalus &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">pmin</span>(dat1<span class="op">$</span>BonusMalus, <span class="dv">150</span>))</span>
<span id="cb10-42"><a href="#cb10-42"></a></span>
<span id="cb10-43"><a href="#cb10-43"></a><span class="co"># vehicle brand</span></span>
<span id="cb10-44"><a href="#cb10-44"></a></span>
<span id="cb10-45"><a href="#cb10-45"></a>dat1<span class="op">$</span>VehBrand &lt;-<span class="st"> </span><span class="kw">factor</span>(dat1<span class="op">$</span>VehBrand)      <span class="co"># consider VehGas as categorical</span></span>
<span id="cb10-46"><a href="#cb10-46"></a><span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>VehBrand),sum)</span>
<span id="cb10-47"><a href="#cb10-47"></a>dat1[,<span class="st">&quot;VehBrand&quot;</span>] &lt;-<span class="kw">relevel</span>(dat1[,<span class="st">&quot;VehBrand&quot;</span>], <span class="dt">ref=</span><span class="st">&quot;B1&quot;</span>)</span>
<span id="cb10-48"><a href="#cb10-48"></a></span>
<span id="cb10-49"><a href="#cb10-49"></a><span class="co"># vehicle gas</span></span>
<span id="cb10-50"><a href="#cb10-50"></a></span>
<span id="cb10-51"><a href="#cb10-51"></a>dat1<span class="op">$</span>VehGas &lt;-<span class="st"> </span><span class="kw">factor</span>(dat1<span class="op">$</span>VehGas)      <span class="co"># consider VehGas as categorical</span></span>
<span id="cb10-52"><a href="#cb10-52"></a><span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>VehGas),sum)</span>
<span id="cb10-53"><a href="#cb10-53"></a>dat1[,<span class="st">&quot;VehGas&quot;</span>] &lt;-<span class="kw">relevel</span>(dat1[,<span class="st">&quot;VehGas&quot;</span>], <span class="dt">ref=</span><span class="st">&quot;Regular&quot;</span>)</span>
<span id="cb10-54"><a href="#cb10-54"></a></span>
<span id="cb10-55"><a href="#cb10-55"></a><span class="co"># area (related to density)</span></span>
<span id="cb10-56"><a href="#cb10-56"></a></span>
<span id="cb10-57"><a href="#cb10-57"></a>dat1<span class="op">$</span>Area &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>Area)</span>
<span id="cb10-58"><a href="#cb10-58"></a></span>
<span id="cb10-59"><a href="#cb10-59"></a><span class="co"># density</span></span>
<span id="cb10-60"><a href="#cb10-60"></a></span>
<span id="cb10-61"><a href="#cb10-61"></a>dat1<span class="op">$</span>DensityLn &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">log</span>(dat1<span class="op">$</span>Density))</span>
<span id="cb10-62"><a href="#cb10-62"></a></span>
<span id="cb10-63"><a href="#cb10-63"></a><span class="co"># region</span></span>
<span id="cb10-64"><a href="#cb10-64"></a></span>
<span id="cb10-65"><a href="#cb10-65"></a><span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>Region),sum)[<span class="kw">order</span>(</span>
<span id="cb10-66"><a href="#cb10-66"></a>  <span class="kw">aggregate</span>(dat1<span class="op">$</span>Exposure,<span class="dt">by=</span><span class="kw">list</span>(dat1<span class="op">$</span>Region),sum)<span class="op">$</span>x),]</span>
<span id="cb10-67"><a href="#cb10-67"></a>dat1[,<span class="st">&quot;Region&quot;</span>] &lt;-<span class="kw">relevel</span>(dat1[,<span class="st">&quot;Region&quot;</span>], <span class="dt">ref=</span><span class="st">&quot;Centre&quot;</span>)</span>
<span id="cb10-68"><a href="#cb10-68"></a><span class="kw">str</span>(dat1)</span>
<span id="cb10-69"><a href="#cb10-69"></a></span>
<span id="cb10-70"><a href="#cb10-70"></a><span class="co"># model matrix for GLM</span></span>
<span id="cb10-71"><a href="#cb10-71"></a></span>
<span id="cb10-72"><a href="#cb10-72"></a>design_matrix&lt;-</span>
<span id="cb10-73"><a href="#cb10-73"></a><span class="st">  </span><span class="kw">model.matrix</span>( <span class="op">~</span><span class="st"> </span>ClaimNb <span class="op">+</span><span class="st"> </span>Exposure <span class="op">+</span><span class="st"> </span>VehPowerFac <span class="op">+</span><span class="st"> </span>VehAgeFac <span class="op">+</span><span class="st"> </span></span>
<span id="cb10-74"><a href="#cb10-74"></a><span class="st">                  </span>DrivAge <span class="op">+</span><span class="st"> </span>DrivAgeLn <span class="op">+</span><span class="st"> </span>DrivAge2 <span class="op">+</span><span class="st"> </span>DrivAge3 <span class="op">+</span><span class="st"> </span>DrivAge4 <span class="op">+</span><span class="st"> </span></span>
<span id="cb10-75"><a href="#cb10-75"></a><span class="st">                  </span>BonusMalus <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">+</span><span class="st"> </span>VehGas <span class="op">+</span><span class="st"> </span>Area <span class="op">+</span><span class="st"> </span>DensityLn <span class="op">+</span><span class="st"> </span>Region, <span class="dt">data=</span>dat1)[,<span class="op">-</span><span class="dv">1</span>] </span>
<span id="cb10-76"><a href="#cb10-76"></a><span class="co"># VehPower, VehAge as factor variables</span></span>
<span id="cb10-77"><a href="#cb10-77"></a><span class="co"># design_matrix2&lt;-</span></span>
<span id="cb10-78"><a href="#cb10-78"></a><span class="co"># model.matrix( ~ ClaimNb + Exposure + VehPower + VehAge + DrivAge + </span></span>
<span id="cb10-79"><a href="#cb10-79"></a><span class="co">#                BonusMalus + VehBrand + VehGas + Area + DensityLn + Region, data=dat1)[,-1] </span></span>
<span id="cb10-80"><a href="#cb10-80"></a><span class="co"># VehPower, VehAge, and DrivAge as continuous variables</span></span>
<span id="cb10-81"><a href="#cb10-81"></a><span class="co"># dim(design_matrix2)</span></span></code></pre></div>
</div>
</div>
<div id="è®­ç»ƒé›†-éªŒè¯é›†-æµ‹è¯•é›†" class="section level2">
<h2><span class="header-section-number">2.4</span> è®­ç»ƒé›†-éªŒè¯é›†-æµ‹è¯•é›†</h2>
<ul>
<li><p>æ¯”ä¾‹ä¸º<span class="math inline">\(0.6:0.2:0.2\)</span></p></li>
<li><p>æ ¹æ®ç´¢èµ”æ¬¡æ•°åˆ†å±‚æŠ½æ ·</p></li>
<li><p>ç»éªŒç´¢èµ”é¢‘ç‡çº¦ä¸º<span class="math inline">\(10\%\)</span></p></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>seed_split&lt;-<span class="dv">11</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># claim 0/1 proportions</span></span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>index_zero&lt;-<span class="kw">which</span>(dat1<span class="op">$</span>ClaimNb<span class="op">==</span><span class="dv">0</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a>index_one&lt;-<span class="kw">which</span>(dat1<span class="op">$</span>ClaimNb<span class="op">&gt;</span><span class="dv">0</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a>prop_zero&lt;-<span class="kw">round</span>(<span class="kw">length</span>(index_zero)<span class="op">/</span>(<span class="kw">length</span>(index_one)<span class="op">+</span><span class="kw">length</span>(index_zero)),<span class="dv">2</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a>prop_zero</span>
<span id="cb11-9"><a href="#cb11-9"></a>prop_one&lt;-<span class="kw">round</span>(<span class="kw">length</span>(index_one)<span class="op">/</span>(<span class="kw">length</span>(index_one)<span class="op">+</span><span class="kw">length</span>(index_zero)),<span class="dv">2</span>)</span>
<span id="cb11-10"><a href="#cb11-10"></a>prop_one</span>
<span id="cb11-11"><a href="#cb11-11"></a></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co"># 0.6:0.2:0.2</span></span>
<span id="cb11-13"><a href="#cb11-13"></a></span>
<span id="cb11-14"><a href="#cb11-14"></a>size_valid&lt;-<span class="kw">round</span>(<span class="kw">nrow</span>(dat1)<span class="op">*</span><span class="fl">0.2</span>,<span class="dv">0</span>)</span>
<span id="cb11-15"><a href="#cb11-15"></a>size_test&lt;-size_valid</span>
<span id="cb11-16"><a href="#cb11-16"></a>size_train&lt;-<span class="kw">nrow</span>(dat1)<span class="op">-</span><span class="dv">2</span><span class="op">*</span>size_valid</span>
<span id="cb11-17"><a href="#cb11-17"></a></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co"># stratified sampling</span></span>
<span id="cb11-19"><a href="#cb11-19"></a></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="kw">set.seed</span>(seed_split)</span>
<span id="cb11-21"><a href="#cb11-21"></a>index_train_<span class="dv">0</span>&lt;-<span class="kw">sample</span>(index_zero,size_train<span class="op">*</span>prop_zero)</span>
<span id="cb11-22"><a href="#cb11-22"></a>index_train_<span class="dv">1</span>&lt;-<span class="kw">sample</span>(index_one, size_train<span class="op">-</span><span class="kw">length</span>(index_train_<span class="dv">0</span>))</span>
<span id="cb11-23"><a href="#cb11-23"></a>index_train&lt;-<span class="kw">union</span>(index_train_<span class="dv">0</span>,index_train_<span class="dv">1</span>)</span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="kw">length</span>(index_train);size_train</span>
<span id="cb11-25"><a href="#cb11-25"></a>index_valid&lt;-<span class="kw">c</span>(<span class="kw">sample</span>(<span class="kw">setdiff</span>(index_zero,index_train_<span class="dv">0</span>),<span class="kw">round</span>(size_valid<span class="op">*</span>prop_zero,<span class="dv">0</span>)),</span>
<span id="cb11-26"><a href="#cb11-26"></a>               <span class="kw">sample</span>(<span class="kw">setdiff</span>(index_one,index_train_<span class="dv">1</span>),size_valid<span class="op">-</span><span class="kw">round</span>(size_valid<span class="op">*</span>prop_zero,<span class="dv">0</span>)))</span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="kw">length</span>(index_valid);size_valid</span>
<span id="cb11-28"><a href="#cb11-28"></a>index_test&lt;-<span class="kw">setdiff</span>(<span class="kw">union</span>(index_zero,index_one),<span class="kw">union</span>(index_train,index_valid))</span>
<span id="cb11-29"><a href="#cb11-29"></a>index_learn&lt;-<span class="kw">union</span>(index_train,index_valid)</span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="kw">length</span>(index_train);<span class="kw">length</span>(index_valid);<span class="kw">length</span>(index_test)</span>
<span id="cb11-31"><a href="#cb11-31"></a></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="co"># train-validation-test; learn-test</span></span>
<span id="cb11-33"><a href="#cb11-33"></a></span>
<span id="cb11-34"><a href="#cb11-34"></a>dat1_train&lt;-dat1[index_train,]</span>
<span id="cb11-35"><a href="#cb11-35"></a>dat1_valid&lt;-dat1[index_valid,]</span>
<span id="cb11-36"><a href="#cb11-36"></a>dat1_test&lt;-dat1[index_test,]</span>
<span id="cb11-37"><a href="#cb11-37"></a>dat1_learn&lt;-dat1[index_learn,]</span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="kw">sum</span>(dat1_train<span class="op">$</span>ClaimNb)<span class="op">/</span><span class="kw">sum</span>(dat1_train<span class="op">$</span>Exposure)</span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="kw">sum</span>(dat1_valid<span class="op">$</span>ClaimNb)<span class="op">/</span><span class="kw">sum</span>(dat1_valid<span class="op">$</span>Exposure)</span>
<span id="cb11-40"><a href="#cb11-40"></a><span class="kw">sum</span>(dat1_test<span class="op">$</span>ClaimNb)<span class="op">/</span><span class="kw">sum</span>(dat1_test<span class="op">$</span>Exposure)</span>
<span id="cb11-41"><a href="#cb11-41"></a><span class="kw">sum</span>(dat1_learn<span class="op">$</span>ClaimNb)<span class="op">/</span><span class="kw">sum</span>(dat1_learn<span class="op">$</span>Exposure)</span>
<span id="cb11-42"><a href="#cb11-42"></a></span>
<span id="cb11-43"><a href="#cb11-43"></a><span class="co"># glm matrix</span></span>
<span id="cb11-44"><a href="#cb11-44"></a></span>
<span id="cb11-45"><a href="#cb11-45"></a>matrix_train&lt;-design_matrix[index_train,]</span>
<span id="cb11-46"><a href="#cb11-46"></a>matrix_valid&lt;-design_matrix[index_valid,]</span>
<span id="cb11-47"><a href="#cb11-47"></a>matrix_test&lt;-design_matrix[index_test,]</span>
<span id="cb11-48"><a href="#cb11-48"></a>matrix_learn&lt;-design_matrix[index_learn,]</span>
<span id="cb11-49"><a href="#cb11-49"></a></span>
<span id="cb11-50"><a href="#cb11-50"></a><span class="co"># gbm matrix (learn)</span></span>
<span id="cb11-51"><a href="#cb11-51"></a></span>
<span id="cb11-52"><a href="#cb11-52"></a>dat1_learn_gbm&lt;-dat1_learn[,<span class="kw">c</span>(<span class="st">&quot;ClaimNb&quot;</span>, <span class="st">&quot;Exposure&quot;</span>,</span>
<span id="cb11-53"><a href="#cb11-53"></a>                              <span class="st">&quot;VehPower&quot;</span>, <span class="st">&quot;VehAge&quot;</span>, <span class="st">&quot;DrivAge&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>,</span>
<span id="cb11-54"><a href="#cb11-54"></a>                              <span class="st">&quot;VehBrand&quot;</span>, <span class="st">&quot;VehGas&quot;</span>, <span class="st">&quot;Area&quot;</span>, <span class="st">&quot;DensityLn&quot;</span>, <span class="st">&quot;Region&quot;</span>)]</span>
<span id="cb11-55"><a href="#cb11-55"></a><span class="kw">class</span>(dat1_learn_gbm)</span>
<span id="cb11-56"><a href="#cb11-56"></a>train_pro&lt;-size_train<span class="op">/</span>(size_train<span class="op">+</span>size_valid)</span></code></pre></div>
</div>
<div id="æ³Šæ¾åå·®æŸå¤±å‡½æ•°" class="section level2">
<h2><span class="header-section-number">2.5</span> æ³Šæ¾åå·®æŸå¤±å‡½æ•°</h2>
<ul>
<li>å¹³å‡æ³Šæ¾åå·®æŸå¤±</li>
</ul>
<p><span class="math display">\[\mathcal{L}(\mathbf{N},\mathbf{\hat{N}})=\frac{2}{|\mathbf{N}|}\sum_{i}N_i\left[\frac{\hat{N}_i}{N_i}-1-\ln\left(\frac{\hat{N}_i}{N_i}\right)\right]\]</span></p>
<ul>
<li>Keraså®šä¹‰å¹³å‡æ³Šæ¾åå·®æŸå¤±ä¸º</li>
</ul>
<p><span class="math display">\[\tilde{\mathcal{L}}(\mathbf{N},\mathbf{\hat{N}})=\frac{1}{|\mathbf{N}|}\sum_{i}\left[\hat{N}_i-N_i\ln\left(\hat{N}_i\right)\right]\]</span></p>
<ul>
<li>å› ä¸ºå¯¹äºå¤§éƒ¨åˆ†ä¿å•ï¼Œ<span class="math inline">\(N_i-N_i\ln N_i\approx0\)</span>ï¼Œæ‰€ä»¥æ³Šæ¾åå·®æŸå¤±å‡½æ•°çº¦ä¸ºKeraså®šä¹‰çš„2å€ï¼ˆè‡³å°‘åœ¨ä¸€ä¸ªé‡çº§ï¼‰ã€‚</li>
</ul>
<p><span class="math display">\[\mathcal{L}(\mathbf{N},\mathbf{\hat{N}})\approx2\tilde{\mathcal{L}}(\mathbf{N},\mathbf{\hat{N}})\]</span></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>Poisson.Deviance &lt;-<span class="st"> </span><span class="cf">function</span>(pred,obs)</span>
<span id="cb12-2"><a href="#cb12-2"></a>  {<span class="dv">200</span><span class="op">*</span>(<span class="kw">sum</span>(pred)<span class="op">-</span><span class="kw">sum</span>(obs)<span class="op">+</span><span class="kw">sum</span>(<span class="kw">log</span>((obs<span class="op">/</span>pred)<span class="op">^</span>(obs))))<span class="op">/</span><span class="kw">length</span>(pred)}</span>
<span id="cb12-3"><a href="#cb12-3"></a>keras_poisson_dev&lt;-<span class="cf">function</span>(y_hat,y_true)</span>
<span id="cb12-4"><a href="#cb12-4"></a>  {<span class="dv">100</span><span class="op">*</span><span class="kw">sum</span>(y_hat<span class="op">-</span>y_true<span class="op">*</span><span class="kw">log</span>(y_hat))<span class="op">/</span><span class="kw">length</span>(y_true)}</span>
<span id="cb12-5"><a href="#cb12-5"></a>f_keras&lt;-<span class="cf">function</span>(x) <span class="dv">100</span><span class="op">*</span>(x<span class="op">-</span>x<span class="op">*</span><span class="kw">log</span>(x))</span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="kw">f_keras</span>(<span class="fl">0.1</span>);<span class="kw">f_keras</span>(<span class="fl">0.2</span>)</span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="co"># png(&quot;./plots/1/poi_dev.png&quot;)</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="kw">plot</span>(<span class="kw">seq</span>(<span class="fl">0.05</span>,<span class="fl">0.15</span>,<span class="fl">0.01</span>),<span class="kw">f_keras</span>(<span class="kw">seq</span>(<span class="fl">0.05</span>,<span class="fl">0.15</span>,<span class="fl">0.01</span>)),<span class="dt">type=</span><span class="st">&quot;l&quot;</span>,</span>
<span id="cb12-9"><a href="#cb12-9"></a>      <span class="dt">xlab=</span><span class="st">&quot;frequency&quot;</span>,<span class="dt">ylab=</span><span class="st">&quot;approximated Poisson deviance&quot;</span>,<span class="dt">main=</span><span class="st">&quot;100(freq - freq * ln freq)&quot;</span>)</span>
<span id="cb12-10"><a href="#cb12-10"></a> <span class="kw">abline</span>(<span class="dt">v=</span><span class="fl">0.1</span>,<span class="dt">lty=</span><span class="dv">2</span>);<span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">f_keras</span>((<span class="fl">0.1</span>)),<span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co"># dev.off()</span></span></code></pre></div>
<p><img src="./plots/1/poi_dev.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="æ³Šæ¾å›å½’æ¨¡å‹" class="section level2">
<h2><span class="header-section-number">2.6</span> æ³Šæ¾å›å½’æ¨¡å‹</h2>
<ul>
<li><p>ä½¿ç”¨æå¤§ä¼¼ç„¶æ–¹æ³•åœ¨æ˜ å°„ç©ºé—´ä¸­æ‰¾åˆ°æœ€ä¼˜çš„å›å½’æ–¹ç¨‹</p></li>
<li><p>åœ¨æå¤§ä¼¼ç„¶ä¸­ä½¿ç”¨çš„æ•°æ®é›†ç§°ä¸ºå­¦ä¹ é›†ï¼ˆlearning data setï¼‰ã€‚</p></li>
<li><p>ä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œåå˜é‡é€‰æ‹©ï¼Œå¯ä»¥åˆ æ‰ä¸æ˜¾è‘—çš„åå˜é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€æ­¥å›å½’ã€æœ€ä¼˜å­é›†ã€LASSOç­‰ï¼Œåˆ¤æ–­æ ‡å‡†ä¸ºAICç­‰ã€‚</p></li>
<li><p>åŒè´¨æ¨¡å‹ <span class="math display">\[\mathbf{E}(N)=\beta_0\]</span></p></li>
<li><p>å…¨æ¨¡å‹</p>
<p><span class="math display">\[\ln \mathbf{E}(N)=\ln e + \beta_0 + \beta_{\text{VehPowerFac}} + \beta_{\text{VehAgeFac}} \\ + \beta_1\text{DrivAge} + \beta_2\ln\text{DrivAge} + \beta_3\text{DrivAge}^2 + \beta_4\text{DrivAge}^3 + \beta_5\text{DrivAge}^4 \\ \beta_6\text{BM} + \beta_{\text{VehBrand}} + \beta_{\text{VehGas}} + \beta_7\text{Area} + \beta_8\text{DensityLn} + \beta_{\text{Region}}\]</span></p></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># homogeneous model</span></span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>d.glm0 &lt;-<span class="st"> </span><span class="kw">glm</span>(ClaimNb <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(<span class="kw">log</span> (Exposure)), </span>
<span id="cb13-4"><a href="#cb13-4"></a>              <span class="dt">data=</span><span class="kw">data.frame</span>(matrix_learn), <span class="dt">family=</span><span class="kw">poisson</span>())</span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#summary(d.glm0)</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>dat1_test<span class="op">$</span>fitGLM0 &lt;-<span class="st"> </span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">  </span><span class="kw">predict</span>(d.glm0, <span class="dt">newdata=</span><span class="kw">data.frame</span>(matrix_test), <span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitGLM0,matrix_test[,<span class="dv">1</span>])</span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitGLM0,matrix_test[,<span class="dv">1</span>])</span>
<span id="cb13-10"><a href="#cb13-10"></a></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="co"># full GLM</span></span>
<span id="cb13-12"><a href="#cb13-12"></a></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="kw">names</span>(<span class="kw">data.frame</span>(matrix_learn))</span>
<span id="cb13-14"><a href="#cb13-14"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb13-15"><a href="#cb13-15"></a>d.glm1 &lt;-<span class="st"> </span><span class="kw">glm</span>(ClaimNb <span class="op">~</span><span class="st"> </span>.<span class="op">-</span>Exposure <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(<span class="kw">log</span>(Exposure)), </span>
<span id="cb13-16"><a href="#cb13-16"></a>              <span class="dt">data=</span><span class="kw">data.frame</span>(matrix_learn), <span class="dt">family=</span><span class="kw">poisson</span>())</span>
<span id="cb13-17"><a href="#cb13-17"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb13-18"><a href="#cb13-18"></a><span class="co"># summary(d.glm1)</span></span>
<span id="cb13-19"><a href="#cb13-19"></a>dat1_train<span class="op">$</span>fitGLM1 &lt;-<span class="st"> </span></span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="st">  </span><span class="kw">predict</span>(d.glm1, <span class="dt">newdata=</span><span class="kw">data.frame</span>(matrix_train), <span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb13-21"><a href="#cb13-21"></a>dat1_valid<span class="op">$</span>fitGLM1 &lt;-<span class="st"> </span></span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="st">  </span><span class="kw">predict</span>(d.glm1, <span class="dt">newdata=</span><span class="kw">data.frame</span>(matrix_valid), <span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb13-23"><a href="#cb13-23"></a>dat1_test<span class="op">$</span>fitGLM1 &lt;-<span class="st"> </span></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="st">  </span><span class="kw">predict</span>(d.glm1, <span class="dt">newdata=</span><span class="kw">data.frame</span>(matrix_test), <span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb13-25"><a href="#cb13-25"></a>dat1_learn<span class="op">$</span>fitGLM1 &lt;-<span class="st"> </span></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="st">  </span><span class="kw">predict</span>(d.glm1, <span class="dt">newdata=</span><span class="kw">data.frame</span>(matrix_learn), <span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitGLM1,matrix_test[,<span class="dv">1</span>])</span>
<span id="cb13-28"><a href="#cb13-28"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitGLM1,matrix_test[,<span class="dv">1</span>])</span></code></pre></div>
<p><strong>Step wiseã€LASSOåå˜é‡é€‰æ‹©</strong></p>
<ul>
<li><p>é€æ­¥å›å½’éå¸¸æ…¢ï¼Œåœ¨Linux 8æ ¸i7 3.4GHz 16Gå†…å­˜éƒ½éœ€è¦50å¤šåˆ†é’Ÿã€‚ä¸”æ ·æœ¬å¤–æŸå¤±å’Œå…¨æ¨¡å‹æ²¡æœ‰æ˜æ˜¾å‡å°ã€‚</p></li>
<li><p>5æŠ˜CV Lassoåœ¨Linux 8æ ¸i7 3.4GHz 16Gå†…å­˜éœ€è¦5åˆ†é’Ÿã€‚</p></li>
<li><p>æ ¹æ®5æŠ˜CV-erroré€‰å–Lassoæ­£åˆ™å‚æ•°<code>beta=4*10^-5</code>ã€‚</p></li>
<li><p>ä¸¤ç§æ–¹æ³•çš„æ ·æœ¬å¤–æŸå¤±å’Œå…¨æ¨¡å‹æ²¡æœ‰æ˜æ˜¾å‡å°ï¼Œè¯´æ˜æ²¡æœ‰å‘ç”Ÿæ˜æ˜¾è¿‡æ‹Ÿåˆã€‚ä¹Ÿè¯´æ˜éœ€è¦ä»éçº¿æ€§æ•ˆåº”å’Œäº¤äº’é¡¹å‡ºå‘æå‡æ¨¡å‹ã€‚</p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># step wise selectionï¼› this takes a long time (more than 50 minutes!)</span></span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co"># d.glm00 &lt;- glm(ClaimNb ~ VehAgeFac1 + VehAgeFac3 + VehAgeFac4 + VehAgeFac5 + </span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">#                  DrivAge + DrivAge2 + DrivAge3 + DrivAge4 + DrivAgeLn + </span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="co">#                  BonusMalus + VehBrandB12 + VehGasDiesel + DensityLn + </span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co">#                  offset(log (Exposure)), </span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co">#                data=data.frame(matrix_learn), family=poisson())</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co"># {t1 &lt;- proc.time()</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co"># d.glm2&lt;-step(d.glm00,direction=&quot;forward&quot;,trace = 1,</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#              scope =list(lower=formula(d.glm00), upper=formula(d.glm1)))</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co"># (proc.time()-t1)}</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>d.glm2&lt;-<span class="kw">glm</span>(ClaimNb <span class="op">~</span><span class="st"> </span>VehAgeFac1 <span class="op">+</span><span class="st"> </span>VehAgeFac3 <span class="op">+</span><span class="st"> </span>VehAgeFac4 <span class="op">+</span><span class="st"> </span>VehAgeFac5 <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="st">    </span>DrivAge <span class="op">+</span><span class="st"> </span>DrivAge2 <span class="op">+</span><span class="st"> </span>DrivAge3 <span class="op">+</span><span class="st"> </span>DrivAge4 <span class="op">+</span><span class="st"> </span>DrivAgeLn <span class="op">+</span><span class="st"> </span>BonusMalus <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="st">    </span>VehBrandB12 <span class="op">+</span><span class="st"> </span>VehGasDiesel <span class="op">+</span><span class="st"> </span>DensityLn <span class="op">+</span><span class="st"> </span>VehPowerFac4 <span class="op">+</span><span class="st"> </span>VehPowerFac8 <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="st">    </span>RegionNord.Pas.de.Calais <span class="op">+</span><span class="st"> </span>VehPowerFac7 <span class="op">+</span><span class="st"> </span>RegionRhone.Alpes <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="st">    </span>RegionBretagne <span class="op">+</span><span class="st"> </span>RegionAuvergne <span class="op">+</span><span class="st"> </span>RegionLimousin <span class="op">+</span><span class="st"> </span>RegionLanguedoc.Roussillon <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="st">    </span>RegionIle.de.France <span class="op">+</span><span class="st"> </span>RegionAquitaine <span class="op">+</span><span class="st"> </span>RegionMidi.Pyrenees <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="st">    </span>RegionPays.de.la.Loire <span class="op">+</span><span class="st"> </span>RegionProvence.Alpes.Cotes.D.Azur <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="st">    </span>RegionPoitou.Charentes <span class="op">+</span><span class="st"> </span>RegionHaute.Normandie <span class="op">+</span><span class="st"> </span>VehBrandB5 <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="st">    </span>VehBrandB11 <span class="op">+</span><span class="st"> </span>RegionBasse.Normandie <span class="op">+</span><span class="st"> </span>VehBrandB14 <span class="op">+</span><span class="st"> </span>RegionCorse <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-21"><a href="#cb14-21"></a><span class="st">    </span><span class="kw">offset</span>(<span class="kw">log</span>(Exposure)), <span class="dt">data=</span><span class="kw">data.frame</span>(matrix_learn), <span class="dt">family=</span><span class="kw">poisson</span>())</span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="kw">summary</span>(d.glm2)</span>
<span id="cb14-23"><a href="#cb14-23"></a>dat1_test<span class="op">$</span>fitGLM2 &lt;-<span class="st"> </span><span class="kw">predict</span>(d.glm2, <span class="dt">newdata=</span><span class="kw">data.frame</span>(matrix_test), <span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitGLM2,<span class="kw">data.frame</span>(matrix_test)<span class="op">$</span>ClaimNb)</span>
<span id="cb14-25"><a href="#cb14-25"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitGLM2,matrix_test[,<span class="dv">1</span>])</span>
<span id="cb14-26"><a href="#cb14-26"></a></span>
<span id="cb14-27"><a href="#cb14-27"></a><span class="co"># lasso regressionï¼› this takes a few minutes</span></span>
<span id="cb14-28"><a href="#cb14-28"></a></span>
<span id="cb14-29"><a href="#cb14-29"></a>alpha0=<span class="dv">1</span> <span class="co"># 1 for lasso, 0 for ridge.</span></span>
<span id="cb14-30"><a href="#cb14-30"></a><span class="kw">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="co"># {t1 &lt;- proc.time()</span></span>
<span id="cb14-32"><a href="#cb14-32"></a><span class="co"># cvfit = cv.glmnet(matrix_learn[,-c(1,2)], matrix_learn[,1], </span></span>
<span id="cb14-33"><a href="#cb14-33"></a><span class="co">#                   family = &quot;poisson&quot;,offset=log(matrix_learn[,2]),</span></span>
<span id="cb14-34"><a href="#cb14-34"></a><span class="co">#                   alpha = alpha0,nfolds = 5,trace.it = 1)</span></span>
<span id="cb14-35"><a href="#cb14-35"></a><span class="co"># (proc.time()-t1)}</span></span>
<span id="cb14-36"><a href="#cb14-36"></a><span class="co"># cvfit$lambda.min #4*10^-5</span></span>
<span id="cb14-37"><a href="#cb14-37"></a><span class="co"># cvfit$lambda.1se # 0.0016</span></span>
<span id="cb14-38"><a href="#cb14-38"></a><span class="co"># plot(cvfit)</span></span>
<span id="cb14-39"><a href="#cb14-39"></a>d.glm3 =<span class="st"> </span><span class="kw">glmnet</span>(matrix_learn[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)], matrix_learn[,<span class="dv">1</span>], </span>
<span id="cb14-40"><a href="#cb14-40"></a>                <span class="dt">family =</span> <span class="st">&quot;poisson&quot;</span>, <span class="dt">offset=</span><span class="kw">log</span>(matrix_learn[,<span class="dv">2</span>]), </span>
<span id="cb14-41"><a href="#cb14-41"></a>                <span class="dt">alpha=</span>alpha0, <span class="dt">lambda=</span><span class="fl">4.024746e-05</span>, <span class="dt">trace.it =</span> <span class="dv">1</span>)</span>
<span id="cb14-42"><a href="#cb14-42"></a></span>
<span id="cb14-43"><a href="#cb14-43"></a>dat1_test<span class="op">$</span>fitLasso&lt;-<span class="kw">predict</span>(d.glm3, <span class="dt">newx =</span> matrix_test[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)],</span>
<span id="cb14-44"><a href="#cb14-44"></a>                            <span class="dt">newoffset=</span><span class="kw">log</span>(matrix_test[,<span class="dv">2</span>]),<span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb14-45"><a href="#cb14-45"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitLasso, matrix_test[,<span class="dv">1</span>])</span>
<span id="cb14-46"><a href="#cb14-46"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitLasso, matrix_test[,<span class="dv">1</span>])</span></code></pre></div>
</div>
<div id="æ³Šæ¾å¯åŠ æ¨¡å‹" class="section level2">
<h2><span class="header-section-number">2.7</span> æ³Šæ¾å¯åŠ æ¨¡å‹</h2>
<ul>
<li><p>GAMè¾¹ç¼˜æå‡æ¨¡å‹</p></li>
<li><p>æ ·æœ¬å¤–æŸå¤±å‡å°‘ï¼Œè¯´æ˜éçº¿æ€§æ•ˆåº”å­˜åœ¨ã€‚</p></li>
</ul>
<p><span class="math display">\[\ln \mathbf{E}(N)=\ln\hat{\lambda}^{\text{GLM}}+s_1(\text{VehAge})+s_2(\text{BM})\]</span></p>
<ul>
<li><p><span class="math inline">\(s_1,s_2\)</span>ä¸ºæ ·æ¡å¹³æ»‘å‡½æ•°ã€‚</p></li>
<li><p>ä½¿ç”¨<code>ddply</code>èšåˆæ•°æ®ï¼Œæ‰¾åˆ°å……åˆ†ç»Ÿè®¡é‡ï¼ŒåŠ å¿«æ¨¡å‹æ‹Ÿåˆé€Ÿåº¦ã€‚</p></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co">#  GAM marginals improvement (VehAge and BonusMalus)</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb15-4"><a href="#cb15-4"></a>dat.GAM &lt;-<span class="st"> </span><span class="kw">ddply</span>(dat1_learn, .(VehAge, BonusMalus), summarise, </span>
<span id="cb15-5"><a href="#cb15-5"></a>                 <span class="dt">fitGLM1=</span><span class="kw">sum</span>(fitGLM1), <span class="dt">ClaimNb=</span><span class="kw">sum</span>(ClaimNb))</span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a>d.gam &lt;-<span class="st"> </span><span class="kw">gam</span>(ClaimNb <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(VehAge, <span class="dt">bs=</span><span class="st">&quot;cr&quot;</span>)<span class="op">+</span><span class="kw">s</span>(BonusMalus, <span class="dt">bs=</span><span class="st">&quot;cr&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="st">               </span><span class="kw">offset</span>(<span class="kw">log</span>(fitGLM1)), <span class="dt">data=</span>dat.GAM, <span class="dt">method=</span><span class="st">&quot;GCV.Cp&quot;</span>, <span class="dt">family=</span>poisson)</span>
<span id="cb15-9"><a href="#cb15-9"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="kw">summary</span>(d.gam)</span>
<span id="cb15-11"><a href="#cb15-11"></a>dat1_train<span class="op">$</span>fitGAM1 &lt;-<span class="st"> </span><span class="kw">predict</span>(d.gam, <span class="dt">newdata=</span>dat1_train,<span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb15-12"><a href="#cb15-12"></a>dat1_valid<span class="op">$</span>fitGAM1 &lt;-<span class="st"> </span><span class="kw">predict</span>(d.gam, <span class="dt">newdata=</span>dat1_valid,<span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb15-13"><a href="#cb15-13"></a>dat1_test<span class="op">$</span>fitGAM1 &lt;-<span class="st"> </span><span class="kw">predict</span>(d.gam, <span class="dt">newdata=</span>dat1_test,<span class="dt">type=</span><span class="st">&quot;response&quot;</span>)</span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitGAM1, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitGAM1,matrix_test[,<span class="dv">1</span>])</span></code></pre></div>
</div>
<div id="æ³Šæ¾å›å½’æ ‘" class="section level2">
<h2><span class="header-section-number">2.8</span> æ³Šæ¾å›å½’æ ‘</h2>
<ul>
<li><p>ä½¿ç”¨ recursive partitioning by binary splits ç®—æ³•å¯¹é£é™©ç©ºé—´è¿›è¡Œåˆ’åˆ†ï¼Œä½¿å¾—å„å­ç©ºé—´å†…çš„åº”å˜é‡å·®å¼‚æœ€å°ã€‚</p></li>
<li><p>ä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œä½¿ç”¨äº¤å‰éªŒè¯ç¡®å®šcost-complexity parameterã€‚</p></li>
<li><p><code>cp=10^-3.421</code>(1-SD rule)å‰ªææˆ<code>split=22</code>çš„æ ‘ï¼Œæˆ–è€…<code>cp=10^-3.949</code>(min CV rule)å‰ªææˆ<code>split=55</code>çš„æ ‘ã€‚</p></li>
<li><p><code>split=55</code>(min CV rule)æ ‘çš„æ ·æœ¬å¤–æŸå¤±è¾ƒå°ã€‚</p></li>
<li><p>Variable importance (min CV rule)</p>
<pre><code>BonusMalus     VehAge   VehBrand    DrivAge     VehGas   VehPower     Region  DensityLn 
 4675.0231  4396.8667  1389.2909   877.9473   795.6308   715.3584   480.3459   140.5463</code></pre></li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># cross validation using xval in rpart.control</span></span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="kw">names</span>(dat1_learn)</span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb17-5"><a href="#cb17-5"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb17-6"><a href="#cb17-6"></a>tree0&lt;-<span class="kw">rpart</span>(<span class="kw">cbind</span>(Exposure, ClaimNb) <span class="op">~</span><span class="st"> </span>VehPower <span class="op">+</span><span class="st"> </span>VehAge <span class="op">+</span><span class="st"> </span>DrivAge <span class="op">+</span><span class="st"> </span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="st">               </span>BonusMalus <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">+</span><span class="st"> </span>VehGas <span class="op">+</span><span class="st"> </span>Area <span class="op">+</span><span class="st"> </span>DensityLn <span class="op">+</span><span class="st"> </span>Region, </span>
<span id="cb17-8"><a href="#cb17-8"></a>             <span class="dt">data =</span> dat1_learn, <span class="dt">method =</span> <span class="st">&quot;poisson&quot;</span>, </span>
<span id="cb17-9"><a href="#cb17-9"></a>             <span class="dt">control =</span> <span class="kw">rpart.control</span> (<span class="dt">xval=</span><span class="dv">5</span>, <span class="dt">minbucket=</span><span class="dv">1000</span>, <span class="dt">cp=</span><span class="dv">10</span><span class="op">^-</span><span class="dv">5</span>,</span>
<span id="cb17-10"><a href="#cb17-10"></a>                                      <span class="dt">maxcompete =</span> <span class="dv">0</span>, <span class="dt">maxsurrogate =</span> <span class="dv">0</span>))</span>
<span id="cb17-11"><a href="#cb17-11"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb17-12"><a href="#cb17-12"></a>x0 &lt;-<span class="st"> </span><span class="kw">log10</span>(tree0<span class="op">$</span>cptable[,<span class="dv">1</span>])</span>
<span id="cb17-13"><a href="#cb17-13"></a>err0&lt;-tree0<span class="op">$</span>cptable[,<span class="dv">4</span>]</span>
<span id="cb17-14"><a href="#cb17-14"></a>std0&lt;-tree0<span class="op">$</span>cptable[,<span class="dv">5</span>]</span>
<span id="cb17-15"><a href="#cb17-15"></a>xmain &lt;-<span class="st"> &quot;cross-validation error plot&quot;</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>xlabel &lt;-<span class="st"> &quot;cost-complexity parameter (log-scale)&quot;</span></span>
<span id="cb17-17"><a href="#cb17-17"></a>ylabel &lt;-<span class="st"> &quot;relative CV error&quot;</span></span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a>(cp_min&lt;-x0[<span class="kw">which.min</span>(err0)])</span>
<span id="cb17-20"><a href="#cb17-20"></a>(cp_1sd&lt;-x0[<span class="kw">min</span>(<span class="kw">which</span>(err0<span class="op">&lt;</span><span class="kw">min</span>(err0)<span class="op">+</span>std0[<span class="kw">which.min</span>(err0)]))])</span>
<span id="cb17-21"><a href="#cb17-21"></a>(nsplit_min&lt;-tree0<span class="op">$</span>cptable[<span class="kw">which.min</span>(err0),<span class="dv">2</span>])</span>
<span id="cb17-22"><a href="#cb17-22"></a>(nsplit_1sd&lt;-tree0<span class="op">$</span>cptable[<span class="kw">min</span>(<span class="kw">which</span>(err0<span class="op">&lt;</span><span class="kw">min</span>(err0)<span class="op">+</span>std0[<span class="kw">which.min</span>(err0)])),<span class="dv">2</span>])</span>
<span id="cb17-23"><a href="#cb17-23"></a></span>
<span id="cb17-24"><a href="#cb17-24"></a><span class="co"># png(&quot;./plots/1/tree_cv.png&quot;)</span></span>
<span id="cb17-25"><a href="#cb17-25"></a><span class="kw">errbar</span>(<span class="dt">x=</span>x0, <span class="dt">y=</span>err0<span class="op">*</span><span class="dv">100</span>, <span class="dt">yplus=</span>(err0<span class="op">+</span>std0)<span class="op">*</span><span class="dv">100</span>, <span class="dt">yminus=</span>(err0<span class="op">-</span>std0)<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb17-26"><a href="#cb17-26"></a>      <span class="dt">xlim=</span><span class="kw">rev</span>(<span class="kw">range</span>(x0)), <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">main=</span>xmain, <span class="dt">ylab=</span>ylabel, <span class="dt">xlab=</span>xlabel)</span>
<span id="cb17-27"><a href="#cb17-27"></a><span class="kw">lines</span>(<span class="dt">x=</span>x0, <span class="dt">y=</span>err0<span class="op">*</span><span class="dv">100</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>)</span>
<span id="cb17-28"><a href="#cb17-28"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">c</span>(<span class="kw">min</span>(err0<span class="op">+</span>std0)<span class="op">*</span><span class="dv">100</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>)</span>
<span id="cb17-29"><a href="#cb17-29"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">c</span>(<span class="kw">min</span>(err0)<span class="op">*</span><span class="dv">100</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;magenta&quot;</span>)</span>
<span id="cb17-30"><a href="#cb17-30"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="kw">c</span>(cp_1sd,cp_min),<span class="dt">lty=</span><span class="dv">2</span>,<span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;orange&quot;</span>,<span class="st">&quot;magenta&quot;</span>))</span>
<span id="cb17-31"><a href="#cb17-31"></a><span class="kw">legend</span>(<span class="dt">x=</span><span class="st">&quot;topright&quot;</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;magenta&quot;</span>,<span class="st">&quot;orange&quot;</span>,<span class="st">&quot;magenta&quot;</span>),</span>
<span id="cb17-32"><a href="#cb17-32"></a>      <span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">19</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb17-33"><a href="#cb17-33"></a>      <span class="kw">c</span>(<span class="st">&quot;tree0&quot;</span>, <span class="st">&quot;1-SD rule&quot;</span>, <span class="st">&quot;min.CV rule&quot;</span>,</span>
<span id="cb17-34"><a href="#cb17-34"></a>        <span class="kw">paste</span>(<span class="st">&quot;log cp = &quot;</span>,<span class="kw">round</span>(cp_1sd,<span class="dv">3</span>)),<span class="kw">paste</span>(<span class="st">&quot;log cp = &quot;</span>, <span class="kw">round</span>(cp_min,<span class="dv">3</span>))))</span>
<span id="cb17-35"><a href="#cb17-35"></a><span class="co"># dev.off()</span></span>
<span id="cb17-36"><a href="#cb17-36"></a>tree1 &lt;-<span class="st"> </span><span class="kw">prune</span>(tree0, <span class="dt">cp=</span><span class="dv">10</span><span class="op">^</span><span class="kw">mean</span>(cp_min,<span class="kw">min</span>(x0[x0<span class="op">&gt;</span>cp_min]))) </span>
<span id="cb17-37"><a href="#cb17-37"></a>tree11&lt;-<span class="st"> </span><span class="kw">prune</span>(tree0, <span class="dt">cp=</span><span class="dv">10</span><span class="op">^</span><span class="kw">mean</span>(cp_1sd,<span class="kw">min</span>(x0[x0<span class="op">&gt;</span>cp_1sd]))) </span>
<span id="cb17-38"><a href="#cb17-38"></a>tree1<span class="op">$</span>cptable[<span class="kw">nrow</span>(tree1<span class="op">$</span>cptable),<span class="dv">2</span>];nsplit_min</span>
<span id="cb17-39"><a href="#cb17-39"></a>tree11<span class="op">$</span>cptable[<span class="kw">nrow</span>(tree11<span class="op">$</span>cptable),<span class="dv">2</span>];nsplit_1sd</span>
<span id="cb17-40"><a href="#cb17-40"></a></span>
<span id="cb17-41"><a href="#cb17-41"></a>dat1_test<span class="op">$</span>fitRT_min &lt;-<span class="st"> </span><span class="kw">predict</span>(tree1, <span class="dt">newdata=</span>dat1_test)<span class="op">*</span>dat1_test<span class="op">$</span>Exposure</span>
<span id="cb17-42"><a href="#cb17-42"></a>dat1_test<span class="op">$</span>fitRT_sd &lt;-<span class="st"> </span><span class="kw">predict</span>(tree11, <span class="dt">newdata=</span>dat1_test)<span class="op">*</span>dat1_test<span class="op">$</span>Exposure</span>
<span id="cb17-43"><a href="#cb17-43"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitRT_min, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb17-44"><a href="#cb17-44"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitRT_sd, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb17-45"><a href="#cb17-45"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitRT_min, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb17-46"><a href="#cb17-46"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitRT_sd, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb17-47"><a href="#cb17-47"></a></span>
<span id="cb17-48"><a href="#cb17-48"></a>tree1<span class="op">$</span>variable.importance</span>
<span id="cb17-49"><a href="#cb17-49"></a>tree11<span class="op">$</span>variable.importance</span></code></pre></div>
<p><img src="./plots/1/tree_cv.png" width="60%"  style="display: block; margin: auto;" /></p>
<ul>
<li><p>äº¤å‰éªŒè¯å¯ä½¿ç”¨<code>rpart(..., control=rpart.control(xval= ,...))</code>æˆ–è€…<code>xpred.rpart(tree, group)</code>ã€‚</p></li>
<li><p>ä»¥ä¸Šä¸¤ç§æ–¹å¼å¾—åˆ°å¾ˆç›¸è¿‘çš„<code>min CV rule</code>å‰ªææ ‘55 vs 51ï¼Œä½†<code>1-SD rule</code>ç›¸å·®è¾ƒå¤š22 vs 12ã€‚</p></li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># K-fold cross-validation using xpred.rpart</span></span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb18-5"><a href="#cb18-5"></a>tree00&lt;-<span class="kw">rpart</span>(<span class="kw">cbind</span>(Exposure, ClaimNb) <span class="op">~</span><span class="st"> </span>VehPower <span class="op">+</span><span class="st"> </span>VehAge <span class="op">+</span><span class="st"> </span>DrivAge <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="st">                </span>BonusMalus <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">+</span><span class="st"> </span>VehGas <span class="op">+</span><span class="st"> </span>Area <span class="op">+</span><span class="st"> </span>DensityLn <span class="op">+</span><span class="st"> </span>Region, </span>
<span id="cb18-7"><a href="#cb18-7"></a>              <span class="dt">data =</span> dat1_learn, <span class="dt">method =</span> <span class="st">&quot;poisson&quot;</span>, </span>
<span id="cb18-8"><a href="#cb18-8"></a>              <span class="dt">control =</span> <span class="kw">rpart.control</span> (<span class="dt">xval=</span><span class="dv">1</span>, <span class="dt">minbucket=</span><span class="dv">1000</span> ,<span class="dt">cp=</span><span class="dv">10</span><span class="op">^-</span><span class="dv">5</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>                                       <span class="dt">maxcompete =</span> <span class="dv">0</span>, <span class="dt">maxsurrogate =</span> <span class="dv">0</span>))</span>
<span id="cb18-10"><a href="#cb18-10"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb18-11"><a href="#cb18-11"></a></span>
<span id="cb18-12"><a href="#cb18-12"></a>(n_subtrees &lt;-<span class="st"> </span><span class="kw">dim</span>(tree00<span class="op">$</span>cptable)[<span class="dv">1</span>])</span>
<span id="cb18-13"><a href="#cb18-13"></a>std1&lt;-<span class="st"> </span><span class="kw">numeric</span>(n_subtrees)</span>
<span id="cb18-14"><a href="#cb18-14"></a>err1 &lt;-<span class="st"> </span><span class="kw">numeric</span>(n_subtrees)</span>
<span id="cb18-15"><a href="#cb18-15"></a></span>
<span id="cb18-16"><a href="#cb18-16"></a>K &lt;-<span class="st"> </span><span class="dv">5</span>                  </span>
<span id="cb18-17"><a href="#cb18-17"></a>xgroup &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>K, <span class="dt">length =</span> <span class="kw">nrow</span>(dat1_learn))</span>
<span id="cb18-18"><a href="#cb18-18"></a>xfit &lt;-<span class="st"> </span><span class="kw">xpred.rpart</span>(tree00, xgroup)</span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="kw">dim</span>(xfit);<span class="kw">dim</span>(dat1_learn)</span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_subtrees){</span>
<span id="cb18-21"><a href="#cb18-21"></a> err_group&lt;-<span class="kw">rep</span>(<span class="ot">NA</span>,K)</span>
<span id="cb18-22"><a href="#cb18-22"></a> <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>K){</span>
<span id="cb18-23"><a href="#cb18-23"></a>  ind_group &lt;-<span class="st"> </span><span class="kw">which</span>(xgroup <span class="op">==</span>k)  </span>
<span id="cb18-24"><a href="#cb18-24"></a>  err_group[k] &lt;-<span class="st"> </span><span class="kw">keras_poisson_dev</span>(dat1_learn[ind_group,<span class="st">&quot;Exposure&quot;</span>]<span class="op">*</span>xfit[ind_group,i],</span>
<span id="cb18-25"><a href="#cb18-25"></a>                                    dat1_learn[ind_group,<span class="st">&quot;ClaimNb&quot;</span>])</span>
<span id="cb18-26"><a href="#cb18-26"></a>  }</span>
<span id="cb18-27"><a href="#cb18-27"></a>  err1[i] &lt;-<span class="st"> </span><span class="kw">mean</span>(err_group)             </span>
<span id="cb18-28"><a href="#cb18-28"></a>  std1[i] &lt;-<span class="st"> </span><span class="kw">sd</span>(err_group)</span>
<span id="cb18-29"><a href="#cb18-29"></a>}</span>
<span id="cb18-30"><a href="#cb18-30"></a></span>
<span id="cb18-31"><a href="#cb18-31"></a>x1 &lt;-<span class="st"> </span><span class="kw">log10</span>(tree00<span class="op">$</span>cptable[,<span class="dv">1</span>])</span>
<span id="cb18-32"><a href="#cb18-32"></a>(cp_min1&lt;-x1[<span class="kw">which.min</span>(err1)])</span>
<span id="cb18-33"><a href="#cb18-33"></a>(cp_1sd1&lt;-x1[<span class="kw">min</span>(<span class="kw">which</span>(err1<span class="op">&lt;</span><span class="kw">min</span>(err1)<span class="op">+</span>std1[<span class="kw">which.min</span>(err1)]))])</span>
<span id="cb18-34"><a href="#cb18-34"></a>(nsplit_min1&lt;-tree00<span class="op">$</span>cptable[<span class="kw">which.min</span>(err1),<span class="dv">2</span>])</span>
<span id="cb18-35"><a href="#cb18-35"></a>(nsplit_1sd1&lt;-tree00<span class="op">$</span>cptable[<span class="kw">min</span>(<span class="kw">which</span>(err1<span class="op">&lt;</span><span class="kw">min</span>(err1)<span class="op">+</span>std1[<span class="kw">which.min</span>(err1)])),<span class="dv">2</span>])</span>
<span id="cb18-36"><a href="#cb18-36"></a></span>
<span id="cb18-37"><a href="#cb18-37"></a>xmain &lt;-<span class="st"> &quot;cross-validation error plot&quot;</span></span>
<span id="cb18-38"><a href="#cb18-38"></a>xlabel &lt;-<span class="st"> &quot;cost-complexity parameter (log-scale)&quot;</span></span>
<span id="cb18-39"><a href="#cb18-39"></a>ylabel &lt;-<span class="st"> &quot;CV error (in 10^(-2))&quot;</span></span>
<span id="cb18-40"><a href="#cb18-40"></a><span class="kw">errbar</span>(<span class="dt">x=</span>x1, <span class="dt">y=</span>err1<span class="op">*</span><span class="dv">100</span>, <span class="dt">yplus=</span>(err1<span class="op">+</span>std1)<span class="op">*</span><span class="dv">100</span>, <span class="dt">yminus=</span>(err1<span class="op">-</span>std1)<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb18-41"><a href="#cb18-41"></a>       <span class="dt">xlim=</span><span class="kw">rev</span>(<span class="kw">range</span>(x1)), <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">main=</span>xmain, <span class="dt">ylab=</span>ylabel, <span class="dt">xlab=</span>xlabel)</span>
<span id="cb18-42"><a href="#cb18-42"></a><span class="kw">lines</span>(<span class="dt">x=</span>x1, <span class="dt">y=</span>err1<span class="op">*</span><span class="dv">100</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>)</span>
<span id="cb18-43"><a href="#cb18-43"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">c</span>(<span class="kw">min</span>(err1<span class="op">+</span>std1)<span class="op">*</span><span class="dv">100</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>)</span>
<span id="cb18-44"><a href="#cb18-44"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">c</span>(<span class="kw">min</span>(err1)<span class="op">*</span><span class="dv">100</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;magenta&quot;</span>)</span>
<span id="cb18-45"><a href="#cb18-45"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="kw">c</span>(cp_1sd1,cp_min1),<span class="dt">lty=</span><span class="dv">2</span>,<span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;orange&quot;</span>,<span class="st">&quot;magenta&quot;</span>))</span>
<span id="cb18-46"><a href="#cb18-46"></a><span class="kw">legend</span>(<span class="dt">x=</span><span class="st">&quot;topright&quot;</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;magenta&quot;</span>,<span class="st">&quot;orange&quot;</span>,<span class="st">&quot;magenta&quot;</span>),</span>
<span id="cb18-47"><a href="#cb18-47"></a>      <span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">19</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb18-48"><a href="#cb18-48"></a>      <span class="kw">c</span>(<span class="st">&quot;tree0&quot;</span>, <span class="st">&quot;1-SD rule&quot;</span>, <span class="st">&quot;min.CV rule&quot;</span>,</span>
<span id="cb18-49"><a href="#cb18-49"></a>        <span class="kw">paste</span>(<span class="st">&quot;log cp = &quot;</span>,<span class="kw">round</span>(cp_1sd1,<span class="dv">3</span>)),<span class="kw">paste</span>(<span class="st">&quot;log cp = &quot;</span>, <span class="kw">round</span>(cp_min1,<span class="dv">3</span>))))</span>
<span id="cb18-50"><a href="#cb18-50"></a></span>
<span id="cb18-51"><a href="#cb18-51"></a>tree2 &lt;-<span class="st"> </span><span class="kw">prune</span>(tree00, <span class="dt">cp=</span><span class="dv">10</span><span class="op">^</span><span class="kw">mean</span>(cp_min1,<span class="kw">min</span>(x1[x1<span class="op">&gt;</span>cp_min1]))) </span>
<span id="cb18-52"><a href="#cb18-52"></a>tree22 &lt;-<span class="st"> </span><span class="kw">prune</span>(tree00, <span class="dt">cp=</span><span class="dv">10</span><span class="op">^</span><span class="kw">mean</span>(cp_1sd1,<span class="kw">min</span>(x1[x1<span class="op">&gt;</span>cp_1sd1]))) </span>
<span id="cb18-53"><a href="#cb18-53"></a><span class="kw">printcp</span>(tree2)</span>
<span id="cb18-54"><a href="#cb18-54"></a><span class="kw">printcp</span>(tree22)</span>
<span id="cb18-55"><a href="#cb18-55"></a>dat1_test<span class="op">$</span>fitRT2 &lt;-<span class="st"> </span><span class="kw">predict</span>(tree2, <span class="dt">newdata=</span>dat1_test)<span class="op">*</span>dat1_test<span class="op">$</span>Exposure</span>
<span id="cb18-56"><a href="#cb18-56"></a>dat1_test<span class="op">$</span>fitRT22 &lt;-<span class="st"> </span><span class="kw">predict</span>(tree22, <span class="dt">newdata=</span>dat1_test)<span class="op">*</span>dat1_test<span class="op">$</span>Exposure</span>
<span id="cb18-57"><a href="#cb18-57"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitRT2, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb18-58"><a href="#cb18-58"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitRT22, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb18-59"><a href="#cb18-59"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitRT2, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb18-60"><a href="#cb18-60"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitRT22, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb18-61"><a href="#cb18-61"></a><span class="kw">sum</span>((dat1_test<span class="op">$</span>fitRT2<span class="op">-</span>dat1_test<span class="op">$</span>fitRT_min)<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb18-62"><a href="#cb18-62"></a><span class="kw">sum</span>((dat1_test<span class="op">$</span>fitRT22<span class="op">-</span>dat1_test<span class="op">$</span>fitRT_sd)<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb18-63"><a href="#cb18-63"></a>tree2<span class="op">$</span>variable.importance</span>
<span id="cb18-64"><a href="#cb18-64"></a>tree1<span class="op">$</span>variable.importance</span>
<span id="cb18-65"><a href="#cb18-65"></a>tree22<span class="op">$</span>variable.importance</span>
<span id="cb18-66"><a href="#cb18-66"></a>tree11<span class="op">$</span>variable.importance</span></code></pre></div>
</div>
<div id="éšæœºæ£®æ—" class="section level2">
<h2><span class="header-section-number">2.9</span> éšæœºæ£®æ—</h2>
<ul>
<li><p>ä½¿ç”¨<a href="https://github.com/henckr/distRforest" class="uri">https://github.com/henckr/distRforest</a>å»ºç«‹æ³Šæ¾éšæœºæ£®æ—ã€‚</p></li>
<li><p><code>ncand</code>æ¯æ¬¡åˆ†è£‚è€ƒè™‘çš„åå˜é‡ä¸ªæ•°ï¼›<code>subsample</code>è®­ç»ƒæ¯æ£µæ ‘çš„æ ·æœ¬ã€‚</p></li>
<li><p>ä½¿ç”¨éªŒè¯æŸå¤±ç¡®å®šæ ‘çš„æ•°é‡ã€‚</p></li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># fit the random forest</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw">library</span>(distRforest)</span>
<span id="cb19-4"><a href="#cb19-4"></a>ntrees0&lt;-<span class="dv">200</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb19-6"><a href="#cb19-6"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb19-7"><a href="#cb19-7"></a>forest1&lt;-<span class="kw">rforest</span>(<span class="kw">cbind</span>(Exposure, ClaimNb) <span class="op">~</span><span class="st">  </span>VehPower <span class="op">+</span><span class="st"> </span>VehAge <span class="op">+</span><span class="st"> </span>DrivAge <span class="op">+</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="st">                   </span>BonusMalus <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">+</span><span class="st"> </span>VehGas <span class="op">+</span><span class="st"> </span>Area <span class="op">+</span><span class="st"> </span>DensityLn <span class="op">+</span><span class="st"> </span>Region,</span>
<span id="cb19-9"><a href="#cb19-9"></a>                 <span class="dt">data =</span> dat1_train, <span class="dt">method =</span> <span class="st">&quot;poisson&quot;</span>, </span>
<span id="cb19-10"><a href="#cb19-10"></a>                 <span class="dt">control =</span> <span class="kw">rpart.control</span> (<span class="dt">xval=</span><span class="dv">0</span>, <span class="dt">minbucket=</span><span class="dv">1000</span> ,<span class="dt">cp=</span><span class="dv">10</span><span class="op">^-</span><span class="dv">4</span>,</span>
<span id="cb19-11"><a href="#cb19-11"></a>                                <span class="dt">maxcompete =</span> <span class="dv">0</span>,<span class="dt">maxsurrogate =</span> <span class="dv">0</span>, <span class="dt">seed=</span><span class="dv">1</span>), </span>
<span id="cb19-12"><a href="#cb19-12"></a>                 <span class="dt">parms=</span><span class="kw">list</span>(<span class="dt">shrink=</span><span class="dv">1</span>), <span class="dt">ncand=</span><span class="dv">5</span>,<span class="dt">ntrees =</span> ntrees0, </span>
<span id="cb19-13"><a href="#cb19-13"></a>                 <span class="dt">subsample =</span> <span class="fl">0.5</span>, <span class="dt">red_mem =</span> T)</span>
<span id="cb19-14"><a href="#cb19-14"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb19-15"><a href="#cb19-15"></a></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="co"># determine number of trees using validation error</span></span>
<span id="cb19-17"><a href="#cb19-17"></a></span>
<span id="cb19-18"><a href="#cb19-18"></a>fit_valid&lt;-<span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">nrow</span>(dat1_valid))</span>
<span id="cb19-19"><a href="#cb19-19"></a>error_valid&lt;-<span class="kw">rep</span>(<span class="dv">0</span>,ntrees0)</span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>ntrees0){</span>
<span id="cb19-21"><a href="#cb19-21"></a>  fit_valid&lt;-fit_valid <span class="op">+</span><span class="st"> </span><span class="kw">predict</span>(forest1<span class="op">$</span>trees[[i]], <span class="dt">newdata=</span>dat1_valid) <span class="op">*</span></span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="st">    </span>dat1_valid<span class="op">$</span>Exposure</span>
<span id="cb19-23"><a href="#cb19-23"></a>  fit_valid_norm &lt;-<span class="st"> </span>fit_valid<span class="op">/</span>i</span>
<span id="cb19-24"><a href="#cb19-24"></a>  error_valid[i]&lt;-<span class="kw">Poisson.Deviance</span>(fit_valid_norm, dat1_valid<span class="op">$</span>ClaimNb)</span>
<span id="cb19-25"><a href="#cb19-25"></a>}</span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="co"># png(&quot;./plots/1/random_forest_error.png&quot;)</span></span>
<span id="cb19-27"><a href="#cb19-27"></a><span class="kw">plot</span>(error_valid,<span class="dt">type=</span><span class="st">&quot;l&quot;</span>,<span class="dt">xlab=</span><span class="st">&quot;number of trees&quot;</span>,<span class="dt">ylab=</span><span class="st">&quot;validation error in 10^-2&quot;</span>)</span>
<span id="cb19-28"><a href="#cb19-28"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="kw">which.min</span>(error_valid),<span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="co"># dev.off()</span></span>
<span id="cb19-30"><a href="#cb19-30"></a>(<span class="dt">best.trees=</span><span class="kw">which.min</span>(error_valid))</span>
<span id="cb19-31"><a href="#cb19-31"></a></span>
<span id="cb19-32"><a href="#cb19-32"></a><span class="co"># test error</span></span>
<span id="cb19-33"><a href="#cb19-33"></a></span>
<span id="cb19-34"><a href="#cb19-34"></a>fitRF&lt;-<span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">nrow</span>(dat1_test))</span>
<span id="cb19-35"><a href="#cb19-35"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>best.trees){</span>
<span id="cb19-36"><a href="#cb19-36"></a>  fitRF&lt;-fitRF<span class="op">+</span><span class="kw">predict</span>(forest1<span class="op">$</span>trees[[i]], <span class="dt">newdata=</span>dat1_test)<span class="op">*</span>dat1_test<span class="op">$</span>Exposure</span>
<span id="cb19-37"><a href="#cb19-37"></a>}</span>
<span id="cb19-38"><a href="#cb19-38"></a>dat1_test<span class="op">$</span>fitRF &lt;-<span class="st"> </span>fitRF<span class="op">/</span>best.trees</span>
<span id="cb19-39"><a href="#cb19-39"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitRF, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb19-40"><a href="#cb19-40"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitRF, dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb19-41"><a href="#cb19-41"></a><span class="kw">names</span>(forest1<span class="op">$</span>trees[[<span class="dv">2</span>]]<span class="op">$</span>variable.importance)</span>
<span id="cb19-42"><a href="#cb19-42"></a><span class="kw">sum</span>(forest1<span class="op">$</span>trees[[<span class="dv">3</span>]]<span class="op">$</span>variable.importance)</span></code></pre></div>
<p><img src="./plots/1/random_forest_error.png" width="60%"  style="display: block; margin: auto;" /></p>
</div>
<div id="æ³Šæ¾æå‡æ ‘" class="section level2">
<h2><span class="header-section-number">2.10</span> æ³Šæ¾æå‡æ ‘</h2>
<ul>
<li><code>n.trees</code> æ ‘çš„æ•°é‡ï¼›<code>shrinkage</code> å­¦ä¹ æ­¥é•¿ï¼Œå’Œæ ‘çš„æ•°é‡æˆåæ¯”ï¼›<code>interaction.depth</code> äº¤äº’é¡¹æ·±åº¦ï¼›<code>bag.fraction</code> æ¯æ£µæ ‘ä½¿ç”¨çš„æ•°æ®æ¯”ä¾‹ï¼›<code>train.fraction</code> è®­ç»ƒé›†æ¯”ä¾‹ï¼›<code>n.minobsinnode</code>å¶å­ä¸Šæœ€å°‘æ ·æœ¬é‡ã€‚</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb20-2"><a href="#cb20-2"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb20-3"><a href="#cb20-3"></a>  gbm1 &lt;-</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">    </span><span class="kw">gbm</span>(</span>
<span id="cb20-5"><a href="#cb20-5"></a>      ClaimNb <span class="op">~</span><span class="st">  </span>VehPower <span class="op">+</span><span class="st"> </span>VehAge <span class="op">+</span><span class="st"> </span>DrivAge <span class="op">+</span><span class="st"> </span>BonusMalus <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">+</span><span class="st"> </span>VehGas <span class="op">+</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="st">        </span>Area <span class="op">+</span><span class="st"> </span>DensityLn <span class="op">+</span><span class="st"> </span>Region <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(<span class="kw">log</span>(Exposure)),</span>
<span id="cb20-7"><a href="#cb20-7"></a>      <span class="dt">data =</span> dat1_learn_gbm,</span>
<span id="cb20-8"><a href="#cb20-8"></a>      <span class="dt">distribution =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb20-9"><a href="#cb20-9"></a>      <span class="dt">n.trees =</span> <span class="dv">500</span>,</span>
<span id="cb20-10"><a href="#cb20-10"></a>      <span class="dt">shrinkage =</span> <span class="fl">0.1</span>,</span>
<span id="cb20-11"><a href="#cb20-11"></a>      <span class="dt">interaction.depth =</span> <span class="dv">5</span>,</span>
<span id="cb20-12"><a href="#cb20-12"></a>      <span class="dt">bag.fraction =</span> <span class="fl">0.5</span>,</span>
<span id="cb20-13"><a href="#cb20-13"></a>      <span class="dt">train.fraction =</span> train_pro,</span>
<span id="cb20-14"><a href="#cb20-14"></a>      <span class="dt">cv.folds =</span> <span class="dv">0</span>,</span>
<span id="cb20-15"><a href="#cb20-15"></a>      <span class="dt">n.minobsinnode =</span> <span class="dv">1000</span>,</span>
<span id="cb20-16"><a href="#cb20-16"></a>      <span class="dt">verbose =</span> T</span>
<span id="cb20-17"><a href="#cb20-17"></a>    )</span>
<span id="cb20-18"><a href="#cb20-18"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb20-19"><a href="#cb20-19"></a></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="co"># plot the performance</span></span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="co"># png(&quot;./plots/1/gbm_error.png&quot;)</span></span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="kw">gbm.perf</span>(gbm1,<span class="dt">method=</span><span class="st">&quot;test&quot;</span>)</span>
<span id="cb20-24"><a href="#cb20-24"></a><span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>,<span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;black&quot;</span>,<span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>),</span>
<span id="cb20-25"><a href="#cb20-25"></a>       <span class="kw">c</span>(<span class="st">&quot;training error&quot;</span>, <span class="st">&quot;validation error&quot;</span>, <span class="st">&quot;best iterations&quot;</span>))</span>
<span id="cb20-26"><a href="#cb20-26"></a><span class="co"># dev.off()</span></span>
<span id="cb20-27"><a href="#cb20-27"></a></span>
<span id="cb20-28"><a href="#cb20-28"></a>best.iter&lt;-<span class="kw">gbm.perf</span>(gbm1,<span class="dt">method=</span><span class="st">&quot;test&quot;</span>)</span>
<span id="cb20-29"><a href="#cb20-29"></a>dat1_test<span class="op">$</span>fitGBM1&lt;-</span>
<span id="cb20-30"><a href="#cb20-30"></a><span class="st">  </span><span class="kw">predict</span>(gbm1, dat1_test,<span class="dt">n.trees=</span>best.iter,<span class="dt">type=</span><span class="st">&quot;response&quot;</span>)<span class="op">*</span>dat1_test<span class="op">$</span>Exposure</span>
<span id="cb20-31"><a href="#cb20-31"></a><span class="kw">keras_poisson_dev</span>(dat1_test<span class="op">$</span>fitGBM1,dat1_test<span class="op">$</span>ClaimNb)</span>
<span id="cb20-32"><a href="#cb20-32"></a><span class="kw">Poisson.Deviance</span>(dat1_test<span class="op">$</span>fitGBM1,dat1_test<span class="op">$</span>ClaimNb)</span></code></pre></div>
<ul>
<li>æ ¹æ®éªŒè¯é›†æŸå¤±ç¡®å®šè¿­ä»£æ¬¡æ•°ã€‚</li>
</ul>
<p><img src="./plots/1/gbm_error.png" width="60%"  style="display: block; margin: auto;" /></p>
<ul>
<li>Variable importance</li>
</ul>
<pre><code>             rel.inf
BonusMalus 27.687137
VehAge     19.976441
VehBrand   13.515198
Region     13.495375
DrivAge     9.284520
VehGas      7.082648
VehPower    4.583522
DensityLn   4.375159
Area        0.000000</code></pre>
<ul>
<li>é‡è¦å˜é‡çš„è¾¹ç¼˜æ•ˆåº”</li>
</ul>
<p><img src="./plots/1/gbm_mar1.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_mar2.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_mar3.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_mar4.png" width="40%"  style="display: block; margin: auto;" /></p>
<ul>
<li>é‡è¦å˜é‡çš„äº¤äº’æ•ˆåº”</li>
</ul>
<p><img src="./plots/1/gbm_int1.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_int2.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_int3.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_int4.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_int5.png" width="40%"  style="display: block; margin: auto;" /><img src="./plots/1/gbm_int6.png" width="40%"  style="display: block; margin: auto;" /></p>
</div>
<div id="æ¨¡å‹æ¯”è¾ƒ" class="section level2">
<h2><span class="header-section-number">2.11</span> æ¨¡å‹æ¯”è¾ƒ</h2>
<pre><code>##                       model test_error test_error_keras
## 1                 Intercept    33.5695          21.7647
## 2                       GLM    31.7731          20.8665
## 3                 GLM Lasso    31.8132          20.8866
## 4                       GAM    31.6651          20.8125
## 5             Decision tree    30.9780          20.4690
## 6             Random forest    30.9652          20.4626
## 7 Generalized boosted model    30.8972          20.4286
## 8            Neural network    31.0607          20.5080</code></pre>
<ul>
<li>Boosting &gt; RF &gt; Tree &gt; GAM &gt; GLM &gt; Homo</li>
</ul>
<!--chapter:end:02-french.Rmd-->
</div>
</div>
<div id="nn" class="section level1">
<h1><span class="header-section-number">3</span> ç¥ç»ç½‘ç»œ</h1>
<p>æ­£å¦‚è®¡ç®—æœºé€Ÿåº¦çš„æå‡å’ŒMCMCæ–¹æ³•ç»™è´å¶æ–¯ç»Ÿè®¡å¸¦æ¥äº†ç”Ÿæœºï¼Œè®¡ç®—æœºè¿ç®—èƒ½åŠ›çš„æå‡å’Œåå‘ä¼ æ’­ç®—æ³•ï¼ˆback propagationï¼‰ä¹Ÿç»™ç¥ç»ç½‘ç»œå¸¦æ¥äº†é£é€Ÿå‘å±•ã€‚</p>
<p><code>Tensorflow</code>å’Œ<code>Pytorch</code>çš„æ›´æ–°é€Ÿåº¦åæ˜ äº†è¿™ä¸ªé¢†åŸŸçš„çƒ­åº¦ã€‚</p>
<div id="å»ºç«‹ç¥ç»ç½‘ç»œçš„ä¸€èˆ¬æ­¥éª¤" class="section level2">
<h2><span class="header-section-number">3.1</span> å»ºç«‹ç¥ç»ç½‘ç»œçš„ä¸€èˆ¬æ­¥éª¤</h2>
<div id="æ˜ç¡®ç›®æ ‡å’Œæ•°æ®ç±»å‹" class="section level3">
<h3><span class="header-section-number">3.1.1</span> æ˜ç¡®ç›®æ ‡å’Œæ•°æ®ç±»å‹</h3>
<ul>
<li><p>ç¥ç»ç½‘ç»œæ˜¯ä¸€ç§éå‚éçº¿æ€§å›å½’æ¨¡å‹ï¼Œå®ƒå¯ä»¥åˆ»ç”»éçº¿æ€§æ•ˆåº”å’Œäº¤äº’æ•ˆåº”ã€‚</p></li>
<li><p>åœ¨ä½¿ç”¨ç¥ç»ç½‘ç»œå‰ï¼Œéœ€è¦ç†è§£ç ”ç©¶ç›®æ ‡å’Œæ•°æ®ç»“æ„ï¼Œæœ‰ä¸€äº›ç‰¹æ®Šçš„layerï¼Œå¦‚å·ç§¯å±‚ï¼Œä¸“é—¨ä¸ºæŸç§ä»»åŠ¡ã€æˆ–æŸç§æ•°æ®ç»“æ„è€Œè®¾ç«‹ï¼Œä¸æ˜¯å¯ä»¥ç”¨åœ¨ä»»ä½•çš„æ•°æ®ä¸Šã€‚</p></li>
<li><p>ç¥ç»ç½‘ç»œæœ‰å¤§é‡çš„å‚æ•°ï¼Œå…¨å±€æœ€ä¼˜è§£å¿…ç„¶ä¼šé€ æˆè¿‡æ‹Ÿåˆï¼Œé€šå¸¸åˆ©ç”¨éªŒè¯é›†æŸå¤±æ¥åˆ¤æ–­æ¢¯åº¦ä¸‹é™çš„æ¬¡æ•°ã€‚</p></li>
</ul>
</div>
<div id="æ•°æ®é¢„å¤„ç†" class="section level3">
<h3><span class="header-section-number">3.1.2</span> æ•°æ®é¢„å¤„ç†</h3>
<ul>
<li><p>æè¿°æ€§ç»Ÿè®¡åˆ†æ</p></li>
<li><p>ç¼ºå¤±å€¼ã€å¼‚å¸¸å€¼å¤„ç†</p></li>
<li><p>è¿ç»­å‹å˜é‡æ ‡å‡†åŒ–ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®©æ¢¯åº¦ä¸‹é™æ³•æ›´æœ‰æ•ˆåœ°å·¥ä½œã€‚å¸¸ç”¨çš„æ ‡å‡†åŒ–æ–¹æ³•æœ‰<em>MinMaxScaler</em></p>
<p><span class="math display">\[x^*=2\frac{x-\min x}{\max x - \min x}-1\]</span></p></li>
<li><p>åˆ†ç±»å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨dummy codingã€one-hot encodingï¼Œæˆ–è€…ä½¿ç”¨ç¥ç»ç½‘ç»œä¸­çš„embedding layerã€‚ç¬¬ä¸‰ç§åŠæ³•å¯ä»¥æœ‰æ•ˆåœ°å‡å°‘å‚æ•°ä¸ªæ•°ã€‚</p></li>
<li><p>è®­ç»ƒ-éªŒè¯-æµ‹è¯•æ•°æ®åˆ†å‰²ï¼šè®­ç»ƒé›†ç”¨äºæ¢¯åº¦ä¸‹é™æ³•æ±‚è§£å‚æ•°ï¼ŒéªŒè¯é›†ç”¨äºåˆ¤æ–­epochæ¬¡æ•°ã€è°ƒæ•´æ¨¡å‹ç»“æ„çš„è¶…å‚æ•°ï¼Œæµ‹è¯•é›†ç”¨äºæ¯”è¾ƒä¸åŒæ¨¡å‹çš„æ ·æœ¬å¤–é¢„æµ‹èƒ½åŠ›ã€‚</p></li>
</ul>
</div>
<div id="é€‰å–åˆé€‚çš„ç¥ç»ç½‘ç»œç±»å‹" class="section level3">
<h3><span class="header-section-number">3.1.3</span> é€‰å–åˆé€‚çš„ç¥ç»ç½‘ç»œç±»å‹</h3>
<ul>
<li><p>å…¨è¿æ¥ç¥ç»ç½‘ç»œï¼šé€‚ç”¨äºä¸€èˆ¬çš„å›å½’é—®é¢˜ï¼Œå¦‚ç´¢èµ”é¢‘ç‡é¢„æµ‹ã€‚ä¿¡æ¯ä¸€ç›´å‘å‰ä¼ é€’ã€‚å‚æ•°ä¸ªæ•°è¾ƒå¤šã€‚å¯è§£é‡Šæ€§å·®ã€‚</p></li>
<li><p>å·ç§¯ç¥ç»ç½‘ç»œï¼šé€‚ç”¨äºæ•°æ®æœ‰ç©ºé—´ç»“æ„ï¼Œä¸”ç›¸åŒçš„æ¨¡å¼å¯èƒ½å‡ºç°åœ¨ä¸åŒçš„ä½ç½®ï¼Œå¦‚å›¾åƒè¯†åˆ«ã€‚ä¿¡æ¯ä¸€ç›´å‘å‰ä¼ é€’ã€‚å‚æ•°ä¸ªæ•°è¾ƒå°‘ã€‚æœ‰å¯è§£é‡Šæ€§ã€‚</p></li>
<li><p>é€’å½’ç¥ç»ç½‘ç»œï¼šé€‚ç”¨äºæ•°æ®æœ‰æ—¶é—´åºåˆ—ç‰¹å¾ï¼Œä¸”ç›¸åŒçš„æ¨¡å¼å¯èƒ½å‡ºç°åœ¨ä¸åŒæ—¶é—´ç‚¹ï¼Œå¦‚å¤©æ°”é¢„æŠ¥ã€è¯­éŸ³è¯†åˆ«ã€‚ä¿¡æ¯å¯ä»¥è¿”å›åˆ°å‰é¢çš„ç¥ç»å…ƒã€‚å‚æ•°ä¸ªæ•°è¾ƒå¤šã€‚å¯è§£é‡Šæ€§å·®ã€‚</p></li>
</ul>
</div>
<div id="å»ºç«‹ç¥ç»ç½‘ç»œå…¨è¿æ¥ç¥ç»ç½‘ç»œ" class="section level3">
<h3><span class="header-section-number">3.1.4</span> å»ºç«‹ç¥ç»ç½‘ç»œï¼ˆå…¨è¿æ¥ç¥ç»ç½‘ç»œï¼‰</h3>
<p>åœ¨å»ºç«‹ç¥ç»ç½‘ç»œæ—¶ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li><p>è¾“å…¥å±‚æ•°æ®ç±»å‹</p></li>
<li><p>éšè—å±‚å±‚æ•°ï¼Œéšè—å±‚æ€§è´¨ï¼Œç¥ç»å…ƒä¸ªæ•°ï¼Œæ¿€æ´»å‡½æ•°ï¼Œæ­£åˆ™åŒ–ï¼Œdropout</p></li>
<li><p>è¾“å‡ºç¥ç»å…ƒæ•°æ®ç±»å‹ï¼Œè¾“å‡ºç¥ç»å…ƒæ¿€æ´»å‡½æ•°</p></li>
<li><p>æŸå¤±å‡½æ•°é€‰æ‹©</p></li>
</ul>
</div>
<div id="è®­ç»ƒç¥ç»ç½‘ç»œ" class="section level3">
<h3><span class="header-section-number">3.1.5</span> è®­ç»ƒç¥ç»ç½‘ç»œ</h3>
<p>åœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹</p>
<ul>
<li><p>æ¢¯åº¦ä¸‹é™æ³•ï¼ˆoptimizerï¼‰</p></li>
<li><p>è¿­ä»£æ¬¡æ•°ï¼ˆpatienceï¼‰</p></li>
<li><p>éå†æ¬¡æ•°ï¼ˆepochï¼‰ï¼Œæ‰¹é‡å¤§å°ï¼ˆbatch sizeï¼‰</p></li>
</ul>
</div>
<div id="è°ƒå‚" class="section level3">
<h3><span class="header-section-number">3.1.6</span> è°ƒå‚</h3>
<p>è¿”å›ç¬¬4æ­¥ï¼Œè°ƒæ•´æ¨¡å‹ç»“æ„çš„è¶…å‚æ•°ï¼ˆhyper-parameter tuningï¼‰ï¼Œè§‚å¯ŸéªŒè¯æŸå¤±çš„å˜åŒ–ï¼Œé€‰å–æœ€ç»ˆæ¨¡å‹ã€‚</p>
</div>
</div>
<div id="æ•°æ®é¢„å¤„ç†-1" class="section level2">
<h2><span class="header-section-number">3.2</span> æ•°æ®é¢„å¤„ç†</h2>
<pre><code>  &#39;data.frame&#39;: 678013 obs. of  12 variables:
   $ IDpol     : num  1 3 5 10 11 13 15 17 18 21 ...
   $ ClaimNb   : &#39;table&#39; num [1:678013(1d)] 1 1 1 1 1 1 1 1 1 1 ...
   $ Exposure  : num  0.1 0.77 0.75 0.09 0.84 0.52 0.45 0.27 0.71 0.15 ...
   $ VehPower  : int  5 5 6 7 7 6 6 7 7 7 ...
   $ VehAge    : int  0 0 2 0 0 2 2 0 0 0 ...
   $ DrivAge   : int  55 55 52 46 46 38 38 33 33 41 ...
   $ BonusMalus: int  50 50 50 50 50 50 50 68 68 50 ...
   $ VehBrand  : Factor w/ 11 levels &quot;B1&quot;,&quot;B10&quot;,&quot;B11&quot;,..: 4 4 4 4 4 4 4 4 4 4 ...
   $ VehGas    : chr  &quot;Regular&quot; &quot;Regular&quot; &quot;Diesel&quot; &quot;Diesel&quot; ...
   $ Area      : Factor w/ 6 levels &quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,..: 4 4 2 2 2 5 5 3 3 2 ...
   $ Density   : int  1217 1217 54 76 76 3003 3003 137 137 60 ...
   $ Region    : Factor w/ 21 levels &quot;Alsace&quot;,&quot;Aquitaine&quot;,..: 21 21 18 2 2 16 16 13 13 17 ...</code></pre>
<p>åœ¨è¿›è¡Œä¸‹é¢codeä¹‹å‰ï¼Œéœ€è¦è¿è¡Œä¸Šä¸€ç« çš„ä»£ç ç›´åˆ°Treeä¹‹å‰ã€‚</p>
<ul>
<li>è¿ç»­å‹å˜é‡ï¼šæ ‡å‡†åŒ–å¤„ç†ã€‚</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>PreProcess.Continuous &lt;-<span class="st"> </span><span class="cf">function</span>(var1, dat1){</span>
<span id="cb24-2"><a href="#cb24-2"></a>   <span class="kw">names</span>(dat1)[<span class="kw">names</span>(dat1) <span class="op">==</span><span class="st"> </span>var1]  &lt;-<span class="st"> &quot;V1&quot;</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>   dat1<span class="op">$</span>X &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(dat1<span class="op">$</span>V1)</span>
<span id="cb24-4"><a href="#cb24-4"></a>   dat1<span class="op">$</span>X &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">*</span>(dat1<span class="op">$</span>X<span class="op">-</span><span class="kw">min</span>(dat1<span class="op">$</span>X))<span class="op">/</span>(<span class="kw">max</span>(dat1<span class="op">$</span>X)<span class="op">-</span><span class="kw">min</span>(dat1<span class="op">$</span>X))<span class="op">-</span><span class="dv">1</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>   <span class="kw">names</span>(dat1)[<span class="kw">names</span>(dat1) <span class="op">==</span><span class="st"> &quot;V1&quot;</span>]  &lt;-<span class="st"> </span>var1</span>
<span id="cb24-6"><a href="#cb24-6"></a>   <span class="kw">names</span>(dat1)[<span class="kw">names</span>(dat1) <span class="op">==</span><span class="st"> &quot;X&quot;</span>]  &lt;-<span class="st"> </span><span class="kw">paste</span>(var1,<span class="st">&quot;X&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb24-7"><a href="#cb24-7"></a>   dat1</span>
<span id="cb24-8"><a href="#cb24-8"></a>   }</span>
<span id="cb24-9"><a href="#cb24-9"></a></span>
<span id="cb24-10"><a href="#cb24-10"></a>Features.PreProcess &lt;-<span class="st"> </span><span class="cf">function</span>(dat1){</span>
<span id="cb24-11"><a href="#cb24-11"></a>   dat1<span class="op">$</span>VehPower &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>VehPower,<span class="dv">9</span>)</span>
<span id="cb24-12"><a href="#cb24-12"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;VehPower&quot;</span>, dat1)   </span>
<span id="cb24-13"><a href="#cb24-13"></a>   dat1<span class="op">$</span>VehAge &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>VehAge,<span class="dv">20</span>)</span>
<span id="cb24-14"><a href="#cb24-14"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;VehAge&quot;</span>, dat1)   </span>
<span id="cb24-15"><a href="#cb24-15"></a>   dat1<span class="op">$</span>DrivAge &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>DrivAge,<span class="dv">90</span>)</span>
<span id="cb24-16"><a href="#cb24-16"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;DrivAge&quot;</span>, dat1)   </span>
<span id="cb24-17"><a href="#cb24-17"></a>   dat1<span class="op">$</span>BonusMalus &lt;-<span class="st"> </span><span class="kw">pmin</span>(dat1<span class="op">$</span>BonusMalus,<span class="dv">150</span>)</span>
<span id="cb24-18"><a href="#cb24-18"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;BonusMalus&quot;</span>, dat1)   </span>
<span id="cb24-19"><a href="#cb24-19"></a>   dat1<span class="op">$</span>VehBrandX &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>VehBrand)<span class="op">-</span><span class="dv">1</span>  <span class="co"># categorical variable</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>   dat1<span class="op">$</span>VehGas &lt;-<span class="st"> </span><span class="kw">as.factor</span>(dat1<span class="op">$</span>VehGas)</span>
<span id="cb24-21"><a href="#cb24-21"></a>   dat1<span class="op">$</span>VehGasX &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>VehGas) <span class="op">-</span><span class="st"> </span><span class="fl">1.5</span> <span class="co"># binary: continuous or categorical</span></span>
<span id="cb24-22"><a href="#cb24-22"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;Area&quot;</span>, dat1)   </span>
<span id="cb24-23"><a href="#cb24-23"></a>   dat1 &lt;-<span class="st"> </span><span class="kw">PreProcess.Continuous</span>(<span class="st">&quot;Density&quot;</span>, dat1)   </span>
<span id="cb24-24"><a href="#cb24-24"></a>   dat1<span class="op">$</span>RegionX &lt;-<span class="st"> </span><span class="kw">as.integer</span>(dat1<span class="op">$</span>Region) <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="co"># categorical</span></span>
<span id="cb24-25"><a href="#cb24-25"></a>   dat1</span>
<span id="cb24-26"><a href="#cb24-26"></a>}</span>
<span id="cb24-27"><a href="#cb24-27"></a></span>
<span id="cb24-28"><a href="#cb24-28"></a>dat2 &lt;-<span class="st"> </span><span class="kw">Features.PreProcess</span>(freMTPL2freq)   </span>
<span id="cb24-29"><a href="#cb24-29"></a><span class="kw">names</span>(dat2)</span>
<span id="cb24-30"><a href="#cb24-30"></a>dat2_train&lt;-dat2[index_train,]</span>
<span id="cb24-31"><a href="#cb24-31"></a>dat2_valid&lt;-dat2[index_valid,]</span>
<span id="cb24-32"><a href="#cb24-32"></a>dat2_test&lt;-dat2[index_test,]</span>
<span id="cb24-33"><a href="#cb24-33"></a>dat2_learn&lt;-dat2[index_learn,]</span></code></pre></div>
<ul>
<li><p>åˆ†ç±»å˜é‡ï¼š é‡‡ç”¨embedding layerã€‚</p></li>
<li><p>è®­ç»ƒé›†-éªŒè¯é›†-æµ‹è¯•é›†ï¼šåˆ†å±‚æŠ½æ ·ã€‚</p></li>
<li><p>è°ƒæ•´æ•°æ®ç»“æ„ï¼Œä½¿å…¶åŒ¹é…ç¥ç»ç½‘ç»œçš„è¾“å…¥å±‚åŠå…¶ç»´åº¦ã€‚è¾“å…¥æ•°æ®é›†åŒ…æ‹¬<code>Xtrain, Brtain, Retrain, Vtrain</code>ï¼Œå› å˜é‡æ•°æ®é›†ä¸º<code>Ytrain</code>ã€‚</p></li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>lambda.hom &lt;-<span class="st"> </span><span class="kw">sum</span>(dat2_train<span class="op">$</span>ClaimNb)<span class="op">/</span><span class="kw">sum</span>(dat2_train<span class="op">$</span>Exposure);lambda.hom</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw">names</span>(dat2)</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co"># index of continous variables (non-categorical)</span></span>
<span id="cb25-5"><a href="#cb25-5"></a></span>
<span id="cb25-6"><a href="#cb25-6"></a>features &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">13</span><span class="op">:</span><span class="dv">16</span>, <span class="dv">18</span><span class="op">:</span><span class="dv">20</span>)</span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="kw">names</span>(dat2_learn)[features]</span>
<span id="cb25-8"><a href="#cb25-8"></a>(q0 &lt;-<span class="st"> </span><span class="kw">length</span>(features))</span>
<span id="cb25-9"><a href="#cb25-9"></a></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="co"># training data</span></span>
<span id="cb25-11"><a href="#cb25-11"></a></span>
<span id="cb25-12"><a href="#cb25-12"></a>Xtrain&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train[, features])  <span class="co"># design matrix learning sample</span></span>
<span id="cb25-13"><a href="#cb25-13"></a>Brtrain &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>VehBrandX)</span>
<span id="cb25-14"><a href="#cb25-14"></a>Retrain &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>RegionX)</span>
<span id="cb25-15"><a href="#cb25-15"></a>Ytrain&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>ClaimNb)</span>
<span id="cb25-16"><a href="#cb25-16"></a>Vtrain&lt;-<span class="kw">as.matrix</span>(<span class="kw">log</span>(dat2_train<span class="op">$</span>Exposure<span class="op">*</span>lambda.hom))</span>
<span id="cb25-17"><a href="#cb25-17"></a></span>
<span id="cb25-18"><a href="#cb25-18"></a><span class="co"># validation data </span></span>
<span id="cb25-19"><a href="#cb25-19"></a></span>
<span id="cb25-20"><a href="#cb25-20"></a>Xvalid&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid[, features])  <span class="co"># design matrix learning sample</span></span>
<span id="cb25-21"><a href="#cb25-21"></a>Brvalid &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid<span class="op">$</span>VehBrandX)</span>
<span id="cb25-22"><a href="#cb25-22"></a>Revalid &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid<span class="op">$</span>RegionX)</span>
<span id="cb25-23"><a href="#cb25-23"></a>Yvalid&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_valid<span class="op">$</span>ClaimNb)</span>
<span id="cb25-24"><a href="#cb25-24"></a>Vvalid&lt;-<span class="kw">as.matrix</span>(<span class="kw">log</span>(dat2_valid<span class="op">$</span>Exposure<span class="op">*</span>lambda.hom))</span>
<span id="cb25-25"><a href="#cb25-25"></a>xxvalid&lt;-<span class="kw">list</span>(Xvalid,Brvalid,Revalid,Vvalid)</span>
<span id="cb25-26"><a href="#cb25-26"></a></span>
<span id="cb25-27"><a href="#cb25-27"></a><span class="co"># testing data</span></span>
<span id="cb25-28"><a href="#cb25-28"></a></span>
<span id="cb25-29"><a href="#cb25-29"></a>Xtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test[, features])    <span class="co"># design matrix test sample</span></span>
<span id="cb25-30"><a href="#cb25-30"></a>Brtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test<span class="op">$</span>VehBrandX)</span>
<span id="cb25-31"><a href="#cb25-31"></a>Retest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test<span class="op">$</span>RegionX)</span>
<span id="cb25-32"><a href="#cb25-32"></a>Ytest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat2_test<span class="op">$</span>ClaimNb)</span>
<span id="cb25-33"><a href="#cb25-33"></a>Vtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat2_test<span class="op">$</span>Exposure<span class="op">*</span>lambda.hom))</span></code></pre></div>
</div>
<div id="ç¥ç»ç½‘ç»œæå‡æ¨¡å‹-combined-actuarial-neural-network" class="section level2">
<h2><span class="header-section-number">3.3</span> ç¥ç»ç½‘ç»œæå‡æ¨¡å‹ ï¼ˆcombined actuarial neural networkï¼‰</h2>
<p>åŸºæœ¬ç»“æ„</p>
<p><span class="math display">\[\ln \lambda(\mathbf{x})= e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\hat{\lambda}^{\text{NN}}(\mathbf{x})\]</span></p>
<p>å…¶ä¸­ï¼Œ<span class="math inline">\(\hat{\lambda}^{\text{GAM}}\)</span>ä¸ºå¹¿ä¹‰å¯åŠ è¾¹ç¼˜æå‡æ¨¡å‹çš„ç´¢èµ”é¢‘ç‡ä¼°è®¡å€¼ï¼ˆå‚è§ä¸Šä¸€ç« ï¼‰ï¼Œ<span class="math inline">\(\hat{\lambda}^{\text{NN}}\)</span>ä¸ºç¥ç»ç½‘ç»œç´¢èµ”é¢‘ç‡çš„ä¼°è®¡å€¼ï¼Œç¬¬ä¸€é¡¹åœ¨æ¨¡å‹è®­ç»ƒä¸­ä¿æŒä¸å˜ã€‚</p>
<p>ä½¿ç”¨ä¸Šè¿°æ¨¡å‹çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p><span class="math inline">\(\hat{\lambda}^{\text{GAM}}\)</span>çš„éƒ¨åˆ†å¯è§£é‡Šæ€§ã€‚</p></li>
<li><p>ç¥ç»ç½‘ç»œä»ä¸€ä¸ªç›¸å¯¹â€œè¾ƒå¥½â€çš„åˆå§‹çŠ¶æ€<span class="math inline">\(e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\)</span>å¼€å§‹è®­ç»ƒï¼Œå¾ˆå¿«æ”¶æ•›ã€‚</p></li>
</ul>
<p>åœ¨ä»£ç å®ç°ä¸­ï¼Œå¯ä»¥æŠŠ<span class="math inline">\(e\hat{\lambda}^{\text{GAM}}\)</span>å½“ä½œä¼ªé£é™©æš´éœ²æ•°ã€‚</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>CANN &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># 0 = normal NN, 1=CANN</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="cf">if</span> (CANN<span class="op">==</span><span class="dv">1</span>){</span>
<span id="cb26-3"><a href="#cb26-3"></a>     Vtrain &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_train<span class="op">$</span>fitGAM1))</span>
<span id="cb26-4"><a href="#cb26-4"></a>     Vvalid&lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_valid<span class="op">$</span>fitGAM1))</span>
<span id="cb26-5"><a href="#cb26-5"></a>     Vtest &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_test<span class="op">$</span>fitGAM1))</span>
<span id="cb26-6"><a href="#cb26-6"></a>}</span></code></pre></div>
</div>
<div id="ç¥ç»ç½‘ç»œç»“æ„" class="section level2">
<h2><span class="header-section-number">3.4</span> ç¥ç»ç½‘ç»œç»“æ„</h2>
<p><img src="./plots/1/nn-structure.png" width="60%" style="display: block; margin: auto;" /></p>
<p>åœ¨æ„å»ºç¥ç»ç½‘ç»œæ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<div id="ç»“æ„å‚æ•°" class="section level3">
<h3><span class="header-section-number">3.4.1</span> ç»“æ„å‚æ•°</h3>
<ol style="list-style-type: decimal">
<li>ç¥ç»ç½‘ç»œç»“æ„çš„è¶…å‚æ•°é€‰æ‹©ï¼Œ<code>BrLabel</code>ä¸ºè½¦å‹ä¸ªæ•°ï¼Œ<code>ReLabel</code>ä¸ºåœ°åŒºä¸ªæ•°ï¼Œ<code>q1-q4</code>ä¸ºå››ä¸ªéšè—å±‚ä¸­ç¥ç»å…ƒä¸ªæ•°ï¼Œ<code>d</code>ä¸ºembedding layerä¸­ç¥ç»å…ƒä¸ªæ•°ã€‚</li>
</ol>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># hyperparameters of the neural network architecture</span></span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a>(BrLabel &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(dat2_train<span class="op">$</span>VehBrandX)))</span>
<span id="cb27-4"><a href="#cb27-4"></a>(ReLabel &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(dat2_train<span class="op">$</span>RegionX)))</span>
<span id="cb27-5"><a href="#cb27-5"></a>q1 &lt;-<span class="st"> </span><span class="dv">20</span>   </span>
<span id="cb27-6"><a href="#cb27-6"></a>q2 &lt;-<span class="st"> </span><span class="dv">15</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>q3 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb27-8"><a href="#cb27-8"></a>q4 &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb27-9"><a href="#cb27-9"></a>d &lt;-<span class="st"> </span><span class="dv">1</span>        <span class="co"># dimensions embedding layers for categorical features</span></span></code></pre></div>
</div>
<div id="è¾“å…¥å±‚" class="section level3">
<h3><span class="header-section-number">3.4.2</span> è¾“å…¥å±‚</h3>
<ol start="2" style="list-style-type: decimal">
<li><p>è¾“å…¥å±‚åŒ…æ‹¬<code>Design, VehBrand, Region, LogVol</code>ï¼Œå…¶ä¸­<code>Design</code>ä¸ºè¿ç»­å‹åå˜é‡çš„è¾“å…¥å±‚ï¼Œ<code>VehBrand, Region</code>ä¸ºåˆ†ç±»å˜é‡çš„è¾“å…¥å±‚ï¼Œ<code>LogVol</code>ç›´æ¥è¿æ¥åˆ°æ¨¡å‹è¾“å‡ºç¥ç»å…ƒã€‚</p></li>
<li><p><code>shape</code>è¡¨ç¤ºè¾“å…¥ï¼ˆè¾“å‡ºï¼‰ç»´åº¦ï¼ˆç¥ç»å…ƒä¸ªæ•°ï¼‰,<code>dtype</code>è¡¨ç¤ºæ•°æ®ç±»å‹ï¼Œ<code>name</code>è¡¨ç¤ºå±‚åã€‚</p></li>
<li><p><code>shape=(None, 7)</code> ä¸­<code>None</code>è¡¨ç¤ºæ ·æœ¬å¤§å°ï¼Œå› ä¸ºè¿˜æ²¡æœ‰æ•°æ®è¿›å…¥ç¥ç»ç½‘ç»œï¼Œæ•…æ­¤æ—¶ä¸ç¡®å®šã€‚</p>
<p>Tensor(â€œDesign_1:0â€, shape=(None, 7), dtype=float32)</p></li>
</ol>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># input layer</span></span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a>(Design   &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(q0),  <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;Design&#39;</span>))</span>
<span id="cb28-4"><a href="#cb28-4"></a>(VehBrand &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>),   <span class="dt">dtype =</span> <span class="st">&#39;int32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;VehBrand&#39;</span>))</span>
<span id="cb28-5"><a href="#cb28-5"></a>(Region   &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>),   <span class="dt">dtype =</span> <span class="st">&#39;int32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;Region&#39;</span>))</span>
<span id="cb28-6"><a href="#cb28-6"></a>(LogVol   &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>),   <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;LogVol&#39;</span>))</span></code></pre></div>
</div>
<div id="embedding-layer" class="section level3">
<h3><span class="header-section-number">3.4.3</span> Embedding layer</h3>
<ol start="5" style="list-style-type: decimal">
<li><p>å»ºç«‹ä¸€ä¸ªlayerï¼Œéœ€è¦æ˜ç¡®è¾“å…¥ç¥ç»å…ƒä¸ªæ•°<code>input_dim</code>å’Œè¾“å‡ºç¥ç»å…ƒä¸ªæ•°<code>output_dim</code>ï¼Œé€šå¸¸éœ€è¦æŒ‡å®šè¾“å‡ºç¥ç»å…ƒä¸ªæ•°ï¼Œè€Œè¾“å…¥ç¥ç»å…ƒä¸ªæ•°ç”±å®ƒçš„ä¸Šå±‚è¾“å‡ºç¥ç»å…ƒä¸ªæ•°å†³å®šã€‚</p></li>
<li><p>æŠŠåˆ†ç±»å˜é‡ç”¨<code>layer_embedding</code>å¤„ç†ï¼Œè¿™ä¸¤ä¸ª<code>layer_embedding</code>çš„è¾“å‡ºç¥ç»å…ƒä¸ªæ•°ä¸º<span class="math inline">\(d\)</span>ï¼Œå³æ¯ä¸ªæ°´å¹³é€šè¿‡<code>layer_embedding</code>è¾“å‡º<span class="math inline">\(d\)</span>ä¸ªè¿ç»­å‹å˜é‡ï¼Œå½“<span class="math inline">\(d=1\)</span>ï¼Œ<code>layer_embedding</code>ç±»ä¼¼äºGLMå¯¹åˆ†ç±»å˜é‡çš„å¤„ç†ã€‚<code>input_length</code>ä¸»è¦ç”¨äºæ—¶é—´åºåˆ—æ•°æ®ï¼Œå¦‚æ¯ä¸ªæ ·æœ¬ä¸ºå¤šä¸ªè¯ç»„æˆçš„ä¸€å¥è¯ï¼Œè¿™é‡Œä¸€ä¸ªæ ·æœ¬åªæœ‰ä¸€ä¸ªæ°´å¹³ï¼Œæ•…<code>input_length = 1</code>ã€‚</p></li>
<li><p><code>layer_flatten</code>ç”¨äºè°ƒæ•´ç»´åº¦ï¼Œ<code>layer_flatten</code>çš„è¾“å…¥ç»´åº¦æ˜¯<span class="math inline">\(n\times 1\times d\)</span>ï¼Œè¾“å‡ºç»´åº¦æ˜¯<span class="math inline">\(n\times d\)</span>ï¼Œè¯¥å±‚æ²¡æœ‰å‚æ•°ã€‚è¯¥è¾“å‡ºç»´åº¦æ˜¯<code>layer_dense</code>è¦æ±‚çš„è¾“å…¥ç»´åº¦ã€‚å»ºç«‹ç¥ç»ç½‘ç»œéœ€è¦æ³¨æ„å±‚é—´ç»´åº¦åŒ¹é…ã€‚</p></li>
<li><p><code>BrandEmb</code>å»ºç«‹çš„æ˜ å°„ä¸º<span class="math inline">\(\{1,\ldots,11\}\rightarrow 1\times\mathbf{R}^d\rightarrow\mathbf{R}^d\)</span>. <code>RegionEmb</code>å»ºç«‹çš„æ˜ å°„ä¸º<span class="math inline">\(\{1,\ldots,21\}\rightarrow 1\times\mathbf{R}^d\rightarrow\mathbf{R}^d\)</span></p></li>
</ol>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># embedding layer</span></span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a>(<span class="dt">BrandEmb =</span> VehBrand <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="st">    </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> BrLabel, <span class="dt">output_dim =</span> d, </span>
<span id="cb29-5"><a href="#cb29-5"></a>                    <span class="dt">input_length =</span> <span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&#39;BrandEmb&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="st">   </span><span class="kw">layer_flatten</span>(<span class="dt">name=</span><span class="st">&#39;Brand_flat&#39;</span>))</span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="co"># input_dim is the size of vocabulary; input_length is the length of input sequences</span></span>
<span id="cb29-8"><a href="#cb29-8"></a>    </span>
<span id="cb29-9"><a href="#cb29-9"></a>(<span class="dt">RegionEmb =</span> Region <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="st">      </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> ReLabel, <span class="dt">output_dim =</span> d, </span>
<span id="cb29-11"><a href="#cb29-11"></a>                      <span class="dt">input_length =</span> <span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&#39;RegionEmb&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="st">      </span><span class="kw">layer_flatten</span>(<span class="dt">name=</span><span class="st">&#39;Region_flat&#39;</span>))</span></code></pre></div>
</div>
<div id="éšè—å±‚" class="section level3">
<h3><span class="header-section-number">3.4.4</span> éšè—å±‚</h3>
<p>9 <code>Network</code>å»ºç«‹çš„æ˜ å°„ä¸º<span class="math display">\[[-1,1]^{q0}\times\mathbf{R}^d\times\mathbf{R}^d\rightarrow (-1,1)^{q1}\rightarrow (-1,1)^{q2}\\ \rightarrow (-1,1)^{q3}\rightarrow (-1,1)^{q4}\rightarrow\mathbf{R}\]</span></p>
<ol start="10" style="list-style-type: decimal">
<li><p><code>layer_concatenate</code>æŠŠä¸‰ä¸ªè¾“å…¥å±‚è¿èµ·æ¥ï¼Œ<code>layer_dropout</code>ä¸ºé˜²æ­¢è¿‡æ‹Ÿåˆï¼Œ<code>layer_batch_normalization</code>ä¸ºé˜²æ­¢vanishing gradient problemï¼Œè¿™ä¸‰ç§å±‚å†…æ— å‚æ•°ï¼Œä¸”ä¸ä¼šæ”¹å˜ä¸Šå±‚çš„ç»´åº¦ã€‚<code>layer_dropout</code>ä»¤ä¸€å®šæ¯”ä¾‹çš„ä¸Šå±‚ç¥ç»å…ƒä¸º0ï¼Œæ­£åˆ™åŒ–æ–¹æ³•è¿˜åŒ…æ‹¬åœ¨<code>layer_dense</code>ä¸­ä½¿ç”¨<span class="math inline">\(L^2\)</span>èŒƒæ•°æ­£åˆ™åŒ–<code>kernel_regularizer = regularizer_l2</code>ã€‚<code>layer_batch_normalization</code>æŠŠè¾“å‡ºç¥ç»å…ƒæ˜ å°„åˆ°<span class="math inline">\((-1,1)\)</span>ï¼Œé€šå¸¸åœ¨æ¿€æ´»å‡½æ•°ä¸º<code>relu</code>æ›´æœ‰ç”¨ã€‚</p></li>
<li><p>å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ä¸º<code>tanh, relu, linear, exponential, softmax, sigmoid</code>ã€‚å…¶ä¸­ï¼Œ<code>sigmoid, softmax</code>é€‚ç”¨äºäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»çš„è¾“å‡ºç¥ç»å…ƒï¼Œ<code>exponential</code>é€‚ç”¨äºå› å˜é‡ä¸ºæ­£ï¼Œå¦‚æ­¤æ—¶çš„ç´¢èµ”é¢‘ç‡é¢„æµ‹ã€‚æ­¤å¤–<code>sigmoid</code>å’Œ<code>tanh</code>æœ‰çº¿æ€§å…³ç³»ï¼Œå¯ä»¥åªè€ƒè™‘å…¶ä¸­ä¸€ä¸ªã€‚</p></li>
<li><p><code>layer_dense</code>çš„æ˜ å°„ä¸º<code>output = activation (dot (input, kernal) + bias)</code>ï¼Œæ‰€ä»¥æ¯ä¸ªè¾“å‡ºç¥ç»å…ƒéƒ½å«æœ‰è¾“å…¥ç¥ç»å…ƒçš„ä¿¡æ¯ã€‚å¦‚æœè€ƒè™‘å¤šä¸ªå…¨è¿æ¥å±‚ï¼Œå¯ä»¥åˆ»ç”»åå˜é‡çš„äº¤äº’æ•ˆåº”ç°ã€‚æ¿€æ´»å‡½æ•°å¦‚æœå–éçº¿æ€§å‡½æ•°ï¼Œåˆ™å¯ä»¥åˆ»ç”»åå˜é‡çš„éçº¿æ€§æ•ˆåº”ã€‚</p></li>
<li><p><code>Network</code>ä¸­æœ€åä¸€å±‚çš„å‚æ•°è®¾å®šä¸º0ï¼Œä½¿å¾—<code>Network</code>åˆå§‹å€¼ä¸º0ï¼Œè¿™æ ·ç¥ç»ç½‘ç»œåˆå§‹çŠ¶æ€ä¸ºGAMï¼Œæ¢¯åº¦ä¸‹é™å°†ä»GAMå¼€å§‹ã€‚</p></li>
</ol>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>Network =<span class="st"> </span><span class="kw">list</span>(Design, BrandEmb, RegionEmb) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_concatenate</span>(<span class="dt">name=</span><span class="st">&#39;concate&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q1, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden1&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q2, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden2&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q3, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden3&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q4, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden4&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="st">          </span><span class="kw">layer_batch_normalization</span>()<span class="op">%&gt;%</span></span>
<span id="cb30-13"><a href="#cb30-13"></a><span class="st">          </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span><span class="fl">0.05</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-14"><a href="#cb30-14"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">name=</span><span class="st">&#39;Network&#39;</span>,</span>
<span id="cb30-15"><a href="#cb30-15"></a>                      <span class="dt">weights =</span> <span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(q4,<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span></code></pre></div>
</div>
<div id="è¾“å‡ºå±‚" class="section level3">
<h3><span class="header-section-number">3.4.5</span> è¾“å‡ºå±‚</h3>
<ol start="14" style="list-style-type: decimal">
<li><p><code>Response</code>å»ºç«‹çš„æ˜ å°„ä¸º<span class="math inline">\(\mathbf{R}\times \mathbf{R}\rightarrow \mathbf{R}^+\)</span>ï¼Œä¸”è¦æ±‚è¯¥æ˜ å°„ä¸­çš„å‚æ•°ä¸å‚åŠ æ¢¯åº¦ä¸‹é™æ³•ã€‚å¯ä»¥çœ‹åˆ°<code>Network</code>çš„è¾“å‡ºç¥ç»å…ƒä¸º<span class="math inline">\(\ln \hat{\lambda}^{\text{NN}}(\mathbf{x})\)</span>ï¼Œè¾“å…¥å±‚<code>LogVol</code>ä¸º<span class="math inline">\(\ln e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\)</span>ï¼Œ<code>Response</code>çš„è¾“å‡ºç¥ç»å…ƒä¸º<span class="math display">\[\exp\left(\ln \hat{\lambda}^{\text{NN}}(\mathbf{x}) + \ln e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\right)=e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\hat{\lambda}^{\text{NN}}(\mathbf{x}).\]</span></p></li>
<li><p>é€šè¿‡æ¢¯åº¦ä¸‹é™æ³•ä½¿å¾—è¾“å‡ºç¥ç»å…ƒ<span class="math inline">\(e\hat{\lambda}^{\text{GAM}}(\mathbf{x})\hat{\lambda}^{\text{NN}}(\mathbf{x})\)</span>ä¸è§‚å¯Ÿå€¼<span class="math inline">\(N\)</span>æœ€æ¥è¿‘ï¼ˆç”¨æ³Šæ¾åå·®æŸå¤±åº¦é‡ï¼‰ï¼Œè¿›è€Œè®­ç»ƒç¥ç»ç½‘ç»œ<span class="math inline">\(\hat{\lambda}^{\text{NN}}(\mathbf{x})\)</span>ä¸­çš„å‚æ•°ã€‚</p></li>
<li><p>Keraså®šä¹‰å¹³å‡æ³Šæ¾åå·®æŸå¤±ä¸º</p></li>
</ol>
<p><span class="math display">\[\tilde{\mathcal{L}}(\mathbf{N},\mathbf{\hat{N}})=\frac{1}{|\mathbf{N}|}\sum_{i}\left[\hat{N}_i-N_i\ln\left(\hat{N}_i\right)\right]\]</span></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>Response =<span class="st"> </span><span class="kw">list</span>(Network, LogVol) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_add</span>(<span class="dt">name=</span><span class="st">&#39;Add&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="st">           </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span>k_exp, <span class="dt">name =</span> <span class="st">&#39;Response&#39;</span>, <span class="dt">trainable=</span><span class="ot">FALSE</span>,</span>
<span id="cb31-3"><a href="#cb31-3"></a>                        <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">1</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb31-4"><a href="#cb31-4"></a></span>
<span id="cb31-5"><a href="#cb31-5"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> <span class="kw">c</span>(Design, VehBrand, Region, LogVol), <span class="dt">outputs =</span> <span class="kw">c</span>(Response))</span>
<span id="cb31-6"><a href="#cb31-6"></a>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;poisson&#39;</span>)</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="kw">summary</span>(model)</span></code></pre></div>
<ol start="17" style="list-style-type: decimal">
<li>ä¸‹è¡¨åˆ—å‡ºäº†ç¥ç»ç½‘ç»œçš„ç»“æ„ï¼ŒåŒ…æ‹¬å±‚çš„åç§°ã€(å±‚çš„ç‰¹æ€§)ã€è¾“å‡ºç¥ç»å…ƒä¸ªæ•°ã€å‚æ•°ä¸ªæ•°ã€ä¸Šå±‚çš„åç§°ã€‚</li>
</ol>
<pre><code>Model: &quot;model&quot;
________________________________________________________________________________________________________________________________
Layer (type)                              Output Shape                Param #        Connected to                               
================================================================================================================================
VehBrand (InputLayer)                     [(None, 1)]                 0                                                         
________________________________________________________________________________________________________________________________
Region (InputLayer)                       [(None, 1)]                 0                                                         
________________________________________________________________________________________________________________________________
BrandEmb (Embedding)                      (None, 1, 1)                11             VehBrand[0][0]                             
________________________________________________________________________________________________________________________________
RegionEmb (Embedding)                     (None, 1, 1)                21             Region[0][0]                               
________________________________________________________________________________________________________________________________
Design (InputLayer)                       [(None, 7)]                 0                                                         
________________________________________________________________________________________________________________________________
Brand_flat (Flatten)                      (None, 1)                   0              BrandEmb[0][0]                             
________________________________________________________________________________________________________________________________
Region_flat (Flatten)                     (None, 1)                   0              RegionEmb[0][0]                            
________________________________________________________________________________________________________________________________
concate (Concatenate)                     (None, 9)                   0              Design[0][0]                               
                                                                                     Brand_flat[0][0]                           
                                                                                     Region_flat[0][0]                          
________________________________________________________________________________________________________________________________
hidden1 (Dense)                           (None, 20)                  200            concate[0][0]                              
________________________________________________________________________________________________________________________________
batch_normalization_1 (BatchNormalization (None, 20)                  80             hidden1[0][0]                              
________________________________________________________________________________________________________________________________
dropout (Dropout)                         (None, 20)                  0              batch_normalization_1[0][0]                
________________________________________________________________________________________________________________________________
hidden2 (Dense)                           (None, 15)                  315            dropout[0][0]                              
________________________________________________________________________________________________________________________________
batch_normalization_2 (BatchNormalization (None, 15)                  60             hidden2[0][0]                              
________________________________________________________________________________________________________________________________
dropout_1 (Dropout)                       (None, 15)                  0              batch_normalization_2[0][0]                
________________________________________________________________________________________________________________________________
hidden3 (Dense)                           (None, 10)                  160            dropout_1[0][0]                            
________________________________________________________________________________________________________________________________
batch_normalization_3 (BatchNormalization (None, 10)                  40             hidden3[0][0]                              
________________________________________________________________________________________________________________________________
dropout_2 (Dropout)                       (None, 10)                  0              batch_normalization_3[0][0]                
________________________________________________________________________________________________________________________________
hidden4 (Dense)                           (None, 5)                   55             dropout_2[0][0]                            
________________________________________________________________________________________________________________________________
batch_normalization_4 (BatchNormalization (None, 5)                   20             hidden4[0][0]                              
________________________________________________________________________________________________________________________________
dropout_3 (Dropout)                       (None, 5)                   0              batch_normalization_4[0][0]                
________________________________________________________________________________________________________________________________
Network (Dense)                           (None, 1)                   6              dropout_3[0][0]                            
________________________________________________________________________________________________________________________________
LogVol (InputLayer)                       [(None, 1)]                 0                                                         
________________________________________________________________________________________________________________________________
Add (Add)                                 (None, 1)                   0              Network[0][0]                              
                                                                                     LogVol[0][0]                               
________________________________________________________________________________________________________________________________
Response (Dense)                          (None, 1)                   2              Add[0][0]                                  
================================================================================================================================
Total params: 970
Trainable params: 868
Non-trainable params: 102
________________________________________________________________________________________________________________________________</code></pre>
</div>
</div>
<div id="è®­ç»ƒç¥ç»ç½‘ç»œ-1" class="section level2">
<h2><span class="header-section-number">3.5</span> è®­ç»ƒç¥ç»ç½‘ç»œ</h2>
<p>è®­ç»ƒç¥ç»ç½‘ç»œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹åŒ–ç¥ç»ç½‘ç»œï¼Œå°†ä»GAMå¼€å§‹è®­ç»ƒç¥ç»ç½‘ç»œï¼Œä¸”GAMé¢„æµ‹éƒ¨åˆ†ä¿æŒä¸å˜ã€‚</p></li>
<li><p>å½“<code>batch_size</code>ä¸ºå…¨ä½“è®­ç»ƒé›†æ—¶ï¼Œä¸º<em>steepest gradient decent method</em>ï¼Œå‚æ•°åœ¨ä¸€ä¸ª<code>epoch</code>åªè¿­ä»£ä¸€æ¬¡ã€‚</p></li>
<li><p>å½“<code>batch_size</code>æ¯”å…¨ä½“è®­ç»ƒé›†å°æ—¶ï¼Œä¸º<em>stochastic gradient decent method</em>ï¼Œå‚æ•°åœ¨ä¸€ä¸ª<code>epoch</code>è¿­ä»£æ¬¡æ•°çº¦ä¸º<code>training size / batch size</code>ã€‚</p></li>
<li><p>æ¢¯åº¦ä¸‹é™æ³•å¸¸å¼•å…¥<em>momentum</em>ï¼Œè¿›è€Œæå‡ä¼˜åŒ–æ•ˆç‡ï¼Œå¦‚<code>adam, nadam,rmsprop</code>ç­‰ï¼Œè¿™äº›ç®—æ³•è‡ªåŠ¨é€‰æ‹©<code>learning rate, momentum parameters</code>ç­‰ã€‚</p></li>
<li><p><code>callback_early_stopping (monitor = "val_loss", patience =10)</code>è¡¨ç¤ºå¦‚æœéªŒè¯é›†æŸå¤±åœ¨10æ¬¡å†…æ²¡æœ‰æå‡ï¼Œé‚£ä¹ˆåœæ­¢è®­ç»ƒï¼Œç”±æ­¤å¯ä»¥æ§åˆ¶è¿­ä»£æ¬¡æ•°ã€‚</p></li>
<li><p>ä½¿ç”¨<code>predict</code>åœ¨æµ‹è¯•é›†ä¸Šé¢„æµ‹ã€‚</p></li>
</ol>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># fitting the neural network</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>early_stop &lt;-<span class="st"> </span><span class="kw">callback_early_stopping</span>(<span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">patience =</span><span class="dv">10</span>)</span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="co"># print_dot_callback &lt;- callback_lambda(</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="co">#   on_epoch_end = function(epoch, logs) {</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="co">#     if (epoch %% 50 == 0) cat(&quot;\n&quot;)</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="co">#     cat(&quot;.&quot;)</span></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="co">#   }</span></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="co"># )  </span></span>
<span id="cb33-9"><a href="#cb33-9"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>();</span>
<span id="cb33-10"><a href="#cb33-10"></a>fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="kw">list</span>(Xtrain, Brtrain, Retrain, Vtrain), Ytrain,</span>
<span id="cb33-11"><a href="#cb33-11"></a>                     <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">batch_size=</span><span class="dv">5000</span>, <span class="dt">verbose=</span><span class="dv">1</span>,</span>
<span id="cb33-12"><a href="#cb33-12"></a>                     <span class="dt">validation_data=</span><span class="kw">list</span>(xxvalid,Yvalid),</span>
<span id="cb33-13"><a href="#cb33-13"></a>                     <span class="dt">callbacks=</span><span class="kw">list</span>(early_stop));</span>
<span id="cb33-14"><a href="#cb33-14"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb33-15"><a href="#cb33-15"></a></span>
<span id="cb33-16"><a href="#cb33-16"></a><span class="co"># png(&quot;./plots/1/nn.png&quot;)</span></span>
<span id="cb33-17"><a href="#cb33-17"></a><span class="kw">matplot</span>(<span class="kw">cbind</span>(fit<span class="op">$</span>metrics<span class="op">$</span>loss,fit<span class="op">$</span>metrics<span class="op">$</span>val_loss), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>,<span class="dt">xlab=</span><span class="st">&quot;epoch&quot;</span>,<span class="dt">ylab=</span><span class="st">&quot;Keras Poisson Loss&quot;</span>)</span>
<span id="cb33-18"><a href="#cb33-18"></a><span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;training loss&quot;</span>,<span class="st">&quot;validation loss&quot;</span>),<span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">col=</span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</span>
<span id="cb33-19"><a href="#cb33-19"></a><span class="co"># dev.off()</span></span>
<span id="cb33-20"><a href="#cb33-20"></a></span>
<span id="cb33-21"><a href="#cb33-21"></a><span class="co"># calculating the predictions</span></span>
<span id="cb33-22"><a href="#cb33-22"></a>dat2_test<span class="op">$</span>fitNN &lt;-<span class="st"> </span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">list</span>(Xtest, Brtest, Retest, Vtest)))</span>
<span id="cb33-23"><a href="#cb33-23"></a><span class="kw">keras_poisson_dev</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb)</span>
<span id="cb33-24"><a href="#cb33-24"></a><span class="kw">Poisson.Deviance</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb)</span></code></pre></div>
<p><img src="./plots/1/nn.png" width="60%"  style="display: block; margin: auto;" /></p>
</div>
<div id="æ€»ç»“" class="section level2">
<h2><span class="header-section-number">3.6</span> æ€»ç»“</h2>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>dev_sum&lt;-<span class="kw">fread</span>(<span class="st">&quot;./plots/1/dev_sum.csv&quot;</span>)[,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb34-2"><a href="#cb34-2"></a>AD&lt;-<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="st">&quot;Neural network&quot;</span>,<span class="dt">test_error=</span><span class="dv">0</span>,<span class="dt">test_error_keras=</span><span class="dv">0</span>)</span>
<span id="cb34-3"><a href="#cb34-3"></a>dev_sum&lt;-<span class="kw">rbind</span>(dev_sum,AD)</span>
<span id="cb34-4"><a href="#cb34-4"></a>dev_sum<span class="op">$</span>test_error[<span class="dv">8</span>]&lt;-<span class="kw">round</span>(<span class="kw">Poisson.Deviance</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb),<span class="dv">4</span>)</span>
<span id="cb34-5"><a href="#cb34-5"></a>dev_sum<span class="op">$</span>test_error_keras[<span class="dv">8</span>]&lt;-<span class="kw">round</span>(<span class="kw">keras_poisson_dev</span>(dat2_test<span class="op">$</span>fitNN, dat2_test<span class="op">$</span>ClaimNb),<span class="dv">4</span>)</span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="co"># write.csv(dev_sum,&quot;./plots/1/dev_sum.csv&quot;)</span></span></code></pre></div>
<p><img src="03-nn_files/figure-html/sum output-1.png" width="672"  /></p>
<ul>
<li><p>Boosting &gt; RF &gt; Tree &gt; NN &gt; GAM &gt; GLM &gt; Homo</p></li>
<li><p>Boosting, RF, Tree, NNç›¸è¾ƒäºGAMçš„æå‡ä¸»è¦åœ¨äºäº¤äº’ä½œç”¨ï¼›GAMç›¸è¾ƒäºGLMçš„æå‡ä¸å¤§ï¼ŒåŸå› æ˜¯åœ¨GLMä¸­è¿›è¡Œäº†åˆé€‚çš„ç‰¹å¾å·¥ç¨‹ï¼Œå¯ä»¥åˆ»ç”»éçº¿æ€§æ•ˆåº”ã€‚</p></li>
</ul>
</div>
<div id="å…¶å®ƒæ¨¡å‹" class="section level2">
<h2><span class="header-section-number">3.7</span> å…¶å®ƒæ¨¡å‹</h2>
<p>é€šè¿‡å°è¯•å‘ç°ï¼Œä¸»è¦å­˜åœ¨ä¸¤ä¸ªäº¤äº’ä½œç”¨ï¼š<code>VehPower, VehAge, VehGas, VehBrand</code>å’Œ<code>DriAge, BonusMalus</code>ï¼Œå¯è®¾ç«‹å¦‚ä¸‹ç®€åŒ–çš„ç¥ç»ç½‘ç»œæå‡æ¨¡å‹ã€‚</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>train.x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.matrix</span>(dat2_train[,<span class="kw">c</span>(<span class="st">&quot;VehPowerX&quot;</span>, <span class="st">&quot;VehAgeX&quot;</span>, <span class="st">&quot;VehGasX&quot;</span>)]),</span>
<span id="cb35-2"><a href="#cb35-2"></a>                <span class="kw">as.matrix</span>(dat2_train[,<span class="st">&quot;VehBrandX&quot;</span>]),</span>
<span id="cb35-3"><a href="#cb35-3"></a>                <span class="kw">as.matrix</span>(dat2_train[,<span class="kw">c</span>(<span class="st">&quot;DrivAgeX&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>)]),</span>
<span id="cb35-4"><a href="#cb35-4"></a>                <span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_train<span class="op">$</span>fitGAM1)) )</span>
<span id="cb35-5"><a href="#cb35-5"></a>valid.x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.matrix</span>(dat2_valid[,<span class="kw">c</span>(<span class="st">&quot;VehPowerX&quot;</span>, <span class="st">&quot;VehAgeX&quot;</span>, <span class="st">&quot;VehGasX&quot;</span>)]),</span>
<span id="cb35-6"><a href="#cb35-6"></a>                <span class="kw">as.matrix</span>(dat2_valid[,<span class="st">&quot;VehBrandX&quot;</span>]),</span>
<span id="cb35-7"><a href="#cb35-7"></a>                <span class="kw">as.matrix</span>(dat2_valid[,<span class="kw">c</span>(<span class="st">&quot;DrivAgeX&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>)]),</span>
<span id="cb35-8"><a href="#cb35-8"></a>                <span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_valid<span class="op">$</span>fitGAM1)) )</span>
<span id="cb35-9"><a href="#cb35-9"></a>test.x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.matrix</span>(dat2_test[,<span class="kw">c</span>(<span class="st">&quot;VehPowerX&quot;</span>, <span class="st">&quot;VehAgeX&quot;</span>, <span class="st">&quot;VehGasX&quot;</span>)]),</span>
<span id="cb35-10"><a href="#cb35-10"></a>                <span class="kw">as.matrix</span>(dat2_test[,<span class="st">&quot;VehBrandX&quot;</span>]),</span>
<span id="cb35-11"><a href="#cb35-11"></a>                <span class="kw">as.matrix</span>(dat2_test[,<span class="kw">c</span>(<span class="st">&quot;DrivAgeX&quot;</span>, <span class="st">&quot;BonusMalus&quot;</span>)]),</span>
<span id="cb35-12"><a href="#cb35-12"></a>                <span class="kw">as.matrix</span>(<span class="kw">log</span>(dat1_test<span class="op">$</span>fitGAM1)) )</span>
<span id="cb35-13"><a href="#cb35-13"></a></span>
<span id="cb35-14"><a href="#cb35-14"></a>neurons &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">15</span>,<span class="dv">10</span>,<span class="dv">5</span>)</span>
<span id="cb35-15"><a href="#cb35-15"></a></span>
<span id="cb35-16"><a href="#cb35-16"></a>model<span class="fl">.2</span>IA &lt;-<span class="st"> </span><span class="cf">function</span>(Brlabel){</span>
<span id="cb35-17"><a href="#cb35-17"></a>   Cont1        &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">3</span>), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name=</span><span class="st">&#39;Cont1&#39;</span>)</span>
<span id="cb35-18"><a href="#cb35-18"></a>   Cat1         &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dtype =</span> <span class="st">&#39;int32&#39;</span>,   <span class="dt">name=</span><span class="st">&#39;Cat1&#39;</span>)</span>
<span id="cb35-19"><a href="#cb35-19"></a>   Cont2        &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">2</span>), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name=</span><span class="st">&#39;Cont2&#39;</span>)</span>
<span id="cb35-20"><a href="#cb35-20"></a>   LogExposure  &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;LogExposure&#39;</span>) </span>
<span id="cb35-21"><a href="#cb35-21"></a>   </span>
<span id="cb35-22"><a href="#cb35-22"></a>   x.input &lt;-<span class="st"> </span><span class="kw">c</span>(Cont1, Cat1, Cont2, LogExposure)</span>
<span id="cb35-23"><a href="#cb35-23"></a>   <span class="co">#</span></span>
<span id="cb35-24"><a href="#cb35-24"></a>   Cat1_embed =<span class="st"> </span>Cat1 <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb35-25"><a href="#cb35-25"></a><span class="st">            </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> Brlabel, <span class="dt">output_dim =</span> <span class="dv">1</span>, <span class="dt">trainable=</span><span class="ot">TRUE</span>, </span>
<span id="cb35-26"><a href="#cb35-26"></a>                    <span class="dt">input_length =</span> <span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&#39;Cat1_embed&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-27"><a href="#cb35-27"></a><span class="st">                    </span><span class="kw">layer_flatten</span>(<span class="dt">name=</span><span class="st">&#39;Cat1_flat&#39;</span>)</span>
<span id="cb35-28"><a href="#cb35-28"></a>   <span class="co">#</span></span>
<span id="cb35-29"><a href="#cb35-29"></a>   NNetwork1 =<span class="st"> </span><span class="kw">list</span>(Cont1, Cat1_embed) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_concatenate</span>(<span class="dt">name=</span><span class="st">&#39;cont&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-30"><a href="#cb35-30"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">1</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden1&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-31"><a href="#cb35-31"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">2</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden2&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-32"><a href="#cb35-32"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">3</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden3&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-33"><a href="#cb35-33"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">name=</span><span class="st">&#39;NNetwork1&#39;</span>, </span>
<span id="cb35-34"><a href="#cb35-34"></a>                    <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(neurons[<span class="dv">3</span>],<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb35-35"><a href="#cb35-35"></a>   <span class="co">#</span></span>
<span id="cb35-36"><a href="#cb35-36"></a>   NNetwork2 =<span class="st"> </span>Cont2 <span class="op">%&gt;%</span></span>
<span id="cb35-37"><a href="#cb35-37"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">1</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden4&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-38"><a href="#cb35-38"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">2</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden5&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-39"><a href="#cb35-39"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>neurons[<span class="dv">3</span>], <span class="dt">activation=</span><span class="st">&#39;relu&#39;</span>, <span class="dt">name=</span><span class="st">&#39;hidden6&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-40"><a href="#cb35-40"></a><span class="st">            </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">name=</span><span class="st">&#39;NNetwork2&#39;</span>, </span>
<span id="cb35-41"><a href="#cb35-41"></a>                    <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(neurons[<span class="dv">3</span>],<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb35-42"><a href="#cb35-42"></a></span>
<span id="cb35-43"><a href="#cb35-43"></a>   <span class="co">#</span></span>
<span id="cb35-44"><a href="#cb35-44"></a>   NNoutput =<span class="st"> </span><span class="kw">list</span>(NNetwork1, NNetwork2, LogExposure) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">layer_add</span>(<span class="dt">name=</span><span class="st">&#39;Add&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-45"><a href="#cb35-45"></a><span class="st">                 </span><span class="kw">layer_dense</span>(<span class="dt">units=</span><span class="dv">1</span>, <span class="dt">activation=</span>k_exp, <span class="dt">name =</span> <span class="st">&#39;NNoutput&#39;</span>, <span class="dt">trainable=</span><span class="ot">FALSE</span>,</span>
<span id="cb35-46"><a href="#cb35-46"></a>                       <span class="dt">weights=</span><span class="kw">list</span>(<span class="kw">array</span>(<span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)), <span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>))))</span>
<span id="cb35-47"><a href="#cb35-47"></a></span>
<span id="cb35-48"><a href="#cb35-48"></a>   model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> x.input, <span class="dt">outputs =</span> <span class="kw">c</span>(NNoutput))</span>
<span id="cb35-49"><a href="#cb35-49"></a>   model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;poisson&#39;</span>)        </span>
<span id="cb35-50"><a href="#cb35-50"></a>   model</span>
<span id="cb35-51"><a href="#cb35-51"></a>   }</span>
<span id="cb35-52"><a href="#cb35-52"></a></span>
<span id="cb35-53"><a href="#cb35-53"></a>model &lt;-<span class="st"> </span><span class="kw">model.2IA</span>(BrLabel)</span>
<span id="cb35-54"><a href="#cb35-54"></a><span class="kw">summary</span>(model)</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>early_stop &lt;-<span class="st"> </span><span class="kw">callback_early_stopping</span>(<span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">patience =</span><span class="dv">10</span>)</span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="co"># print_dot_callback &lt;- callback_lambda(</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">#   on_epoch_end = function(epoch, logs) {</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co">#     if (epoch %% 50 == 0) cat(&quot;\n&quot;)</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">#     cat(&quot;.&quot;)</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="co">#   }</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="co"># )  </span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="co"># may take a couple of minutes if epochs is more than 100</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb36-10"><a href="#cb36-10"></a>     fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(train.x, <span class="kw">as.matrix</span>(dat2_train<span class="op">$</span>ClaimNb), </span>
<span id="cb36-11"><a href="#cb36-11"></a>                          <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">batch_size=</span><span class="dv">10000</span>, <span class="dt">verbose=</span><span class="dv">1</span>,</span>
<span id="cb36-12"><a href="#cb36-12"></a>                                       <span class="dt">validation_data=</span><span class="kw">list</span>(valid.x,dat2_valid<span class="op">$</span>ClaimNb),</span>
<span id="cb36-13"><a href="#cb36-13"></a>                          <span class="dt">callback=</span><span class="kw">list</span>(early_stop))</span>
<span id="cb36-14"><a href="#cb36-14"></a>(<span class="kw">proc.time</span>()<span class="op">-</span>t1)}</span>
<span id="cb36-15"><a href="#cb36-15"></a></span>
<span id="cb36-16"><a href="#cb36-16"></a><span class="kw">matplot</span>(<span class="kw">cbind</span>(fit<span class="op">$</span>metrics<span class="op">$</span>loss,fit<span class="op">$</span>metrics<span class="op">$</span>val_loss), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>)</span>
<span id="cb36-17"><a href="#cb36-17"></a></span>
<span id="cb36-18"><a href="#cb36-18"></a>dat2_test<span class="op">$</span>fitGAMPlus &lt;-<span class="st"> </span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(test.x))</span>
<span id="cb36-19"><a href="#cb36-19"></a><span class="kw">Poisson.Deviance</span>(dat2_test<span class="op">$</span>fitGAMPlus, dat2_test<span class="op">$</span>ClaimNb)</span>
<span id="cb36-20"><a href="#cb36-20"></a><span class="kw">keras_poisson_dev</span>(dat2_test<span class="op">$</span>fitGAMPlus, dat2_test<span class="op">$</span>ClaimNb)</span></code></pre></div>
<!--chapter:end:03-nn.Rmd-->
</div>
</div>
<div id="boosting" class="section level1">
<h1><span class="header-section-number">4</span> æå‡æ–¹æ³• (Boosting)</h1>
<p><em>èŒƒé›¨æ–‡ã€æ¯›é›ªå©·ã€é«˜å…‰è¿œ</em></p>
<blockquote>
<p>Breiman called <strong>AdaBoost</strong> the <strong>â€˜best off-the-shelf classifier in the worldâ€™</strong> (NIPS Workshop 1996).</p>
</blockquote>
<blockquote>
<p>On the data science competition platform Kaggle, among <strong>29</strong> challenge winning solutions in 2015, <strong>17</strong> used <strong>XGBoost</strong>, a boosting algorithm introduced by Chen and Guestrin.</p>
</blockquote>
<p><strong>AdaBooståŠç›¸è¿‘ç®—æ³•</strong></p>
<p>AdaBoostæ˜¯ä¸€ç§è¿­ä»£ç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯è®­ç»ƒä¸åŒçš„åˆ†ç±»å™¨(å¼±åˆ†ç±»å™¨<span class="math inline">\(T\)</span>)ï¼Œç„¶åæŠŠè¿™äº›å¼±åˆ†ç±»å™¨çº¿æ€§ç»„åˆèµ·æ¥ï¼Œæ„æˆä¸€ä¸ªæ›´å¼ºçš„æœ€ç»ˆåˆ†ç±»å™¨ï¼ˆå¼ºåˆ†ç±»å™¨<span class="math inline">\(C\)</span>ï¼‰ã€‚</p>
<p>è¯¥ç®—æ³•æ˜¯ä¸€ä¸ªç®€å•çš„å¼±åˆ†ç±»ç®—æ³•æå‡è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šè¿‡ä¸æ–­çš„è®­ç»ƒï¼Œå¯ä»¥æé«˜å¯¹æ•°æ®çš„åˆ†ç±»èƒ½åŠ›ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ol style="list-style-type: decimal">
<li><p>é€šè¿‡å¯¹è®­ç»ƒæ ·æœ¬<span class="math inline">\((\mathcal{D},\mathbb{\omega})\)</span>çš„å­¦ä¹ å¾—åˆ°ç¬¬<span class="math inline">\(m-1\)</span>ä¸ªå¼±åˆ†ç±»å™¨<code>WeakClassifier m-1</code>, <span class="math inline">\(T^{(m-1)}\)</span>ï¼›</p></li>
<li><p>è®¡ç®—å¾—å‡ºå…¶åˆ†ç±»é”™è¯¯ç‡<span class="math inline">\(\epsilon^{(m-1)}\)</span>ï¼Œä»¥æ­¤è®¡ç®—å‡ºå…¶å¼±åˆ†ç±»å™¨æƒé‡<span class="math inline">\(\alpha^{(m-1)}\)</span>ä¸æ•°æ®æƒé‡<span class="math inline">\(\omega^{(m-1)}_i\)</span>;</p></li>
<li><p>ç”¨æƒé‡ä¸º<span class="math inline">\(\omega^{(m-1)}_i\)</span>çš„æ•°æ®é›†è®­ç»ƒå¾—åˆ°è®­ç»ƒå¼±åˆ†ç±»å™¨<code>WeakClassifier m</code>, <span class="math inline">\(T^{(m)}\)</span>;</p></li>
<li><p>é‡å¤ä»¥ä¸Šä¸æ–­è¿­ä»£çš„è¿‡ç¨‹;</p></li>
<li><p>æœ€ç»ˆç»“æœé€šè¿‡åŠ æƒæŠ•ç¥¨è¡¨å†³çš„æ–¹æ³•ï¼Œè®©æ‰€æœ‰å¼±åˆ†ç±»å™¨<span class="math inline">\(T^{(m)}\)</span>è¿›è¡Œæƒé‡ä¸º<span class="math inline">\(\alpha^{(m)}\)</span>çš„æŠ•ç¥¨è¡¨å†³çš„æ–¹æ³•å¾—åˆ°æœ€ç»ˆé¢„æµ‹è¾“å‡ºã€‚</p></li>
</ol>
<p><img src="./plots/4/overview.png" width="60%" style="display: block; margin: auto;" /></p>
<ul>
<li><p>AdaBoost: Schapire and Freund (1997, 2012)</p></li>
<li><p>LogitBoost: Friedman, Hastie, Tibshirani (1998)</p></li>
<li><p>AdaBoost.M1: Schapire and Freund (1996, 1997)</p></li>
<li><p>SAMME: Zhu, Zou, Rosset et al.Â (2006)</p></li>
<li><p>SAMME.R: Zhu, Zou, Rosset et al.Â (2006)</p></li>
</ul>
<p><strong>æ¢¯åº¦æå‡ç®—æ³•</strong></p>
<p>æ ¸å¿ƒæ€æƒ³: Gradient descent method and Newtonâ€™s method.</p>
<p><em>Gradient descent method</em></p>
<p>Minimize the following approximation over <span class="math inline">\(y\)</span>,
<span class="math display">\[f(y)\approx f(x)+\nabla f(x)^T(y-x) +\frac{1}{2t}||y-x||^2 \]</span>
we have <span class="math inline">\(y=x^+=x-t\nabla f(x)\)</span>.</p>
<p><em>Newtonâ€™s method</em></p>
<p>Minimize the following approximation over <span class="math inline">\(y\)</span>,
<span class="math display">\[f(y)\approx f(x)+\nabla f(x)^T(y-x) +\frac{1}{2}(y-x)^T\nabla^2f(x)(y-x)\]</span>
we have <span class="math inline">\(y=x^+=x-\frac{\nabla f(x)}{\nabla ^2f(x)}\)</span>.</p>
<ul>
<li><p>Gradient Boost: Friedman (2001)</p></li>
<li><p>Newton Boosting: Nielsen (2016)</p></li>
<li><p>XGBoost: Chen and Guestrin (2016)</p></li>
</ul>
<div id="adaboost" class="section level2">
<h2><span class="header-section-number">4.1</span> AdaBoost</h2>
<p><span class="math inline">\(Y\in\{0,1\}\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹æƒé‡ <span class="math inline">\(\omega^{(0)}_i=\frac{1}{n}\)</span>.</p></li>
<li><p>ä½¿ç”¨<span class="math inline">\((\mathcal{D},\mathbf{\omega}^{(m-1)})\)</span>ï¼Œè®­ç»ƒå¼±å­¦ä¹ æœº<span class="math inline">\(T^{(m-1)}\)</span>.</p></li>
<li><p>è®¡ç®—åŠ æƒåˆ†ç±»é”™è¯¯ <span class="math display">\[\epsilon^{(m-1)}=\sum_{i=1}^n\omega^{(m-1)}_i \mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i))\]</span></p></li>
<li><p>è®¡ç®—æ¨¡å‹æƒé‡ <span class="math inline">\(\alpha^{(m-1)}=\ln\beta^{(m-1)}\)</span>, å…¶ä¸­<span class="math display">\[\beta^{(m-1)}=\frac{1-\epsilon^{(m-1)}}{\epsilon^{(m-1)}}\]</span></p></li>
<li><p>è®¡ç®—æ ·æœ¬æƒé‡<span class="math display">\[\omega^{(m)}_i=\omega^{(m-1)}_i\exp\left( \alpha^{(m-1)}\mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i)) \right)/w^{(m)}\]</span>, å…¶ä¸­<span class="math inline">\(w^{(m)}\)</span>ä¸ºæ ‡å‡†åŒ–å¸¸æ•°ã€‚</p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º <span class="math display">\[C(\mathbf{x})= \underset{k}{\arg \max} \sum_{m=1}^M\alpha^{(m)}\mathbb{I}(T^{(m)}(\mathbf{x})=k)\]</span></p></li>
</ol>
<p><strong>å¦å¤–ä¸€ç§ç­‰ä»·ç®—æ³•</strong></p>
<p><span class="math inline">\(Y\in\{-1,1\}\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹æƒé‡ <span class="math inline">\(\omega^{(0)}_i=\frac{1}{n}\)</span>.</p></li>
<li><p>ä½¿ç”¨<span class="math inline">\((\mathcal{D},\mathbf{\omega}^{(m-1)})\)</span>ï¼Œè®­ç»ƒå¼±å­¦ä¹ æœº<span class="math inline">\(T^{(m-1)}\)</span>.</p></li>
<li><p>è®¡ç®—åŠ æƒåˆ†ç±»é”™è¯¯ <span class="math display">\[\epsilon^{(m-1)}=\sum_{i=1}^n\omega^{(m-1)}_i \mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i))\]</span></p></li>
<li><p>è®¡ç®—æ¨¡å‹æƒé‡ <span class="math inline">\(\alpha^{(m-1)}=\frac{1}{2}\ln\beta^{(m-1)}\)</span>, å…¶ä¸­<span class="math display">\[\beta^{(m-1)}=\frac{1-\epsilon^{(m-1)}}{\epsilon^{(m-1)}}.\]</span></p></li>
<li><p>è®¡ç®—æ ·æœ¬æƒé‡<span class="math display">\[\omega^{(m)}_i=\omega^{(m-1)}_i\exp\left(-\alpha^{(m-1)}y_i T^{(m-1)}(\mathbf{x}_i) \right)/w^{(m)},\]</span> å…¶ä¸­<span class="math inline">\(w^{(m)}\)</span>ä¸ºæ ‡å‡†åŒ–å¸¸æ•°ã€‚</p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º<span class="math display">\[C(\mathbf{x})= \underset{k}{\arg \max} \sum_{m=1}^M\alpha^{(m)}\mathbb{I}(T^{(m)}(\mathbf{x})=k)\]</span></p></li>
</ol>
</div>
<div id="logit-boost-real-discrete-gentle-adaboost" class="section level2">
<h2><span class="header-section-number">4.2</span> Logit Boost (real, discrete, gentle AdaBoost)</h2>
<p><span class="math inline">\(Y\in\{-1,1\}\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹å¼±å­¦ä¹ æœº <span class="math inline">\(T^{(0)}=0, C^{(0)}=0\)</span>.</p></li>
<li><p>è®¡ç®—é¢„æµ‹æ¦‚ç‡ <span class="math display">\[p^{(m-1)}(Y_i|\mathbf{x_i})=\frac{1}{1+\exp(-Y_iT^{(m-1)}(\mathbf{x_i}))}\]</span> æ³¨ï¼š<span class="math display">\[p^{(m-1)}(Y_i=1|\mathbf{x_i})+p^{(m-1)}(Y_i=-1|\mathbf{x_i})=1\]</span></p></li>
<li><p>è®¡ç®—æ ·æœ¬æƒé‡ <span class="math display">\[\omega^{(m-1)}_i=p^{(m-1)}(Y_i=y_i|\mathbf{x_i})(1-p^{(m-1)}(Y_i=y_i|\mathbf{x_i}))\]</span></p></li>
<li><p>è®¡ç®—å·¥ä½œå› å˜é‡ <span class="math display">\[z^{(m)}_i = y_i(1+\exp(-y_i C^{(m-1)}(\mathbf{x_i})))\]</span></p></li>
<li><p>è®­ç»ƒå¼±å­¦ä¹ æœº<span class="math inline">\(T^{(m)}\)</span>ï¼Œä½¿ä¹‹æœ€å°åŒ–å¦‚ä¸‹åŠ æƒæŸå¤±å‡½æ•° <span class="math display">\[\sum_{i=1}^N \omega_i^{(m-1)}(T^{(m)}(\mathbf{x_i})-z^{(m-1)}_i)^2\]</span></p></li>
<li><p>ä»¤<span class="math inline">\(C^{(m)}=C^{(m-1)}+T^{(m)}\)</span></p></li>
<li><p>æœ€ç»ˆé¢„æµ‹æ¦‚ç‡ä¸º<span class="math display">\[\Pr(Y=y|\mathbf{x})= \frac{1}{1+\exp(-yC^{(m)}(\mathbf{x_i}))}\]</span></p></li>
</ol>
</div>
<div id="adaboost.m1" class="section level2">
<h2><span class="header-section-number">4.3</span> AdaBoost.M1</h2>
<p><span class="math inline">\(Y\in\{1,\ldots,K\}\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹æƒé‡ <span class="math inline">\(\omega^{(0)}_i=\frac{1}{n}\)</span>.</p></li>
<li><p>ä½¿ç”¨<span class="math inline">\((\mathcal{D},\mathbf{\omega}^{(m-1)})\)</span>ï¼Œè®­ç»ƒå¼±å­¦ä¹ æœº<span class="math inline">\(T^{(m-1)}\)</span>.</p></li>
<li><p>è®¡ç®—åŠ æƒåˆ†ç±»é”™è¯¯ <span class="math display">\[\epsilon^{(m-1)}=\sum_{i=1}^n\omega^{(m-1)}_i \mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i))\]</span></p></li>
<li><p>è®¡ç®—æ¨¡å‹æƒé‡ <span class="math inline">\(\alpha^{(m-1)}=\ln\beta^{(m-1)}\)</span>, å…¶ä¸­<span class="math display">\[\beta^{(m-1)}=\frac{1-\epsilon^{(m-1)}}{\epsilon^{(m-1)}}\]</span></p></li>
<li><p>è®¡ç®—æ ·æœ¬æƒé‡<span class="math display">\[\omega^{(m)}_i=\omega^{(m-1)}_i\exp\left( \alpha^{(m-1)}\mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i)) \right)/w^{(m)},\]</span> å…¶ä¸­<span class="math inline">\(w^{(m)}\)</span>ä¸ºæ ‡å‡†åŒ–å¸¸æ•°ã€‚</p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º <span class="math display">\[C(\mathbf{x})= \underset{k}{\arg \max} \sum_{m=1}^M\alpha^{(m)}\mathbb{I}(T^{(m)}(\mathbf{x})=k)\]</span></p></li>
</ol>
</div>
<div id="samme-stage-wise-additive-modeling-using-a-multi-class-exponential-loss-function" class="section level2">
<h2><span class="header-section-number">4.4</span> SAMME (Stage-wise Additive Modeling using a Multi-class Exponential loss function)</h2>
<p><span class="math inline">\(Y\in \{1,\ldots,K\}\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹æƒé‡ <span class="math inline">\(\omega^{(0)}_i=\frac{1}{n}\)</span>.</p></li>
<li><p>ä½¿ç”¨<span class="math inline">\((\mathcal{D},\mathbf{\omega}^{(m-1)})\)</span>ï¼Œè®­ç»ƒå¼±å­¦ä¹ æœº<span class="math inline">\(T^{(m-1)}\)</span>.</p></li>
<li><p>è®¡ç®—åŠ æƒåˆ†ç±»é”™è¯¯ <span class="math display">\[\epsilon^{(m-1)}=\sum_{i=1}^n\omega^{(m-1)}_i \mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i))\]</span></p></li>
<li><p>è®¡ç®—æ¨¡å‹æƒé‡ <span class="math display">\[\alpha^{(m-1)}=\eta\left(\ln\beta^{(m-1)}+\ln (k-1)\right),\]</span> å…¶ä¸­<span class="math display">\[\beta^{(m-1)}=\frac{1-\epsilon^{(m-1)}}{\epsilon^{(m-1)}}\]</span></p></li>
<li><p>è®¡ç®—æ ·æœ¬æƒé‡<span class="math display">\[\omega^{(m)}_i=\omega^{(m-1)}_i\exp\left( \alpha^{(m-1)}\mathbb{I}(y_i \neq T^{(m-1)}(\mathbf{x}_i)) \right)/w^{(m)},\]</span> å…¶ä¸­<span class="math inline">\(w^{(m)}\)</span>ä¸ºæ ‡å‡†åŒ–å¸¸æ•°ã€‚</p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º <span class="math display">\[C(\mathbf{x})= \underset{k}{\arg \max} \sum_{m=1}^M\alpha^{(m)}\mathbb{I}(T^{(m)}(\mathbf{x})=k)\]</span></p></li>
</ol>
</div>
<div id="samme.r-multi-class-real-adaboost" class="section level2">
<h2><span class="header-section-number">4.5</span> SAMME.R (multi-class real AdaBoost)</h2>
<p>è§<a href="https://web.stanford.edu/~hastie/Papers/samme.pdf" class="uri">https://web.stanford.edu/~hastie/Papers/samme.pdf</a></p>
<p><span class="math inline">\(Y\in \{1,\ldots,K\},\mathbf{Z}=(Z_1,\ldots,Z_k)&#39;\in\{1,-1/(K-1)\}^K\)</span>, å»ºç«‹æ˜ å°„<span class="math inline">\(\{1,\ldots,K\}\rightarrow \{1,-1/(K-1)\}^K, Y\mapsto \mathbf{Z}(Y)\)</span>, å…¶ä¸­<span class="math inline">\(Z_k(k)=1\)</span>, ä¸”<span class="math inline">\(Z_{k&#39;}(k)=-1/(K-1), k&#39;\neq k\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹æƒé‡ <span class="math inline">\(\omega^{(0)}_i=\frac{1}{n}\)</span>.</p></li>
<li><p>ä½¿ç”¨<span class="math inline">\((\mathcal{D},\mathbf{\omega}^{(m-1)})\)</span>ï¼Œè®­ç»ƒå¼±å­¦ä¹ æœº<span class="math inline">\(T^{(m-1)}\)</span>.</p></li>
<li><p>æ ¹æ®<span class="math inline">\(T^{(m-1)}\)</span>è®¡ç®—(åŠ æƒ)é¢„æµ‹é¢‘ç‡ <span class="math display">\[p_k^{(m-1)}(\mathbf{x})=\Pr(y=k|\mathbf{x}),\]</span> ä»¤<span class="math inline">\(\mathbf{p}^{(m-1)}(\mathbf{x})=(p_1^{(m-1)}(\mathbf{x}), \ldots,p_K^{(m-1)}(\mathbf{x}))&#39;\)</span></p></li>
<li><p>è®¡ç®—æ¨¡å‹(é¢„æµ‹ä¸º<span class="math inline">\(k\)</span>)æƒé‡ <span class="math display">\[h^{(m-1)}_k(\mathbf{x})=(K-1)\left(\ln p^{(m-1)}_k(\mathbf{x})-\frac{1}{K}\sum_{k&#39;\neq k} \ln p_{k&#39;}^{(m-1)}(\mathbf{x})\right)\]</span></p></li>
<li><p>è®¡ç®—æ ·æœ¬æƒé‡<span class="math display">\[\omega^{(m)}_i=\omega^{(m-1)}_i\exp\left( -\frac{K-1}{K}\mathbf{Z}(y_i)^{T}\ln p^{(m-1)}(x_i) \right)/w^{(m)},\]</span> å…¶ä¸­<span class="math inline">\(w^{(m)}\)</span>ä¸ºæ ‡å‡†åŒ–å¸¸æ•°ã€‚</p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º <span class="math display">\[C(\mathbf{x})= \underset{k}{\arg \max} \sum_{m=1}^M h_k^{(m)}(\mathbf{x})\]</span></p></li>
</ol>
<p>å‚è€ƒ<code>Multiclass exponential loss</code> <span class="math display">\[L(Z,f)=\exp\left(-\frac{1}{K}Z^Tf\right)\]</span></p>
</div>
<div id="gradient-boosting" class="section level2">
<h2><span class="header-section-number">4.6</span> Gradient Boosting</h2>
<p><span class="math inline">\(Y\in\{-1,1\}\)</span>ï¼Œè®¾å®šå­¦ä¹ ç‡<span class="math inline">\(\eta\in(0,1]\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹å¼±å­¦ä¹ å™¨
<span class="math display">\[f_0(\mathbf{x})= \underset{\theta\in\mathbb{R}}{\arg \min} \sum_{i=1}^n L(Y_i, \theta)\]</span></p></li>
<li><p>è®¡ç®—ç¬¬<span class="math inline">\(m\)</span>æ¬¡è¿­ä»£ä¸­,æŸå¤±å‡½æ•°çš„è´Ÿæ¢¯åº¦<span class="math display">\[g_m(\mathbf{x_i}) = - \frac{\partial L(Y_i, f_i)}{\partial f_{m-1,i}}\]</span></p></li>
<li><p>æ±‚è§£å¼±å­¦ä¹ å™¨<span class="math inline">\(T^m\)</span>å‚æ•° <span class="math display">\[h_m^{*} = \underset{h\in\mathcal{F},\beta}{\arg \min} \sum_{i=1}^n(g_m(\mathbf{x_i}) - \beta h(\mathbf{x_i}))^2 \]</span></p></li>
<li><p>é€šè¿‡çº¿æœç´¢å¾—åˆ°æ­¥é•¿ <span class="math display">\[\rho_m = \underset{\rho&gt;0}{\arg \min} \sum_{i=1}^n L(Y_i,f_{m-1}(\mathbf{x_i}) + \rho h_m^{*}(\mathbf{x_i}))\]</span></p></li>
<li><p>shrinkageï¼Œä¹˜ä»¥æå‰ç»™å®šçš„å­¦ä¹ ç‡ <span class="math display">\[f_m^{*} = \eta\rho_m h_m^{*}\]</span></p></li>
<li><p>æ›´æ–°ï¼Œå‰<span class="math inline">\(m\)</span>ä¸ªå¼±å­¦ä¹ å™¨çš„çº¿æ€§ç»„åˆ <span class="math display">\[f_m(\mathbf{x}) = f_{m-1}(\mathbf{x}) + f_{m}^*(\mathbf{x}) \]</span></p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º <span class="math inline">\(f_M(\mathbf{x})\)</span></p></li>
</ol>
</div>
<div id="newton-boosting" class="section level2">
<h2><span class="header-section-number">4.7</span> Newton Boosting</h2>
<p><span class="math inline">\(Y\in\{-1,1\}\)</span>ï¼Œè®¾å®šå­¦ä¹ ç‡<span class="math inline">\(\eta\in(0,1]\)</span></p>
<ol style="list-style-type: decimal">
<li><p>åˆå§‹å¼±å­¦ä¹ å™¨<span class="math display">\[f_0(\mathbf{x})= \underset{\theta\in\mathbb{R}}{\arg \min} \sum_{i=1}^n L(Y_i, \theta)\]</span></p></li>
<li><p>è®¡ç®—ç¬¬<span class="math inline">\(m\)</span>æ¬¡è¿­ä»£ä¸­çš„è´Ÿæ¢¯åº¦<span class="math display">\[g_m(\mathbf{x_i}) = - \frac{\partial L(Y_i, \theta)}{\partial f_{m-1,i}}\]</span></p></li>
<li><p>è®¡ç®—Hessian Matrix <span class="math display">\[H_m(\mathbf{x_i}) = (\nabla^2\mathcal{L}(\mathbb{f_{m-1}}))_{ii}\]</span></p></li>
<li><p>æ±‚è§£å¼±å­¦ä¹ å™¨<span class="math inline">\(T^m\)</span>å‚æ•°<span class="math display">\[h_m^{*} = \underset{h\in\mathcal{F}}{\arg \min} \sum_{i=1}^n(\frac{g_m(\mathbf{x_i})}{H_m(\mathbf{x_i})} + \frac{1}{2} H_m(\mathbf{x_i})h(\mathbf{x_i}))^2 \\ 
= \underset{h\in\mathcal{F}}{\arg \min} \sum_{i=1}^n\frac{1}{2} H_m(\mathbf{x_i})(-\frac{g_m(\mathbf{x_i})}{H_m(\mathbf{x_i})} - h(\mathbf{x_i}))^2 \]</span></p></li>
<li><p>shrinkageï¼Œä¹˜ä»¥æå‰ç»™å®šçš„å­¦ä¹ ç‡<span class="math display">\[f_m^{*} = \eta h_m^{*}\]</span></p></li>
<li><p>æ›´æ–°ï¼Œå‰<span class="math inline">\(m\)</span>ä¸ªå¼±å­¦ä¹ å™¨çš„çº¿æ€§ç»„åˆ <span class="math display">\[f_m(\mathbf{x}) = f_{m-1}(\mathbf{x}) + f_{m}^*(\mathbf{x}) \]</span></p></li>
<li><p>æœ€ç»ˆé¢„æµ‹ç»“æœä¸º <span class="math inline">\(f_M(\mathbf{x})\)</span></p></li>
</ol>
</div>
<div id="xgboost" class="section level2">
<h2><span class="header-section-number">4.8</span> XGBoost</h2>
<ol style="list-style-type: decimal">
<li><p>objective function:
<span class="math display">\[\mathcal{L} =\sum_{i=1}^n L(\hat{y_i},y_i) + \sum_{m=1}^M\Omega(f_m)\]</span> where <span class="math inline">\(L(\hat{y_i},y_i)\)</span> is a differential convex loss function and <span class="math inline">\(\Omega(f_m) = \gamma T + \frac{1}{2}\lambda||\omega||^2\)</span> is a regularization term to penalize model complexity (including number of leaves <span class="math inline">\(T\)</span> and <span class="math inline">\(L^2\)</span>-norm of leaf scores <span class="math inline">\(\omega\)</span>)</p></li>
<li><p>Newton approximation of objective function:
<span class="math display">\[\tilde{\mathcal{L}}^m = \sum_{i=1}^n \lbrack L(\hat{y_i}^{m-1},y_i) + g_if_m(\mathbf{x_i}) + \frac{1}{2}h_if_m^2(\mathbf{x_i}) \rbrack+\Omega(f_m) \]</span> where <span class="math inline">\(g_i = \frac{\partial L}{\partial\hat{y_i}^{m-1}}|_{(\hat{y_i}^{m-1}, y_i)}\)</span> and <span class="math inline">\(h_i= \frac{\partial^2 L}{\partial\hat{y_i}^{m-1}\partial\hat{y_i}^{m-1}}|_{(\hat{y_i}^{m-1}, y_i)}\)</span></p></li>
<li><p>æœ€å°åŒ–ä¸Šè¿°å¼å­ï¼Œå¾—åˆ°the optimal score (or weight) <span class="math inline">\(\omega_j^*\)</span> of leaf <span class="math inline">\(j\in\{1,\dots,T\}\)</span>is:<span class="math display">\[ \omega_j^*=-\frac{\sum_{i=1}^n g_i \mathbb{I}[q(\mathbf{x_i}) = j]}{\lambda + \sum_{i=1}^nh_i\mathbb{I}[q(\mathbf{x_i}) = j]} \]</span></p></li>
</ol>
<p><img src="./plots/4/summary.png" width="60%"  style="display: block; margin: auto;" /></p>
</div>
<div id="case-study" class="section level2">
<h2><span class="header-section-number">4.9</span> Case study</h2>
<p>æœ¬æ¡ˆä¾‹çš„æ•°æ®æ¥æºäºKaggleä¸Šçš„æ¯”èµ›â€œPorto Seguroâ€™s Safe Driver Prediction Competitionâ€ã€‚</p>
<p>æ¯”èµ›çš„ç›®æ ‡æ˜¯é¢„æµ‹æœªæ¥ä¸€å¹´å¸æœºæ˜¯å¦ä¼šå‘ç”Ÿäº¤é€šäº‹æ•…ï¼Œæ˜¯ä¸€ä¸ª<strong>äºŒåˆ†ç±»</strong>é—®é¢˜ã€‚æ­¤æ¡ˆä¾‹ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ç»è¿‡äº†åŒ¿ååŒ–å¤„ç†ã€‚</p>
<div id="æ•°æ®æè¿°" class="section level3">
<h3><span class="header-section-number">4.9.1</span> æ•°æ®æè¿°</h3>
<p>æ•°æ®åŒ…å«595212æ¡è®°å½•ï¼Œ59ä¸ªå˜é‡ã€‚</p>
<p>å˜é‡åŒ…å«ä¸‰ç±»ï¼š</p>
<ul>
<li>å”¯ä¸€ç¼–ç ï¼ˆ1ä¸ªï¼‰ï¼š<code>id</code></li>
<li>ç›®æ ‡å˜é‡ï¼ˆ1ä¸ªï¼‰ï¼š<code>target</code>ï¼Œå–å€¼ä¸º<span class="math inline">\(\{0, 1\}\)</span></li>
<li>è§£é‡Šå˜é‡ï¼ˆ57ä¸ªï¼‰ï¼š<code>ps_*</code>ï¼ŒåŒ…æ‹¬å››ç§ï¼Œåˆ†åˆ«æ˜¯äºŒåˆ†ç±»å˜é‡ï¼ˆbinaryï¼‰ï¼Œå¤šåˆ†ç±»å˜é‡ï¼ˆcategoricalï¼‰ï¼Œè¿ç»­å‹å˜é‡ï¼ˆcontinuousï¼‰ï¼Œå®šåºå˜é‡ï¼ˆordinalï¼‰ã€‚</li>
</ul>
<p>æ­¤æ¡ˆä¾‹ä¸­ï¼Œç¼ºå¤±å€¼ç”¨-1è¡¨ç¤ºã€‚</p>
<p><img src="./plots/4/æ•°æ®æè¿°.png" width="60%"  style="display: block; margin: auto;" /></p>
</div>
<div id="æ•°æ®é¢„å¤„ç†-2" class="section level3">
<h3><span class="header-section-number">4.9.2</span> æ•°æ®é¢„å¤„ç†</h3>
<ol style="list-style-type: decimal">
<li>ç»Ÿè®¡ç¼ºå¤±å€¼</li>
</ol>
<p>æ•°æ®ä¸­ï¼Œ<code>ps_car_03_cat</code>å’Œ<code>ps_car_05_cat</code>çš„ç¼ºå¤±å€¼è¾ƒå¤šï¼Œç¼ºå¤±å€¼åˆ†åˆ«å 69.09%å’Œ44.78%ï¼Œä¹‹åå°†è¿›è¡Œç¼ºå¤±å€¼å¤„ç†ã€‚</p>
<p><img src="./plots/4/ç¼ºå¤±å€¼.png" width="60%"  style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>å•å˜é‡åˆ†æ</li>
</ol>
<p>å¯¹äºä¸åŒç±»å‹çš„è§£é‡Šå˜é‡ï¼Œæˆ‘ä»¬å°†ä¾ç…§ä¸åŒçš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p>
<ul>
<li><p>åˆ†ç±»å˜é‡ï¼Œç»Ÿè®¡å„ä¸ªç±»åˆ«çš„å æ¯”</p></li>
<li><p>å®šè·å’Œå®šåºå˜é‡ï¼Œä½œæ¡å½¢å›¾</p></li>
<li><p>æ•°å€¼å‹å˜é‡ï¼Œä½œç›´æ–¹å›¾</p></li>
</ul>
<p>å¯¹äºç›®æ ‡å˜é‡ï¼Œæˆ‘ä»¬å‘ç°å®ƒçš„å–å€¼éå¸¸ä¸å¹³è¡¡ã€‚</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># levels for the target variable </span></span>
<span id="cb37-2"><a href="#cb37-2"></a>lev_target <span class="op">=</span> ( pd.crosstab(index <span class="op">=</span> data[<span class="st">&#39;target&#39;</span>], columns <span class="op">=</span> <span class="st">&#39;Frequency&#39;</span>) <span class="op">/</span> data.shape[<span class="dv">0</span>] ) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>lev_target.<span class="bu">round</span>(<span class="dv">2</span>)</span></code></pre></div>
<p>é€šå¸¸æ¥è¯´ï¼Œå¤„ç†<strong>ä¸å¹³è¡¡</strong>çš„åˆ†ç±»æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li><p>SMOTEï¼ˆSynthetic Minority Oversampling Techniqueï¼‰</p></li>
<li><p>ä¸Šé‡‡æ ·ï¼ˆOver-samplingï¼‰</p></li>
<li><p>ä¸‹é‡‡æ ·ï¼ˆUnder-samplingï¼‰</p></li>
<li><p>åŠ æƒæŠ½æ ·ï¼ˆSampling Weightingï¼‰</p></li>
<li><p>æˆæœ¬æ•æ„Ÿè®­ç»ƒï¼ˆCost-sensitive Trainingï¼‰</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>å¤šå˜é‡åˆ†æ</li>
</ol>
<p>åœ¨ä¸åŒçš„è§£é‡Šå˜é‡ä¹‹é—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½œç›¸å…³ç³»æ•°çŸ©é˜µçƒ­å›¾å’Œæ•£ç‚¹å›¾çŸ©é˜µã€‚</p>
<ul>
<li>ç›¸å…³ç³»æ•°çŸ©é˜µçƒ­å›¾</li>
</ul>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># Pearson correlation matrix: computation and visualization</span></span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="co"># use method=&#39;pearson&#39; resp. method=&#39;spearman&#39; to compute Pearson resp. Spearman correlations</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="kw">def</span> corr_heatmap(v):</span>
<span id="cb38-5"><a href="#cb38-5"></a>    correlations <span class="op">=</span> data[v].corr(method<span class="op">=</span><span class="st">&#39;pearson&#39;</span>)</span>
<span id="cb38-6"><a href="#cb38-6"></a>    fig <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb38-7"><a href="#cb38-7"></a></span>
<span id="cb38-8"><a href="#cb38-8"></a>    sns.heatmap(correlations,  center<span class="op">=</span><span class="dv">0</span>, fmt<span class="op">=</span><span class="st">&#39;.2f&#39;</span>, cbar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb38-9"><a href="#cb38-9"></a>                square<span class="op">=</span><span class="va">True</span>, linewidths<span class="op">=</span><span class="dv">1</span>, annot<span class="op">=</span><span class="va">True</span>,  cmap<span class="op">=</span><span class="st">&quot;YlGnBu&quot;</span>)</span>
<span id="cb38-10"><a href="#cb38-10"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>) </span>
<span id="cb38-11"><a href="#cb38-11"></a>    plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>) </span>
<span id="cb38-12"><a href="#cb38-12"></a>    plt.show()</span>
<span id="cb38-13"><a href="#cb38-13"></a></span>
<span id="cb38-14"><a href="#cb38-14"></a><span class="co"># one applies the corr_heatmap function on the interval features    </span></span>
<span id="cb38-15"><a href="#cb38-15"></a>v <span class="op">=</span> meta[(meta.level <span class="op">==</span> <span class="st">&#39;interval&#39;</span>) <span class="op">&amp;</span> (meta.keep)].index</span>
<span id="cb38-16"><a href="#cb38-16"></a>corr_heatmap(v)</span></code></pre></div>
<p><img src="./plots/4/ç›¸å…³ç³»æ•°çŸ©é˜µçƒ­å›¾.png" width="60%"  style="display: block; margin: auto;" /></p>
<ul>
<li>æ•£ç‚¹å›¾çŸ©é˜µ</li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># scatterplot high correlation interval variables</span></span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="im">import</span> seaborn</span>
<span id="cb39-3"><a href="#cb39-3"></a>high <span class="op">=</span> pd.Index([<span class="st">&#39;ps_reg_01&#39;</span>, <span class="st">&#39;ps_reg_02&#39;</span>, <span class="st">&#39;ps_reg_03&#39;</span>, <span class="st">&#39;ps_car_12&#39;</span>, <span class="st">&#39;ps_car_13&#39;</span>, <span class="st">&#39;ps_car_15&#39;</span>])</span>
<span id="cb39-4"><a href="#cb39-4"></a>pd.plotting.scatter_matrix(data[high], alpha <span class="op">=</span> <span class="fl">0.2</span>, figsize <span class="op">=</span> (<span class="dv">40</span>, <span class="dv">40</span>), diagonal <span class="op">=</span> <span class="st">&#39;kde&#39;</span>)</span></code></pre></div>
<p><img src="./plots/4/æ•£ç‚¹å›¾çŸ©é˜µ.png" width="80%"  style="display: block; margin: auto;" /></p>
<p>åœ¨è§£é‡Šå˜é‡å’Œç›®æ ‡å˜é‡ä¹‹é—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½œæ•£ç‚¹å›¾ã€ç®±çº¿å›¾ã€æ¡å½¢å›¾ç­‰ã€‚</p>
<p><img src="./plots/4/target_vs_features.png" width="80%"  style="display: block; margin: auto;" /></p>
</div>
<div id="ç‰¹å¾å·¥ç¨‹-1" class="section level3">
<h3><span class="header-section-number">4.9.3</span> ç‰¹å¾å·¥ç¨‹</h3>
<ol style="list-style-type: decimal">
<li>åˆ é™¤å˜é‡</li>
</ol>
<p>ä¸ºäº†ç®€åŒ–åˆ†æã€æå‡è®¡ç®—é€Ÿåº¦ï¼Œåˆ é™¤14ä¸ªå®šè·å˜é‡ï¼ˆintervalï¼‰å’Œå®šåºå˜é‡ï¼ˆordinalï¼‰
<code>ps_calc_01</code>ï¼Œ<code>ps_calc_02</code>ï¼Œ<code>ps_calc_03</code>ï¼Œ<code>ps_calc_04</code>ï¼Œ<code>ps_calc_05</code>ï¼Œ<code>ps_calc_06</code>ï¼Œ<code>ps_calc_07</code>ï¼Œ<code>ps_calc_08</code>ï¼Œ<code>ps_calc_09</code>ï¼Œ<code>ps_calc_10</code>ï¼Œ<code>ps_calc_11</code>ï¼Œ<code>ps_calc_12</code>ï¼Œ<code>ps_calc_13</code>ï¼Œ<code>ps_calc_14</code>ã€‚</p>
<ol start="2" style="list-style-type: decimal">
<li>ç¼ºå¤±å€¼å¤„ç†</li>
</ol>
<ul>
<li><p>åˆ é™¤ç¼ºå¤±å€¼è¾ƒå¤šçš„å˜é‡<code>ps_car_03_cat</code>å’Œ<code>ps_car_05_cat</code></p></li>
<li><p>å‡å€¼æ’è¡¥è¿ç»­å‹å˜é‡<code>ps_reg_03</code>ï¼Œ<code>ps_car_12</code>å’Œ<code>ps_car_14</code></p></li>
<li><p>ä¼—æ•°æ’è¡¥åˆ†ç±»å˜é‡<code>ps_car_11</code></p></li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># dropping &#39;ps_car_03_cat&#39;, &#39;ps_car_05_cat&#39; and updating meta information</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>vars_to_drop <span class="op">=</span> [<span class="st">&#39;ps_car_03_cat&#39;</span>, <span class="st">&#39;ps_car_05_cat&#39;</span>]</span>
<span id="cb40-3"><a href="#cb40-3"></a>data.drop(vars_to_drop, inplace <span class="op">=</span> <span class="va">True</span>, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb40-4"><a href="#cb40-4"></a>meta.loc[(vars_to_drop), <span class="st">&#39;keep&#39;</span>] <span class="op">=</span> <span class="va">False</span>  </span>
<span id="cb40-5"><a href="#cb40-5"></a></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="co"># imputing with the mean or mode using Imputer from sklearn.preprocessing</span></span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> Imputer</span>
<span id="cb40-8"><a href="#cb40-8"></a></span>
<span id="cb40-9"><a href="#cb40-9"></a>mean_imp <span class="op">=</span> Imputer(missing_values <span class="op">=</span> <span class="dv">-1</span>, strategy <span class="op">=</span> <span class="st">&#39;mean&#39;</span>, axis <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb40-10"><a href="#cb40-10"></a>mode_imp <span class="op">=</span> Imputer(missing_values <span class="op">=</span> <span class="dv">-1</span>, strategy <span class="op">=</span> <span class="st">&#39;most_frequent&#39;</span>, axis <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb40-11"><a href="#cb40-11"></a></span>
<span id="cb40-12"><a href="#cb40-12"></a>data[<span class="st">&#39;ps_reg_03&#39;</span>] <span class="op">=</span> mean_imp.fit_transform(data[[<span class="st">&#39;ps_reg_03&#39;</span>]]).ravel()</span>
<span id="cb40-13"><a href="#cb40-13"></a>data[<span class="st">&#39;ps_car_12&#39;</span>] <span class="op">=</span> mean_imp.fit_transform(data[[<span class="st">&#39;ps_car_12&#39;</span>]]).ravel()</span>
<span id="cb40-14"><a href="#cb40-14"></a>data[<span class="st">&#39;ps_car_14&#39;</span>] <span class="op">=</span> mean_imp.fit_transform(data[[<span class="st">&#39;ps_car_14&#39;</span>]]).ravel()</span>
<span id="cb40-15"><a href="#cb40-15"></a>data[<span class="st">&#39;ps_car_11&#39;</span>] <span class="op">=</span> mode_imp.fit_transform(data[[<span class="st">&#39;ps_car_11&#39;</span>]]).ravel()</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>ç”Ÿæˆå“‘å˜é‡</li>
</ol>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># creating dummy variables</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>data <span class="op">=</span> pd.get_dummies(data, columns <span class="op">=</span> v, drop_first <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="bu">print</span>(<span class="st">&#39;After dummification we have </span><span class="sc">{}</span><span class="st"> variables in data&#39;</span>.<span class="bu">format</span>(data.shape[<span class="dv">1</span>]))</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>åˆ’åˆ†å­¦ä¹ é›†å’Œæµ‹è¯•é›†</li>
</ol>
<p>ä»¥80:20çš„æ¯”ä¾‹åˆ’åˆ†å­¦ä¹ é›†å’Œæµ‹è¯•é›†ï¼Œåˆ†åˆ«è®°ä½œ<code>(X_train, y_train)</code>å’Œ<code>(X_test, y_test)</code>ã€‚</p>
<p>ç»è¿‡åˆ’åˆ†ï¼Œå­¦ä¹ é›†æœ‰476169æ¡è®°å½•ï¼Œæµ‹è¯•é›†æœ‰119043æ¡è®°å½•ã€‚æ¨¡å‹å°†ä¼šåœ¨å­¦ä¹ é›†ä¸Šè®­ç»ƒï¼Œç„¶ååœ¨æµ‹è¯•é›†ä¸Šåˆ†æå…¶è¡¨ç°ã€‚</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(data.drop([<span class="st">&#39;id&#39;</span>, <span class="st">&#39;target&#39;</span>], axis<span class="op">=</span><span class="dv">1</span>), </span>
<span id="cb42-2"><a href="#cb42-2"></a>                                                    data[<span class="st">&#39;target&#39;</span>], </span>
<span id="cb42-3"><a href="#cb42-3"></a>                                                    test_size<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb42-4"><a href="#cb42-4"></a>                                                    random_state<span class="op">=</span>random_state</span>
<span id="cb42-5"><a href="#cb42-5"></a>                                                   )</span></code></pre></div>
</div>
<div id="å»ºæ¨¡æµç¨‹" class="section level3">
<h3><span class="header-section-number">4.9.4</span> å»ºæ¨¡æµç¨‹</h3>
<table>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="60%" />
</colgroup>
<thead>
<tr class="header">
<th></th>
<th align="center">æ¨¡å‹ç¼–å·</th>
<th>å»ºæ¨¡è¿‡ç¨‹</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>åŸºå‡†æ¨¡å‹ Baseline modeling</td>
<td align="center">ST0</td>
<td>ç”¨é»˜è®¤å‚æ•°è®­ç»ƒæ¨¡å‹ (no cv, no tunning)</td>
</tr>
<tr class="even">
<td>æ·±å…¥å»ºæ¨¡ In-depth modeling</td>
<td align="center">ST1, ST2</td>
<td>åŒ…æ‹¬å‚æ•°è°ƒæ•´(<code>iteration</code>, <code>depth</code>, <code>learning rate</code>)ã€äº¤å‰éªŒè¯ã€å¤–æ ·æœ¬æµ‹è¯•<br><br>æ•´ä½“æ­¥éª¤ä¸ºï¼š<br>1.é€‰æ‹©è‹¥å¹²å¥—å‚æ•° (hyper parameter tuning)<br>2.å¯¹äºæ¯å¥—å‚æ•°ï¼Œåœ¨<code>X_train</code>ä¸Šè¿›è¡Œè®­ç»ƒå’Œäº¤å‰éªŒè¯ï¼Œè®¡ç®—æ¯ä¸€æŠ˜çš„è¡¨ç°<br>(å…ˆç”¨1-4æŠ˜è®­ç»ƒï¼Œè®¡ç®—ç¬¬5æŠ˜çš„cv errorï¼›å†ç”¨ç¬¬1-3å’Œ5æŠ˜è®­ç»ƒï¼Œè®¡ç®—ç¬¬4æŠ˜çš„cv errorï¼›ä¾æ¬¡ç±»æ¨)<br>3.è®¡ç®—æ¯å¥—å‚æ•°çš„å¹³å‡è¡¨ç°(GINIï¼ŒAUCï¼Œaccuracyï¼Œlogit loss function)<br>4.é€‰æ‹©è¡¨ç°æœ€å¥½çš„ä¸€å¥—å‚æ•°åœ¨<code>X_train</code>ä¸Šè®­ç»ƒï¼Œä½œä¸ºæœ€ä¼˜æ¨¡å‹<br>5.åœ¨<code>X_test</code>ä¸Šå¯¹æœ€ä¼˜æ¨¡å‹è¿›è¡Œæµ‹è¯•</td>
</tr>
</tbody>
</table>
</div>
<div id="æ¨¡å‹åº¦é‡giniç³»æ•°" class="section level3">
<h3><span class="header-section-number">4.9.5</span> æ¨¡å‹åº¦é‡â€”â€”Giniç³»æ•°</h3>
<ol style="list-style-type: decimal">
<li>Giniç³»æ•°</li>
</ol>
<p>Giniç³»æ•°æ˜¯åº¦é‡æ¨¡å‹è¡¨ç°çš„ä¸€ä¸ªæŒ‡æ ‡ï¼Œå®ƒçš„è®¡ç®—å…¬å¼ä¸ºï¼š</p>
<p><span class="math display">\[Gini_{CAP} = \frac {a_R} {a_P}\]</span></p>
<p>å…¶ä¸­ï¼Œ<span class="math inline">\(a_R\)</span>æ˜¯æŸä¸€æ¨¡å‹CAPæ›²çº¿å’ŒéšæœºçŒœæ¨¡å‹CAPæ›²çº¿é—´çš„é¢ç§¯ï¼Œ<span class="math inline">\(a_P\)</span>æ˜¯å®Œç¾æ¨¡å‹CAPæ›²çº¿å’ŒéšæœºçŒœæ¨¡å‹CAPæ›²çº¿é—´çš„é¢ç§¯ã€‚</p>
<ol start="2" style="list-style-type: decimal">
<li>Giniç³»æ•°æ¡ˆä¾‹</li>
</ol>
<p><a href="https://www.kaggle.com/batzner/gini-coefficient-an-intuitive-explanation">Gini Coefficient - An Intuitive Explanation</a></p>
<p><img src="./plots/4/gini.png" width="80%"  style="display: block; margin: auto;" /></p>
<p><span class="math display">\[Gini = \frac {0.189} {0.3} = 0.630\]</span></p>
<ol start="3" style="list-style-type: decimal">
<li>Giniç³»æ•°ä»£ç </li>
</ol>
<p>åœ¨pythonä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æ¥å®šä¹‰Giniç³»æ•°ã€‚</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> make_scorer</span>
<span id="cb43-2"><a href="#cb43-2"></a></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="co"># Gini coefficient</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="kw">def</span> gini(actual, pred):</span>
<span id="cb43-5"><a href="#cb43-5"></a>    </span>
<span id="cb43-6"><a href="#cb43-6"></a>    <span class="co"># a structural check</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>    <span class="cf">assert</span> (<span class="bu">len</span>(actual) <span class="op">==</span> <span class="bu">len</span>(pred))</span>
<span id="cb43-8"><a href="#cb43-8"></a>    </span>
<span id="cb43-9"><a href="#cb43-9"></a>    <span class="co"># introducing an array called all</span></span>
<span id="cb43-10"><a href="#cb43-10"></a>    <span class="bu">all</span> <span class="op">=</span> np.asarray(np.c_[actual, pred, np.arange(<span class="bu">len</span>(actual))], dtype<span class="op">=</span>np.<span class="bu">float</span>)  <span class="co">#slicing along second axis</span></span>
<span id="cb43-11"><a href="#cb43-11"></a>    </span>
<span id="cb43-12"><a href="#cb43-12"></a>    <span class="co"># sorting the array along predicted probabilities (descending order) and along the index axis all[:, 2] in case of ties</span></span>
<span id="cb43-13"><a href="#cb43-13"></a>    <span class="bu">all</span> <span class="op">=</span> <span class="bu">all</span>[np.lexsort((<span class="bu">all</span>[:, <span class="dv">2</span>], <span class="dv">-1</span> <span class="op">*</span> <span class="bu">all</span>[:, <span class="dv">1</span>]))]                             <span class="co">#</span></span>
<span id="cb43-14"><a href="#cb43-14"></a></span>
<span id="cb43-15"><a href="#cb43-15"></a>    <span class="co"># towards the Gini coefficient</span></span>
<span id="cb43-16"><a href="#cb43-16"></a>    totalLosses <span class="op">=</span> <span class="bu">all</span>[:, <span class="dv">0</span>].<span class="bu">sum</span>()</span>
<span id="cb43-17"><a href="#cb43-17"></a>    giniSum <span class="op">=</span> <span class="bu">all</span>[:, <span class="dv">0</span>].cumsum().<span class="bu">sum</span>() <span class="op">/</span> totalLosses</span>
<span id="cb43-18"><a href="#cb43-18"></a></span>
<span id="cb43-19"><a href="#cb43-19"></a>    giniSum <span class="op">-=</span> (<span class="bu">len</span>(actual) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> <span class="fl">2.</span></span>
<span id="cb43-20"><a href="#cb43-20"></a>    <span class="cf">return</span> giniSum <span class="op">/</span> <span class="bu">len</span>(actual)</span>
<span id="cb43-21"><a href="#cb43-21"></a></span>
<span id="cb43-22"><a href="#cb43-22"></a><span class="co"># normalized Gini coefficient</span></span>
<span id="cb43-23"><a href="#cb43-23"></a><span class="kw">def</span> gini_normalized_score(actual, pred):</span>
<span id="cb43-24"><a href="#cb43-24"></a>    <span class="cf">return</span> gini(actual, pred) <span class="op">/</span> gini(actual, actual)</span>
<span id="cb43-25"><a href="#cb43-25"></a></span>
<span id="cb43-26"><a href="#cb43-26"></a><span class="co"># score using the normalized Gini</span></span>
<span id="cb43-27"><a href="#cb43-27"></a>score_gini <span class="op">=</span> make_scorer(gini_normalized_score, greater_is_better<span class="op">=</span><span class="va">True</span>, needs_threshold <span class="op">=</span> <span class="va">True</span>)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Giniç³»æ•°ä¸AUC</li>
</ol>
<p>Giniç³»æ•°ä¸AUCä¹‹é—´å­˜åœ¨å¦‚ä¸‹ç­‰å¼å…³ç³»ï¼š</p>
<p><span class="math display">\[Gini = 2 \times AUC - 1\]</span></p>
<p>åœ¨æ­¤ä¾‹ä¸­ï¼ŒGiniç³»æ•°å°†ç”¨äºè®¡ç®—äº¤å‰éªŒè¯ä¸­æ¨¡å‹åœ¨éªŒè¯é›†ä¸Šçš„è¡¨ç°ã€‚</p>
</div>
<div id="å»ºç«‹adaboostæ¨¡å‹" class="section level3">
<h3><span class="header-section-number">4.9.6</span> å»ºç«‹AdaBoostæ¨¡å‹</h3>
<div id="st0" class="section level4">
<h4><span class="header-section-number">4.9.6.1</span> ST0</h4>
<p>é€‰å–treeä½œä¸ºåŸºæ¨¡å‹ï¼Œæ„å»ºSAMMEå’ŒSAMME.Ræ¨¡å‹ã€‚</p>
<p>é»˜è®¤å‚æ•°ï¼š<code>n_estimators = 50</code>ï¼Œ<code>learning_rate = 1</code></p>
<p><img src="./plots/4/ada_st0.png" width="80%"  style="display: block; margin: auto;" /></p>
<p>SAMME.Ræ¨¡å‹çš„è¡¨ç°ä¼˜äºSAMMEæ¨¡å‹ã€‚</p>
</div>
<div id="st1" class="section level4">
<h4><span class="header-section-number">4.9.6.2</span> ST1</h4>
<p>æ„å»ºSAMME.Ræ¨¡å‹ï¼Œé€‰å–å‚æ•°<code>n_estimators = 500</code>ï¼Œ<code>learning_rate = 1</code>ï¼Œè§‚å¯Ÿä¸åŒ<code>max_depth</code>ä¸‹å¤–æ ·æœ¬æµ‹è¯•çš„AUCã€‚</p>
<p>å·¦å›¾<code>max_depth = 1</code>ï¼Œå³å›¾<code>max_depth = 3</code>ã€‚</p>
<p><img src="./plots/4/ada_st1.png" width="80%"  style="display: block; margin: auto;" /></p>
<p>å½“<code>max_depth = 1</code>æ—¶ï¼Œæµ‹è¯•é›†ä¸Šï¼ŒSAMME.Rçš„æœ€å¤§AUCä¸º<strong>0.639</strong>ï¼Œåœ¨è¿­ä»£267æ¬¡æ—¶å–å¾—ï¼›</p>
<p>å½“<code>max_depth = 3</code>æ—¶ï¼Œæµ‹è¯•é›†ä¸Šï¼ŒSAMME.Rçš„æœ€å¤§AUCä¸º0.624ï¼Œåœ¨è¿­ä»£8æ¬¡æ—¶å–å¾—ï¼Œå‡ºç°äº†è¿‡æ‹Ÿåˆï¼›</p>
<p>å½“<code>max_depth = 5</code>ï¼Œè¿­ä»£æå°‘çš„æ¬¡æ•°å°±å‡ºç°äº†è¿‡æ‹Ÿåˆã€‚</p>
<p>å› æ­¤ï¼Œå½“å¢åŠ æ ‘çš„æœ€å¤§æ·±åº¦æ—¶ï¼Œå®¹æ˜“å‡ºç°è¿‡æ‹Ÿåˆï¼Œè¿™æ—¶éœ€è¦é™ä½å­¦ä¹ ç‡ä»¥é¿å…è¿‡æ‹Ÿåˆã€‚</p>
</div>
<div id="st2" class="section level4">
<h4><span class="header-section-number">4.9.6.3</span> ST2</h4>
<p>æ¥ä¸‹æ¥ï¼Œè®¾ç½®ä¸åŒçš„<code>max_depth</code>ã€<code>learning_rate</code>ã€<code>n_estimators</code>ï¼Œæ„å»ºSAMME.Ræ¨¡å‹ï¼Œæœå¯»å¤–æ ·æœ¬æµ‹è¯•ä¸ŠAUCæœ€å¤§çš„æ¨¡å‹ã€‚</p>
<p><img src="./plots/4/ada_st2.png" width="80%"  style="display: block; margin: auto;" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œæœ€ä½³æ¨¡å‹çš„å‚æ•°æ˜¯<code>max_depth = 1</code>ï¼Œ<code>learning rate = 0.1</code>ï¼Œ<code>n_estimators = 400</code>ï¼Œæ­¤æ—¶AUCä¸º<strong>0.637</strong>ã€‚</p>
</div>
</div>
<div id="å»ºç«‹xgboostæ¨¡å‹" class="section level3">
<h3><span class="header-section-number">4.9.7</span> å»ºç«‹XGBoostæ¨¡å‹</h3>
<div id="st0-1" class="section level4">
<h4><span class="header-section-number">4.9.7.1</span> ST0</h4>
<p>é‡‡ç”¨é»˜è®¤å‚æ•°ï¼š<code>learning rate = 0.1</code>ï¼Œ<code>max_depth = 3</code>ï¼Œ<code>n_estimators = 100</code>ï¼Œæ„å»ºXGBoostæ¨¡å‹ã€‚</p>
<p>å¾—å‡ºout-of-sample AUCä¸º<strong>0.638</strong>ï¼Œè¿™å·²ç»å¥½äºAdaBoostçš„ST0ï¼ˆ0.635ï¼‰å’ŒST2ï¼ˆ0.637ï¼‰ï¼Œç¨å·®äºST1ï¼ˆ0.639ï¼‰ã€‚</p>
</div>
<div id="st1-1" class="section level4">
<h4><span class="header-section-number">4.9.7.2</span> ST1</h4>
<p>è®¾ç½®ä¸åŒçš„<code>max_depth</code>ã€<code>learning_rate</code>ã€<code>n_estimators</code>ï¼Œæ„å»ºXGBoostæ¨¡å‹ï¼Œæœå¯»å¤–æ ·æœ¬æµ‹è¯•ä¸ŠAUCæœ€å¤§çš„æ¨¡å‹ã€‚</p>
<p><img src="./plots/4/xg_st1.png" width="60%"  style="display: block; margin: auto;" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>max_depth = 2</code>ï¼Œ<code>learning_rate = 0.1</code>ï¼Œ<code>n_estimators = 500</code>å’Œ<code>max_depth = 3</code>ï¼Œ<code>learning_rate = 0.1</code>ï¼Œ<code>n_estimators =  300</code>ï¼ŒAUCéƒ½å–åˆ°äº†æœ€å¤§ä¸º<strong>0.643</strong>ã€‚</p>
<p>ç‰¹å¾é‡è¦æ€§æ’åºå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="./plots/4/feature_impo.png" width="80%"  style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="ç»“è®º" class="section level3">
<h3><span class="header-section-number">4.9.8</span> ç»“è®º</h3>
<p>æ€»çš„æ¥è¯´ï¼Œåœ¨æ­¤æ•°æ®é›†ä¸Š:</p>
<p>SAMME.Rä¼˜äºSAMMEï¼ŒSAMME.Råœ¨å•å±‚æ ‘ã€é€‚åº¦çš„å­¦ä¹ ç‡å’Œè¾ƒå¤§çš„è¿­ä»£æ¬¡æ•°ä¸Šè¡¨ç°è¾ƒå¥½ï¼›</p>
<p>XGBoostä¼˜äºAdaBoostï¼ŒXGBooståœ¨è¾ƒæµ…çš„æ ‘ã€é€‚åº¦çš„å­¦ä¹ ç‡å’Œè¾ƒå¤§çš„è¿­ä»£æ¬¡æ•°ä¸Šè¡¨ç°è¾ƒå¥½ã€‚</p>
</div>
</div>
<div id="appendix-commonly-used-python-code-for-py-beginners" class="section level2">
<h2><span class="header-section-number">4.10</span> Appendix: Commonly used Python code (for py-beginners)</h2>
<div id="pythonæ ‡å‡†æ•°æ®ç±»å‹" class="section level3">
<h3><span class="header-section-number">4.10.1</span> Pythonæ ‡å‡†æ•°æ®ç±»å‹</h3>
<ul>
<li><p>Numbersï¼ˆæ•°å­—ï¼‰ï¼šç”¨äºå­˜å‚¨æ•°å€¼ï¼ŒåŒ…æ‹¬intï¼Œlongï¼Œfloatå’Œcomplexã€‚</p></li>
<li><p>Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šç”±æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ç»„æˆçš„ä¸€ä¸²å­—ç¬¦ã€‚</p></li>
<li><p>Listï¼ˆåˆ—è¡¨ï¼‰ï¼šPythonä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®Œæˆå¤§å¤šæ•°é›†åˆç±»çš„æ•°æ®ç»“æ„å®ç°ï¼Œå®ƒæ”¯æŒæ•°å­—ã€å­—ç¬¦ä¸²ç”šè‡³å¯ä»¥åŒ…å«åˆ—è¡¨ï¼ˆå³åµŒå¥—ï¼‰ã€‚</p></li>
<li><p>Tupleï¼ˆå…ƒç»„ï¼‰ï¼šå…ƒç»„ä¸èƒ½äºŒæ¬¡èµ‹å€¼ï¼Œç›¸å½“äºâ€œåªè¯»â€åˆ—è¡¨ã€‚</p></li>
<li><p>Dictionaryï¼ˆå­—å…¸ï¼‰ï¼šé™¤åˆ—è¡¨ä»¥å¤–pythonä¹‹ä¸­æœ€çµæ´»çš„å†…ç½®æ•°æ®ç»“æ„ç±»å‹ï¼Œä¸åˆ—è¡¨çš„åŒºåˆ«åœ¨äºâ€”â€”åˆ—è¡¨æ˜¯æœ‰åºçš„å¯¹è±¡é›†åˆï¼Œå­—å…¸æ˜¯æ— åºçš„å¯¹è±¡é›†åˆï¼Œå­—å…¸å½“ä¸­çš„å…ƒç´ æ˜¯é€šè¿‡é”®æ¥å­˜å–çš„ã€‚</p></li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>n <span class="op">=</span> <span class="fl">3.6</span>  <span class="co"># æ•°å­—</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>s <span class="op">=</span> <span class="st">&#39;Hello, python!&#39;</span>  <span class="co"># å­—ç¬¦ä¸²</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>L <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="st">&#39;a&#39;</span>]  <span class="co"># åˆ—è¡¨</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>t <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="st">&#39;a&#39;</span>)  <span class="co"># å…ƒç»„</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>d <span class="op">=</span> {<span class="st">&#39;a&#39;</span>:<span class="dv">1</span>, <span class="st">&#39;b&#39;</span>:<span class="dv">2</span>}  <span class="co"># å­—å…¸</span></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="bu">print</span>(n, s, L, t, d, sep <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\n\n</span><span class="st">&#39;</span>)</span></code></pre></div>
</div>
<div id="pythonå†…ç½®å‡½æ•°" class="section level3">
<h3><span class="header-section-number">4.10.2</span> Pythonå†…ç½®å‡½æ•°</h3>
<ol style="list-style-type: decimal">
<li>è¾“å…¥è¾“å‡º</li>
</ol>
<ul>
<li><p><code>print()</code>å°†å¯¹è±¡è¾“å‡ºè‡³æ§åˆ¶å°</p></li>
<li><p><code>open()</code>æ‰“å¼€æ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶å¯¹è±¡</p></li>
<li><p><code>input()</code>è·å–æ§åˆ¶å°è¾“å…¥</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>è¿­ä»£ç›¸å…³</li>
</ol>
<ul>
<li><p><code>enumerate()</code>è¿”å›å…ƒç´ çš„åºå·ä¸å¯¹åº”å€¼</p></li>
<li><p><code>zip()</code>å°†å¤šä¸ªåºåˆ—ä¸­çš„å…ƒç´ é…å¯¹ï¼Œäº§ç”Ÿæ–°çš„å…ƒç»„åˆ—è¡¨</p></li>
<li><p><code>all()</code>å¦‚æœç»™å®šçš„å¯è¿­ä»£å‚æ•°ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½ä¸ºTrueåˆ™è¿”å›Trueï¼Œå¦åˆ™è¿”å›False</p></li>
<li><p><code>any()</code>å¦‚æœç»™å®šçš„å¯è¿­ä»£å‚æ•°ä¸­çš„ä»»ä¸€å…ƒç´ ä¸ºTrueåˆ™è¿”å›Trueï¼Œå¦åˆ™è¿”å›False</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>åºåˆ—å±æ€§</li>
</ol>
<ul>
<li><p><code>max()</code>åºåˆ—æœ€å¤§å€¼</p></li>
<li><p><code>min()</code>åºåˆ—æœ€å°å€¼</p></li>
<li><p><code>sum()</code>åºåˆ—çš„å’Œ</p></li>
<li><p><code>len()</code>åºåˆ—é•¿åº¦</p></li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>åºåˆ—æ“ä½œ</li>
</ol>
<ul>
<li><p><code>range()</code>ç”Ÿæˆåºåˆ—</p></li>
<li><p><code>reversed()</code>å°†åºåˆ—é€†ç½®</p></li>
<li><p><code>sorted()</code>å¯¹åºåˆ—è¿›è¡Œæ’åº</p></li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>å¯¹è±¡å±æ€§</li>
</ol>
<ul>
<li><p><code>dir()</code>è¿”å›å±æ€§åˆ—è¡¨</p></li>
<li><p><code>id()</code>è¿”å›å¯¹è±¡åœ°å€</p></li>
<li><p><code>isinstance()</code>åˆ¤æ–­å¯¹è±¡çš„ç±»å‹</p></li>
<li><p><code>type</code>è¿”å›å¯¹è±¡çš„ç±»å‹</p></li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>æ˜ å°„ç±»å‹</li>
</ol>
<ul>
<li><p><code>eval()</code>å»é™¤å­—ç¬¦ä¸²çš„å•å¼•å·ï¼Œä»è€Œè·å–å¼•å·å†…éƒ¨å†…å®¹</p></li>
<li><p><code>map()</code>å°†ä¼ è¿›æ¥çš„å‡½æ•°åº”ç”¨äºåºåˆ—ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¿­ä»£å™¨</p></li>
<li><p><code>slice()</code>ç”Ÿæˆåˆ‡ç‰‡</p></li>
</ul>
</div>
<div id="numpyåŒ…" class="section level3">
<h3><span class="header-section-number">4.10.3</span> numpyåŒ…</h3>
<p>NumPy(Numerical Python)æ˜¯Pythonçš„ä¸€ä¸ªæ‰©å±•ç¨‹åºåº“ï¼Œæ”¯æŒå¤§é‡çš„ç»´åº¦æ•°ç»„ä¸çŸ©é˜µè¿ç®—ï¼Œå®ƒä¹Ÿé’ˆå¯¹æ•°ç»„è¿ç®—æä¾›å¤§é‡çš„æ•°å­¦å‡½æ•°åº“ã€‚</p>
<ol style="list-style-type: decimal">
<li>åˆ›å»ºndarrayæ•°ç»„</li>
</ol>
<p>ndarrayæ˜¯ä¸€ç§å¤šç»´æ•°ç»„å¯¹è±¡ï¼Œå…¶ä¸­çš„æ‰€æœ‰å…ƒç´ å¿…é¡»æ˜¯ç›¸åŒç±»å‹çš„ã€‚</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb45-2"><a href="#cb45-2"></a>a1 <span class="op">=</span> np.array([[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]])  <span class="co"># åˆ›å»ºæ•°ç»„</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="bu">print</span>(a1)</span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="bu">print</span>(a1.ndim)  <span class="co"># æ•°ç»„çš„ç»´åº¦</span></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="bu">print</span>(a1.shape)  <span class="co"># æ•°ç»„çš„å½¢çŠ¶</span></span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="bu">print</span>(a1.dtype)  <span class="co"># æ•°ç»„çš„å…ƒç´ ç±»å‹</span></span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="bu">print</span>(a1.itemsize)  <span class="co"># æ¯ä¸ªå…ƒç´ çš„å­—èŠ‚å•ä½é•¿åº¦</span></span>
<span id="cb45-8"><a href="#cb45-8"></a></span>
<span id="cb45-9"><a href="#cb45-9"></a><span class="co"># å…¶ä»–åˆ›å»ºæ•°ç»„çš„æ–¹æ³•</span></span>
<span id="cb45-10"><a href="#cb45-10"></a>a2 <span class="op">=</span> np.zeros(shape <span class="op">=</span> (<span class="dv">2</span>,<span class="dv">2</span>), dtype <span class="op">=</span> <span class="bu">float</span>)  <span class="co"># åˆ›å»ºå…ƒç´ å…¨æ˜¯0çš„æ•°ç»„</span></span>
<span id="cb45-11"><a href="#cb45-11"></a>a3 <span class="op">=</span> np.ones(shape <span class="op">=</span> (<span class="dv">2</span>,<span class="dv">2</span>), dtype <span class="op">=</span> <span class="bu">int</span>)  <span class="co"># åˆ›å»ºå…ƒç´ å…¨æ˜¯1çš„æ•°ç»„</span></span>
<span id="cb45-12"><a href="#cb45-12"></a>a4 <span class="op">=</span> np.arange(start <span class="op">=</span> <span class="dv">10</span>, stop <span class="op">=</span> <span class="dv">20</span>, step <span class="op">=</span> <span class="dv">2</span>)  <span class="co"># åˆ›å»ºæŒ‡å®šæ•°æ®èŒƒå›´çš„æ•°ç»„</span></span>
<span id="cb45-13"><a href="#cb45-13"></a><span class="bu">print</span>(a1, a2, a3, a4, sep <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\n\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>ndarrayå¯¹è±¡çš„åˆ‡ç‰‡å’Œç´¢å¼•</li>
</ol>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb46-2"><a href="#cb46-2"></a>a <span class="op">=</span> np.arange(<span class="dv">24</span>).reshape((<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>))  <span class="co"># åˆ›å»º2ç»´ã€3è¡Œã€4åˆ—çš„æ•°ç»„ï¼Œå…ƒç´ ä»0-23å¡«å……</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="bu">print</span>(a[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">2</span>, <span class="dv">1</span>:<span class="dv">3</span>])  <span class="co"># ç´¢å¼•ç¬¬1ä¸ªæ•°ç»„ç¬¬1-2è¡Œç¬¬2-3åˆ—</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb47-2"><a href="#cb47-2"></a>arr <span class="op">=</span> np.arange(<span class="dv">10</span>)  <span class="co"># åˆ›å»ºå…ƒç´ ä¸º0-9çš„ä¸€ç»´æ•°ç»„</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>arr_s <span class="op">=</span> arr[<span class="dv">3</span>:<span class="dv">5</span>]  <span class="co"># åˆ‡ç‰‡ï¼Œæå‡ºæ•°ç»„çš„ç¬¬4ã€5ä¸ªå…ƒç´ </span></span>
<span id="cb47-4"><a href="#cb47-4"></a>arr_s[:] <span class="op">=</span> <span class="dv">99</span>  <span class="co"># å°†99èµ‹å€¼ç»™åˆ‡ç‰‡arr_sä¸­çš„æ‰€æœ‰å…ƒç´ </span></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="bu">print</span>(arr_s, arr, sep <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\n\n</span><span class="st">&#39;</span>)  <span class="co"># ä¿®æ”¹ä¼šç›´æ¥åæ˜ åˆ°æºæ•°ç»„ä¸Š</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>æ•°å­¦è¿ç®—</li>
</ol>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-2"><a href="#cb48-2"></a>a <span class="op">=</span> np.array([<span class="fl">1.0</span>, <span class="fl">5.55</span>, <span class="dv">123</span>, <span class="fl">0.567</span>, <span class="fl">25.532</span>])  </span>
<span id="cb48-3"><a href="#cb48-3"></a>b <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">6</span>, <span class="dv">1</span>)</span>
<span id="cb48-4"><a href="#cb48-4"></a></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="bu">print</span>(np.around(a, decimals <span class="op">=</span> <span class="dv">1</span>))  <span class="co"># å››èˆäº”å…¥è‡³1ä½å°æ•°</span></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="bu">print</span>(np.floor(a))  <span class="co"># å‘ä¸‹å–æ•´</span></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="bu">print</span>(np.ceil(a))  <span class="co"># å‘ä¸Šå–æ•´</span></span>
<span id="cb48-8"><a href="#cb48-8"></a></span>
<span id="cb48-9"><a href="#cb48-9"></a><span class="bu">print</span>(np.sqrt(a))  <span class="co"># å¼€æ ¹å·</span></span>
<span id="cb48-10"><a href="#cb48-10"></a><span class="bu">print</span>(np.square(a))  <span class="co"># å¹³æ–¹</span></span>
<span id="cb48-11"><a href="#cb48-11"></a><span class="bu">print</span>(np.log(a))  <span class="co"># å–å¯¹æ•°</span></span>
<span id="cb48-12"><a href="#cb48-12"></a><span class="bu">print</span>(np.exp(a))  <span class="co"># å–æŒ‡æ•°</span></span>
<span id="cb48-13"><a href="#cb48-13"></a><span class="bu">print</span>(np.sign(a))  <span class="co"># å–ç¬¦å·å‡½æ•°</span></span>
<span id="cb48-14"><a href="#cb48-14"></a></span>
<span id="cb48-15"><a href="#cb48-15"></a><span class="bu">print</span>(np.add(a, b))  <span class="co"># ä¸¤ä¸ªæ•°ç»„ç›¸åŠ </span></span>
<span id="cb48-16"><a href="#cb48-16"></a><span class="bu">print</span>(np.subtract(a, b))  <span class="co"># ä¸¤ä¸ªæ•°ç»„ç›¸å‡</span></span>
<span id="cb48-17"><a href="#cb48-17"></a><span class="bu">print</span>(np.multiply(a, b))  <span class="co"># ä¸¤ä¸ªæ•°ç»„ç›¸ä¹˜</span></span>
<span id="cb48-18"><a href="#cb48-18"></a><span class="bu">print</span>(np.divide(a, b))  <span class="co"># ä¸¤ä¸ªæ•°ç»„ç›¸é™¤</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>ç»Ÿè®¡è¿ç®—</li>
</ol>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb49-2"><a href="#cb49-2"></a>a <span class="op">=</span> np.array([[<span class="dv">3</span>, <span class="dv">7</span>, <span class="dv">5</span>], [<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">3</span>], [<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">9</span>]])  </span>
<span id="cb49-3"><a href="#cb49-3"></a></span>
<span id="cb49-4"><a href="#cb49-4"></a><span class="bu">print</span>(np.<span class="bu">min</span>(a, axis <span class="op">=</span> <span class="dv">0</span>))  <span class="co"># æ²¿çºµè½´çš„æœ€å°å€¼</span></span>
<span id="cb49-5"><a href="#cb49-5"></a><span class="bu">print</span>(np.<span class="bu">max</span>(a, axis <span class="op">=</span> <span class="dv">1</span>))  <span class="co"># æ²¿æ¨ªè½´çš„æœ€å¤§å€¼        # ä»¥ä¸‹å‡½æ•°å‡å¯ä»¥é€šè¿‡å‚æ•°axisé€‰æ‹©çºµè½´ï¼ˆaxis=0ï¼‰æˆ–æ¨ªè½´ï¼ˆaxis=1ï¼‰</span></span>
<span id="cb49-6"><a href="#cb49-6"></a><span class="bu">print</span>(np.ptp(a))  <span class="co"># æ•°ç»„ä¸­å…ƒç´ æœ€å¤§å€¼ä¸æœ€å°å€¼çš„å·®</span></span>
<span id="cb49-7"><a href="#cb49-7"></a><span class="bu">print</span>(np.percentile(a, q <span class="op">=</span> <span class="dv">70</span>, axis <span class="op">=</span> <span class="dv">0</span>))  <span class="co"># ç™¾åˆ†ä½æ•°</span></span>
<span id="cb49-8"><a href="#cb49-8"></a><span class="bu">print</span>(np.<span class="bu">sum</span>(a))  <span class="co"># æ±‚å’Œ</span></span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="bu">print</span>(np.median(a))  <span class="co"># ä¸­ä½æ•°</span></span>
<span id="cb49-10"><a href="#cb49-10"></a><span class="bu">print</span>(np.mean(a))  <span class="co"># å‡å€¼</span></span>
<span id="cb49-11"><a href="#cb49-11"></a><span class="bu">print</span>(np.average(a, axis <span class="op">=</span> <span class="dv">0</span>, weights <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>], returned <span class="op">=</span> <span class="va">True</span>))  <span class="co"># åŠ æƒå¹³å‡æ•°</span></span>
<span id="cb49-12"><a href="#cb49-12"></a><span class="bu">print</span>(np.std(a))  <span class="co"># æ ‡å‡†å·®</span></span>
<span id="cb49-13"><a href="#cb49-13"></a><span class="bu">print</span>(np.var(a))  <span class="co"># æ–¹å·®</span></span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>æ’åº</li>
</ol>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb50-2"><a href="#cb50-2"></a>a <span class="op">=</span> np.array([(<span class="st">&quot;raju&quot;</span>,<span class="dv">21</span>), (<span class="st">&quot;anil&quot;</span>,<span class="dv">25</span>), (<span class="st">&quot;ravi&quot;</span>,<span class="dv">17</span>), (<span class="st">&quot;amar&quot;</span>,<span class="dv">27</span>)], dtype <span class="op">=</span> np.dtype([(<span class="st">&#39;name&#39;</span>,<span class="st">&#39;S10&#39;</span>), (<span class="st">&#39;age&#39;</span>,<span class="bu">int</span>)]))</span>
<span id="cb50-3"><a href="#cb50-3"></a></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="bu">print</span>(a)</span>
<span id="cb50-5"><a href="#cb50-5"></a><span class="bu">print</span>(np.sort(a, order <span class="op">=</span> <span class="st">&#39;age&#39;</span>))  <span class="co"># ä»å°åˆ°å¤§æ’åº</span></span>
<span id="cb50-6"><a href="#cb50-6"></a><span class="bu">print</span>(np.argsort(a, order <span class="op">=</span> <span class="st">&#39;age&#39;</span>))  <span class="co"># ä»å°åˆ°å¤§æ’åºçš„ç´¢å¼•</span></span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>çº¿æ€§ä»£æ•°</li>
</ol>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb51-2"><a href="#cb51-2"></a>a <span class="op">=</span> np.arange(<span class="dv">6</span>).reshape(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb51-3"><a href="#cb51-3"></a>b <span class="op">=</span> np.arange(<span class="dv">6</span>).reshape(<span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb51-4"><a href="#cb51-4"></a>c <span class="op">=</span> a.copy()  <span class="co"># å¤åˆ¶</span></span>
<span id="cb51-5"><a href="#cb51-5"></a></span>
<span id="cb51-6"><a href="#cb51-6"></a><span class="bu">print</span>(a)</span>
<span id="cb51-7"><a href="#cb51-7"></a><span class="bu">print</span>(a.T)  <span class="co"># è½¬ç½®</span></span>
<span id="cb51-8"><a href="#cb51-8"></a><span class="bu">print</span>(np.dot(a,b))  <span class="co"># æ•°ç»„ç‚¹ç§¯</span></span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="bu">print</span>(np.vdot(a,b))  <span class="co"># å‘é‡ç‚¹ç§¯, å¤šç»´æ•°ç»„ä¼šè¢«å±•å¼€</span></span>
<span id="cb51-10"><a href="#cb51-10"></a><span class="bu">print</span>(np.inner(a,c))  <span class="co"># å‘é‡å†…ç§¯ï¼Œå¯¹äºæ›´é«˜çš„ç»´åº¦ï¼Œå®ƒè¿”å›æœ€åä¸€ä¸ªè½´ä¸Šçš„å’Œçš„ä¹˜ç§¯</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-2"><a href="#cb52-2"></a>a <span class="op">=</span> np.arange(<span class="dv">4</span>).reshape(<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="bu">print</span>(a)</span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="bu">print</span>(np.diag(a))  <span class="co"># å¯¹è§’é˜µ</span></span>
<span id="cb52-5"><a href="#cb52-5"></a><span class="bu">print</span>(np.linalg.inv(a))  <span class="co"># é€†</span></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="bu">print</span>(np.linalg.det(a))  <span class="co"># è¡Œåˆ—å¼</span></span>
<span id="cb52-7"><a href="#cb52-7"></a><span class="bu">print</span>(np.linalg.eig(a))  <span class="co"># ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡</span></span>
<span id="cb52-8"><a href="#cb52-8"></a><span class="bu">print</span>(np.linalg.svd(a))  <span class="co"># å¥‡å¼‚å€¼åˆ†è§£</span></span></code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>éšæœºæ•°</li>
</ol>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb53-2"><a href="#cb53-2"></a>np.random.seed(<span class="dv">123</span>)  <span class="co"># éšæœºæ•°ç§å­</span></span>
<span id="cb53-3"><a href="#cb53-3"></a></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="bu">print</span>(np.random.rand(<span class="dv">2</span>, <span class="dv">2</span>))  <span class="co"># å‡åŒ€åˆ†å¸ƒ</span></span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="bu">print</span>(np.random.randn(<span class="dv">2</span>, <span class="dv">3</span>)) <span class="co"># æ ‡å‡†æ­£æ€åˆ†å¸ƒ</span></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="bu">print</span>(np.random.randint(low <span class="op">=</span> <span class="dv">0</span>, high <span class="op">=</span> <span class="dv">100</span>, size <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">2</span>)))  <span class="co"># éšæœºæ•´æ•°</span></span>
<span id="cb53-7"><a href="#cb53-7"></a></span>
<span id="cb53-8"><a href="#cb53-8"></a><span class="co"># åˆ†å¸ƒ</span></span>
<span id="cb53-9"><a href="#cb53-9"></a><span class="bu">print</span>(np.random.normal(loc <span class="op">=</span> <span class="dv">3</span>, scale <span class="op">=</span> <span class="dv">9</span>, size <span class="op">=</span> <span class="dv">2</span>))  <span class="co"># æ­£æ€</span></span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="bu">print</span>(np.random.poisson(lam <span class="op">=</span> <span class="dv">10</span>, size <span class="op">=</span> <span class="dv">6</span>))  <span class="co"># æ³Šæ¾</span></span>
<span id="cb53-11"><a href="#cb53-11"></a><span class="bu">print</span>(np.random.binomial(n <span class="op">=</span> <span class="dv">10</span>, p <span class="op">=</span> <span class="fl">0.1</span>, size <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">2</span>)))  <span class="co"># äºŒé¡¹</span></span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="bu">print</span>(np.random.negative_binomial(n <span class="op">=</span> <span class="dv">10</span>, p <span class="op">=</span> <span class="fl">0.1</span>, size <span class="op">=</span> <span class="dv">1</span>))  <span class="co"># è´ŸäºŒé¡¹</span></span>
<span id="cb53-13"><a href="#cb53-13"></a><span class="bu">print</span>(np.random.gamma(shape <span class="op">=</span> <span class="dv">3</span>, scale <span class="op">=</span> <span class="dv">2</span>, size <span class="op">=</span> <span class="dv">10</span>))  <span class="co"># ä¼½é©¬</span></span></code></pre></div>
</div>
<div id="pandasåŒ…" class="section level3">
<h3><span class="header-section-number">4.10.4</span> pandasåŒ…</h3>
<p>pandasæ˜¯åŸºäºNumPyçš„ä¸€ä¸ªä¸ºè§£å†³æ•°æ®åˆ†æä»»åŠ¡è€Œåˆ›å»ºçš„åŒ…ï¼Œæä¾›äº†å¤§é‡èƒ½ä½¿æˆ‘ä»¬å¿«é€Ÿä¾¿æ·åœ°å¤„ç†æ•°æ®çš„å‡½æ•°å’Œæ–¹æ³•ã€‚</p>
<ol style="list-style-type: decimal">
<li>åˆ›å»ºDataFrame</li>
</ol>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>data1 <span class="op">=</span> pd.read_csv(<span class="st">&#39;file.csv&#39;</span>, encoding <span class="op">=</span> <span class="st">&#39;gbk&#39;</span>)  <span class="co"># ä»å¤–éƒ¨è¯»å…¥csvæ–‡ä»¶</span></span>
<span id="cb54-4"><a href="#cb54-4"></a></span>
<span id="cb54-5"><a href="#cb54-5"></a>data2 <span class="op">=</span> {<span class="st">&#39;state&#39;</span>: [<span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Nevada&#39;</span>, <span class="st">&#39;Nevada&#39;</span>],  <span class="co"># å…ˆåˆ›å»ºå­—å…¸</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>        <span class="st">&#39;year&#39;</span>: [<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2002</span>, <span class="dv">2001</span>, <span class="dv">2002</span>],</span>
<span id="cb54-7"><a href="#cb54-7"></a>        <span class="st">&#39;pop&#39;</span>: [<span class="fl">1.5</span>, <span class="fl">1.7</span>, <span class="fl">3.6</span>, <span class="fl">2.4</span>, <span class="fl">2.9</span>]}</span>
<span id="cb54-8"><a href="#cb54-8"></a>data2 <span class="op">=</span> pd.DataFrame(data2, columns <span class="op">=</span> [<span class="st">&#39;year&#39;</span>, <span class="st">&#39;state&#39;</span>, <span class="st">&#39;pop&#39;</span>])  <span class="co"># åŸºäºå­—å…¸åˆ›å»ºDataFrame</span></span>
<span id="cb54-9"><a href="#cb54-9"></a>data2[<span class="st">&#39;debt&#39;</span>] <span class="op">=</span> <span class="fl">16.5</span>  <span class="co"># æ–°å¢ä¸€åˆ—debt</span></span>
<span id="cb54-10"><a href="#cb54-10"></a></span>
<span id="cb54-11"><a href="#cb54-11"></a><span class="bu">print</span>(data1, data2, sep <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\n\n</span><span class="st">&#39;</span>)</span>
<span id="cb54-12"><a href="#cb54-12"></a></span>
<span id="cb54-13"><a href="#cb54-13"></a><span class="bu">print</span>(data2.dtypes)  <span class="co"># å…ƒç´ ç±»å‹</span></span>
<span id="cb54-14"><a href="#cb54-14"></a><span class="bu">print</span>(data2.columns)  <span class="co"># åˆ—å</span></span>
<span id="cb54-15"><a href="#cb54-15"></a><span class="bu">print</span>(data2.shape)  <span class="co"># å½¢çŠ¶</span></span>
<span id="cb54-16"><a href="#cb54-16"></a><span class="bu">print</span>(data2.head(<span class="dv">10</span>))  <span class="co"># çœ‹å‰10æ¡è®°å½•</span></span>
<span id="cb54-17"><a href="#cb54-17"></a><span class="bu">print</span>(data2.tail(<span class="dv">5</span>))  <span class="co"># çœ‹å5æ¡è®°å½•</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>ç´¢å¼•</li>
</ol>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb55-2"><a href="#cb55-2"></a>data <span class="op">=</span> {<span class="st">&#39;state&#39;</span>: [<span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Nevada&#39;</span>, <span class="st">&#39;Nevada&#39;</span>],</span>
<span id="cb55-3"><a href="#cb55-3"></a>        <span class="st">&#39;year&#39;</span>: [<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2002</span>, <span class="dv">2001</span>, <span class="dv">2002</span>],</span>
<span id="cb55-4"><a href="#cb55-4"></a>        <span class="st">&#39;pop&#39;</span>: [<span class="fl">1.5</span>, <span class="fl">1.7</span>, <span class="fl">3.6</span>, <span class="fl">2.4</span>, <span class="fl">2.9</span>]}</span>
<span id="cb55-5"><a href="#cb55-5"></a>data <span class="op">=</span> pd.DataFrame(data, columns <span class="op">=</span> [<span class="st">&#39;year&#39;</span>, <span class="st">&#39;state&#39;</span>, <span class="st">&#39;pop&#39;</span>])</span>
<span id="cb55-6"><a href="#cb55-6"></a>data[<span class="st">&#39;debt&#39;</span>] <span class="op">=</span> <span class="fl">16.5</span></span>
<span id="cb55-7"><a href="#cb55-7"></a></span>
<span id="cb55-8"><a href="#cb55-8"></a><span class="bu">print</span>(data)</span>
<span id="cb55-9"><a href="#cb55-9"></a><span class="bu">print</span>(data[<span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># ç´¢å¼•ç¬¬1-2è¡Œ</span></span>
<span id="cb55-10"><a href="#cb55-10"></a><span class="bu">print</span>(data.iloc[<span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># ç´¢å¼•ç¬¬1-2è¡Œ</span></span>
<span id="cb55-11"><a href="#cb55-11"></a><span class="bu">print</span>(data.loc[<span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># ç´¢å¼•indexä¸º0-2çš„è¡Œ</span></span>
<span id="cb55-12"><a href="#cb55-12"></a><span class="bu">print</span>(data[<span class="st">&#39;year&#39;</span>])  <span class="co"># ç´¢å¼•åä¸ºyearçš„åˆ—</span></span>
<span id="cb55-13"><a href="#cb55-13"></a><span class="bu">print</span>(data.loc[<span class="dv">0</span>,<span class="st">&#39;year&#39;</span>])</span>
<span id="cb55-14"><a href="#cb55-14"></a><span class="bu">print</span>(data.iloc[<span class="dv">0</span>:<span class="dv">2</span>, <span class="dv">0</span>:<span class="dv">2</span>])  <span class="co"># ç´¢å¼•ç¬¬1-2è¡Œã€ç¬¬1-2åˆ—</span></span>
<span id="cb55-15"><a href="#cb55-15"></a></span>
<span id="cb55-16"><a href="#cb55-16"></a><span class="bu">print</span>(data[data[<span class="st">&#39;pop&#39;</span>]<span class="op">&gt;</span><span class="dv">2</span>])  <span class="co"># ç´¢å¼•pop&gt;2çš„è¡Œ</span></span>
<span id="cb55-17"><a href="#cb55-17"></a><span class="bu">print</span>(data[(data[<span class="st">&#39;pop&#39;</span>]<span class="op">&gt;</span><span class="dv">2</span>) <span class="op">&amp;</span> (data[<span class="st">&#39;state&#39;</span>] <span class="op">==</span> <span class="st">&#39;Ohio&#39;</span>)])  <span class="co"># ç´¢å¼•pop&gt;2ä¸”stateæ˜¯Ohioçš„è¡Œ</span></span>
<span id="cb55-18"><a href="#cb55-18"></a><span class="bu">print</span>(data[(data[<span class="st">&#39;pop&#39;</span>]<span class="op">&gt;</span><span class="dv">2</span>) <span class="op">&amp;</span> (data[<span class="st">&#39;state&#39;</span>] <span class="op">==</span> <span class="st">&#39;Ohio&#39;</span>)][[<span class="st">&#39;year&#39;</span>, <span class="st">&#39;debt&#39;</span>]])  <span class="co"># ç´¢å¼•pop&gt;2ä¸”stateæ˜¯Ohioçš„è¡Œã€åä¸ºyearå’Œdebtçš„åˆ—</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>æ•°æ®é¢„å¤„ç†</li>
</ol>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb56-2"><a href="#cb56-2"></a>data <span class="op">=</span> {<span class="st">&#39;state&#39;</span>: [<span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Nevada&#39;</span>, <span class="st">&#39;Nevada&#39;</span>],</span>
<span id="cb56-3"><a href="#cb56-3"></a>        <span class="st">&#39;year&#39;</span>: [<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2001</span>, <span class="dv">2001</span>, <span class="dv">2002</span>],</span>
<span id="cb56-4"><a href="#cb56-4"></a>        <span class="st">&#39;pop&#39;</span>: [<span class="fl">1.5</span>, <span class="fl">1.7</span>, <span class="fl">1.7</span>, <span class="fl">2.4</span>, <span class="va">None</span>]}</span>
<span id="cb56-5"><a href="#cb56-5"></a>data <span class="op">=</span> pd.DataFrame(data, columns <span class="op">=</span> [<span class="st">&#39;year&#39;</span>, <span class="st">&#39;state&#39;</span>, <span class="st">&#39;pop&#39;</span>])</span>
<span id="cb56-6"><a href="#cb56-6"></a>data[<span class="st">&#39;debt&#39;</span>] <span class="op">=</span> <span class="fl">16.5</span></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="bu">print</span>(data)</span>
<span id="cb56-8"><a href="#cb56-8"></a><span class="bu">print</span>(data.drop_duplicates())  <span class="co"># åˆ é™¤é‡å¤è¡Œ</span></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="bu">print</span>(data.dropna(axis <span class="op">=</span> <span class="dv">0</span>, how <span class="op">=</span> <span class="st">&quot;any&quot;</span>))  <span class="co"># åˆ é™¤æœ‰ç¼ºå¤±å€¼çš„è¡Œ</span></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="bu">print</span>(data.drop([<span class="st">&#39;debt&#39;</span>], axis <span class="op">=</span> <span class="dv">1</span>))  <span class="co"># åˆ é™¤åˆ—debt</span></span>
<span id="cb56-11"><a href="#cb56-11"></a></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="bu">print</span>(pd.get_dummies(data, drop_first <span class="op">=</span> <span class="va">True</span>))  <span class="co"># ç”Ÿæˆå“‘å˜é‡</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>æ’åº</li>
</ol>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb57-2"><a href="#cb57-2"></a>data <span class="op">=</span> {<span class="st">&#39;state&#39;</span>: [<span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Nevada&#39;</span>, <span class="st">&#39;Nevada&#39;</span>],</span>
<span id="cb57-3"><a href="#cb57-3"></a>        <span class="st">&#39;year&#39;</span>: [<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2002</span>, <span class="dv">2001</span>, <span class="dv">2002</span>],</span>
<span id="cb57-4"><a href="#cb57-4"></a>        <span class="st">&#39;pop&#39;</span>: [<span class="fl">1.5</span>, <span class="fl">1.7</span>, <span class="fl">3.6</span>, <span class="fl">2.4</span>, <span class="fl">2.9</span>]}</span>
<span id="cb57-5"><a href="#cb57-5"></a>data <span class="op">=</span> pd.DataFrame(data, columns <span class="op">=</span> [<span class="st">&#39;year&#39;</span>, <span class="st">&#39;state&#39;</span>, <span class="st">&#39;pop&#39;</span>])</span>
<span id="cb57-6"><a href="#cb57-6"></a>data[<span class="st">&#39;debt&#39;</span>] <span class="op">=</span> <span class="fl">16.5</span></span>
<span id="cb57-7"><a href="#cb57-7"></a></span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="bu">print</span>(data.sort_values(by <span class="op">=</span> <span class="st">&#39;year&#39;</span>, ascending <span class="op">=</span> <span class="va">True</span>))  <span class="co"># æŒ‰ç…§yearçš„å€¼å‡åº</span></span>
<span id="cb57-9"><a href="#cb57-9"></a><span class="bu">print</span>(data.sort_index(axis <span class="op">=</span> <span class="dv">1</span>))  <span class="co"># æŒ‰ç…§åˆ—ç´¢å¼•å‡åº</span></span>
<span id="cb57-10"><a href="#cb57-10"></a><span class="bu">print</span>(data.rank())  <span class="co"># æ±‚ç§©</span></span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>ç»Ÿè®¡åˆ†æ</li>
</ol>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb58-2"><a href="#cb58-2"></a>data <span class="op">=</span> {<span class="st">&#39;state&#39;</span>: [<span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Ohio&#39;</span>, <span class="st">&#39;Nevada&#39;</span>, <span class="st">&#39;Nevada&#39;</span>],</span>
<span id="cb58-3"><a href="#cb58-3"></a>        <span class="st">&#39;year&#39;</span>: [<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2002</span>, <span class="dv">2001</span>, <span class="dv">2002</span>],</span>
<span id="cb58-4"><a href="#cb58-4"></a>        <span class="st">&#39;pop&#39;</span>: [<span class="fl">1.5</span>, <span class="fl">1.7</span>, <span class="fl">3.6</span>, <span class="fl">2.4</span>, <span class="fl">2.9</span>]}</span>
<span id="cb58-5"><a href="#cb58-5"></a>data <span class="op">=</span> pd.DataFrame(data, columns <span class="op">=</span> [<span class="st">&#39;year&#39;</span>, <span class="st">&#39;state&#39;</span>, <span class="st">&#39;pop&#39;</span>])</span>
<span id="cb58-6"><a href="#cb58-6"></a>data[<span class="st">&#39;debt&#39;</span>] <span class="op">=</span> <span class="fl">16.5</span></span>
<span id="cb58-7"><a href="#cb58-7"></a></span>
<span id="cb58-8"><a href="#cb58-8"></a><span class="bu">print</span>(data.describe())  <span class="co"># å¯¹æ¯åˆ—è®¡ç®—åŸºæœ¬ç»Ÿè®¡é‡</span></span>
<span id="cb58-9"><a href="#cb58-9"></a><span class="bu">print</span>(data.count())  <span class="co"># è®¡æ•°</span></span>
<span id="cb58-10"><a href="#cb58-10"></a><span class="bu">print</span>(data.<span class="bu">max</span>())  <span class="co"># æœ€å¤§å€¼</span></span>
<span id="cb58-11"><a href="#cb58-11"></a><span class="bu">print</span>(data.<span class="bu">min</span>())  <span class="co"># æœ€å°å€¼</span></span>
<span id="cb58-12"><a href="#cb58-12"></a><span class="bu">print</span>(data.<span class="bu">sum</span>())  <span class="co"># å’Œ</span></span>
<span id="cb58-13"><a href="#cb58-13"></a><span class="bu">print</span>(data.mean())  <span class="co"># å‡å€¼</span></span>
<span id="cb58-14"><a href="#cb58-14"></a><span class="bu">print</span>(data.median())  <span class="co"># ä¸­ä½æ•°</span></span>
<span id="cb58-15"><a href="#cb58-15"></a><span class="bu">print</span>(data.var())  <span class="co"># æ–¹å·®</span></span>
<span id="cb58-16"><a href="#cb58-16"></a><span class="bu">print</span>(data.std())  <span class="co"># æ ‡å‡†å·®</span></span>
<span id="cb58-17"><a href="#cb58-17"></a><span class="bu">print</span>(data.cov())  <span class="co"># åæ–¹å·®</span></span>
<span id="cb58-18"><a href="#cb58-18"></a><span class="bu">print</span>(data.corr())  <span class="co"># ç›¸å…³ç³»æ•°</span></span></code></pre></div>
</div>
<div id="matplotlibåŒ…" class="section level3">
<h3><span class="header-section-number">4.10.5</span> MatplotlibåŒ…</h3>
<p>Matplotlibæ˜¯ä¸€ä¸ªPython çš„2Dç»˜å›¾åº“ï¼Œå®ƒä»¥å„ç§ç¡¬æ‹·è´æ ¼å¼å’Œè·¨å¹³å°çš„äº¤äº’å¼ç¯å¢ƒç”Ÿæˆå‡ºç‰ˆè´¨é‡çº§åˆ«çš„å›¾å½¢ã€‚</p>
<ol style="list-style-type: decimal">
<li>æŠ˜çº¿å›¾</li>
</ol>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt </span>
<span id="cb59-3"><a href="#cb59-3"></a> </span>
<span id="cb59-4"><a href="#cb59-4"></a>x <span class="op">=</span> np.arange(<span class="dv">1</span>,<span class="dv">11</span>) </span>
<span id="cb59-5"><a href="#cb59-5"></a>y <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>x <span class="op">+</span> <span class="dv">5</span> </span>
<span id="cb59-6"><a href="#cb59-6"></a></span>
<span id="cb59-7"><a href="#cb59-7"></a>plt.title(<span class="st">&#39;Matplotlib demo&#39;</span>) </span>
<span id="cb59-8"><a href="#cb59-8"></a>plt.xlabel(<span class="st">&#39;x&#39;</span>) </span>
<span id="cb59-9"><a href="#cb59-9"></a>plt.ylabel(<span class="st">&#39;y&#39;</span>) </span>
<span id="cb59-10"><a href="#cb59-10"></a>plt.plot(x, y, ls <span class="op">=</span> <span class="st">&#39;--&#39;</span>, marker <span class="op">=</span> <span class="st">&#39;+&#39;</span>, color <span class="op">=</span> <span class="st">&#39;lightblue&#39;</span>)  <span class="co"># lsä¸ºçº¿å‹ï¼Œmarkerä¸ºæ ‡è®°ç±»å‹</span></span>
<span id="cb59-11"><a href="#cb59-11"></a>plt.show()</span></code></pre></div>
<p><img src="./plots/4/æŠ˜çº¿å›¾.png" width="50%"  style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>æ•£ç‚¹å›¾</li>
</ol>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb60-2"><a href="#cb60-2"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt </span>
<span id="cb60-3"><a href="#cb60-3"></a></span>
<span id="cb60-4"><a href="#cb60-4"></a>x <span class="op">=</span> np.random.random(<span class="dv">100</span>)</span>
<span id="cb60-5"><a href="#cb60-5"></a>y <span class="op">=</span> np.random.random(<span class="dv">100</span>)</span>
<span id="cb60-6"><a href="#cb60-6"></a></span>
<span id="cb60-7"><a href="#cb60-7"></a>plt.scatter(x, y, s<span class="op">=</span>x<span class="op">*</span><span class="dv">1000</span>, color<span class="op">=</span><span class="st">&#39;pink&#39;</span>, marker<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">1</span>), alpha<span class="op">=</span><span class="fl">0.5</span>, lw<span class="op">=</span><span class="dv">2</span>)  <span class="co"># sä¸ºå›¾åƒå¤§å°ï¼Œlwä¸ºå›¾åƒè¾¹æ¡†å®½åº¦</span></span>
<span id="cb60-8"><a href="#cb60-8"></a>plt.show()</span></code></pre></div>
<p><img src="./plots/4/æ•£ç‚¹å›¾.png" width="50%"  style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>ç®±çº¿å›¾</li>
</ol>
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb61-3"><a href="#cb61-3"></a>x <span class="op">=</span> np.random.gamma(shape <span class="op">=</span> <span class="dv">3</span>, scale <span class="op">=</span> <span class="dv">2</span>, size <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb61-4"><a href="#cb61-4"></a></span>
<span id="cb61-5"><a href="#cb61-5"></a>plt.boxplot(x, vert<span class="op">=</span><span class="va">True</span>)  <span class="co"># vertæ§åˆ¶æ–¹å‘</span></span>
<span id="cb61-6"><a href="#cb61-6"></a>plt.show()</span></code></pre></div>
<p><img src="./plots/4/ç®±çº¿å›¾.png" width="50%"  style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>æ¡å½¢å›¾</li>
</ol>
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb62-3"><a href="#cb62-3"></a></span>
<span id="cb62-4"><a href="#cb62-4"></a>x_index <span class="op">=</span> np.arange(<span class="dv">5</span>)   <span class="co">#æŸ±çš„ç´¢å¼•</span></span>
<span id="cb62-5"><a href="#cb62-5"></a>x_data <span class="op">=</span> [<span class="st">&#39;A&#39;</span>, <span class="st">&#39;B&#39;</span>, <span class="st">&#39;C&#39;</span>, <span class="st">&#39;D&#39;</span>, <span class="st">&#39;E&#39;</span>]</span>
<span id="cb62-6"><a href="#cb62-6"></a>y1_data <span class="op">=</span> [<span class="dv">20</span>, <span class="dv">35</span>, <span class="dv">30</span>, <span class="dv">35</span>, <span class="dv">27</span>]</span>
<span id="cb62-7"><a href="#cb62-7"></a>y2_data <span class="op">=</span> [<span class="dv">25</span>, <span class="dv">32</span>, <span class="dv">34</span>, <span class="dv">20</span>, <span class="dv">25</span>]</span>
<span id="cb62-8"><a href="#cb62-8"></a></span>
<span id="cb62-9"><a href="#cb62-9"></a>plt.bar(x_index, y1_data, width<span class="op">=</span><span class="fl">0.35</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">&#39;lightblue&#39;</span>, label<span class="op">=</span><span class="st">&#39;y1&#39;</span>)  <span class="co"># å‚æ•°ï¼šå·¦åç§»ã€é«˜åº¦ã€æŸ±å®½ã€é€æ˜åº¦ã€é¢œè‰²ã€å›¾ä¾‹</span></span>
<span id="cb62-10"><a href="#cb62-10"></a>plt.bar(x_index <span class="op">+</span> <span class="fl">0.35</span>, y2_data, width<span class="op">=</span><span class="fl">0.35</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">&#39;pink&#39;</span>, label<span class="op">=</span><span class="st">&#39;y2&#39;</span>)</span>
<span id="cb62-11"><a href="#cb62-11"></a></span>
<span id="cb62-12"><a href="#cb62-12"></a>plt.xticks(x_index <span class="op">+</span> bar_width<span class="op">/</span><span class="dv">2</span>, x_data)  <span class="co"># xè½´åˆ»åº¦çº¿</span></span>
<span id="cb62-13"><a href="#cb62-13"></a>plt.legend()  <span class="co"># æ˜¾ç¤ºå›¾ä¾‹</span></span>
<span id="cb62-14"><a href="#cb62-14"></a>plt.show()</span></code></pre></div>
<p><img src="./plots/4/æ¡å½¢å›¾.png" width="50%"  style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>ç›´æ–¹å›¾</li>
</ol>
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb63-3"><a href="#cb63-3"></a></span>
<span id="cb63-4"><a href="#cb63-4"></a>x <span class="op">=</span> np.random.randn(<span class="dv">10000</span>)</span>
<span id="cb63-5"><a href="#cb63-5"></a></span>
<span id="cb63-6"><a href="#cb63-6"></a>plt.hist(x, bins<span class="op">=</span><span class="dv">40</span>, density<span class="op">=</span><span class="va">True</span>, histtype<span class="op">=</span><span class="st">&#39;bar&#39;</span>, color<span class="op">=</span><span class="st">&#39;lightblue&#39;</span>)</span>
<span id="cb63-7"><a href="#cb63-7"></a>plt.show()</span></code></pre></div>
<p><img src="./plots/4/ç›´æ–¹å›¾.png" width="50%"  style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>é¥¼å›¾</li>
</ol>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a>labels <span class="op">=</span> [<span class="st">&#39;A&#39;</span>, <span class="st">&#39;B&#39;</span>, <span class="st">&#39;C&#39;</span>, <span class="st">&#39;D&#39;</span>]</span>
<span id="cb64-4"><a href="#cb64-4"></a>x <span class="op">=</span> [<span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">10</span>]</span>
<span id="cb64-5"><a href="#cb64-5"></a>explode <span class="op">=</span> (<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb64-6"><a href="#cb64-6"></a>colors <span class="op">=</span> [<span class="st">&#39;pink&#39;</span>, <span class="st">&#39;tomato&#39;</span>, <span class="st">&#39;lightblue&#39;</span>, <span class="st">&#39;lightyellow&#39;</span>]</span>
<span id="cb64-7"><a href="#cb64-7"></a>    </span>
<span id="cb64-8"><a href="#cb64-8"></a>plt.pie(x, labels<span class="op">=</span>labels, autopct<span class="op">=</span><span class="st">&#39;</span><span class="sc">%1.1f%%</span><span class="st">&#39;</span>, shadow<span class="op">=</span><span class="va">False</span>, explode<span class="op">=</span>explode, startangle<span class="op">=</span><span class="dv">90</span>, colors<span class="op">=</span>colors)</span>
<span id="cb64-9"><a href="#cb64-9"></a>plt.axis(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb64-10"><a href="#cb64-10"></a>plt.legend(labels<span class="op">=</span>labels, loc<span class="op">=</span><span class="st">&#39;right&#39;</span>)</span>
<span id="cb64-11"><a href="#cb64-11"></a>plt.show()</span></code></pre></div>
<p><img src="./plots/4/é¥¼å›¾.png" width="50%"  style="display: block; margin: auto;" /></p>
</div>
<div id="å¸¸ç”¨æ•™ç¨‹ç½‘å€" class="section level3">
<h3><span class="header-section-number">4.10.6</span> å¸¸ç”¨æ•™ç¨‹ç½‘å€</h3>
<ul>
<li><p><a href="https://www.runoob.com/python/python-tutorial.html">PythonåŸºç¡€æ•™ç¨‹</a></p></li>
<li><p><a href="https://docs.python.org/3/">Python3è¯´æ˜æ–‡æ¡£</a></p></li>
<li><p><a href="https://matplotlib.org/">matplotlibå®˜ç½‘</a></p></li>
<li><p><a href="https://scikit-learn.org/stable/">sklearnå­¦ä¹ </a></p></li>
</ul>
<!--chapter:end:04-boosting.Rmd-->
</div>
</div>
</div>
<div id="unsupervised-learning" class="section level1">
<h1><span class="header-section-number">5</span> æ— ç›‘ç£å­¦ä¹ æ–¹æ³•</h1>
<p><em>æ¢è¯‘ä¸­ã€æ–¹æ˜æ…§ã€ç‹æ™—ã€é«˜å…‰è¿œ</em></p>
<p>å¤§å­¦åŠä»¥åç”Ÿæ´»ä¸­æœ€å¸¸ç”¨çš„å­¦ä¹ æ–¹æ³•ã€‚</p>
<p>åœ¨æ— ç›‘ç£å­¦ä¹ ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥é™ä½æ•°æ®ï¼ˆåå˜é‡ï¼Œç‰¹å¾ï¼‰ç»´åº¦ã€æ ¹æ®ç‰¹å¾çš„ç›¸ä¼¼åº¦å¯¹æ ·æœ¬è¿›è¡Œèšç±»ã€è®¾è®¡å¯è§†åŒ–å·¥å…·æ­ç¤ºé«˜ç»´æ•°æ®çš„ç‰¹æ€§ã€‚æ— ç›‘ç£å­¦ä¹ ä¸è€ƒè™‘å“åº”å˜é‡ï¼Œä»…è€ƒè™‘ç‰¹å¾çš„ç›¸ä¼¼æ€§ã€‚</p>
<p>æœ¬ç« å°†è€ƒè™‘ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p>
<ul>
<li><p><strong>é™ç»´</strong>ï¼š</p>
<ul>
<li><p>ä¸»æˆåˆ†åˆ†æï¼ˆPCAï¼‰</p></li>
<li><p>è‡ªç¼–ç ï¼Œç“¶é¢ˆç¥ç»ç½‘ç»œï¼ˆBNNï¼‰</p></li>
</ul></li>
<li><p><strong>èšç±»</strong>ï¼š</p>
<ul>
<li><p>åˆ†å±‚èšç±»ï¼šä¸éœ€äº‹å…ˆæŒ‡å®šèšç±»ä¸ªæ•°</p>
<ul>
<li><p>è‡ªä¸‹è€Œä¸Šï¼šåˆå§‹<span class="math inline">\(n\)</span>ç±»ï¼Œå†å°†ç›¸è·æœ€è¿‘çš„ä¸¤ç±»åˆå¹¶ï¼Œå»ºç«‹ä¸€ä¸ªæ–°çš„ç±»ï¼Œç›´åˆ°æœ€ååˆå¹¶æˆ<span class="math inline">\(1\)</span>ç±»ï¼›</p></li>
<li><p>è‡ªä¸Šè€Œä¸‹ï¼šåˆå§‹<span class="math inline">\(1\)</span>ç±»ï¼Œå†å°†ç›¸è·æœ€è¿œçš„æ ·æœ¬åˆ†è£‚æˆä¸¤ç±»ï¼Œç›´åˆ°æœ€ååˆ†è£‚æˆ<span class="math inline">\(n\)</span>ä¸ªç±»ã€‚</p></li>
</ul></li>
<li><p>åŸºäºè´¨å¿ƒçš„èšç±»: K-means, K-medoids</p></li>
<li><p>åŸºäºåˆ†å¸ƒçš„èšç±»: Gaussian mixture models (GMMs)</p></li>
</ul></li>
<li><p><strong>å¯è§†åŒ–é«˜ç»´æ•°æ®</strong>ï¼š</p>
<ul>
<li><p>å˜åˆ†è‡ªåŠ¨ç¼–ç å™¨ï¼ˆVAEï¼‰</p></li>
<li><p><span class="math inline">\(t\)</span>åˆ†å¸ƒéšæœºé‚»è¿‘åµŒå…¥ï¼ˆ<span class="math inline">\(t\)</span>-SNEï¼‰ï¼Œ</p></li>
<li><p>ç»Ÿä¸€æµå½¢é€¼è¿‘å’ŒæŠ•å½±ï¼ˆUMAPï¼‰ï¼Œ</p></li>
<li><p>è‡ªç»„ç»‡æ˜ å°„ï¼ˆSOMï¼‰</p></li>
<li><p>Kohonenå›¾ã€‚</p></li>
</ul></li>
</ul>
<div id="æ•°æ®é¢„å¤„ç†-3" class="section level2">
<h2><span class="header-section-number">5.1</span> æ•°æ®é¢„å¤„ç†</h2>
<p>æ•°æ®ä¸­å„ä¸ªå˜é‡çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr class="header">
<th align="center">å˜é‡</th>
<th align="center">ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">brand</td>
<td align="center">factor</td>
<td>43ä¸ªæ±½è½¦å“ç‰Œ</td>
</tr>
<tr class="even">
<td align="center">type</td>
<td align="center">factor</td>
<td>96ä¸ªæ°´å¹³</td>
</tr>
<tr class="odd">
<td align="center">model</td>
<td align="center">factor</td>
<td>113ä¸ªæ°´å¹³</td>
</tr>
<tr class="even">
<td align="center">seats</td>
<td align="center">int</td>
<td>åº§ä½æ•°</td>
</tr>
<tr class="odd">
<td align="center">max_power</td>
<td align="center">int</td>
<td>å‘åŠ¨æœºæœ€å¤§åŠŸç‡(kW),å–å¯¹æ•°</td>
</tr>
<tr class="even">
<td align="center">max_torque</td>
<td align="center">num</td>
<td>æœ€å¤§è½¬çŸ©(Nm),å–å¯¹æ•°</td>
</tr>
<tr class="odd">
<td align="center">cubic_capacity</td>
<td align="center">int</td>
<td>å®¹é‡(cm<span class="math inline">\(^3\)</span>),å–å¯¹æ•°</td>
</tr>
<tr class="even">
<td align="center">weight</td>
<td align="center">int</td>
<td>è½¦é‡(kg)ï¼Œå–å¯¹æ•°</td>
</tr>
<tr class="odd">
<td align="center">max_engine_speed</td>
<td align="center">int</td>
<td>å‘åŠ¨æœºæœ€å¤§è½¬é€Ÿ(rpm)</td>
</tr>
<tr class="even">
<td align="center">seconds_to_100</td>
<td align="center">int</td>
<td>è¾¾åˆ°100km/hæ‰€éœ€è¦ç§’æ•°</td>
</tr>
<tr class="odd">
<td align="center">top_speed</td>
<td align="center">int</td>
<td>æœ€å¤§è¡Œé©¶é€Ÿåº¦(km/h)</td>
</tr>
<tr class="even">
<td align="center">sports_car</td>
<td align="center">int</td>
<td>è·‘è½¦</td>
</tr>
<tr class="odd">
<td align="center">tau</td>
<td align="center">num</td>
<td>ä¸“å®¶è¯„åˆ†</td>
</tr>
</tbody>
</table>
<p>Figure @ref(fig:pairs) æ˜¾ç¤ºäº†å„ä¸ªå˜é‡ï¼ˆå–å¯¹æ•°åï¼‰çš„æ•£ç‚¹å›¾ï¼ŒQ-Qå›¾ï¼ŒåŠç›¸å…³ç³»æ•°ã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/log.png" alt="æ•£ç‚¹å›¾" width="40%" />
<p class="caption">
(#fig:pairs1)æ•£ç‚¹å›¾
</p>
</div>
<p><span class="math inline">\(\tau\)</span>ä¸ºä¸“å®¶æå‡ºçš„è¯„åˆ†æ–¹ç¨‹ï¼Œæ®æ­¤è¯„åˆ†å¯ä»¥å¤§æ¦‚åˆ¤æ–­è¯¥è½¦æ˜¯å¦ä¸ºè·‘è½¦ï¼š</p>
<p><span class="math display">\[\tau=\frac{\text{weight}}{\frac{\text{max_power}}{0.735499}}\text{seats}^{\frac{1}{3}}\left(\frac{\text{cubic_capacity}}{1000}\right)^{\frac{1}{4}}\]</span>
å¦‚æœæŠŠå¸¸æ•°é¡¹æå‡ºï¼Œå¯å¾—åˆ°å¦‚ä¸‹ç­‰ä»·çš„è¯„åˆ†<span class="math inline">\(\tau^+\)</span>:</p>
<p><span class="math display">\[\tau^+=\frac{\text{weight}}{\text{max_power}}\text{seats}^{\frac{1}{3}}\text{cubic_capacity}^{\frac{1}{4}}\]</span></p>
<p>ä¸“å®¶æŠŠ<span class="math inline">\(\tau&lt;17\)</span>æˆ–<span class="math inline">\(\tau^+&lt;129.9773\)</span>çš„æ±½è½¦å®šä¹‰ä¸ºè·‘è½¦ã€‚</p>
</div>
<div id="ä¸»æˆåˆ†åˆ†æ" class="section level2">
<h2><span class="header-section-number">5.2</span> ä¸»æˆåˆ†åˆ†æ</h2>
<p>Ingenbleek-Lemaire (1988) çš„ç›®æ ‡æ˜¯åˆ©ç”¨ä¸»æˆåˆ†åˆ†ææ¥å¯¹æ•°æ®è¿›è¡Œé™ç»´ï¼Œæ ¹æ®é€‰å–çš„ä¸»æˆåˆ†æ¥åŒºåˆ†è·‘è½¦å’Œæ™®é€šè½¦ï¼Œå¹¶å°è¯•è¾¾åˆ°å’Œä¸“å®¶é€‰æ‹©ä¸€æ ·çš„æ•ˆæœã€‚</p>
<p>PCAé€‚ç”¨äºé«˜æ–¯åˆ†å¸ƒï¼Œè‹¥å˜é‡æ˜¾è‘—ä¸ç¬¦åˆé«˜æ–¯åˆ†å¸ƒï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼ˆæ¯”å¦‚å–å¯¹æ•°æˆ–å…¶ä»–æ–¹æ³•ï¼‰ã€‚
Ingenbleek-Lemaire (1988) æ„é€ äº†ä»¥ä¸‹5ä¸ªè¿‘ä¼¼æœä»é«˜æ–¯åˆ†å¸ƒçš„å˜é‡ä»¥ä¾¿è¿›è¡Œåç»­åˆ†æã€‚</p>
<p><span class="math display">\[x_1^*=\ln\left(\frac{\text{weight}}{\text{max_power}}\right)\]</span>
<span class="math display">\[x_2^*=\ln\left(\frac{\text{max_power}}{\text{cubic_capacity}}\right)\]</span>
<span class="math display">\[x_3^*=\ln\left(\text{max_torque}\right)\]</span>
<span class="math display">\[x_4^*=\ln\left(\text{max_engine_speed}\right)\]</span> <span class="math display">\[x_5^*=log\left(\text{cubic_capacity}\right)\]</span></p>
<p>Figure (fig:pairs2) å±•ç¤ºäº†ä»¥ä¸Š5ä¸ªå˜é‡çš„ç›¸å…³æ€§ã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/x1-x5scatter.png" alt="æ•£ç‚¹å›¾" width="40%"  />
<p class="caption">
(#fig:pairs2)æ•£ç‚¹å›¾
</p>
</div>
<p>ä¸»æˆåˆ†åˆ†æå¯ä»¥é™ä½é«˜ç»´æ•°æ®çš„ç»´æ•°ï¼Œä½¿ç›¸å¯¹äºåŸå§‹æ•°æ®çš„é‡æ„è¯¯å·®æœ€å°ã€‚å¦‚æœåº”ç”¨æˆåŠŸï¼Œå®ƒå‡å°‘äº†ç‰¹å¾ç©ºé—´çš„ç»´æ•°ï¼Œå¹¶ä¸”å®ƒå¯¹äº(ç²¾ç®—)å›å½’å»ºæ¨¡ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒæä¾›äº†å°‘é‡çš„ä¸ç›¸å…³çš„è§£é‡Šå˜é‡ã€‚</p>
<p>å‡è®¾æ ·æœ¬é‡ä¸º<span class="math inline">\(n\)</span>çš„æ ·æœ¬æœ‰<span class="math inline">\(q\)</span>ä¸ªç‰¹å¾<span class="math inline">\(\mathbf{x}_1^*,\ldots,\mathbf{x}^*_n\in\mathbb{R}^q\)</span>ã€‚å…¶è®¾è®¡çŸ©é˜µä¸º
<span class="math display">\[\mathbf{X}^*=(\mathbf{x}_1^*,\ldots,\mathbf{x}^*_n)^\intercal\in\mathbb{R}^{n\times q}.\]</span>
æŠŠè®¾è®¡çŸ©é˜µçš„æ¯åˆ—è¿›è¡Œæ ‡å‡†åŒ–ï¼Œå¾—åˆ°
<span class="math display">\[\mathbf{X}=(x_{i,j})_{1\le i \le n,1\le j\le q}\in\mathbb{R}^{n\times q}.\]</span>
å…¶ä¸­ï¼Œç¬¬<span class="math inline">\(i\)</span>è¡Œæ˜¯æ ·æœ¬<span class="math inline">\(i\)</span>çš„ç‰¹å¾<span class="math inline">\(\mathbf{x}_i\in\mathbb{R}^q, 1\le i\le n\)</span>, ç¬¬<span class="math inline">\(j\)</span>åˆ—æ˜¯ç¬¬<span class="math inline">\(j\)</span>ä¸ªç‰¹å¾<span class="math inline">\(x_j\in\mathbb{R}^n\)</span>.</p>
<p>çŸ©é˜µ<span class="math inline">\(\mathbf{X}\)</span>çš„ç§©ä¸º<span class="math inline">\(q\le n\)</span>ï¼Œå¯ä»¥æ‰¾åˆ°<span class="math inline">\(q\)</span>ä¸ªæ­£äº¤çš„<span class="math inline">\(q\)</span>ç»´åŸºå‘é‡<span class="math inline">\(\mathbf{v}_1,\ldots,\mathbf{v}_q\in\mathbb{R}^q\)</span>, ä½¿å¾—<span class="math inline">\(\mathbf{v}_1\)</span>ä¸º<span class="math inline">\(\mathbf{X}\)</span>æ³¢åŠ¨æœ€å¤§çš„æ–¹å‘ï¼Œ<span class="math inline">\(\mathbf{v}_2\)</span>ä¸ºä¸<span class="math inline">\(\mathbf{v}_1\)</span>æ­£äº¤æ–¹å‘ä¸Šçš„<span class="math inline">\(\mathbf{X}\)</span>æ³¢åŠ¨æœ€å¤§çš„æ–¹å‘ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p>
<p>ç”¨æ•°å­¦å…¬å¼è¡¨ç¤ºå¦‚ä¸‹ï¼š
<span class="math display">\[\mathbf{v}_1=\underset{||\omega||_2=1}{\arg \max}||\mathbf{X}\omega||_2^2=\underset{\omega^\intercal\omega=1}{\arg \max} (\omega^\intercal\mathbf{X}^\intercal\mathbf{X}\omega)\]</span></p>
<p><span class="math display">\[\mathbf{v}_2=\underset{||\omega||_2=1}{\arg \max}||\mathbf{X}\omega||_2^2 ~~~\text{ subject to } \mathbf{v}_1^\intercal\omega=0.\]</span></p>
<p><span class="math display">\[\ldots\]</span></p>
<p>ä¸»æˆåˆ†åˆ†æå¯é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®ç°</p>
<ul>
<li><p>æ±‚<span class="math inline">\(\mathbf{X}^\intercal \mathbf{X}\)</span>æˆ–è€…<span class="math inline">\(\mathbf{X}\)</span>çš„åæ–¹å·®çŸ©é˜µ<span class="math inline">\(\mathbf{\Sigma}\)</span>çš„ç‰¹å¾å‘é‡å’Œç‰¹å¾å€¼ã€‚æ˜“çŸ¥<span class="math inline">\(\mathbf{X}^\intercal \mathbf{X}=n\times\mathbf{\Sigma}\)</span>ï¼Œæ‰€ä»¥å®ƒä»¬çš„ç‰¹å¾å‘é‡ç›¸åŒã€‚ç¬¬ä¸€ä¸ªç‰¹å¾å‘é‡å³ä¸º<span class="math inline">\(\mathbf{v}_1\)</span>ï¼Œç¬¬äºŒä¸ªç‰¹å¾å‘é‡ä¸º<span class="math inline">\(\mathbf{v}_2\)</span>ã€‚å‰ä¸¤ä¸ªä¸»æˆåˆ†ä¸º<span class="math inline">\(\mathbf{X}\mathbf{v}_1,\mathbf{X}\mathbf{v}_2\)</span></p></li>
<li><p>å¯¹<span class="math inline">\(\mathbf{X}\)</span>è¿›è¡Œå¥‡å¼‚å€¼ï¼ˆsingular value decompositionï¼‰åˆ†è§£:<span class="math display">\[\mathbf{X}=U\Lambda V^\intercal.\]</span>å…¶ä¸­ï¼Œå¯¹è§’çŸ©é˜µ<span class="math inline">\(\Lambda=\text{diag}(\lambda_1,\ldots,\lambda_q)\)</span>çš„å…ƒç´ ä¸º<span class="math inline">\(\mathbf{X}^\intercal \mathbf{X}\)</span>çš„ç‰¹å¾å€¼ï¼Œ<span class="math inline">\(V\)</span>ä¸º<span class="math inline">\(\mathbf{X}^\intercal \mathbf{X}\)</span>çš„ç‰¹å¾å‘é‡ã€‚ä¸»æˆåˆ†å¯ä»¥é€šè¿‡<span class="math inline">\(\mathbf{X}V\)</span>æ±‚å¾—ã€‚</p></li>
</ul>
<p>åˆ©ç”¨å‰<span class="math inline">\(p\)</span>ä¸ªä¸»æˆåˆ†å¯ä»¥é‡æ„è®¾è®¡çŸ©é˜µçš„è¿‘ä¼¼å€¼<span class="math display">\[\mathbf{X}_p=U\text{diag}(\lambda_1,\ldots,\lambda_p,0,\ldots,0)V^{\intercal}.\]</span></p>
<p>è¯¥è¿‘ä¼¼å€¼ä¸ºä»¥ä¸‹æå€¼é—®é¢˜çš„æ ¹<span class="math display">\[\underset{B\in\mathbb{R}^{n\times q}}{\arg \min}||\mathbf{X}-B||^2 ~~\text{subject to rank}(B)\le q,\]</span></p>
<p>å³çŸ©é˜µ<span class="math inline">\(\mathbf{X}_p\)</span>æ˜¯æ‰€æœ‰ç§©ä¸º<span class="math inline">\(p\)</span>çš„çŸ©é˜µä¸­ï¼Œä¸åŸå§‹è®¾è®¡çŸ©é˜µ<span class="math inline">\(\mathbf{X}\)</span>é‡ç»„å¹³æ–¹è¯¯å·®(FèŒƒæ•°)æœ€å°çš„çŸ©é˜µã€‚</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a><span class="co"># standardize matrix</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>X &lt;-<span class="st"> </span>X01<span class="op">/</span><span class="kw">sqrt</span>(<span class="kw">colMeans</span>(X01<span class="op">^</span><span class="dv">2</span>))[<span class="kw">col</span>(X01)]</span>
<span id="cb65-3"><a href="#cb65-3"></a></span>
<span id="cb65-4"><a href="#cb65-4"></a><span class="co"># eigenvectors and eigenvalues</span></span>
<span id="cb65-5"><a href="#cb65-5"></a>X1 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(X)</span>
<span id="cb65-6"><a href="#cb65-6"></a><span class="kw">nrow</span>(X1)</span>
<span id="cb65-7"><a href="#cb65-7"></a>A &lt;-<span class="st">  </span><span class="kw">t</span>(X1) <span class="op">%*%</span><span class="st"> </span>X1</span>
<span id="cb65-8"><a href="#cb65-8"></a>A</span>
<span id="cb65-9"><a href="#cb65-9"></a><span class="kw">sum</span>(<span class="kw">eigen</span>(A)<span class="op">$</span>value)<span class="op">/</span><span class="dv">5</span></span>
<span id="cb65-10"><a href="#cb65-10"></a><span class="kw">sqrt</span>(<span class="kw">eigen</span>(A)<span class="op">$</span>value)      <span class="co"># singular values</span></span>
<span id="cb65-11"><a href="#cb65-11"></a><span class="kw">sqrt</span>(<span class="kw">eigen</span>(A)<span class="op">$</span>value<span class="op">/</span><span class="kw">nrow</span>(X1))   <span class="co"># scaled eigenvalues</span></span>
<span id="cb65-12"><a href="#cb65-12"></a><span class="kw">eigen</span>(A)<span class="op">$</span>vector</span>
<span id="cb65-13"><a href="#cb65-13"></a>A1&lt;-<span class="kw">cor</span>(X1)</span>
<span id="cb65-14"><a href="#cb65-14"></a>A1<span class="op">*</span><span class="kw">nrow</span>(X1)</span>
<span id="cb65-15"><a href="#cb65-15"></a><span class="kw">sqrt</span>(<span class="kw">eigen</span>(A1)<span class="op">$</span>value)  </span>
<span id="cb65-16"><a href="#cb65-16"></a><span class="kw">eigen</span>(A1)<span class="op">$</span>vector</span>
<span id="cb65-17"><a href="#cb65-17"></a><span class="kw">eigen</span>(A1)<span class="op">$</span>value</span>
<span id="cb65-18"><a href="#cb65-18"></a></span>
<span id="cb65-19"><a href="#cb65-19"></a><span class="co"># singular value decomposition</span></span>
<span id="cb65-20"><a href="#cb65-20"></a>SVD &lt;-<span class="st"> </span><span class="kw">svd</span>(X1)</span>
<span id="cb65-21"><a href="#cb65-21"></a>SVD<span class="op">$</span>d                       <span class="co"># singular values</span></span>
<span id="cb65-22"><a href="#cb65-22"></a><span class="kw">rbind</span>(SVD<span class="op">$</span>v[,<span class="dv">1</span>],SVD<span class="op">$</span>v[,<span class="dv">2</span>])  <span class="co"># first two right singular vectors</span></span>
<span id="cb65-23"><a href="#cb65-23"></a></span>
<span id="cb65-24"><a href="#cb65-24"></a><span class="co"># PCA with package PCA</span></span>
<span id="cb65-25"><a href="#cb65-25"></a>t.pca &lt;-<span class="st"> </span><span class="kw">princomp</span>(X1,<span class="dt">cor=</span><span class="ot">TRUE</span>)</span>
<span id="cb65-26"><a href="#cb65-26"></a>t.pca<span class="op">$</span>loadings          </span>
<span id="cb65-27"><a href="#cb65-27"></a><span class="kw">summary</span>(t.pca)</span>
<span id="cb65-28"><a href="#cb65-28"></a><span class="kw">eigen</span>(A1)<span class="op">$</span>value<span class="op">/</span><span class="kw">sum</span>(<span class="kw">eigen</span>(A1)<span class="op">$</span>value)</span></code></pre></div>
<p>é€šè¿‡<code>summary(t.pca)</code>æˆ‘ä»¬å¯ä»¥å¾—åˆ°å‰ä¸¤ä¸ªä¸»æˆåˆ†çš„ç´¯è®¡è´¡çŒ®åº¦å·²ç»åˆ°<span class="math inline">\(92%\)</span>ï¼Œå‰ä¸¤ä¸ªä¸»æˆåˆ†æå–äº†åŸå§‹æ•°æ®çš„ç»å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©2ä¸ªä¸»æˆåˆ†åº”è¯¥å¯ä»¥è¾ƒå¥½åœ°é‡æ„åŸå§‹æ•°æ®ã€‚</p>
<p>ä»¥ç¬¬ä¸€ä¸»æˆåˆ†ä¸ºä¾‹è¯´æ˜ç¬¬ä¸€ä¸»æˆåˆ†å’Œ<span class="math inline">\(x_1^*,\ldots,x_5^*\)</span>çš„å…³ç³»</p>
<pre class="{rï¼Œeval=f}"><code># PCA Sports Cars weights
alpha &lt;- SVD$v[,1]/sds
(alpha_star &lt;- c(alpha[1],alpha[2]-alpha[1], alpha[3], alpha[4], alpha[5]-alpha[2])/alpha[1])</code></pre>
<p><span class="math inline">\(y_1=\left&lt;\mathbf{v_1},\mathbf{x}\right&gt;=-0.558x_1+0.412x_2+0.539x_3+0.126x_4+0.461x_5\)</span>å› ä¸ºæ­¤å¤„çš„<span class="math inline">\(x_1,\ldots,x_5\)</span>æ¥è‡ªæ ‡å‡†è®¾è®¡çŸ©é˜µï¼Œæ‰€ä»¥æˆ‘ä»¬åšé€†å˜æ¢<span class="math inline">\(\alpha_lx_l^*=\alpha_l\left(\hat{\sigma_l}\frac{x_l^*-\hat{\mu_l}}{\hat{\sigma_l}}+\hat{\mu_l}\right)=\alpha_l\hat{\sigma_l}x_l+\alpha_l\hat{\mu_l}\)</span>,å…¶ä¸­<span class="math inline">\(\alpha_l\hat{\sigma_l}=\mathbf{v_{1,l}}\)</span>,ç”±æ­¤å¯å¾—åŸå§‹æ–¹ç¨‹ä¸º<span class="math inline">\(\frac{y^*}{\alpha_1}=log(\text{weight})-1.93log(\text{max_power})-0.65log(\text{max_torque})-0.64log(\text{max_engine_speed})+0.25log(\text{cubic_capacity})\)</span>å°†æ ·æœ¬å¸¦å…¥è®¡ç®—æˆ‘ä»¬å³å¯å¾—åˆ°ç¬¬ä¸€ä¸»æˆåˆ†çš„å¾—åˆ†ã€‚ç¬¬äºŒä¸»æˆåˆ†è®¡ç®—åŒä¸Šã€‚</p>
<pre class="{rï¼Œeval=f}"><code># scatter plot
switch_sign &lt;- -1           # switch sign of the first component to make svd and princomp compatible
tt.pca &lt;- t.pca$scores
tt.pca[,1] &lt;- switch_sign *tt.pca[,1]
pairs(tt.pca,diag.panel=panel.qq,upper.panel=panel.cor)</code></pre>
<div class="figure" style="text-align: center">
<img src="./plots/5/pcascatter.png" alt="ä¸»æˆåˆ†æ•£ç‚¹å›¾" width="40%"  />
<p class="caption">
(#fig:pairs)ä¸»æˆåˆ†æ•£ç‚¹å›¾
</p>
</div>
<p>Figure 5.3:å¯¹è§’çº¿ä¸ºQ-Qå›¾ï¼Œå·¦ä¸‹éƒ¨åˆ†æ•£ç‚¹å›¾ï¼Œå³ä¸Šéƒ¨åˆ†ç›¸å…³ç³»æ•°å›¾ï¼ˆå„ä¸ªä¸»æˆåˆ†ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ‰€ä»¥ç›¸å…³ç³»æ•°ä¸º0ï¼‰</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="co"># plot first two principal components</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>dat3 &lt;-<span class="st"> </span>d.data </span>
<span id="cb68-3"><a href="#cb68-3"></a>dat3<span class="op">$</span>v1 &lt;-<span class="st"> </span>X1 <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,<span class="dv">1</span>]</span>
<span id="cb68-4"><a href="#cb68-4"></a>dat3<span class="op">$</span>v2 &lt;-<span class="st"> </span>X1 <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,<span class="dv">2</span>]</span>
<span id="cb68-5"><a href="#cb68-5"></a></span>
<span id="cb68-6"><a href="#cb68-6"></a><span class="co"># png(&quot;./plots/5/pca.png&quot;)</span></span>
<span id="cb68-7"><a href="#cb68-7"></a><span class="kw">plot</span>(<span class="dt">x=</span>dat3<span class="op">$</span>v1, <span class="dt">y=</span>dat3<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>,<span class="dv">7</span>), <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>,<span class="dv">7</span>), <span class="dt">ylab=</span><span class="st">&quot;2nd principal component&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;1st principal component&quot;</span>, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;principal components analysis&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb68-8"><a href="#cb68-8"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(dat3<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">21</span>),]</span>
<span id="cb68-9"><a href="#cb68-9"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;green&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb68-10"><a href="#cb68-10"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(dat3<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">17</span>),]</span>
<span id="cb68-11"><a href="#cb68-11"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb68-12"><a href="#cb68-12"></a><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;tau&gt;=21&quot;</span>, <span class="st">&quot;17&lt;=tau&lt;21&quot;</span>, <span class="st">&quot;tau&lt;17 (sports car)&quot;</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>))</span>
<span id="cb68-13"><a href="#cb68-13"></a><span class="co">#dev.off()</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/pca.png" alt="ä¸»æˆåˆ†å¾—åˆ†å›¾" width="40%"  />
<p class="caption">
(#fig:2pcas)ä¸»æˆåˆ†å¾—åˆ†å›¾
</p>
</div>
<p>Figure 5.4:æ ·æœ¬(n=475)çš„ä¸»æˆåˆ†å¾—åˆ†å›¾ï¼Œå…¶ä¸­è“è‰²ç‚¹å’Œçº¢è‰²ç‚¹ä¹‹é—´æœ‰ä¸€ä¸ªè¶…å¹³é¢å°†è·‘è½¦å’Œæ™®é€šè½¦å¾ˆå¥½çš„åŒºåˆ†å¼€äº†ã€‚</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="co"># reconstruction error</span></span>
<span id="cb69-2"><a href="#cb69-2"></a>reconstruction.PCA &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="kw">c</span>(<span class="dv">5</span>))</span>
<span id="cb69-3"><a href="#cb69-3"></a></span>
<span id="cb69-4"><a href="#cb69-4"></a><span class="cf">for</span> (p <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>){</span>
<span id="cb69-5"><a href="#cb69-5"></a>  Xp &lt;-<span class="st"> </span>SVD<span class="op">$</span>v[,<span class="dv">1</span><span class="op">:</span>p] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(SVD<span class="op">$</span>v[,<span class="dv">1</span><span class="op">:</span>p]) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(X)</span>
<span id="cb69-6"><a href="#cb69-6"></a>  Xp &lt;-<span class="st"> </span><span class="kw">t</span>(Xp)</span>
<span id="cb69-7"><a href="#cb69-7"></a>  reconstruction.PCA[p] &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">as.matrix</span>((X<span class="op">-</span>Xp)<span class="op">^</span><span class="dv">2</span>))<span class="op">/</span><span class="kw">nrow</span>(X))</span>
<span id="cb69-8"><a href="#cb69-8"></a>               }</span>
<span id="cb69-9"><a href="#cb69-9"></a><span class="kw">round</span>(reconstruction.PCA,<span class="dv">2</span>)               </span>
<span id="cb69-10"><a href="#cb69-10"></a></span>
<span id="cb69-11"><a href="#cb69-11"></a><span class="co"># biplot</span></span>
<span id="cb69-12"><a href="#cb69-12"></a>tt.pca &lt;-<span class="st"> </span>t.pca</span>
<span id="cb69-13"><a href="#cb69-13"></a>tt.pca<span class="op">$</span>scores[,<span class="dv">1</span>] &lt;-<span class="st">  </span>switch_sign <span class="op">*</span><span class="st"> </span>tt.pca<span class="op">$</span>scores[,<span class="dv">1</span>]</span>
<span id="cb69-14"><a href="#cb69-14"></a>tt.pca<span class="op">$</span>loadings[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span>switch_sign <span class="op">*</span><span class="st"> </span>tt.pca<span class="op">$</span>loadings[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span>] </span>
<span id="cb69-15"><a href="#cb69-15"></a><span class="kw">biplot</span>(tt.pca,<span class="dt">choices=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">scale=</span><span class="dv">0</span>, <span class="dt">expand=</span><span class="dv">2</span>, <span class="dt">xlab=</span><span class="st">&quot;1st principal component&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;2nd principal component&quot;</span>, <span class="dt">cex=</span><span class="kw">c</span>(<span class="fl">0.4</span>,<span class="fl">1.5</span>), <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>,<span class="dv">7</span>), <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>,<span class="dv">7</span>))</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/biplot.png" alt="çŸ¢é‡åˆ†è§£å›¾" width="40%"  />
<p class="caption">
(#fig:2pcas-2)çŸ¢é‡åˆ†è§£å›¾
</p>
</div>
<p>Figure 5.5:é»‘ç‚¹ä¹‹é—´çš„è·ç¦»è¡¨ç¤ºç›¸ä¼¼æ€§ã€‚çº¢è‰²çŸ¢é‡æ˜¯å‰ä¸¤ä¸ªæ ‡å‡†æ­£äº¤æƒå€¼å‘é‡<span class="math inline">\(\mathbf{v_1}\)</span>å’Œ<span class="math inline">\(\mathbf{v_2}\)</span>çš„åˆ†é‡ã€‚é•¿åº¦åæ˜ äº†å˜é‡çš„æ ‡å‡†å·®ï¼Œå¤¹è§’çš„ä½™å¼¦å€¼ç»™å‡ºäº†ç›¸åº”çš„ç›¸å…³æ€§ã€‚</p>
</div>
<div id="è‡ªç¼–ç " class="section level2">
<h2><span class="header-section-number">5.3</span> è‡ªç¼–ç </h2>
<p>PCAå¯¹å¼‚å¸¸å€¼å¾ˆæ•æ„Ÿï¼Œä¹Ÿæœ‰ç¨³å¥çš„PCAç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼ŒCrouxç­‰äººç»™å‡ºäº†ä¸€ä¸ªåŸºäºä¸­å€¼ç»å¯¹åå·®(MADs)çš„ç®—æ³•ï¼ŒRåŒ…ï¼špcaPPã€‚
ä¸»æˆåˆ†åˆ†æå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè‡ªåŠ¨ç¼–ç å™¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ›´ä¸€èˆ¬åœ°ä»‹ç»è‡ªåŠ¨ç¼–ç å™¨ï¼Œä¾‹å¦‚BNNã€‚</p>
<p>è‡ªç¼–ç åŒ…å«ç¼–ç å’Œè§£ç ä¸¤ä¸ªé•œé¢å¯¹ç§°çš„æ˜ å°„ï¼š</p>
<ul>
<li><p>ç¼–ç : <span class="math inline">\(\varphi:\mathbb{R}^q\rightarrow\mathbb{R}^p\)</span></p></li>
<li><p>è§£ç : <span class="math inline">\(\psi:\mathbb{R}^p\rightarrow\mathbb{R}^q\)</span>
å…¶ä¸­<span class="math inline">\(p \le q\)</span>ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªåº¦é‡å·®å¼‚çš„å‡½æ•°<span class="math inline">\(d(Â·,Â·)\)</span>ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(\mathbf{x}=\mathbf{y}\)</span>æ—¶<span class="math inline">\(d(x,y)=0\)</span>ï¼Œè‡ªç¼–ç å°±æ˜¯æ‰¾åˆ°ä¸€å¯¹<span class="math inline">\((\varphi,\psi)\)</span>ä½¿å¾—æœ‰<span class="math inline">\(\pi=\psi\circ\varphi\)</span>æ»¡è¶³<span class="math inline">\(d(\pi(\mathbf{x}),\mathbf{x})\)</span>æœ€å°ã€‚</p></li>
</ul>
<p>åœ¨PCAçš„ä¾‹å­ä¸­ï¼š</p>
<p><span class="math display">\[\varphi:\mathbb{R}^q\rightarrow\mathbb{R}^p,\mathbf{x}\mapsto\mathbf{y}=\varphi(\mathbf{x})=(\left&lt;\mathbf{v_1},\mathbf{x}\right&gt;,\ldots,\left&lt;\mathbf{v_p},\mathbf{x}\right&gt;)^T=(\mathbf{v_1},\ldots,\mathbf{v_p})^T\mathbf{x}.\]</span></p>
<p><span class="math display">\[\psi:\mathbb{R}^p\rightarrow\mathbb{R}^q,\mathbf{y}\mapsto\psi(\mathbf{y})=(\mathbf{v_1},\ldots,\mathbf{v_p})\mathbf{y}.\]</span></p>
<p><span class="math display">\[\pi(\mathbf{X}^T)=\psi\circ\varphi(\mathbf{x}^T)=(\mathbf{v_1},\ldots,\mathbf{v_p})(\mathbf{v_1},\ldots,\mathbf{v_p})^T\mathbf{X}^T=\mathbf{X_p}^T.\]</span></p>
<p><span class="math display">\[\sum_{i=1}^nd(\pi(\mathbf{x}_i),\mathbf{x}_i)=\sum_{i=1}^n\|\pi(\mathbf{x}_i-\mathbf{x}_i)\|_2^2=\|\mathbf{X}_p-\mathbf{X}\|_F^2.\]</span></p>
<p>æ­¤å¤„è¡¡é‡é‡æ„è¯¯å·®çš„ä¸ºé’ˆå¯¹çŸ©é˜µçš„æ¬§æ°è·ç¦»ï¼Œå³FèŒƒæ•°ã€‚</p>
<p>ä½œä¸ºéçº¿æ€§è‡ªç¼–ç å™¨çš„ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è€ƒè™‘ç“¶é¢ˆç¥ç»ç½‘ç»œ(BNN)ã€‚ä¸ºäº†æˆåŠŸæ ¡å‡†ä¸€ä¸ªBNNï¼Œå®ƒçš„éšè—å±‚æ•°åº”è¯¥æ˜¯å¥‡æ•°<span class="math inline">\(d\)</span> (<span class="math inline">\(d\)</span>ç§°ä¸ºç¥ç»ç½‘ç»œçš„æ·±åº¦)ï¼Œå¹¶ä¸”ä¸­å¿ƒéšè—å±‚åº”è¯¥æ˜¯ä½ç»´çš„ï¼Œæœ‰<span class="math inline">\(p\)</span>ä¸ªéšè—ç¥ç»å…ƒï¼Œæ‰€æœ‰å‰©ä½™çš„éšè—å±‚åº”è¯¥æ˜¯å›´ç»•è¿™ä¸ªä¸­å¿ƒéšè—å±‚å¯¹ç§°çš„ã€‚å› æ­¤å¯¹äºæ·±åº¦<span class="math inline">\(d = 3\)</span>çš„BNNï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å›¾@ref(fig:bnn-structure)å±•ç¤ºçš„ç¥ç»ç½‘ç»œç»“æ„</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/bnn.png" alt="è‡ªç¼–ç  q=5,p=2" width="40%"  />
<p class="caption">
(#fig:bnn-structure)è‡ªç¼–ç  q=5,p=2
</p>
</div>
<p>ä¸€èˆ¬çš„ç¥ç»ç½‘ç»œæœ‰å¦‚ä¸‹ç»“æ„ï¼š</p>
<p><span class="math display">\[\pi:\mathbb{R}^{q_0}\rightarrow\mathbb{R}^{q_{d+1}=q_0},\mathbf{x}\mapsto\pi(\mathbf{x})=(\mathbf{z}^\left(d+1\right)\circ\mathbf{z}^\left(d\right)\circ\ldots\circ\mathbf{z}^\left(1\right))(\mathbf{x})\]</span></p>
<p><span class="math display">\[\mathbf{z}^\left(m\right):\mathbb{R}^{q_{m-1}}\rightarrow\mathbb{R}^{q_m},\mathbf{z}\mapsto\mathbf{z}^\left(m\right)(\mathbf{z})=\left(\phi\left(\left&lt;\mathbf{w}_1^{\left(m\right)},\mathbf{z}\right&gt;\right),\ldots,\phi\left(\left&lt;\mathbf{w}_{q_m}^{\left(m\right)},\mathbf{z}\right&gt;\right)\right)^T\]</span></p>
<p>å…¶ä¸­<span class="math inline">\(\mathbf{w}_l^{\left(m\right)}\in\mathbb{R}^{q_{m-1}},1 \le l\le q_m\)</span>ä¸ºæƒé‡ï¼Œ<span class="math inline">\(\phi:\mathbb{R}\rightarrow\mathbb{R}\)</span>ä¸ºæ¿€æ´»å‡½æ•°ã€‚</p>
<p><span class="math display">\[\mathbf{z}^\left(d+1\right):\mathbb{R}^{q_{d}}\rightarrow\mathbb{R}^{q_{d+1}},\mathbf{z}\mapsto\mathbf{z}^\left(d+1\right)(\mathbf{z})=\left(\left&lt;\mathbf{w}_1^{\left(d+1\right)},\mathbf{z}\right&gt;,\ldots,\left&lt;\mathbf{w}_{q_{d+1}}^{\left(d+1\right)},\mathbf{z}\right&gt;\right)^T\]</span></p>
<p>æ€»å‚æ•°ä¸ªæ•°ä¸º<span class="math inline">\(r=\sum_{m=1}^{d+1}q_mq_{m-1}\)</span>ã€‚</p>
<ul>
<li><p>ä¸ç»å…¸çš„å‰é¦ˆç¥ç»ç½‘ç»œç›¸æ¯”ï¼Œæˆ‘ä»¬è¿™é‡Œæ²¡æœ‰æˆªè·é¡¹ï¼Œå› ä¸ºç‰¹å¾$_iå·²ç»è¢«æ ‡å‡†åŒ–ã€‚è¿™ç•¥å¾®é™ä½äº†ç½‘ç»œå‚æ•°çš„ç»´æ•°ã€‚</p></li>
<li><p>é€‰æ‹©è¾“å‡ºæ¿€æ´»ä¸ºçº¿æ€§æ¿€æ´»ï¼Œæ˜¯å› ä¸ºxçš„æ‰€æœ‰æˆä»½éƒ½åœ¨å®æ•°é¢†åŸŸä¸­ã€‚ä¸‹é¢æˆ‘ä»¬è¿˜å°†åº”ç”¨å…¶ä»–è¾“å‡ºæ¿€æ´»å‡½æ•°ã€‚</p></li>
<li><p>ä½œä¸ºéšå±‚çš„æ¿€æ´»å‡½æ•°ï¼Œæˆ‘ä»¬é€šå¸¸é€‰ç”¨åŒæ›²æ­£åˆ‡å‡½æ•°ã€‚å¦‚æœä¸€ä¸ªBNNåªæœ‰çº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œé‚£ä¹ˆä»–æ˜¯ç­‰ä»·äºPCAçš„ã€‚</p></li>
</ul>
<div id="æ¨¡å‹è®­ç»ƒ" class="section level3">
<h3><span class="header-section-number">5.3.1</span> æ¨¡å‹è®­ç»ƒ</h3>
<p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>åœ¨æ­£å¼è¿›å…¥ç¥ç»ç½‘ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆè¿›è¡Œæƒé‡é¢„è®­ç»ƒã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/bnn_train.png" alt="è‡ªç¼–ç è®­ç»ƒè¿‡ç¨‹" width="60%"  />
<p class="caption">
(#fig:bnn-train)è‡ªç¼–ç è®­ç»ƒè¿‡ç¨‹
</p>
</div>
<ul>
<li><p>é¦–å…ˆæˆ‘ä»¬å…ˆå°†ä¸­é—´çš„éšè—å±‚æŠ˜å å¾—åˆ°å¦‚å›¾@ref(fig:bnn-train)ä¸­é—´ç»“æ„çš„ç¥ç»ç½‘ç»œï¼Œæ®æ­¤æˆ‘ä»¬å¾—åˆ°æƒé‡ï¼š<span class="math inline">\(\mathbf{w}_1^{(1)}\ldots,\mathbf{w}_{q_1=7}^{(1)}\in\mathbb{R}^{q_0=5}\)</span>
å’Œ<span class="math inline">\(\mathbf{w}_1^{(d+1)}\ldots,\mathbf{w}_{q_{d+1}=5}^{(d+1)}\in\mathbb{R}^{q_d=7}\)</span></p></li>
<li><p>å†è®­ç»ƒéšè—å±‚å³å›¾@ref(fig:bnn-train)ä¸­å³å›¾çš„æƒé‡ï¼Œå¾—åˆ°ï¼š<span class="math inline">\(\mathbf{w}_1^{(2)}\ldots,\mathbf{w}_{q_2=2}^{(2)}\in\mathbb{R}^{q_1=7}\)</span>
å’Œ<span class="math inline">\(\mathbf{w}_1^{(3)}\ldots,\mathbf{w}_{q_{3}=7}^{(3)}\in\mathbb{R}^{q_2=2}\)</span></p></li>
</ul>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>bottleneck<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="cf">function</span>(q00, q22){</span>
<span id="cb70-2"><a href="#cb70-2"></a>   Input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(q00), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;Input&#39;</span>)</span>
<span id="cb70-3"><a href="#cb70-3"></a>   </span>
<span id="cb70-4"><a href="#cb70-4"></a>   Output =<span class="st"> </span>Input <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q22, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">use_bias=</span><span class="ot">FALSE</span>, <span class="dt">name=</span><span class="st">&#39;Bottleneck&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb70-6"><a href="#cb70-6"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q00, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">use_bias=</span><span class="ot">FALSE</span>, <span class="dt">name=</span><span class="st">&#39;Output&#39;</span>)</span>
<span id="cb70-7"><a href="#cb70-7"></a></span>
<span id="cb70-8"><a href="#cb70-8"></a>   model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> Input, <span class="dt">outputs =</span> Output)</span>
<span id="cb70-9"><a href="#cb70-9"></a>   </span>
<span id="cb70-10"><a href="#cb70-10"></a>   model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;mean_squared_error&#39;</span>)</span>
<span id="cb70-11"><a href="#cb70-11"></a>   model</span>
<span id="cb70-12"><a href="#cb70-12"></a>   }</span>
<span id="cb70-13"><a href="#cb70-13"></a></span>
<span id="cb70-14"><a href="#cb70-14"></a>bottleneck<span class="fl">.3</span> &lt;-<span class="st"> </span><span class="cf">function</span>(q00, q11, q22){   </span>
<span id="cb70-15"><a href="#cb70-15"></a>   Input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(q00), <span class="dt">dtype =</span> <span class="st">&#39;float32&#39;</span>, <span class="dt">name =</span> <span class="st">&#39;Input&#39;</span>)</span>
<span id="cb70-16"><a href="#cb70-16"></a>   </span>
<span id="cb70-17"><a href="#cb70-17"></a>   Encoder =<span class="st"> </span>Input <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb70-18"><a href="#cb70-18"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q11, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">use_bias=</span><span class="ot">FALSE</span>, <span class="dt">name=</span><span class="st">&#39;Layer1&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb70-19"><a href="#cb70-19"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q22, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">use_bias=</span><span class="ot">FALSE</span>, <span class="dt">name=</span><span class="st">&#39;Bottleneck&#39;</span>) </span>
<span id="cb70-20"><a href="#cb70-20"></a></span>
<span id="cb70-21"><a href="#cb70-21"></a>   Decoder =<span class="st"> </span>Encoder <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb70-22"><a href="#cb70-22"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q11, <span class="dt">activation=</span><span class="st">&#39;tanh&#39;</span>, <span class="dt">use_bias=</span><span class="ot">FALSE</span>, <span class="dt">name=</span><span class="st">&#39;Layer3&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb70-23"><a href="#cb70-23"></a><span class="st">          </span><span class="kw">layer_dense</span>(<span class="dt">units=</span>q00, <span class="dt">activation=</span><span class="st">&#39;linear&#39;</span>, <span class="dt">use_bias=</span><span class="ot">FALSE</span>, <span class="dt">name=</span><span class="st">&#39;Output&#39;</span>)</span>
<span id="cb70-24"><a href="#cb70-24"></a></span>
<span id="cb70-25"><a href="#cb70-25"></a>   model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> Input, <span class="dt">outputs =</span> Decoder)</span>
<span id="cb70-26"><a href="#cb70-26"></a>   model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(), <span class="dt">loss =</span> <span class="st">&#39;mean_squared_error&#39;</span>)</span>
<span id="cb70-27"><a href="#cb70-27"></a>   model</span>
<span id="cb70-28"><a href="#cb70-28"></a>   }</span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="co"># bottleneck architecture</span></span>
<span id="cb71-2"><a href="#cb71-2"></a>q1 &lt;-<span class="st"> </span><span class="dv">7</span></span>
<span id="cb71-3"><a href="#cb71-3"></a>q2 &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb71-4"><a href="#cb71-4"></a>q0 &lt;-<span class="st"> </span><span class="kw">ncol</span>(X)</span>
<span id="cb71-5"><a href="#cb71-5"></a></span>
<span id="cb71-6"><a href="#cb71-6"></a><span class="co"># pre-training 1: merging layers 1 and 3 (skipping bottleneck)</span></span>
<span id="cb71-7"><a href="#cb71-7"></a>model<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">bottleneck.1</span>(q0, q1)</span>
<span id="cb71-8"><a href="#cb71-8"></a>model<span class="fl">.1</span></span>
<span id="cb71-9"><a href="#cb71-9"></a>epochs &lt;-<span class="st"> </span><span class="dv">2000</span></span>
<span id="cb71-10"><a href="#cb71-10"></a>batch_size &lt;-<span class="st"> </span><span class="kw">nrow</span>(X)</span>
<span id="cb71-11"><a href="#cb71-11"></a></span>
<span id="cb71-12"><a href="#cb71-12"></a><span class="co"># fit the merged model</span></span>
<span id="cb71-13"><a href="#cb71-13"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb71-14"><a href="#cb71-14"></a>  fit &lt;-<span class="st"> </span>model<span class="fl">.1</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="kw">as.matrix</span>(X), <span class="kw">as.matrix</span>(X), <span class="dt">epochs=</span>epochs, <span class="dt">batch_size=</span>batch_size, <span class="dt">verbose=</span><span class="dv">0</span>)</span>
<span id="cb71-15"><a href="#cb71-15"></a><span class="kw">proc.time</span>()<span class="op">-</span>t1}</span>
<span id="cb71-16"><a href="#cb71-16"></a></span>
<span id="cb71-17"><a href="#cb71-17"></a><span class="kw">plot</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss)), <span class="dt">y=</span><span class="kw">sqrt</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss<span class="op">*</span>q0),  <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="kw">max</span>(<span class="kw">sqrt</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss<span class="op">*</span>q0))),<span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">cex=</span>.<span class="dv">5</span>, <span class="dt">xlab=</span><span class="st">&#39;epochs&#39;</span>, <span class="dt">ylab=</span><span class="st">&#39;Frobenius norm loss&#39;</span>, <span class="dt">main=</span><span class="st">&quot;gradient descent algorithm&quot;</span>) </span>
<span id="cb71-18"><a href="#cb71-18"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">c</span>(<span class="fl">0.6124</span>), <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>)</span>
<span id="cb71-19"><a href="#cb71-19"></a> </span>
<span id="cb71-20"><a href="#cb71-20"></a><span class="co"># neuron activations in the central layer </span></span>
<span id="cb71-21"><a href="#cb71-21"></a>zz &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs=</span>model<span class="fl">.1</span><span class="op">$</span>input, <span class="dt">outputs=</span><span class="kw">get_layer</span>(model<span class="fl">.1</span>, <span class="st">&#39;Bottleneck&#39;</span>)<span class="op">$</span>output)</span>
<span id="cb71-22"><a href="#cb71-22"></a>yy &lt;-<span class="st"> </span>zz <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">as.matrix</span>(X))</span>
<span id="cb71-23"><a href="#cb71-23"></a></span>
<span id="cb71-24"><a href="#cb71-24"></a><span class="co"># pre-training 2: middlepart</span></span>
<span id="cb71-25"><a href="#cb71-25"></a>model<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">bottleneck.1</span>(q1, q2)</span>
<span id="cb71-26"><a href="#cb71-26"></a>model<span class="fl">.2</span></span>
<span id="cb71-27"><a href="#cb71-27"></a>epochs &lt;-<span class="st"> </span><span class="dv">2000</span></span>
<span id="cb71-28"><a href="#cb71-28"></a></span>
<span id="cb71-29"><a href="#cb71-29"></a><span class="co"># fit the merged model</span></span>
<span id="cb71-30"><a href="#cb71-30"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb71-31"><a href="#cb71-31"></a>  fit &lt;-<span class="st"> </span>model<span class="fl">.2</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="kw">as.matrix</span>(yy), <span class="kw">as.matrix</span>(yy), <span class="dt">epochs=</span>epochs, <span class="dt">batch_size=</span>batch_size, <span class="dt">verbose=</span><span class="dv">0</span>)</span>
<span id="cb71-32"><a href="#cb71-32"></a><span class="kw">proc.time</span>()<span class="op">-</span>t1}</span>
<span id="cb71-33"><a href="#cb71-33"></a></span>
<span id="cb71-34"><a href="#cb71-34"></a><span class="kw">plot</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss)), <span class="dt">y=</span><span class="kw">sqrt</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss<span class="op">*</span>q0),  <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="kw">max</span>(<span class="kw">sqrt</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss<span class="op">*</span>q0))),<span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">cex=</span>.<span class="dv">5</span>, <span class="dt">xlab=</span><span class="st">&#39;epochs&#39;</span>, <span class="dt">ylab=</span><span class="st">&#39;Frobenius norm loss&#39;</span>, <span class="dt">main=</span><span class="st">&quot;gradient descent algorithm&quot;</span>) </span></code></pre></div>
<p>é¢„è®­ç»ƒç»“æŸåï¼Œç”¨è¿™äº›é¢„å…ˆè®­ç»ƒå¥½çš„æƒå€¼å¯¹æ•´ä¸ªBNNè¿›è¡Œé‡æ„ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªé‡æ„è¯¯å·®ï¼ˆå¦‚ä¸‹ï¼‰åœ¨æ­¤æ¡ˆä¾‹ä¸­ï¼Œæ­¤å¤„çš„é‡æ„è¯¯å·®å¤§äºä½¿ç”¨PCAæ—¶å–ä¸¤ä¸ªä¸»æˆåˆ†çš„é‡æ„è¯¯å·®ã€‚</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># fitting the full model</span></span>
<span id="cb72-2"><a href="#cb72-2"></a>model<span class="fl">.3</span> &lt;-<span class="st"> </span><span class="kw">bottleneck.3</span>(q0, q1, q2)</span>
<span id="cb72-3"><a href="#cb72-3"></a>model<span class="fl">.3</span></span>
<span id="cb72-4"><a href="#cb72-4"></a></span>
<span id="cb72-5"><a href="#cb72-5"></a><span class="co"># set weights</span></span>
<span id="cb72-6"><a href="#cb72-6"></a>weight<span class="fl">.3</span> &lt;-<span class="st"> </span><span class="kw">get_weights</span>(model<span class="fl">.3</span>)</span>
<span id="cb72-7"><a href="#cb72-7"></a>weight<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">get_weights</span>(model<span class="fl">.1</span>)</span>
<span id="cb72-8"><a href="#cb72-8"></a>weight<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">get_weights</span>(model<span class="fl">.2</span>)</span>
<span id="cb72-9"><a href="#cb72-9"></a>weight<span class="fl">.3</span>[[<span class="dv">1</span>]] &lt;-<span class="st"> </span>weight<span class="fl">.1</span>[[<span class="dv">1</span>]]</span>
<span id="cb72-10"><a href="#cb72-10"></a>weight<span class="fl">.3</span>[[<span class="dv">4</span>]] &lt;-<span class="st"> </span>weight<span class="fl">.1</span>[[<span class="dv">2</span>]]</span>
<span id="cb72-11"><a href="#cb72-11"></a>weight<span class="fl">.3</span>[[<span class="dv">2</span>]] &lt;-<span class="st"> </span>weight<span class="fl">.2</span>[[<span class="dv">1</span>]]</span>
<span id="cb72-12"><a href="#cb72-12"></a>weight<span class="fl">.3</span>[[<span class="dv">3</span>]] &lt;-<span class="st"> </span>weight<span class="fl">.2</span>[[<span class="dv">2</span>]]</span>
<span id="cb72-13"><a href="#cb72-13"></a><span class="kw">set_weights</span>(model<span class="fl">.3</span>, weight<span class="fl">.3</span>)</span>
<span id="cb72-14"><a href="#cb72-14"></a>fit0 &lt;-<span class="st"> </span>model<span class="fl">.3</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">as.matrix</span>(X))</span>
<span id="cb72-15"><a href="#cb72-15"></a></span>
<span id="cb72-16"><a href="#cb72-16"></a><span class="co"># reconstruction error of the pre-calibrated network</span></span>
<span id="cb72-17"><a href="#cb72-17"></a><span class="co"># note that this error may differ from the tutorial because we did not set a seed</span></span>
<span id="cb72-18"><a href="#cb72-18"></a><span class="kw">round</span>(<span class="kw">Frobenius.loss</span>(X,fit0),<span class="dv">4</span>)</span></code></pre></div>
<p>ä½¿ç”¨è¿™äº›é¢„å…ˆè®­ç»ƒå¥½çš„æƒå€¼ä½œä¸ºåˆå§‹åŒ–ï¼Œå°†æ¢¯åº¦ä¸‹é™ç®—æ³•åº”ç”¨äºæ•´ä¸ªBNNï¼Œä»¥è·å¾—BNNé™ç»´ã€‚</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a><span class="co"># calibrate full bottleneck network</span></span>
<span id="cb73-2"><a href="#cb73-2"></a>epochs &lt;-<span class="st"> </span><span class="dv">10000</span></span>
<span id="cb73-3"><a href="#cb73-3"></a>batch_size &lt;-<span class="st"> </span><span class="kw">nrow</span>(X)</span>
<span id="cb73-4"><a href="#cb73-4"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb73-5"><a href="#cb73-5"></a>  fit &lt;-<span class="st"> </span>model<span class="fl">.3</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="kw">as.matrix</span>(X), <span class="kw">as.matrix</span>(X), <span class="dt">epochs=</span>epochs, <span class="dt">batch_size=</span>batch_size, <span class="dt">verbose=</span><span class="dv">0</span>)</span>
<span id="cb73-6"><a href="#cb73-6"></a><span class="kw">proc.time</span>()<span class="op">-</span>t1}</span>
<span id="cb73-7"><a href="#cb73-7"></a></span>
<span id="cb73-8"><a href="#cb73-8"></a><span class="kw">plot</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss)), <span class="dt">y=</span><span class="kw">sqrt</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss<span class="op">*</span>q0), <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="kw">max</span>(<span class="kw">sqrt</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss<span class="op">*</span>q0))),<span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">cex=</span>.<span class="dv">5</span>, <span class="dt">xlab=</span><span class="st">&#39;epochs&#39;</span>, <span class="dt">ylab=</span><span class="st">&#39;Frobenius norm loss&#39;</span>, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;gradient descent algorithm&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>) </span>
<span id="cb73-9"><a href="#cb73-9"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">c</span>(<span class="fl">0.6124</span>), <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>) </span>
<span id="cb73-10"><a href="#cb73-10"></a><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;decrease GDM&quot;</span>, <span class="st">&quot;PCA(p=2)&quot;</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;orange&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">19</span>,<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb73-11"><a href="#cb73-11"></a></span>
<span id="cb73-12"><a href="#cb73-12"></a><span class="co"># reconstruction error (slightly differs from 0.5611 because of missing seed)</span></span>
<span id="cb73-13"><a href="#cb73-13"></a>fit0 &lt;-<span class="st"> </span>model<span class="fl">.3</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">as.matrix</span>(X))</span>
<span id="cb73-14"><a href="#cb73-14"></a><span class="kw">round</span>(<span class="kw">Frobenius.loss</span>(X,fit0),<span class="dv">4</span>)</span>
<span id="cb73-15"><a href="#cb73-15"></a></span>
<span id="cb73-16"><a href="#cb73-16"></a><span class="co"># read off the bottleneck activations</span></span>
<span id="cb73-17"><a href="#cb73-17"></a>encoder &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs=</span>model<span class="fl">.3</span><span class="op">$</span>input, <span class="dt">outputs=</span><span class="kw">get_layer</span>(model<span class="fl">.3</span>, <span class="st">&#39;Bottleneck&#39;</span>)<span class="op">$</span>output)</span>
<span id="cb73-18"><a href="#cb73-18"></a>y&lt;-<span class="st"> </span><span class="kw">predict</span>(encoder,<span class="kw">as.matrix</span>(X))</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/gda.png" alt="é‡æ„è¯¯å·®å›¾" width="60%"  />
<p class="caption">
(#fig:gda)é‡æ„è¯¯å·®å›¾
</p>
</div>
<p>æˆ‘ä»¬è¯´æ˜äº†<span class="math inline">\(\mathbf{F}\)</span>èŒƒæ•°æŸå¤±å‡½æ•°åœ¨è¶…è¿‡10,000æ¬¡è¿­ä»£æ—¶çš„ä¸‹é™è¿‡ç¨‹ã€‚åœ¨å¤§çº¦2000æ¬¡è¿­ä»£åï¼ŒæŸå¤±ä½äº<span class="math inline">\(p=2\)</span>ä¸ªä¸»æˆåˆ†çš„PCA(å›¾@ref(fig:gda)ä¸­æ©™è‰²çº¿åœ¨æ°´å¹³0.6124å¤„)ã€‚10,000æ¬¡è¿­ä»£åçš„æœ€ç»ˆé‡æ„è¯¯å·®ä¸º0.5428ã€‚</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># note that we may need sign switches to make it comparable to PCA</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>y0 &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">abs</span>(y))<span class="op">*</span><span class="fl">1.1</span></span>
<span id="cb74-3"><a href="#cb74-3"></a><span class="kw">plot</span>(<span class="dt">x=</span>y[,<span class="dv">1</span>], <span class="dt">y=</span>y[,<span class="dv">2</span>], <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span>y0,y0), <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span>y0,y0), <span class="dt">ylab=</span><span class="st">&quot;2nd bottleneck neuron&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;1st bottleneck neuron&quot;</span>, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;bottleneck neural network autoencoder&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb74-4"><a href="#cb74-4"></a>dat0 &lt;-<span class="st"> </span>y[<span class="kw">which</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">21</span>),]</span>
<span id="cb74-5"><a href="#cb74-5"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0[,<span class="dv">1</span>], <span class="dt">y=</span>dat0[,<span class="dv">2</span>], <span class="dt">col=</span><span class="st">&quot;green&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb74-6"><a href="#cb74-6"></a>dat0 &lt;-<span class="st"> </span>y[<span class="kw">which</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">17</span>),]</span>
<span id="cb74-7"><a href="#cb74-7"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0[,<span class="dv">1</span>], <span class="dt">y=</span>dat0[,<span class="dv">2</span>], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb74-8"><a href="#cb74-8"></a><span class="kw">legend</span>(<span class="st">&quot;bottomright&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;tau&gt;=21&quot;</span>, <span class="st">&quot;17&lt;=tau&lt;21&quot;</span>, <span class="st">&quot;tau&lt;17 (sports car)&quot;</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>))</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/bnns.png" alt="BNN" width="60%"  />
<p class="caption">
(#fig:bnns)BNN
</p>
</div>
<p>å›¾@ref(fig:bnns)ä¸ºå¯¹æ ·æœ¬<span class="math inline">\((n=475)\)</span>çš„åˆ†ç±»æ•ˆæœï¼Œä¸PCAï¼ˆæ—‹è½¬ï¼‰å¾ˆåƒã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/BPcamparison.png" alt="BNNä¸PCAé‡æ„è¯¯å·®å¯¹æ¯”å›¾" width="60%"  />
<p class="caption">
(#fig:BPcamparison)BNNä¸PCAé‡æ„è¯¯å·®å¯¹æ¯”å›¾
</p>
</div>
<p>ç”±å›¾@ref(fig:BPcamparison)å¾—å‡ºç»“è®ºï¼šä¸¤ç§æ–¹æ³•éƒ½å¾—åˆ°äº†ç›¸ä¼¼çš„ç»“æœã€‚ä½†åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒBNNçš„é‡æ„è¯¯å·®è¾ƒå°ã€‚åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼ŒBNNå¯ä»¥å¾—åˆ°æ›´å¥½çš„é‡å»ºç»“æœ(å³ä¸‹è§’çš„æ©™è‰²ç‚¹)ã€‚
é’ˆå¯¹è¿™ä¸ªä¾‹å­è€Œè¨€ï¼Œå±äºä½ç»´æ•°çš„é—®é¢˜ï¼Œä¸»æˆåˆ†åˆ†æé€šå¸¸å°±å¯ä»¥äº†ï¼Œå› ä¸ºéçº¿æ€§çš„éƒ¨åˆ†å¹¶æ²¡æœ‰å‘æŒ¥å…³é”®ä½œç”¨ã€‚</p>
</div>
</div>
<div id="k-means-clustering" class="section level2">
<h2><span class="header-section-number">5.4</span> K-means clustering</h2>
<p>K-meansèšç±»æ˜¯ä¸€ç§åŸºäºè´¨å¿ƒï¼ˆcentroid-basedï¼‰çš„èšç±»æ–¹æ³•ï¼Œå®ƒå°†<span class="math inline">\(n\)</span>ä¸ªæ ·æœ¬ç‚¹<span class="math inline">\(\mathbf{x}_i\in\mathcal{X}\subset\mathbb{R}^q\)</span>åˆ’åˆ†ä¸º<span class="math inline">\(K\)</span>ä¸ªä¸ç›¸äº¤çš„ç±»:<span class="math display">\[\mathcal{C}_K:\mathbb{R}^q\rightarrow\mathcal{K}=\{1,\ldots,K\},~~\mathbf{x}\mapsto\mathcal{C}_K(\mathbf{x})\]</span>ï¼Œä»¥ä¸Šç»™å‡ºäº†å¯¹ç‰¹å¾ç©ºé—´<span class="math inline">\(\mathcal{X}\)</span>çš„ä¸€ä¸ªåˆ†å‰²<span class="math inline">\((C_1,\ldots,C_K)\)</span>ï¼Œå…¶ä¸­<span class="math display">\[C_k=\{\mathbf{x}\in\mathcal{X};\mathcal{C}_K(\mathbf{x})=k\}\]</span></p>
<p>ç¡®å®š<span class="math inline">\(\mathcal{C}_K\)</span>çš„åŸåˆ™æ˜¯ä½¿æ€»ç±»å†…å·®å¼‚æœ€å°ï¼Œè¿™å¯ä»¥è½¬åŒ–ä¸ºè®¡ç®—ä½¿ç±»å†…ç¦»å·®å¹³æ–¹å’Œæ€»å’Œæœ€å°çš„ä¸€ä¸ªåˆ†å‰²ï¼Œæ‰€æ„é€ çš„ç›®æ ‡å‡½æ•°ä¸º ï¼š
<span class="math display">\[\underset{(C_1,\ldots,C_K)}{\arg \min}\sum_{k=1}^K\sum_{\mathbf{x}_i\in C_k\cap\mathcal{X}}d(\mathbf{\mu}_k,\mathbf{x}_i)=\underset{(C_1,\ldots,C_K)}{\arg \min}\sum_{k=1}^K\sum_{\mathbf{x}_i\in C_k\cap\mathcal{X}}||\mathbf{\mu}_k-\mathbf{x}_i||_2^2\]</span></p>
<p>å…¶ä¸­<span class="math inline">\(\mathbf{\mu}_k\)</span>ä¸ºç±»å‡å€¼å‘é‡ï¼Œå› æ­¤ç›®æ ‡å‡½æ•°è¡¡é‡äº†ç±»å†…æ ·æœ¬ç‚¹å›´ç»•ç±»å‡å€¼å‘é‡çš„ç´§å¯†ç¨‹åº¦ï¼Œå…¶å€¼è¶Šå°æ„å‘³ç€ç±»å†…æ ·æœ¬ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œèšç±»æ•ˆæœè¶Šå¥½ã€‚ä½†æ˜¯ä¸Šè¿°ç›®æ ‡å‡½æ•°å¹¶ä¸å®¹æ˜“æ‰¾åˆ°æœ€ä¼˜è§£ï¼Œè¿™éœ€è¦è€ƒè™‘<span class="math inline">\(n\)</span>ä¸ªæ ·æœ¬ç‚¹æ‰€æœ‰å¯èƒ½çš„ç±»åˆ’åˆ†ï¼Œå› æ­¤K-meansç®—æ³•é‡‡ç”¨äº†è´ªå¿ƒç­–ç•¥ï¼Œé€šè¿‡è¿­ä»£ä¼˜åŒ–æ¥è¿‘ä¼¼æ±‚è§£ä¸Šè¿°ç›®æ ‡å‡½æ•°ã€‚</p>
<p>K-meansç®—æ³•:</p>
<ol style="list-style-type: decimal">
<li><p>é€‰æ‹©åˆå§‹èšç±»ä¸­å¿ƒ<span class="math inline">\(\mathbf{\mu}_k^{(0)}\)</span>å’Œèšç±»ä¸ªæ•°<span class="math inline">\(K\)</span>ï¼›</p></li>
<li><p>è¿­ä»£(ç»ˆæ­¢æ¡ä»¶ï¼šé™¤éç±»å‡å€¼å‘é‡<span class="math inline">\(\mathbf{\mu}_k^{(t-1)}\)</span>ä¸å†æ›´æ–°æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°)</p>
<p>(1)è®¡ç®—<span class="math inline">\(n\)</span>ä¸ªæ ·æœ¬ç‚¹<span class="math inline">\(x_i\)</span>ä¸å‰ä¸€è½®å‡å€¼å‘é‡<span class="math inline">\(\mathbf{\mu}_k^{(t)}\)</span>çš„è·ç¦»ï¼Œæ ¹æ®è·ç¦»æœ€è¿‘åŸåˆ™é‡æ–°åˆ†é…æ‰€æœ‰æ ·æœ¬ç‚¹ï¼Œå³<span class="math display">\[C_k^{(t)}(x_i)=\underset{\mathbf{k}\in\mathcal{K}}{\arg\min}||\mathbf{\mu}_k^{(t-1)}-\mathbf{x}_i||_2^2\]</span>
(2)åŸºäº<span class="math inline">\(C_k^{(t)}\)</span>æ›´æ–°ç±»å‡å€¼å‘é‡<span class="math inline">\(\mathbf{\mu}_k^{(t)}\)</span></p></li>
</ol>
<p>K-meansä¸­å­˜åœ¨çš„é—®é¢˜</p>
<ol style="list-style-type: decimal">
<li><p>å¯¹åˆå§‹èšç±»ä¸­å¿ƒæ•æ„Ÿã€‚é€‰æ‹©ä¸åŒçš„èšç±»ä¸­å¿ƒä¼šäº§ç”Ÿä¸åŒçš„èšç±»ç»“æœå’Œä¸åŒçš„å‡†ç¡®ç‡ï¼›è‹¥éšæœºæŒ‡å®šåˆå§‹èšç±»ä¸­å¿ƒï¼Œå½“åˆå§‹æŒ‡å®šçš„ä¸¤ä¸ªèšç±»ä¸­å¿ƒåœ¨åŒä¸€ç±»ä¸­æˆ–å¾ˆæ¥è¿‘ï¼Œèšç±»ç»“æœå¾ˆéš¾åŒºåˆ†ã€‚æ­¤å¤„å¯ä»¥ä½¿ç”¨ä¸€ç§ä¼˜åŒ–ç®—æ³•ï¼šå…ˆæŒ‡å®šk=2æ‰§è¡Œk-means(åˆå§‹èšç±»ä¸­å¿ƒéšæœºæŒ‡å®š)ï¼Œç»“æœå¾—åˆ°ä¸¤ä¸ªèšç±»ä¸­å¿ƒï¼ŒæŠŠå®ƒä»¬ä½œä¸ºk=3æ—¶çš„å…¶ä¸­ä¸¤ä¸ªåˆå§‹èšç±»ä¸­å¿ƒï¼Œå‰©ä¸‹ä¸€ä¸ªåˆå§‹èšç±»ä¸­å¿ƒéšæœºæŒ‡å®š(å¯ä»¥ä½¿ç”¨åˆ—å‡å€¼)ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></li>
<li><p>K-meansèšç±»ç”±äºä½¿ç”¨ç±»å‡å€¼å‘é‡ä½œä¸ºèšç±»ä¸­å¿ƒï¼Œå› æ­¤å¯¹ç¦»ç¾¤ç‚¹éå¸¸æ•æ„Ÿ</p></li>
<li><p>å› ä¸ºK-meansç®—æ³•ä¸»è¦é‡‡ç”¨æ¬§å¼è·ç¦»å‡½æ•°åº¦é‡ç±»é—´ç›¸ä¼¼åº¦ï¼Œå¹¶ä¸”é‡‡ç”¨è¯¯å·®å¹³æ–¹å’Œä½œä¸ºç›®æ ‡å‡½æ•°ï¼Œå› æ­¤é€šå¸¸åªèƒ½å‘ç°æ•°æ®åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€çš„çƒçŠ¶ç±»ã€‚</p></li>
</ol>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a><span class="co"># initialize</span></span>
<span id="cb75-2"><a href="#cb75-2"></a>Kaverage &lt;-<span class="st"> </span><span class="kw">colMeans</span>(X)</span>
<span id="cb75-3"><a href="#cb75-3"></a>K0 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb75-4"><a href="#cb75-4"></a>TWCD &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="kw">c</span>(K0))  <span class="co"># total within-cluster dissimilarity</span></span>
<span id="cb75-5"><a href="#cb75-5"></a>Classifier &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(K0, <span class="kw">nrow</span>(X)))</span>
<span id="cb75-6"><a href="#cb75-6"></a>(TWCD[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">colSums</span>(<span class="kw">as.matrix</span>(X<span class="op">^</span><span class="dv">2</span>))))</span>
<span id="cb75-7"><a href="#cb75-7"></a></span>
<span id="cb75-8"><a href="#cb75-8"></a><span class="co"># run K-means algorithm</span></span>
<span id="cb75-9"><a href="#cb75-9"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb75-10"><a href="#cb75-10"></a><span class="cf">for</span> (K <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>K0){ </span>
<span id="cb75-11"><a href="#cb75-11"></a>   <span class="cf">if</span> (K<span class="op">==</span><span class="dv">2</span>){(K_res &lt;-<span class="st"> </span><span class="kw">kmeans</span>(X,K) )}</span>
<span id="cb75-12"><a href="#cb75-12"></a>   <span class="cf">if</span> (K<span class="op">&gt;</span><span class="dv">2</span>){(K_res  &lt;-<span class="st"> </span><span class="kw">kmeans</span>(X,K_centers) )}</span>
<span id="cb75-13"><a href="#cb75-13"></a>   TWCD[K] &lt;-<span class="st"> </span><span class="kw">sum</span>(K_res<span class="op">$</span>withins)</span>
<span id="cb75-14"><a href="#cb75-14"></a>   Classifier[K,] &lt;-<span class="st"> </span>K_res<span class="op">$</span>cluster</span>
<span id="cb75-15"><a href="#cb75-15"></a>   K_centers &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="kw">c</span>(K<span class="op">+</span><span class="dv">1</span>, <span class="kw">ncol</span>(X)))</span>
<span id="cb75-16"><a href="#cb75-16"></a>   K_centers[K<span class="op">+</span><span class="dv">1</span>,] &lt;-<span class="st"> </span>Kaverage</span>
<span id="cb75-17"><a href="#cb75-17"></a>   K_centers[<span class="dv">1</span><span class="op">:</span>K,] &lt;-<span class="st"> </span>K_res<span class="op">$</span>centers </span>
<span id="cb75-18"><a href="#cb75-18"></a>                }</span>
<span id="cb75-19"><a href="#cb75-19"></a></span>
<span id="cb75-20"><a href="#cb75-20"></a><span class="co"># plot losses                </span></span>
<span id="cb75-21"><a href="#cb75-21"></a>xtitle &lt;-<span class="st"> &quot;decrease in total within-cluster dissimilarity &quot;</span></span>
<span id="cb75-22"><a href="#cb75-22"></a><span class="kw">plot</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>K0), <span class="dt">y=</span>TWCD, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(TWCD)), <span class="dt">main=</span><span class="kw">list</span>(xtitle, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>, <span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">ylab=</span><span class="st">&quot;total within-cluster dissimilarity&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;hyperparameter K&quot;</span>, <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb75-23"><a href="#cb75-23"></a><span class="kw">lines</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>K0), <span class="dt">y=</span>TWCD, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">lty=</span><span class="dv">3</span>)</span>
<span id="cb75-24"><a href="#cb75-24"></a></span>
<span id="cb75-25"><a href="#cb75-25"></a><span class="co"># singular value decomposition</span></span>
<span id="cb75-26"><a href="#cb75-26"></a>SVD &lt;-<span class="st"> </span><span class="kw">svd</span>(<span class="kw">as.matrix</span>(X))</span>
<span id="cb75-27"><a href="#cb75-27"></a>pca &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb75-28"><a href="#cb75-28"></a>dat3 &lt;-<span class="st"> </span>d.data</span>
<span id="cb75-29"><a href="#cb75-29"></a>dat3<span class="op">$</span>v1 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(X) <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,pca[<span class="dv">1</span>]]</span>
<span id="cb75-30"><a href="#cb75-30"></a>dat3<span class="op">$</span>v2 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(X) <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,pca[<span class="dv">2</span>]]</span>
<span id="cb75-31"><a href="#cb75-31"></a></span>
<span id="cb75-32"><a href="#cb75-32"></a>lim0 &lt;-<span class="st"> </span><span class="dv">7</span></span>
<span id="cb75-33"><a href="#cb75-33"></a></span>
<span id="cb75-34"><a href="#cb75-34"></a><span class="kw">plot</span>(<span class="dt">x=</span>dat3<span class="op">$</span>v1, <span class="dt">y=</span>dat3<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span>lim0,lim0), <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span>lim0,lim0), <span class="dt">ylab=</span><span class="kw">paste</span>(<span class="st">&quot;principal component &quot;</span>, pca[<span class="dv">2</span>], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>),<span class="dt">xlab=</span><span class="kw">paste</span>(<span class="st">&quot;principal component &quot;</span>, pca[<span class="dv">1</span>], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>),, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;K-means vs. PCA&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb75-35"><a href="#cb75-35"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(Classifier[<span class="dv">4</span>,]<span class="op">==</span><span class="dv">4</span>),]</span>
<span id="cb75-36"><a href="#cb75-36"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb75-37"><a href="#cb75-37"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(Classifier[<span class="dv">4</span>,]<span class="op">==</span><span class="dv">1</span>),]</span>
<span id="cb75-38"><a href="#cb75-38"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb75-39"><a href="#cb75-39"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(Classifier[<span class="dv">4</span>,]<span class="op">==</span><span class="dv">3</span>),]</span>
<span id="cb75-40"><a href="#cb75-40"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;magenta&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb75-41"><a href="#cb75-41"></a><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;cluster 1&quot;</span>, <span class="st">&quot;cluster 2&quot;</span>, <span class="st">&quot;cluster 3&quot;</span>, <span class="st">&quot;cluster 4&quot;</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>))</span></code></pre></div>
</div>
<div id="k-medoids-clustering-pam" class="section level2">
<h2><span class="header-section-number">5.5</span> K-medoids clustering (PAM)</h2>
<p>K-meansç®—æ³•ä½¿ç”¨ç±»å‡å€¼å‘é‡ä½œä¸ºèšç±»ä¸­å¿ƒï¼Œå› æ­¤å¯¹ç¦»ç¾¤ç‚¹éå¸¸æ•æ„Ÿï¼Œå¦‚æœå…·æœ‰æå¤§å€¼ï¼Œå¯èƒ½å¤§å¹…åº¦åœ°æ‰­æ›²æ•°æ®çš„åˆ†å¸ƒã€‚K-mediodsç®—æ³•ä½¿ç”¨æ ·æœ¬ç‚¹ä½œä¸ºèšç±»ä¸­å¿ƒï¼Œä¿®æ­£èšç±»ä¸­å¿ƒæ˜¯è®¡ç®—å½“å‰ç±»éèšç±»ä¸­å¿ƒç‚¹åˆ°å…¶ä»–æ‰€æœ‰ç‚¹çš„æœ€å°å€¼æ¥æ›´æ–°èšç±»ä¸­å¿ƒï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨Manhattanè·ç¦»ï¼Œå¯ä»¥æœ‰æ•ˆå‰Šå¼±ç¦»ç¾¤ç‚¹çš„å½±å“ã€‚æœ¬ä¾‹ä¸­K-medoidsèšç±»ä½¿ç”¨Manhattanè·ç¦»,(<span class="math inline">\(L1\)</span>èŒƒå¼å¯¹ç¦»ç¾¤ç‚¹çš„æƒ©ç½šæƒé‡æ¯”æ¬§å¼è·ç¦»å°)ï¼Œç»“æœæ˜¾ç¤ºå…¶èšç±»ä¸­å¿ƒè¦æ¯”K-meansèšç±»æ›´åŠ èšé›†ä¸€äº›ã€‚</p>
<p>PAMç®—æ³•ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>é€‰æ‹©åˆå§‹èšç±»ä¸­å¿ƒ<span class="math inline">\(c_1,c_2,\ldots,c_k\in\mathcal{X}\)</span>å’Œèšç±»ä¸ªæ•°<span class="math inline">\(K\)</span>ï¼Œè®¡ç®—<span class="math inline">\(TWCD\)</span>ï¼›
<span class="math display">\[TWCD=\sum_{k=1}^K\sum_{x_i\in{C_k}\cap\mathcal{X}}d(c_k),x_i\]</span></p></li>
<li><p>è¿­ä»£(ç»ˆæ­¢æ¡ä»¶ï¼š<span class="math inline">\(TWCD\)</span>ä¸å†å‡å°‘)</p>
<p>(1)éå†æ¯ä¸ªéèšç±»ä¸­å¿ƒ<span class="math inline">\(x_i\)</span>æ›¿æ¢èšç±»ä¸­å¿ƒç‚¹<span class="math inline">\(c_k^{t-1}\)</span>ï¼Œæ ¹æ®è·ç¦»æœ€è¿‘åŸåˆ™é‡æ–°åˆ†é…å„æ ·æœ¬ç‚¹ï¼Œè®¡ç®—<span class="math inline">\(TWCD\)</span>;</p>
<p>(2)æ ¹æ®<span class="math inline">\(TWCD\)</span>æœ€å°åŸåˆ™æ›´æ–°èšç±»ä¸­å¿ƒ<span class="math inline">\(c_k^{t}\)</span>ã€‚</p></li>
</ol>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb76-2"><a href="#cb76-2"></a>(K_res &lt;-<span class="st"> </span><span class="kw">pam</span>(X, <span class="dt">k=</span><span class="dv">4</span>, <span class="dt">metric=</span><span class="st">&quot;manhattan&quot;</span>, <span class="dt">diss=</span><span class="ot">FALSE</span>))</span>
<span id="cb76-3"><a href="#cb76-3"></a></span>
<span id="cb76-4"><a href="#cb76-4"></a><span class="co"># plot K-medoids versus PCA</span></span>
<span id="cb76-5"><a href="#cb76-5"></a><span class="kw">plot</span>(<span class="dt">x=</span>dat3<span class="op">$</span>v1, <span class="dt">y=</span>dat3<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span>lim0,lim0), <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span>lim0,lim0), <span class="dt">ylab=</span><span class="kw">paste</span>(<span class="st">&quot;principal component &quot;</span>, pca[<span class="dv">2</span>], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>),<span class="dt">xlab=</span><span class="kw">paste</span>(<span class="st">&quot;principal component &quot;</span>, pca[<span class="dv">1</span>], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>),, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;K-medoids vs. PCA&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb76-6"><a href="#cb76-6"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(K_res<span class="op">$</span>cluster<span class="op">==</span><span class="dv">4</span>),]</span>
<span id="cb76-7"><a href="#cb76-7"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb76-8"><a href="#cb76-8"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(K_res<span class="op">$</span>cluster<span class="op">==</span><span class="dv">3</span>),]</span>
<span id="cb76-9"><a href="#cb76-9"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb76-10"><a href="#cb76-10"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(K_res<span class="op">$</span>cluster<span class="op">==</span><span class="dv">2</span>),]</span>
<span id="cb76-11"><a href="#cb76-11"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;magenta&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb76-12"><a href="#cb76-12"></a><span class="kw">points</span>(<span class="dt">x=</span>dat3[K_res<span class="op">$</span>id.med,<span class="st">&quot;v1&quot;</span>],<span class="dt">y=</span>dat3[K_res<span class="op">$</span>id.med,<span class="st">&quot;v2&quot;</span>], <span class="dt">col=</span><span class="st">&quot;black&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">cex=</span><span class="dv">2</span>)</span>
<span id="cb76-13"><a href="#cb76-13"></a><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;cluster 1&quot;</span>, <span class="st">&quot;cluster 2&quot;</span>, <span class="st">&quot;cluster 3&quot;</span>, <span class="st">&quot;cluster 4&quot;</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>))</span></code></pre></div>
</div>
<div id="gaussian-mixture-modelsgmms" class="section level2">
<h2><span class="header-section-number">5.6</span> Gaussian mixture models(GMMs)</h2>
<p>K-meanså‡è®¾æ•°æ®ç‚¹æ˜¯çƒçŠ¶çš„ï¼ŒGMMså‡è®¾æ•°æ®ç‚¹æ˜¯å‘ˆé«˜æ–¯åˆ†å¸ƒï¼Œæä¾›äº†æ›´å¤šçš„å¯èƒ½æ€§ã€‚å¯¹<span class="math inline">\(n\)</span>ç»´æ ·æœ¬ç©ºé—´<span class="math inline">\(\mathcal{X}\)</span>ä¸­çš„éšæœºå‘é‡<span class="math inline">\(x\)</span>ï¼Œè‹¥<span class="math inline">\(x\)</span>æœä»é«˜æ–¯åˆ†å¸ƒï¼Œ<span class="math inline">\(\mu\)</span>æ˜¯<span class="math inline">\(n\)</span>ç»´å‡å€¼å‘é‡ï¼Œ<span class="math inline">\(\Sigma\)</span>æ˜¯<span class="math inline">\(n\times n\)</span> çš„åæ–¹å·®çŸ©é˜µï¼Œå…¶æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š
<span class="math display">\[p(x|\mu,\Sigma)=\frac{1}{(2\pi)^{\frac{n}{2}}|\Sigma|^{\frac{1}{2}}}e^{-\frac{1}{2}(x-\mu)\Sigma^{-1}(x-\mu)}\]</span></p>
<p>ç”±æ­¤å¯å®šä¹‰é«˜æ–¯æ··åˆåˆ†å¸ƒï¼Œè¯¥åˆ†å¸ƒç”±<span class="math inline">\(k\)</span>ä¸ªæ··åˆæˆåˆ†ç»„æˆï¼Œæ¯ä¸ªæ··åˆæˆåˆ†å¯¹åº”ä¸€ä¸ªé«˜æ–¯åˆ†å¸ƒï¼Œå…¶ä¸­<span class="math inline">\(\mu_i\)</span>ä¸<span class="math inline">\(\Sigma_i\)</span>æ˜¯ç¬¬<span class="math inline">\(i\)</span>ä¸ªé«˜æ–¯æ··åˆæˆåˆ†çš„å‚æ•°ï¼Œ<span class="math inline">\(\alpha_i\)</span>ä¸ºç›¸åº”çš„æ··åˆç³»æ•°(<span class="math inline">\(\alpha_i&gt;0,\sum_{i=1}^k\alpha_i=1\)</span>)
<span class="math display">\[p_{\mathcal{M}}=\sum_{i=1}^k\alpha_i\times p(x|\mu_i,\Sigma_i)\]</span></p>
<p>è‹¥è®­ç»ƒé›†<span class="math inline">\(D={x_1,x_2,\dots,x_m}\)</span>ç”±ä¸Šè¿°è¿‡ç¨‹ç”Ÿæˆï¼Œä»¤éšæœºå˜é‡<span class="math inline">\(z_j\in{1,2,\dots,k}\)</span>è¡¨ç¤ºç”Ÿæˆæ ·æœ¬<span class="math inline">\(x_j\)</span>çš„é«˜æ–¯æ··åˆæˆåˆ†ï¼Œæ¢å¥è¯è¯´ï¼Œæ ·æœ¬<span class="math inline">\(x_j\)</span>å±äºç¬¬<span class="math inline">\(z_j\)</span>ä¸ªé«˜æ–¯åˆ†å¸ƒï¼Œ<span class="math inline">\(z_j\)</span>çš„å…ˆéªŒæ¦‚ç‡<span class="math inline">\(p(x_j=i)=\alpha_i(i=1,2,\dots,k)\)</span>ã€‚æ ¹æ®è´å¶æ–¯å®šç†ï¼Œåˆ™<span class="math inline">\(z_j\)</span>çš„åéªŒåˆ†å¸ƒ(è¡¨ç¤ºæ ·æœ¬<span class="math inline">\(x_j\)</span>ç”±ç¬¬<span class="math inline">\(i\)</span>ä¸ªé«˜æ–¯æ··åˆæˆåˆ†ç”Ÿæˆçš„åéªŒæ¦‚ç‡<span class="math inline">\(\gamma_ji\)</span>)ä¸ºï¼š
<span class="math display">\[\gamma_{ji}=p_{\mathcal{M}}(z_j=i|x_j)=\frac{p(z_j=i)\times p_{\mathcal{M}}(x_j|z_j=i)}{p_{\mathcal{M}}(x_j)}=\frac{a_i\times p(x_j|\mu_i,\Sigma_i)}{\sum_{i=1}^k\alpha_l\times p(x_j|\mu_l,\Sigma_l)}\]</span></p>
<p>å½“é«˜æ–¯æ··åˆæˆä¸å·²çŸ¥æ—¶ï¼Œé«˜æ–¯æ··åˆèšç±»å°†æŠŠæ ·æœ¬é›†<span class="math inline">\(D\)</span>åˆ’åˆ†ä¸º<span class="math inline">\(k\)</span>ä¸ªç±»<span class="math inline">\(C=\{C_1,C_2,\dots,C_k\}\)</span>ï¼Œåˆ™æ¯ä¸ªæ ·æœ¬<span class="math inline">\(x_j\)</span>çš„ç±»æ ‡è®°<span class="math inline">\(\gamma_j\)</span>ä½œå¦‚ä¸‹ç¡®å®šï¼š
<span class="math display">\[\gamma_j=\underset{i\in\{1,2,\dots,k\}}{\arg \min}\gamma_{ji}\]</span></p>
<p>å¯¹ç»™å®šæ ·æœ¬é›†<span class="math inline">\(D\)</span>ï¼Œå¯é‡‡ç”¨æå¤§ä¼¼ç„¶ä¼°è®¡æ±‚è§£æ¨¡å‹å‚æ•°<span class="math inline">\(\{(\alpha_i,\mu_i,\Sigma_i)|1 \le i \le k\}\)</span>ï¼Œä¼¼ç„¶å‡½æ•°
<span class="math display">\[LL(D)=ln\left(\prod_{j=1}^m p_{\mathcal{M}(x_j)}\right)=\sum_{j=1}^m ln\left(\sum_{i=1}^k \alpha_i \times p(x_j|\mu_i,\Sigma_i) \right)\]</span></p>
<p>ä»¤<span class="math inline">\(\frac{\partial{LL(D)}}{\partial(\mu_i)}=0\)</span>ï¼Œå¾—åˆ°<span class="math inline">\(\mu_i=\frac{\sum_{j=1}^{m}\gamma_{ji}x_j}{\sum_{j=1}^m\gamma_{ji}}\)</span>
ä»¤<span class="math inline">\(\frac{\partial{LL(D)}}{\partial(\Sigma_i)}=0\)</span>ï¼Œå¾—åˆ°<span class="math inline">\(\Sigma_i=\frac{\sum_{j=1}^{m}\gamma_{ji}(x_j-\mu_i)(x_j-\mu_i)^T}{\sum_{j=1}^m\gamma_{ji}}\)</span>
å¯ä»¥çœ‹åˆ°å„æ··åˆæˆåˆ†çš„å‡å€¼<span class="math inline">\(\mu_i\)</span>å’Œåæ–¹å·®é˜µ<span class="math inline">\(\Sigma_i\)</span>å¯é€šè¿‡æ ·æœ¬åŠ æƒå¹³å‡æ¥ä¼°è®¡ï¼Œæ ·æœ¬æƒé‡æ˜¯æ¯ä¸ªæ ·æœ¬å±äºè¯¥æˆåˆ†çš„åéªŒæ¦‚ç‡ã€‚</p>
<p>å¯¹äºæ··åˆç³»æ•°<span class="math inline">\(\alpha_i\)</span>ï¼Œé™¤äº†è¦æœ€å¤§åŒ–<span class="math inline">\(LL(D)\)</span>ï¼Œè¿˜éœ€è¦æ»¡è¶³<span class="math inline">\(\alpha_i&gt;0,\sum_{i=1}^k\alpha_i=1\)</span>ï¼Œå¯ä»¥ä½¿ç”¨æ‹‰æ ¼æœ—æ—¥æ¡ä»¶æå€¼æ±‚è§£ï¼Œå…¶ä¸­<span class="math inline">\(\lambda\)</span>ä¸ºæ‹‰æ ¼æœ—æ—¥ä¹˜å­ã€‚
<span class="math display">\[LLF(D)=LL(D)=\lambda\left(\sum_{i=1}^k\alpha_i-1\right)\]</span></p>
<p>ä»¤<span class="math inline">\(\frac{\partial{LLF(D)}}{\partial(\alpha_i)}=0\)</span>ï¼Œå¾—åˆ°<span class="math inline">\(\alpha_i=\frac{\sum_{j=1}^{m}\gamma_{ji}}{m}\)</span>
å¯ä»¥çœ‹åˆ°å„é«˜æ–¯æˆåˆ†<span class="math inline">\(\alpha_i\)</span>çš„æ··åˆç³»æ•°ç”±æ ·æœ¬å±äºè¯¥æˆåˆ†çš„å¹³å‡åéªŒæ¦‚ç‡ç¡®å®šã€‚</p>
<p>å› ä¸º<span class="math inline">\(z_j\in\{1,2\dots,k\}\)</span>æ˜¯éšå˜é‡(LatentVariable)ï¼Œæ— æ³•è§‚æµ‹ï¼Œä¸€èˆ¬é‡‡ç”¨EMç®—æ³•è¿›è¡Œè¿­ä»£ä¼˜åŒ–ã€‚EMç®—æ³•ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>ç¡®å®šåˆå§‹é«˜æ–¯æ··åˆåˆ†å¸ƒçš„æ¨¡å‹å‚æ•°<span class="math inline">\(\{(\alpha_i,\mu_i,\Sigma_i)|1 \le i \le k\}\)</span>å’Œèšç±»ä¸ªæ•°<span class="math inline">\(K\)</span>.</p></li>
<li><p>è¿­ä»£(ç»ˆæ­¢æ¡ä»¶ï¼šä¼¼ç„¶å‡½æ•°<span class="math inline">\(LL(D)\)</span>å¢é•¿å¾ˆå°‘ç”šè‡³ä¸å†å¢é•¿æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°)</p>
<p>(1)æ ¹æ®å‚æ•°<span class="math inline">\(\Theta^{t-1}=\{(\alpha_i^{t-1},\mu_i^{t-1},\Sigma_i^{t-1})|1 \le i \le k\}\)</span>ç¡®å®š<span class="math inline">\(\gamma_{ji}\)</span>;</p>
<p>(2)æ ¹æ®<span class="math inline">\(\gamma_{ji}\)</span>æ›´æ–°å‚æ•°<span class="math inline">\(\Theta^{t}=\{(\alpha_i^t,\mu_i^t,\Sigma_i^t)|1 \le i \le k\}\)</span></p></li>
<li><p>æœ€åæ ¹æ®<span class="math inline">\(\gamma_j=\underset{i\in\{1,2,\dots,k\}}{\arg \min}\gamma_{ji}\)</span>ç¡®å®šå„æ ·æœ¬<span class="math inline">\(x_j\)</span>æ‰€å±ç±»</p></li>
</ol>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>seed &lt;-<span class="st"> </span><span class="dv">100</span></span>
<span id="cb77-2"><a href="#cb77-2"></a><span class="kw">set.seed</span>(seed)</span>
<span id="cb77-3"><a href="#cb77-3"></a>K_res &lt;-<span class="st"> </span><span class="kw">GMM</span>(X, <span class="dt">gaussian_comps=</span><span class="dv">4</span>, <span class="dt">dist_mode=</span><span class="st">&quot;eucl_dist&quot;</span>, <span class="dt">seed_mode=</span><span class="st">&quot;random_subset&quot;</span>, <span class="dt">em_iter=</span><span class="dv">5</span>, <span class="dt">seed=</span>seed)</span>
<span id="cb77-4"><a href="#cb77-4"></a><span class="kw">summary</span>(K_res)</span>
<span id="cb77-5"><a href="#cb77-5"></a>clust &lt;-<span class="st"> </span><span class="kw">predict_GMM</span>(X, K_res<span class="op">$</span>centroids, K_res<span class="op">$</span>covariance_matrices, K_res<span class="op">$</span>weights)<span class="op">$</span>cluster_labels</span>
<span id="cb77-6"><a href="#cb77-6"></a></span>
<span id="cb77-7"><a href="#cb77-7"></a>pred &lt;-<span class="st"> </span><span class="kw">predict_GMM</span>(X, K_res<span class="op">$</span>centroids, K_res<span class="op">$</span>covariance_matrices, K_res<span class="op">$</span>weights)</span>
<span id="cb77-8"><a href="#cb77-8"></a><span class="kw">names</span>(pred)</span>
<span id="cb77-9"><a href="#cb77-9"></a></span>
<span id="cb77-10"><a href="#cb77-10"></a>pred<span class="op">$</span>cluster_labels[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb77-11"><a href="#cb77-11"></a>pred<span class="op">$</span>cluster_proba[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,]</span>
<span id="cb77-12"><a href="#cb77-12"></a></span>
<span id="cb77-13"><a href="#cb77-13"></a>K_res<span class="op">$</span>centroids</span>
<span id="cb77-14"><a href="#cb77-14"></a></span>
<span id="cb77-15"><a href="#cb77-15"></a><span class="co"># singular value decomposition</span></span>
<span id="cb77-16"><a href="#cb77-16"></a>SVD &lt;-<span class="st"> </span><span class="kw">svd</span>(<span class="kw">as.matrix</span>(X))</span>
<span id="cb77-17"><a href="#cb77-17"></a></span>
<span id="cb77-18"><a href="#cb77-18"></a>pca &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb77-19"><a href="#cb77-19"></a>dat3 &lt;-<span class="st"> </span>d.data</span>
<span id="cb77-20"><a href="#cb77-20"></a>dat3<span class="op">$</span>v1 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(X) <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,pca[<span class="dv">1</span>]]</span>
<span id="cb77-21"><a href="#cb77-21"></a>dat3<span class="op">$</span>v2 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(X) <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,pca[<span class="dv">2</span>]]</span>
<span id="cb77-22"><a href="#cb77-22"></a></span>
<span id="cb77-23"><a href="#cb77-23"></a>(kk1 &lt;-<span class="st"> </span>K_res<span class="op">$</span>centroids <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,pca[<span class="dv">1</span>]])</span>
<span id="cb77-24"><a href="#cb77-24"></a>(kk2 &lt;-<span class="st"> </span>K_res<span class="op">$</span>centroids <span class="op">%*%</span><span class="st"> </span>SVD<span class="op">$</span>v[,pca[<span class="dv">2</span>]])</span>
<span id="cb77-25"><a href="#cb77-25"></a></span>
<span id="cb77-26"><a href="#cb77-26"></a>lim0 &lt;-<span class="st"> </span><span class="dv">7</span></span>
<span id="cb77-27"><a href="#cb77-27"></a></span>
<span id="cb77-28"><a href="#cb77-28"></a><span class="kw">plot</span>(<span class="dt">x=</span>dat3<span class="op">$</span>v1, <span class="dt">y=</span>dat3<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span>lim0,lim0), <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span>lim0,lim0), <span class="dt">ylab=</span><span class="kw">paste</span>(<span class="st">&quot;principal component &quot;</span>, pca[<span class="dv">2</span>], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>),<span class="dt">xlab=</span><span class="kw">paste</span>(<span class="st">&quot;principal component &quot;</span>, pca[<span class="dv">1</span>], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>),, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;GMM(diagonal) vs. PCA&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb77-29"><a href="#cb77-29"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(clust<span class="op">==</span><span class="dv">0</span>),]</span>
<span id="cb77-30"><a href="#cb77-30"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb77-31"><a href="#cb77-31"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(clust<span class="op">==</span><span class="dv">3</span>),]</span>
<span id="cb77-32"><a href="#cb77-32"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb77-33"><a href="#cb77-33"></a>dat0 &lt;-<span class="st"> </span>dat3[<span class="kw">which</span>(clust<span class="op">==</span><span class="dv">1</span>),]</span>
<span id="cb77-34"><a href="#cb77-34"></a><span class="kw">points</span>(<span class="dt">x=</span>dat0<span class="op">$</span>v1, <span class="dt">y=</span>dat0<span class="op">$</span>v2, <span class="dt">col=</span><span class="st">&quot;magenta&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb77-35"><a href="#cb77-35"></a><span class="kw">points</span>(<span class="dt">x=</span>kk1,<span class="dt">y=</span>kk2, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">cex=</span><span class="dv">2</span>)</span>
<span id="cb77-36"><a href="#cb77-36"></a><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;cluster 1&quot;</span>, <span class="st">&quot;cluster 2&quot;</span>, <span class="st">&quot;cluster 3&quot;</span>, <span class="st">&quot;cluster 4&quot;</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>))</span></code></pre></div>
</div>
<div id="ä¸‰ç§èšç±»æ–¹æ³•è¯„ä»·" class="section level2">
<h2><span class="header-section-number">5.7</span> ä¸‰ç§èšç±»æ–¹æ³•è¯„ä»·</h2>
<p>å›¾@ref(fig:cluster-results)å±•ç¤ºäº†èšç±»çš„ç»“æœï¼ŒGMMsæœ€å¥½ã€‚</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb78-2"><a href="#cb78-2"></a><span class="co">#K-meansèšç±»(æ¬§å¼è·ç¦»)</span></span>
<span id="cb78-3"><a href="#cb78-3"></a>K_means &lt;-<span class="st"> </span><span class="kw">kmeans</span>(X, <span class="dv">4</span>)</span>
<span id="cb78-4"><a href="#cb78-4"></a><span class="co">#çš„K-medoidsèšç±»(æ›¼å“ˆé¡¿è·ç¦»)</span></span>
<span id="cb78-5"><a href="#cb78-5"></a>K_medoids &lt;-<span class="st"> </span><span class="kw">pam</span>(X, <span class="dt">k =</span> <span class="dv">4</span>, <span class="dt">metric =</span> <span class="st">&quot;manhattan&quot;</span>)</span>
<span id="cb78-6"><a href="#cb78-6"></a><span class="co">#GMMèšç±»(æ¬§å¼è·ç¦»)</span></span>
<span id="cb78-7"><a href="#cb78-7"></a>K_gmm &lt;-<span class="st"> </span><span class="kw">GMM</span>(X, <span class="dt">gaussian_comps =</span> <span class="dv">4</span>, <span class="dt">dist_mode =</span> <span class="st">&quot;eucl_dist&quot;</span>, </span>
<span id="cb78-8"><a href="#cb78-8"></a>             <span class="dt">seed_mode =</span> <span class="st">&quot;random_subset&quot;</span>, </span>
<span id="cb78-9"><a href="#cb78-9"></a>             <span class="dt">em_iter=</span> <span class="dv">5</span>,<span class="dt">seed =</span> <span class="dv">100</span>)</span>
<span id="cb78-10"><a href="#cb78-10"></a>clust &lt;-<span class="st"> </span><span class="kw">predict_GMM</span>(X, K_gmm<span class="op">$</span>centroids, </span>
<span id="cb78-11"><a href="#cb78-11"></a>                     K_gmm<span class="op">$</span>covariance_matrices, K_gmm<span class="op">$</span>weights)<span class="op">$</span>cluster_labels</span>
<span id="cb78-12"><a href="#cb78-12"></a><span class="co">#k-means</span></span>
<span id="cb78-13"><a href="#cb78-13"></a>cluster &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;cluster1&#39;</span>,<span class="st">&#39;cluster2&#39;</span>,<span class="st">&#39;cluster3&#39;</span>,<span class="st">&#39;cluster4&#39;</span>)</span>
<span id="cb78-14"><a href="#cb78-14"></a>cars &lt;-<span class="st"> </span><span class="cf">function</span>(x,y) <span class="kw">nrow</span>(dat3[<span class="kw">which</span>(y <span class="op">==</span><span class="st"> </span>x),])</span>
<span id="cb78-15"><a href="#cb78-15"></a>sports &lt;-<span class="st"> </span><span class="cf">function</span>(x,y) <span class="kw">nrow</span>(dat3[<span class="kw">which</span>(y <span class="op">==</span><span class="st"> </span>x <span class="op">&amp;</span><span class="st"> </span>dat3<span class="op">$</span>sports_car <span class="op">==</span><span class="st"> </span><span class="dv">1</span>),])</span>
<span id="cb78-16"><a href="#cb78-16"></a>K_means &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(cluster,</span>
<span id="cb78-17"><a href="#cb78-17"></a>                            <span class="st">&quot;cars&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">cars</span>(K_means<span class="op">$</span>cluster,<span class="dv">2</span>),</span>
<span id="cb78-18"><a href="#cb78-18"></a>                                     <span class="kw">cars</span>(K_means<span class="op">$</span>cluster,<span class="dv">4</span>),</span>
<span id="cb78-19"><a href="#cb78-19"></a>                                     <span class="kw">cars</span>(K_means<span class="op">$</span>cluster,<span class="dv">3</span>),</span>
<span id="cb78-20"><a href="#cb78-20"></a>                                     <span class="kw">cars</span>(K_means<span class="op">$</span>cluster,<span class="dv">1</span>)),</span>
<span id="cb78-21"><a href="#cb78-21"></a>                            <span class="st">&quot;sports cars&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">sports</span>(K_means<span class="op">$</span>cluster,<span class="dv">2</span>),</span>
<span id="cb78-22"><a href="#cb78-22"></a>                                            <span class="kw">sports</span>(K_means<span class="op">$</span>cluster,<span class="dv">4</span>),</span>
<span id="cb78-23"><a href="#cb78-23"></a>                                            <span class="kw">sports</span>(K_means<span class="op">$</span>cluster,<span class="dv">3</span>),</span>
<span id="cb78-24"><a href="#cb78-24"></a>                                            <span class="kw">sports</span>(K_means<span class="op">$</span>cluster,<span class="dv">1</span>)))</span>
<span id="cb78-25"><a href="#cb78-25"></a>K_medoids &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(cluster,</span>
<span id="cb78-26"><a href="#cb78-26"></a>                              <span class="st">&quot;cars&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">cars</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">4</span>),</span>
<span id="cb78-27"><a href="#cb78-27"></a>                                       <span class="kw">cars</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">4</span>),</span>
<span id="cb78-28"><a href="#cb78-28"></a>                                       <span class="kw">cars</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">2</span>),</span>
<span id="cb78-29"><a href="#cb78-29"></a>                                       <span class="kw">cars</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">1</span>)),</span>
<span id="cb78-30"><a href="#cb78-30"></a>                              <span class="st">&quot;sports cars&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">sports</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">4</span>),</span>
<span id="cb78-31"><a href="#cb78-31"></a>                                              <span class="kw">sports</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">3</span>),</span>
<span id="cb78-32"><a href="#cb78-32"></a>                                              <span class="kw">sports</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">2</span>),</span>
<span id="cb78-33"><a href="#cb78-33"></a>                                              <span class="kw">sports</span>(K_medoids<span class="op">$</span>clustering,<span class="dv">1</span>)))</span>
<span id="cb78-34"><a href="#cb78-34"></a>GMMs &lt;-<span class="st"> </span><span class="kw">cbind.data.frame</span>(cluster,</span>
<span id="cb78-35"><a href="#cb78-35"></a>                         <span class="st">&quot;cars&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">cars</span>(clust,<span class="dv">0</span>),<span class="kw">cars</span>(clust,<span class="dv">3</span>),</span>
<span id="cb78-36"><a href="#cb78-36"></a>                                  <span class="kw">cars</span>(clust,<span class="dv">1</span>),<span class="kw">cars</span>(clust,<span class="dv">2</span>)),</span>
<span id="cb78-37"><a href="#cb78-37"></a>                         <span class="st">&quot;sports cars&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">sports</span>(clust,<span class="dv">0</span>),<span class="kw">sports</span>(clust,<span class="dv">3</span>),</span>
<span id="cb78-38"><a href="#cb78-38"></a>                                         <span class="kw">sports</span>(clust,<span class="dv">1</span>),<span class="kw">sports</span>(clust,<span class="dv">2</span>)))</span>
<span id="cb78-39"><a href="#cb78-39"></a>k_means &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw">melt</span>(K_means, <span class="dt">id.vars =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb78-40"><a href="#cb78-40"></a>                          <span class="dt">variable.name =</span> <span class="st">&quot;k_means&quot;</span>)</span>
<span id="cb78-41"><a href="#cb78-41"></a>k_medoids &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw">melt</span>(K_medoids, <span class="dt">id =</span> <span class="st">&quot;cluster&quot;</span>, </span>
<span id="cb78-42"><a href="#cb78-42"></a>                            <span class="dt">variable.name =</span> <span class="st">&quot;k_medoids&quot;</span>)</span>
<span id="cb78-43"><a href="#cb78-43"></a>GMMs &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw">melt</span>(GMMs, <span class="dt">id =</span> <span class="st">&quot;cluster&quot;</span>, <span class="dt">variable.name =</span> <span class="st">&quot;GMMs&quot;</span>)</span>
<span id="cb78-44"><a href="#cb78-44"></a><span class="co">#ç»˜åˆ¶ä¸‰ç§èšç±»æ–¹æ³•èšç±»ç»“æœä¸­è·‘è½¦æ ·æœ¬ä¸çœŸå®è·‘è½¦æ ·æœ¬å¯¹æ¯”å›¾</span></span>
<span id="cb78-45"><a href="#cb78-45"></a>myggplot &lt;-<span class="st"> </span><span class="cf">function</span>(mydf,myxcol,myycol,myfill) {</span>
<span id="cb78-46"><a href="#cb78-46"></a>   ggplot2<span class="op">::</span><span class="kw">ggplot</span>(<span class="dt">data=</span>mydf,<span class="kw">aes</span>(<span class="dt">x =</span> {{myxcol}},</span>
<span id="cb78-47"><a href="#cb78-47"></a>                                 <span class="dt">y =</span> {{myycol}},</span>
<span id="cb78-48"><a href="#cb78-48"></a>                                 <span class="dt">fill =</span> {{myfill}}))<span class="op">+</span></span>
<span id="cb78-49"><a href="#cb78-49"></a><span class="st">      </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>,<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>)<span class="op">+</span></span>
<span id="cb78-50"><a href="#cb78-50"></a><span class="st">      </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> value),</span>
<span id="cb78-51"><a href="#cb78-51"></a>                <span class="dt">position =</span> <span class="kw">position_dodge</span>((<span class="dv">1</span>)),</span>
<span id="cb78-52"><a href="#cb78-52"></a>                <span class="dt">size =</span> <span class="dv">3</span>,</span>
<span id="cb78-53"><a href="#cb78-53"></a>                <span class="dt">vjust =</span> <span class="fl">-0.5</span>)<span class="op">+</span></span>
<span id="cb78-54"><a href="#cb78-54"></a><span class="st">      </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb78-55"><a href="#cb78-55"></a>            <span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb78-56"><a href="#cb78-56"></a>            <span class="dt">panel.grid.minor =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb78-57"><a href="#cb78-57"></a>            <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb78-58"><a href="#cb78-58"></a>            <span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>())<span class="op">+</span></span>
<span id="cb78-59"><a href="#cb78-59"></a><span class="st">      </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;number&quot;</span>)<span class="op">+</span></span>
<span id="cb78-60"><a href="#cb78-60"></a><span class="st">      </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="dv">250</span>)</span>
<span id="cb78-61"><a href="#cb78-61"></a>   </span>
<span id="cb78-62"><a href="#cb78-62"></a>}</span>
<span id="cb78-63"><a href="#cb78-63"></a><span class="co">#ç»„åˆå›¾å½¢</span></span>
<span id="cb78-64"><a href="#cb78-64"></a><span class="kw">multiplot</span>(<span class="kw">myggplot</span>(k_means,cluster,value,k_means),</span>
<span id="cb78-65"><a href="#cb78-65"></a>          <span class="kw">myggplot</span>(k_medoids,cluster,value,k_medoids),</span>
<span id="cb78-66"><a href="#cb78-66"></a>          <span class="kw">myggplot</span>(GMMs,cluster,value,GMMs))</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/cluster.png" alt="èšç±»æ¯”è¾ƒ" width="60%"  />
<p class="caption">
(#fig:cluster-results)èšç±»æ¯”è¾ƒ
</p>
</div>
</div>
<div id="t-sne" class="section level2">
<h2><span class="header-section-number">5.8</span> t-SNE</h2>
<p><strong>ç®€ä»‹</strong></p>
<p><strong>tåˆ†å¸ƒ-éšæœºé‚»è¿‘åµŒå…¥</strong>(t-SNE, t-distributed stochastic neighbor embedding)ç”± Laurens van der Maatenå’ŒGeoffrey Hintonåœ¨2008å¹´æå‡ºã€‚t-SNEæœ¬è´¨æ˜¯ä¸€ç§åµŒå…¥æ¨¡å‹ï¼Œèƒ½å¤Ÿå°†é«˜ç»´ç©ºé—´ä¸­çš„æ•°æ®æ˜ å°„åˆ°ä½ç»´ç©ºé—´ä¸­ï¼Œå¹¶ä¿ç•™æ•°æ®é›†çš„å±€éƒ¨ç‰¹æ€§ã€‚</p>
<p><strong>åŸºæœ¬åŸç†</strong></p>
<p>t-SNEå°†æ•°æ®ç‚¹ä¹‹é—´çš„<strong>ç›¸ä¼¼åº¦è½¬åŒ–ä¸ºæ¡ä»¶æ¦‚ç‡</strong>ï¼Œ<strong>åŸå§‹ç©ºé—´</strong>ä¸­æ•°æ®ç‚¹çš„ç›¸ä¼¼åº¦ç”±<strong>é«˜æ–¯è”åˆåˆ†å¸ƒ</strong>è¡¨ç¤ºï¼Œ<strong>åµŒå…¥ç©ºé—´</strong>ä¸­æ•°æ®ç‚¹çš„ç›¸ä¼¼åº¦ç”±<strong>tåˆ†å¸ƒ</strong>è¡¨ç¤ºã€‚</p>
<p>å°†åŸå§‹ç©ºé—´å’ŒåµŒå…¥ç©ºé—´çš„è”åˆæ¦‚ç‡åˆ†å¸ƒçš„<strong>KLæ•£åº¦</strong>ä½œä¸ºæŸå¤±å‡½æ•°(loss function)ï¼Œè¯„ä¼°åµŒå…¥æ•ˆæœçš„å¥½åã€‚é€šè¿‡<strong>æ¢¯åº¦ä¸‹é™ç®—æ³•</strong>æœ€å°åŒ–æŸå¤±å‡½æ•°ï¼Œæœ€ç»ˆè·å¾—æ”¶æ•›ç»“æœã€‚</p>
<p><strong>å…·ä½“è¿‡ç¨‹</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>åŸå§‹ç©ºé—´</strong><br />
æ„å»ºä¸€ä¸ªé«˜ç»´å¯¹è±¡é—´çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä½¿å¾—ç›¸ä¼¼çš„å¯¹è±¡æœ‰æ›´é«˜çš„æ¦‚ç‡è¢«é€‰æ‹©ï¼Œè€Œä¸ç›¸ä¼¼çš„å¯¹è±¡æœ‰è¾ƒä½çš„æ¦‚ç‡è¢«é€‰æ‹©ã€‚<span class="math inline">\(q\)</span>ç»´ç©ºé—´ä¸­ç»™å®šä¸€ç»„æ•°æ®<span class="math inline">\(x_1,â€¦,x_n\)</span>ã€‚<br />
å®šä¹‰æ¡ä»¶æ¦‚ç‡ï¼š
<span class="math display">\[
q_{j|i}=\frac{exp\left\{-\frac{1}{2\sigma_i^2}||x_i-x_j||_2^2\right\}}{\sum_{k\ne i}exp\left\{-\frac{1}{2\sigma_i^2}||x_i-x_j||_2^2\right\}},\ for\ i\ne j
\]</span>
å®šä¹‰è”åˆæ¦‚ç‡åˆ†å¸ƒï¼š
<span class="math display">\[
q_{i,j}=\frac{1}{2n}(q_{j|i}+q_{i|j}),\ for\ i\ne j
\]</span>
æ­¤å¼æ—¢ä¿è¯äº†å¯¹ç§°æ€§ï¼Œåˆä½¿å¾—<span class="math inline">\(\sum_jq_{i,j}&gt;\frac{1}{2n}\)</span>for all <span class="math inline">\(i\)</span><br />
<strong>å›°æƒ‘åº¦(Perplexity)</strong><br />
<span class="math inline">\(\sigma_i\)</span>çš„é€‰æ‹©å¿…é¡»æ»¡è¶³ï¼šåœ¨æ•°æ®å¯†é›†çš„åœ°æ–¹è¦å°ï¼Œæ•°æ®ç¨€ç–çš„åœ°æ–¹è¦å¤§ã€‚<br />
å¯¹äº<span class="math inline">\(\sigma_i\)</span>ï¼Œä¸€ä¸ªå¥½çš„åˆ†é…åº”ä½¿å¾—å›°æƒ‘åº¦ä¸ºå¸¸æ•°ã€‚
<span class="math display">\[
Perp(q_{.|i})=exp\left\{H(q_{.|i})\right\}=exp\left\{-\sum_{j\ne i}q_{j|i}log_2(q_{j|i})\right\} 
\]</span>
å›°æƒ‘åº¦å¯ç†è§£ä¸ºå¯¹æ¯ä¸ªç‚¹é‚»å±…æ•°é‡çš„çŒœæµ‹ï¼Œå¯¹æœ€ç»ˆæˆå›¾æœ‰ç€å¤æ‚çš„å½±å“ã€‚ä½å›°æƒ‘åº¦å¯¹åº”çš„æ˜¯å±€éƒ¨è§†è§’ï¼›é«˜å›°æƒ‘åº¦å¯¹åº”çš„æ˜¯å…¨å±€è§†è§’ã€‚</p></li>
<li><p><strong>åµŒå…¥ç©ºé—´</strong><br />
åœ¨<span class="math inline">\(p\)</span>ç»´ç©ºé—´ä¸­(<span class="math inline">\(p&lt;q\)</span>)æ‰¾åˆ°ä¸€ç»„æ•°æ®ç‚¹<span class="math inline">\(y_1,â€¦,y_n\)</span>ï¼Œä½¿å¾—è¿™ç»„æ•°æ®ç‚¹æ„å»ºçš„è”åˆæ¦‚ç‡åˆ†å¸ƒ<span class="math inline">\(p\)</span>å°½å¯èƒ½åœ°ä¸é«˜ç»´ç©ºé—´ä¸­çš„è”åˆæ¦‚ç‡åˆ†å¸ƒ<span class="math inline">\(q\)</span>ç›¸ä¼¼ã€‚
<span class="math display">\[
p_{i,j}=\frac{(1+||y_i-y_j||_2^2)^{-1}}{\sum_{k\ne l}(1+||y_k-y_l||_2^2)^{-1}},\ for\ i\ne j
\]</span>
<strong>t(1)åˆ†å¸ƒçš„é€‰æ‹©</strong>ï¼šè§£å†³æ‹¥æŒ¤é—®é¢˜ï¼ˆé«˜ç»´ç©ºé—´ä¸­åˆ†ç¦»çš„ç°‡ï¼Œåœ¨ä½ç»´ä¸­è¢«åˆ†çš„ä¸æ˜æ˜¾ï¼‰</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/t-distribution.png" alt="t-distribution" width="60%"  />
<p class="caption">
(#fig:tdist)t-distribution
</p>
</div>
<p>å›¾@ref(fig:tdist)å±•ç¤ºäº†ä¸åŒè‡ªç”±åº¦ä¸‹çš„tåˆ†å¸ƒçš„å¯†åº¦å‡½æ•°å›¾åƒï¼Œå¯ä»¥çœ‹å‡ºï¼Œè‡ªç”±åº¦è¶Šå°ï¼Œtåˆ†å¸ƒçš„å°¾éƒ¨è¶Šåšã€‚
<span class="math display">\[
p_{i,j}\approx||y_i-y_j||^{-2}_2\ for\ ||y_i-y_j||_2\rightarrow\infty 
\]</span>
é™ç»´çš„æ•ˆæœç”¨ä¸¤åˆ†å¸ƒé—´çš„KLæ•£åº¦(Kullback-Leibler divergences)åº¦é‡
<span class="math display">\[
D_{KL}(q||p)=\sum_{j=1}^Jq_jlog\frac{q_j}{p_j}
\]</span></p></li>
</ol>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a><span class="kw">library</span>(tsne)</span>
<span id="cb79-2"><a href="#cb79-2"></a>perp =<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">60</span>) <span class="co">#å›°æƒ‘åº¦</span></span>
<span id="cb79-3"><a href="#cb79-3"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb79-4"><a href="#cb79-4"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>){</span>
<span id="cb79-5"><a href="#cb79-5"></a>    <span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb79-6"><a href="#cb79-6"></a>    tsne =<span class="st"> </span><span class="kw">tsne</span>(X, <span class="dt">k=</span><span class="dv">2</span>, <span class="dt">initial_dim=</span><span class="kw">ncol</span>(X), <span class="dt">perplexity=</span>perp[i])</span>
<span id="cb79-7"><a href="#cb79-7"></a>    tsne1 =<span class="st"> </span>tsne[,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)]</span>
<span id="cb79-8"><a href="#cb79-8"></a>    <span class="kw">plot</span>(tsne1,<span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>,</span>
<span id="cb79-9"><a href="#cb79-9"></a>         <span class="dt">ylab=</span><span class="st">&quot;component 1&quot;</span>,<span class="dt">xlab=</span><span class="st">&quot;component 2&quot;</span>,</span>
<span id="cb79-10"><a href="#cb79-10"></a>         <span class="dt">main=</span><span class="kw">list</span>(<span class="kw">paste</span>(<span class="st">&quot;t-SNE with perplexity &quot;</span>, perp[i], <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)))</span>
<span id="cb79-11"><a href="#cb79-11"></a>    <span class="kw">points</span>(tsne1[<span class="kw">which</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">21</span>),], <span class="dt">col=</span><span class="st">&quot;green&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb79-12"><a href="#cb79-12"></a>    <span class="kw">points</span>(tsne1[<span class="kw">which</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">17</span>),], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb79-13"><a href="#cb79-13"></a>}</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/t-SNE.png" alt="t-SNE" width="80%"  />
<p class="caption">
(#fig:t-SNE)t-SNE
</p>
</div>
<p>å›¾@ref(fig:t-SNE)å±•ç¤ºäº†å›°æƒ‘åº¦ï¼ˆ10-60ï¼‰å¯¹é™ç»´ç»“æœçš„å½±å“ï¼Œå¯ä»¥çœ‹å‡ºï¼Œå›°æƒ‘åº¦ä¸º30æ—¶ï¼Œé™ç»´çš„æ•ˆæœæœ€ä½³ã€‚</p>
</div>
<div id="umap" class="section level2">
<h2><span class="header-section-number">5.9</span> UMAP</h2>
<p><strong>ç®€ä»‹</strong></p>
<strong>ç»Ÿä¸€æµå½¢é€¼è¿‘ä¸æŠ•å½±</strong>(UMAP, Uniform Manifold Approximation and Projection)æ˜¯å»ºç«‹åœ¨é»æ›¼å‡ ä½•å’Œä»£æ•°æ‹“æ‰‘ç†è®ºæ¡†æ¶ä¸Šçš„æ–°çš„é™ç»´<strong>æµå½¢å­¦ä¹ æŠ€æœ¯</strong>ã€‚åœ¨å¯è§†åŒ–è´¨é‡æ–¹é¢ï¼ŒUMAPç®—æ³•ä¸t-SNEå…·æœ‰ç«äº‰ä¼˜åŠ¿ï¼Œä½†æ˜¯å®ƒä¿ç•™äº†æ›´å¤šå…¨å±€ç»“æ„ã€å…·æœ‰ä¼˜è¶Šçš„è¿è¡Œæ€§èƒ½ã€æ›´å¥½çš„å¯æ‰©å±•æ€§ã€‚
<div class="figure" style="text-align: center">
<img src="./plots/5/manifold.png" alt="manifold" width="60%"  />
<p class="caption">
(#fig:manifold)manifold
</p>
</div>
<p>å›¾@ref(fig:manifold)ä¸­ä¸¤ä¸ªé»‘ç‚¹ï¼Œè‹¥è€ƒè™‘ç›´çº¿è·ç¦»ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªé»‘ç‚¹ä¹‹é—´è·ç¦»å¾ˆç›¸è¿‘ï¼›å¦‚æœæ”¾åˆ°æµå½¢å­¦ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç‚¹è·ç¦»å°±å¾—æ²¿ç€å›¾ä¸­æ›²çº¿ç»•ä¸¤åœˆã€‚</p>
<p><strong>åŸºæœ¬åŸç†</strong></p>
<ol style="list-style-type: decimal">
<li><p>è®¡ç®—<strong>é«˜ç»´</strong>çš„<strong>æµå½¢ç»“æ„ç‰¹å¾</strong>ï¼Œç¡®å®šé«˜ç»´ç©ºé—´ä¸­å„ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œä»è€Œæ„é€ é«˜ç»´çš„æ•°æ®åˆ†å¸ƒç»“æ„ã€‚</p></li>
<li><p>å°†å®ƒä»¬<strong>æŠ•å½±åˆ°ä½ç»´ç©ºé—´</strong>ï¼Œæ ¹æ®é«˜ç»´ç©ºé—´ç‚¹ä¸ç‚¹ä¹‹é—´çš„ç›¸å¯¹å…³ç³»ï¼Œæå–ç‰¹å¾å€¼ï¼Œåœ¨ä½ç»´ç©ºé—´ä¸­<strong>é‡æ„</strong>è¿™ç§è·ç¦»å…³ç³»ï¼Œå¹¶è®¡ç®—ä½ç»´ç©ºé—´ä¸­å„ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»ã€‚</p></li>
<li><p>ä½¿ç”¨<strong>éšæœºæ¢¯åº¦ä¸‹é™</strong>æ¥æœ€å°åŒ–è¿™äº›è·ç¦»ä¹‹é—´çš„å·®å¼‚ã€‚</p></li>
</ol>
<p><strong>å…·ä½“è¿‡ç¨‹</strong></p>
<ol style="list-style-type: decimal">
<li><p>æ„å»º<strong>é«˜ç»´ç©ºé—´</strong>çš„æ¨¡ç³Šæ‹“æ‰‘è¡¨ç¤º<br />
<span class="math inline">\(q\)</span>ç»´ç©ºé—´ä¸­ç»™å®šä¸€ç»„æ•°æ®<span class="math inline">\(x_1,â€¦,x_n\)</span>ã€‚å®šä¹‰ï¼š
<span class="math display">\[
d:dissimilarity\ measure\\
X_i=\left\{x_{i_1},â€¦,x_{i_k}\right\}:k\ nearest\ neighbors\ of\ x_i
\]</span>
å¯¹äºæ¯ä¸ª<span class="math inline">\(x_i\)</span>ï¼Œç¡®å®š<span class="math inline">\(\rho_i\)</span>å’Œ<span class="math inline">\(\sigma_i\)</span>
<span class="math display">\[
\rho_i=min\ d(x_i,x_{i_j}),1\le j\le k\\
\sum_{j=1}^kexp\left\{âˆ’\frac{d(x_i,x_{i_j})-\rho_i}{\sigma_i}\right\} =log_2k
\]</span>
<span class="math inline">\(\rho_i\)</span>æ§åˆ¶åµŒå…¥çš„ç´§å¯†ç¨‹åº¦ï¼Œå€¼è¶Šå°ç‚¹è¶Šèšé›†ï¼›<span class="math inline">\(\sigma_i\)</span>æ§åˆ¶æœ‰æ•ˆçš„åµŒå…¥é™ç»´èŒƒå›´ã€‚<br />
åˆ†å¸ƒè®¡ç®—ï¼š
<span class="math display">\[
q_{i|j}=exp\left\{âˆ’\frac{d(x_i,x_{i_j})-\rho_i}{\sigma_i}\right\}\\
q_{i,j}=q_{i|j}+q_{j|i}-q_{i|j}q_{j|i}
\]</span></p></li>
<li><p>ç®€å•åœ°ä¼˜åŒ–ä½ç»´è¡¨ç¤ºï¼Œä½¿å…¶å…·æœ‰å°½å¯èƒ½æ¥è¿‘çš„æ¨¡ç³Šæ‹“æ‰‘è¡¨ç¤ºï¼Œå¹¶ç”¨äº¤å‰ç†µæ¥åº¦é‡ã€‚<br />
ä½ç»´ç©ºé—´çš„åˆ†å¸ƒ<br />
<span class="math display">\[
p_{ij}=(1+a(y_i-y_j)^{2b})^{âˆ’1}
\]</span>
where <span class="math inline">\(a\approx1.93\)</span> and <span class="math inline">\(b\approx0.79\)</span> for default UMAP hyperparameters<br />
äº¤å‰ç†µä½œä¸ºä»£ä»·å‡½æ•°<br />
<span class="math display">\[
CE(X,Y)=\sum_i\sum_j\left\{q_{ij}(X)ln\frac{q_{ij}(X)}{p_{ij}(Y)}+(1-q_{ij}(X))ln\frac{1-q_{ij}(X)}{1-p_{ij}(Y)}\right\}
\]</span></p></li>
</ol>
<p><strong>å‚æ•°è¯´æ˜</strong></p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>umap configuration parameters</th>
<th>value</th>
<th>note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>n_neighbors</strong></td>
<td><strong>15</strong></td>
<td><strong>ç¡®å®šç›¸é‚»ç‚¹çš„æ•°é‡ï¼Œé€šå¸¸å–2-100</strong></td>
</tr>
<tr class="even">
<td><strong>n_components</strong></td>
<td><strong>2</strong></td>
<td><strong>é™ç»´çš„ç»´æ•°ï¼Œé»˜è®¤æ˜¯2</strong></td>
</tr>
<tr class="odd">
<td><strong>metric</strong></td>
<td><strong>euclidean</strong></td>
<td><strong>è·ç¦»çš„è®¡ç®—æ–¹æ³•ï¼Œå¯é€‰ï¼šeuclidean,manhattan,chebyshev,minkowski,correlation,hammingç­‰</strong></td>
</tr>
<tr class="even">
<td><strong>n_epochs</strong></td>
<td><strong>200</strong></td>
<td><strong>æ¨¡å‹è®­ç»ƒè¿­ä»£æ¬¡æ•°ã€‚æ•°æ®é‡å¤§æ—¶200ï¼Œå°æ—¶500</strong></td>
</tr>
<tr class="odd">
<td>input</td>
<td>data</td>
<td>æ•°æ®ç±»å‹ï¼Œå¦‚æœæ˜¯dataå°±ä¼šæŒ‰ç…§æ•°æ®è®¡ç®—ï¼›å¦‚æœæ˜¯distå°±ä¼šæŒ‰è·ç¦»çŸ©é˜µè®¡ç®—</td>
</tr>
<tr class="even">
<td>init</td>
<td>spectral</td>
<td>åˆå§‹åŒ–ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼šspectral,random,è‡ªå®šä¹‰</td>
</tr>
<tr class="odd">
<td><strong>min_dist</strong></td>
<td><strong>0.1</strong></td>
<td><strong>æ§åˆ¶åµŒå…¥çš„ç´§å¯†ç¨‹åº¦ï¼Œå€¼è¶Šå°ç‚¹è¶Šèšé›†ï¼Œé»˜è®¤0.1</strong></td>
</tr>
<tr class="even">
<td>set_op_mix_ratio</td>
<td>1</td>
<td>é™ç»´è¿‡ç¨‹ä¸­ç‰¹å¾çš„ç»“åˆæ–¹å¼ï¼Œå–0-1ã€‚0ä»£è¡¨å–äº¤é›†ï¼Œ1ä»£è¡¨å–åˆé›†ï¼›ä¸­é—´å°±æ˜¯æ¯”ä¾‹</td>
</tr>
<tr class="odd">
<td>local_connectivity</td>
<td>1</td>
<td>å±€éƒ¨è¿æ¥çš„ç‚¹ä¹‹é—´å€¼ï¼Œé»˜è®¤1ï¼Œå…¶å€¼è¶Šå¤§å±€éƒ¨è¿æ¥è¶Šå¤šï¼Œå¯¼è‡´çš„ç»“æœå°±æ˜¯è¶…è¶Šå›ºæœ‰çš„æµå½¢ç»´æ•°å‡ºç°æ”¹å˜</td>
</tr>
<tr class="even">
<td>bandwidth</td>
<td>1</td>
<td>ç”¨äºæ„é€ å­é›†å‚æ•°</td>
</tr>
<tr class="odd">
<td>alpha</td>
<td>1</td>
<td>å­¦ä¹ ç‡</td>
</tr>
<tr class="even">
<td>gamma</td>
<td>1</td>
<td>å¸ƒå±€æœ€ä¼˜çš„å­¦ä¹ ç‡</td>
</tr>
<tr class="odd">
<td>negative_sample_rate</td>
<td>5</td>
<td>æ¯ä¸€ä¸ªé˜³æ€§æ ·æœ¬å¯¼è‡´çš„é˜´æ€§ç‡ã€‚å…¶å€¼è¶Šå¤§å¯¼è‡´é«˜çš„ä¼˜åŒ–ä¹Ÿå°±æ˜¯è¿‡æ‹Ÿåˆï¼Œé¢„æµ‹å‡†ç¡®åº¦ä¸‹é™ã€‚é»˜è®¤æ˜¯5</td>
</tr>
<tr class="even">
<td>a</td>
<td>NA</td>
<td></td>
</tr>
<tr class="odd">
<td>b</td>
<td>NA</td>
<td></td>
</tr>
<tr class="even">
<td><strong>spread</strong></td>
<td><strong>1</strong></td>
<td><strong>æ§åˆ¶æœ‰æ•ˆçš„åµŒå…¥é™ç»´èŒƒå›´ï¼Œä¸min_distè”åˆä½¿ç”¨</strong></td>
</tr>
<tr class="odd">
<td><strong>random_state</strong></td>
<td><strong>NA</strong></td>
<td><strong>éšæœºç§å­ï¼Œç¡®ä¿æ¨¡å‹çš„å¯é‡å¤æ€§</strong></td>
</tr>
<tr class="even">
<td>transform_state</td>
<td>NA</td>
<td>ç”¨äºæ•°å€¼è½¬æ¢æ“ä½œã€‚é»˜è®¤å€¼42</td>
</tr>
<tr class="odd">
<td>knn</td>
<td>NA</td>
<td></td>
</tr>
<tr class="even">
<td>knn_repeats</td>
<td>1</td>
<td></td>
</tr>
<tr class="odd">
<td>verbose</td>
<td>FALSE</td>
<td>æ§åˆ¶å·¥ä½œæ—¥å¿—ï¼Œé˜²æ­¢å­˜å‚¨è¿‡å¤š</td>
</tr>
<tr class="even">
<td>umap_learn_args</td>
<td>NA</td>
<td>è°ƒç”¨pythonåŸºäºumap-learnè®­ç»ƒå¥½çš„å‚æ•°</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a><span class="kw">library</span>(umap)</span>
<span id="cb80-2"><a href="#cb80-2"></a>min_dist =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>)</span>
<span id="cb80-3"><a href="#cb80-3"></a>k =<span class="st"> </span><span class="kw">c</span>(<span class="dv">15</span>,<span class="dv">50</span>,<span class="dv">75</span>,<span class="dv">100</span>)</span>
<span id="cb80-4"><a href="#cb80-4"></a>sign =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>),<span class="dv">4</span>,<span class="dv">2</span>,<span class="dt">byrow =</span> F)</span>
<span id="cb80-5"><a href="#cb80-5"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>))</span>
<span id="cb80-6"><a href="#cb80-6"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>){</span>
<span id="cb80-7"><a href="#cb80-7"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>){</span>
<span id="cb80-8"><a href="#cb80-8"></a>        umap.param =<span class="st"> </span>umap.defaults</span>
<span id="cb80-9"><a href="#cb80-9"></a>        umap.param<span class="op">$</span>n_components =<span class="st"> </span><span class="dv">2</span></span>
<span id="cb80-10"><a href="#cb80-10"></a>        umap.param<span class="op">$</span>random_state =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb80-11"><a href="#cb80-11"></a>        umap.param<span class="op">$</span>min_dist =<span class="st"> </span>min_dist[i]</span>
<span id="cb80-12"><a href="#cb80-12"></a>        umap.param<span class="op">$</span>n_neighbors =<span class="st"> </span>k[j]</span>
<span id="cb80-13"><a href="#cb80-13"></a>        umap =<span class="st"> </span><span class="kw">umap</span>(X, <span class="dt">config=</span>umap.param, <span class="dt">method=</span><span class="st">&quot;naive&quot;</span>)</span>
<span id="cb80-14"><a href="#cb80-14"></a>        umap1 =<span class="st"> </span><span class="kw">matrix</span>()</span>
<span id="cb80-15"><a href="#cb80-15"></a>        umap<span class="op">$</span>layout[,<span class="dv">1</span>] =<span class="st"> </span>sign[j,<span class="dv">1</span>]<span class="op">*</span>umap<span class="op">$</span>layout[,<span class="dv">1</span>]</span>
<span id="cb80-16"><a href="#cb80-16"></a>        umap<span class="op">$</span>layout[,<span class="dv">2</span>] =<span class="st"> </span>sign[j,<span class="dv">2</span>]<span class="op">*</span>umap<span class="op">$</span>layout[,<span class="dv">2</span>]</span>
<span id="cb80-17"><a href="#cb80-17"></a>        umap1 =<span class="st"> </span>umap<span class="op">$</span>layout[,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)]</span>
<span id="cb80-18"><a href="#cb80-18"></a>        <span class="kw">plot</span>(umap1,<span class="dt">col=</span><span class="st">&quot;blue&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>,</span>
<span id="cb80-19"><a href="#cb80-19"></a>             <span class="dt">ylab=</span><span class="st">&quot;component 1&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;component 2&quot;</span>,</span>
<span id="cb80-20"><a href="#cb80-20"></a>             <span class="dt">main=</span><span class="kw">list</span>(<span class="kw">paste</span>(<span class="st">&quot;UMAP (k=&quot;</span>,k[j],<span class="st">&quot;, min_dist= &quot;</span>,min_dist[i], <span class="st">&quot;)&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)))</span>
<span id="cb80-21"><a href="#cb80-21"></a>        <span class="kw">points</span>(umap1[<span class="kw">which</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">21</span>),], <span class="dt">col=</span><span class="st">&quot;green&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb80-22"><a href="#cb80-22"></a>        <span class="kw">points</span>(umap1[<span class="kw">which</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">17</span>),], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb80-23"><a href="#cb80-23"></a>    }</span>
<span id="cb80-24"><a href="#cb80-24"></a>}</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/UMAP.png" alt="UMAP" width="80%"  />
<p class="caption">
(#fig:UMAP)UMAP
</p>
</div>
<p>å›¾@ref(fig:UMAP)å±•ç¤ºäº†é™ç»´ç»“æœä»¥åŠä¸¤å‚æ•°<code>k</code>å’Œ<code>min_dist</code>å¯¹é™ç»´ç»“æœçš„å½±å“<br />
- ç«–çœ‹ï¼š<code>min_dist</code>è¶Šå¤§ï¼Œå›¾å½¢ä¸­çš„ç‚¹åˆ†æ•£åœ°è¶Šå‡åŒ€<br />
- æ¨ªçœ‹ï¼š<code>k</code>è¶Šå°ï¼Œæ•°æ®çš„æµè¡Œç»“æ„æ˜¾ç¤ºåœ°è¶Šæ˜æ˜¾</p>
</div>
<div id="som" class="section level2">
<h2><span class="header-section-number">5.10</span> SOM</h2>
<p><strong>è‡ªç»„ç»‡æ˜ å°„</strong>(Self-organizing map, SOM)æ˜¯ä¸€ç§ç«äº‰å‹ç¥ç»ç½‘ç»œï¼Œç”±è¾“å…¥å±‚å’Œç«äº‰å±‚ï¼ˆå¸¸è§2ç»´ï¼‰æ„æˆã€‚</p>
å›¾@ref(fig:som-ill)å±•ç¤ºäº†SOMçš„ç»“æ„ã€‚
<div class="figure" style="text-align: center">
<img src="./plots/5/som.png" alt="SOM" width="60%"  />
<p class="caption">
(#fig:som-ill)SOM
</p>
</div>
<ul>
<li><p><strong>è¾“å…¥å±‚</strong>ç¥ç»å…ƒçš„æ•°é‡ç”±è¾“å…¥å‘é‡çš„ç»´åº¦å†³å®šï¼Œä¸€ä¸ªç¥ç»å…ƒå¯¹åº”ä¸€ä¸ªç‰¹å¾</p></li>
<li><p><strong>ç«äº‰å±‚</strong>çš„å¸¸è§ç»“æ„ï¼šçŸ©å½¢(Rectangular)ã€å…­è¾¹å½¢(Hexagonal)ï¼Œå‚è§å›¾@ref(fig:SOM-com)ã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/5/som-com.png" alt="SOM-com" width="80%"  />
<p class="caption">
(#fig:SOM-com)SOM-com
</p>
</div>
<p>ç«äº‰å±‚ç¥ç»å…ƒçš„æ•°é‡å†³å®šäº†æœ€ç»ˆæ¨¡å‹çš„ç²’åº¦ä¸è§„æ¨¡ï¼Œå¯¹æœ€ç»ˆæ¨¡å‹çš„å‡†ç¡®æ€§ä¸æ³›åŒ–èƒ½åŠ›å½±å“å¾ˆå¤§ã€‚<br />
ç»éªŒå…¬å¼ï¼š<span class="math inline">\(N\ge5\sqrt{m}\)</span>ï¼Œ<span class="math inline">\(m\)</span>ä¸ºè®­ç»ƒæ ·æœ¬æ•°</p></li>
</ul>
<p><strong>åŸºæœ¬åŸç†</strong></p>
<p>è¿ç”¨ç«äº‰å­¦ä¹ (competitive learning)ç­–ç•¥ï¼Œç«äº‰å±‚å„ç¥ç»å…ƒç«äº‰å¯¹è¾“å…¥å±‚å“åº”çš„æœºä¼šï¼Œæœ€åä»…æœ‰ä¸€ä¸ªç¥ç»å…ƒè·èƒœï¼Œä»£è¡¨å¯¹è¾“å…¥å±‚çš„åˆ†ç±»ã€‚å¦‚æ­¤è¿­ä»£ï¼Œé€æ­¥ä¼˜åŒ–ç½‘ç»œã€‚</p>
<p><strong>å…·ä½“è¿‡ç¨‹</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>åˆå§‹åŒ–</strong>ï¼šåˆå§‹åŒ–è¿æ¥æƒé‡<span class="math inline">\(\omega_{j}^{(0)}=\left(\omega_{j 1}, \ldots, \omega_{j n}\right), j=1, \ldots, N\)</span></p></li>
<li><p><strong>ç«äº‰</strong>ï¼šå¯¹äºè¾“å…¥æ ·æœ¬<span class="math inline">\(x_i\)</span>ï¼Œéå†ç«äº‰å±‚ä¸­æ¯ä¸€ä¸ªç¥ç»å…ƒï¼Œè®¡ç®—<span class="math inline">\(x_i\)</span>ä¸æ¯ä¸ªç¥ç»å…ƒçš„è¿æ¥æƒé‡<span class="math inline">\(\omega_j\)</span>ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼ˆé€šå¸¸ä½¿ç”¨æ¬§å¼è·ç¦»æˆ–å¹³æ–¹æ¬§å¼è·ç¦»ï¼‰ã€‚è·ç¦»æœ€å°çš„ç¥ç»å…ƒèŠ‚ç‚¹èƒœå‡ºï¼Œç§°ä¸ºBMN(best matching neuron)</p></li>
</ol>
<p><span class="math display">\[
j^{*}=j^{*}(i)=\underset{j \in \mathcal{J}}{\arg \min } d\left(\boldsymbol{w}_{j}, \boldsymbol{x}_{i}\right)
\]</span></p>
<ol start="3" style="list-style-type: decimal">
<li><p><strong>åˆä½œ</strong>ï¼šè·èƒœç¥ç»å…ƒå†³å®šäº†å…´å¥‹ç¥ç»å…ƒæ‹“æ‰‘é‚»åŸŸçš„ç©ºé—´ä½ç½®ï¼Œä»è€Œä¸ºç›¸é‚»ç¥ç»å…ƒä¹‹é—´çš„åˆä½œæä¾›äº†åŸºç¡€ã€‚
ç¥ç»ç”Ÿç‰©å­¦çš„ç ”ç©¶è¡¨æ˜ï¼Œä¸€ç»„å…´å¥‹ç¥ç»å…ƒå†…å­˜åœ¨æ¨ªå‘çš„ç›¸äº’ä½œç”¨ã€‚å› æ­¤å½“ä¸€ä¸ªç¥ç»å…ƒè¢«æ¿€æ´»æ—¶ï¼Œè¿‘é‚»èŠ‚ç‚¹å¾€å¾€æ¯”è¿œç¦»çš„èŠ‚ç‚¹æ›´å…´å¥‹ã€‚å®šä¹‰é‚»åŸŸå‡½æ•°<span class="math inline">\(\theta\)</span>ï¼Œè¡¨ç¤ºè·èƒœç¥ç»å…ƒå¯¹è¿‘é‚»ç¥ç»å…ƒçš„å½±å“å¼ºå¼±ï¼Œä¹Ÿå³ä¼˜èƒœé‚»åŸŸä¸­æ¯ä¸ªç¥ç»å…ƒçš„æ›´æ–°å¹…åº¦ã€‚å¸¸è§çš„é€‰æ‹©æ˜¯é«˜æ–¯å‡½æ•°ï¼š
<span class="math display">\[
\theta\left(j^{*}(i), j ; t\right)=\exp \left\{-\frac{1}{2 \sigma(t)^{2}}\left\|j-j^{*}(i)\right\|_{2}^{2} / J^{2}\right\}
\]</span>
é‚»åŸŸåŠå¾„<span class="math inline">\(\sigma(t)\)</span>éšç€æ—¶é—´çš„æ¨ç§»è€Œå‡å°‘ã€‚<br />
è¶Šé è¿‘ä¼˜èƒœç¥ç»å…ƒï¼Œæ›´æ–°å¹…åº¦è¶Šå¤§ï¼›è¶Šè¿œç¦»ä¼˜èƒœç¥ç»å…ƒï¼Œæ›´æ–°å¹…åº¦è¶Šå°</p></li>
<li><p><strong>é€‚åº”/å­¦ä¹ </strong>ï¼šæ›´æ–°ä¼˜èƒœé‚»åŸŸå†…ç¥ç»å…ƒçš„è¿æ¥æƒé‡
<span class="math display">\[
\boldsymbol{w}_{j}^{(t)}=\boldsymbol{w}_{j}^{(t-1)}+\theta\left(j^{*}(i), j ; t\right) \alpha(t)\left(\boldsymbol{x}_{i}-\boldsymbol{w}_{j}^{(t-1)}\right)
\]</span>
å­¦ä¹ ç‡<span class="math inline">\(\alpha(t)\)</span>éšç€æ—¶é—´çš„æ¨ç§»è€Œå‡å°‘ã€‚</p></li>
<li><p><strong>è¿­ä»£</strong>ï¼šè¿”å›ç¬¬äºŒæ­¥ï¼Œè¿­ä»£è‡³æ”¶æ•›æˆ–è¾¾åˆ°è®¾å®šæ¬¡æ•°</p></li>
</ol>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="kw">library</span>(kohonen)</span>
<span id="cb81-2"><a href="#cb81-2"></a>p =<span class="st"> </span><span class="kw">ceiling</span>(<span class="kw">sqrt</span>(<span class="dv">5</span><span class="op">*</span><span class="kw">sqrt</span>(<span class="kw">nrow</span>(X)))) <span class="co">#æ ¹æ®ç»éªŒå…¬å¼ç¡®å®šæ­£æ–¹å½¢çš„è¾¹é•¿</span></span>
<span id="cb81-3"><a href="#cb81-3"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb81-4"><a href="#cb81-4"></a>som1 =<span class="st"> </span><span class="kw">som</span>(<span class="kw">as.matrix</span>(X),<span class="dt">grid=</span><span class="kw">somgrid</span>(<span class="dt">xdim=</span>p,<span class="dt">ydim=</span>p,<span class="dt">topo=</span><span class="st">&quot;rectangular&quot;</span>),<span class="dt">rlen=</span><span class="dv">500</span>,<span class="dt">dist.fcts=</span><span class="st">&quot;euclidean&quot;</span>)</span>
<span id="cb81-5"><a href="#cb81-5"></a><span class="kw">summary</span>(som1)</span>
<span id="cb81-6"><a href="#cb81-6"></a><span class="kw">head</span>(som1<span class="op">$</span>unit.classif,<span class="dv">100</span>) <span class="co">#å„æ•°æ®ç‚¹çš„è·èƒœç¥ç»å…ƒ</span></span>
<span id="cb81-7"><a href="#cb81-7"></a><span class="kw">tail</span>(som1<span class="op">$</span>codes[[<span class="dv">1</span>]]) <span class="co">#è¿æ¥æƒé‡å‘é‡</span></span>
<span id="cb81-8"><a href="#cb81-8"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb81-9"><a href="#cb81-9"></a>som2 =<span class="st"> </span><span class="kw">som</span>(<span class="kw">as.matrix</span>(X),<span class="dt">grid=</span><span class="kw">somgrid</span>(<span class="dt">xdim=</span>p,<span class="dt">ydim=</span>p,<span class="dt">topo=</span><span class="st">&quot;hexagonal&quot;</span>),<span class="dt">rlen=</span><span class="dv">500</span>,<span class="dt">dist.fcts=</span><span class="st">&quot;euclidean&quot;</span>)</span>
<span id="cb81-10"><a href="#cb81-10"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb81-11"><a href="#cb81-11"></a><span class="kw">plot</span>(som1,<span class="kw">c</span>(<span class="st">&quot;changes&quot;</span>))</span>
<span id="cb81-12"><a href="#cb81-12"></a><span class="kw">plot</span>(som1,<span class="kw">c</span>(<span class="st">&quot;counts&quot;</span>), <span class="dt">main=</span><span class="st">&quot;allocation counts to neurons&quot;</span>)</span>
<span id="cb81-13"><a href="#cb81-13"></a>d.data<span class="op">$</span>tau2 =<span class="st"> </span>d.data<span class="op">$</span>sports_car<span class="op">+</span><span class="kw">as.integer</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">21</span>)<span class="op">+</span><span class="dv">1</span></span>
<span id="cb81-14"><a href="#cb81-14"></a><span class="kw">plot</span>(som1,<span class="kw">c</span>(<span class="st">&quot;mapping&quot;</span>),<span class="dt">classif=</span><span class="kw">predict</span>(som1),<span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;red&quot;</span>)[d.data<span class="op">$</span>tau2], <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">main=</span><span class="st">&quot;allocation of cases to neurons&quot;</span>)</span>
<span id="cb81-15"><a href="#cb81-15"></a><span class="kw">plot</span>(som2,<span class="kw">c</span>(<span class="st">&quot;changes&quot;</span>))</span>
<span id="cb81-16"><a href="#cb81-16"></a><span class="kw">plot</span>(som2,<span class="kw">c</span>(<span class="st">&quot;counts&quot;</span>), <span class="dt">main=</span><span class="st">&quot;allocation counts to neurons&quot;</span>)</span>
<span id="cb81-17"><a href="#cb81-17"></a>d.data<span class="op">$</span>tau2 =<span class="st"> </span>d.data<span class="op">$</span>sports_car<span class="op">+</span><span class="kw">as.integer</span>(d.data<span class="op">$</span>tau<span class="op">&lt;</span><span class="dv">21</span>)<span class="op">+</span><span class="dv">1</span></span>
<span id="cb81-18"><a href="#cb81-18"></a><span class="kw">plot</span>(som2,<span class="kw">c</span>(<span class="st">&quot;mapping&quot;</span>),<span class="dt">classif=</span><span class="kw">predict</span>(som2),<span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;green&quot;</span>,<span class="st">&quot;red&quot;</span>)[d.data<span class="op">$</span>tau2], <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">main=</span><span class="st">&quot;allocation of cases to neurons&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/5/som2.png" alt="SOM" width="80%"  />
<p class="caption">
(#fig:SOM)SOM
</p>
</div>
<p>å›¾@ref(fig:SOM)çš„ç¬¬ä¸€è¡Œå±•ç¤ºçš„æ˜¯çŸ©å½¢ç«äº‰å±‚è¾“å‡ºçš„é™ç»´ç»“æœï¼Œç¬¬äºŒè¡Œå±•ç¤ºçš„æ˜¯å…­è¾¹å½¢ç«äº‰å±‚è¾“å‡ºçš„é™ç»´ç»“æœï¼Œsports carsï¼ˆçº¢è‰²ï¼‰å¯ä»¥è¢«è¾ƒä¸ºæ˜æ˜¾åœ°åŒºåˆ†å¼€æ¥ã€‚</p>
<!--chapter:end:05-unsupervised.Rmd-->
</div>
</div>
<div id="rnn" class="section level1">
<h1><span class="header-section-number">6</span> å¾ªç¯ç¥ç»ç½‘ç»œä¸æ­»äº¡ç‡é¢„æµ‹</h1>
<p><em>æ–¹ç‰æ˜•ã€é²ç‘¶ã€é«˜å…‰è¿œ</em></p>
<p>ğŸ˜· æ–°å† è‚ºç‚æ­»äº¡ç‡æ•°æ®ï¼š<a href="https://mpidr.shinyapps.io/stmortality/" class="uri">https://mpidr.shinyapps.io/stmortality/</a></p>
<div id="lee-carter-model" class="section level2">
<h2><span class="header-section-number">6.1</span> Lee-Carter Model</h2>
<p>Lee Carteræ¨¡å‹ä¸­ï¼Œæ­»äº¡åŠ›ï¼ˆforce of mortalityï¼‰çš„å®šä¹‰å¦‚ä¸‹ï¼š<br />
<span class="math display">\[\log \left(m_{t, x}\right)=a_{x}+b_{x} k_{t}\]</span>
å…¶ä¸­ï¼Œ</p>
<ul>
<li><p><span class="math inline">\(m_{t, x}&gt;0\)</span> æ˜¯ <span class="math inline">\(x\)</span> å²çš„äººåœ¨æ—¥å†å¹´ <span class="math inline">\(t\)</span> çš„æ­»äº¡ç‡ï¼ˆmortality rateï¼‰,</p></li>
<li><p><span class="math inline">\(a_{x}\)</span> æ˜¯ <span class="math inline">\(x\)</span> å²çš„äººçš„å¹³å‡å¯¹æ•°æ­»äº¡ç‡,</p></li>
<li><p><span class="math inline">\(b_{x}\)</span> æ˜¯æ­»äº¡ç‡å˜åŒ–çš„å¹´é¾„å› ç´ ,</p></li>
<li><p><span class="math inline">\(\left(k_{t}\right)_{t}\)</span> æ˜¯æ­»äº¡ç‡å˜åŒ–çš„æ—¥å†å¹´å› ç´ .</p></li>
</ul>
<p>ç”¨ <span class="math inline">\(M_{t, x}\)</span> è¡¨ç¤ºæŸä¸€æ€§åˆ«æ­»äº¡ç‡çš„è§‚å¯Ÿå€¼ï¼ˆraw mortality ratesï¼‰.<br />
æˆ‘ä»¬å¯¹å¯¹æ•°æ­»äº¡ç‡ <span class="math inline">\(\log \left(M_{t, x}\right)\)</span> ä¸­å¿ƒåŒ–å¤„ç†ï¼š<br />
<span class="math display">\[\log \left(M_{t, x}^{\circ}\right)=\log \left(M_{t, x}\right)-\widehat{a}_{x}=\log \left(M_{t, x}\right)-\frac{1}{|\mathcal{T}|} \sum_{s \in \mathcal{T}} \log \left(M_{s, x}\right)\]</span></p>
<p>å…¶ä¸­ï¼Œ</p>
<ul>
<li><p><span class="math inline">\(\mathcal{T}\)</span> ä¸ºè®­ç»ƒé›†ä¸­æ—¥å†å¹´çš„é›†åˆ,</p></li>
<li><p><span class="math inline">\(\widehat{a}_{x}=\frac{1}{|\mathcal{T}|} \sum_{s \in \mathcal{T}} \log \left(M_{s, x}\right)\)</span> æ˜¯å¹³å‡å¯¹æ•°æ­»äº¡ç‡ <span class="math inline">\(a_{x}\)</span> çš„ä¼°è®¡.</p></li>
</ul>
<p>å¯¹äº<span class="math inline">\(b_x,k_t\)</span> æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ±‚å¦‚ä¸‹æœ€ä¼˜åŒ–é—®é¢˜ï¼š<br />
<span class="math display">\[\underset{\left(b_{x}\right)_{x},\left(k_{t}\right)_{t}}{\arg \min } \sum_{t, x}\left(\log \left(M_{t, x}^{\circ}\right)-b_{x} k_{t}\right)^{2}ã€‚\]</span></p>
<p>å®šä¹‰çŸ©é˜µ <span class="math inline">\(A=\left(\log \left(M_{t, x}^{\circ}\right)\right)_{x, t}\)</span>ã€‚ä¸Šè¿°æœ€ä¼˜åŒ–é—®é¢˜å¯ä»¥é€šè¿‡å¯¹<span class="math inline">\(A\)</span>è¿›è¡Œå¥‡å¼‚å€¼åˆ†è§£ï¼ˆSVDï¼‰è§£å†³<span class="math display">\[A=U\Lambda V^\intercal,\]</span>
å…¶ä¸­<span class="math inline">\(U\)</span>ç§°ä¸ºå·¦å¥‡å¼‚çŸ©é˜µï¼Œå¯¹è§’çŸ©é˜µ<span class="math inline">\(\Lambda=\text{diag}(\lambda_1,\ldots,\lambda_T)\)</span>ä¸­çš„å¯¹è§’å…ƒç´ <span class="math inline">\(\lambda_1\geq\lambda_2\geq\ldots\geq\lambda_T\geq0\)</span>ç§°ä¸ºå¥‡å¼‚å€¼ï¼Œ<span class="math inline">\(V\)</span>ç§°ä¸ºå³å¥‡å¼‚çŸ©é˜µã€‚</p>
<ul>
<li><p><span class="math inline">\(A\)</span> çš„ç¬¬ä¸€ä¸ªå·¦å¥‡å¼‚å‘é‡<span class="math inline">\(U_{\cdot,1}\)</span>ä¸ç¬¬ä¸€ä¸ªå¥‡å¼‚å€¼<span class="math inline">\(\lambda_1\)</span>ç›¸ä¹˜ï¼Œå¯ä»¥å¾—åˆ° <span class="math inline">\(\left(b_{x}\right)_{x}\)</span> çš„ä¸€ä¸ªä¼°è®¡ <span class="math inline">\(\left(\widehat{b}_{x}\right)_{x}\)</span>ã€‚</p></li>
<li><p><span class="math inline">\(A\)</span> çš„ç¬¬ä¸€ä¸ªå³å¥‡å¼‚å‘é‡<span class="math inline">\(V_{\cdot,1}\)</span>ç»™å‡ºäº† <span class="math inline">\(\left(k_{t}\right)_{t}\)</span> çš„ä¸€ä¸ªä¼°è®¡ <span class="math inline">\(\left(\widehat{k}_{t}\right)_{t}\)</span>ã€‚</p></li>
</ul>
<p>ä¸ºäº†æ±‚è§£ç»“æœçš„å”¯ä¸€æ€§ï¼Œå¢åŠ çº¦æŸï¼š<br />
<span class="math display">\[\sum_{x} \hat{b}_{x}=1 \quad \text { and } \quad \sum_{t \in \mathcal{T}} \hat{k}_{t}=0\]</span>
è‡³æ­¤å³å¯è§£å‡ºå”¯ä¸€çš„ <span class="math inline">\(\left(\hat{a}_{x}, \hat{b}_{x}\right)_{x}, \left(\hat{k}_{t}\right)_{t}\)</span> . è¿™å°±æ˜¯ç»å…¸çš„LCæ¨¡å‹æ„å»ºæ–¹æ³•.</p>
</div>
<div id="æ™®é€šå¾ªç¯ç¥ç»ç½‘ç»œrecurrent-neural-network" class="section level2">
<h2><span class="header-section-number">6.2</span> æ™®é€šå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆrecurrent neural networkï¼‰</h2>
<p><strong>è¾“å…¥å˜é‡ï¼ˆInputï¼‰</strong> : <span class="math inline">\(\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{T}\right)\)</span> with components <span class="math inline">\(\boldsymbol{x}_{t} \in \mathbb{R}^{\tau_{0}}\)</span> at times <span class="math inline">\(t=1, \ldots, T\)</span> (in time series structure).</p>
<p><strong>è¾“å‡ºå˜é‡ï¼ˆOutputï¼‰</strong>: <span class="math inline">\(y \in \mathcal{Y} \subset \mathbb{R}\)</span> .</p>
<p>é¦–å…ˆçœ‹ä¸€ä¸ªå…·æœ‰ <span class="math inline">\(\tau_{1} \in \mathbb{N}\)</span> ä¸ªéšå±‚ç¥ç»å…ƒï¼ˆhidden neuronsï¼‰å’Œå•ä¸€éšå±‚ï¼ˆhidden layerï¼‰çš„RNN. éšå±‚ç”±å¦‚ä¸‹æ˜ å°„ï¼ˆmappingï¼‰å®šä¹‰ï¼š
<span class="math display">\[\boldsymbol{z}^{(1)}: \mathbb{R}^{\tau_{0} \times \tau_{1}} \rightarrow \mathbb{R}^{\tau_{1}}, \quad\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}\right) \mapsto \boldsymbol{z}_{t}^{(1)}=\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}\right)\]</span>
å…¶ä¸­ä¸‹æ ‡ <span class="math inline">\(t\)</span> è¡¨ç¤ºæ—¶é—´,ä¸Šæ ‡ (1) è¡¨ç¤ºç¬¬ä¸€éšå±‚ï¼ˆæœ¬ä¾‹ä¸­ä¹Ÿæ˜¯å”¯ä¸€éšå±‚ï¼‰.</p>
<p>éšå±‚ç»“æ„æ„é€ å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
\begin{aligned}
\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}\right) =&amp;\left(\phi\left(\left\langle\boldsymbol{w}_{1}^{(1)}, \boldsymbol{x}_{t}\right\rangle+\left\langle\boldsymbol{u}_{1}^{(1)}, \boldsymbol{z}_{t-1}\right\rangle\right),  \ldots, \phi\left(\left\langle\boldsymbol{w}_{\tau_{1}}^{(1)}, \boldsymbol{x}_{t}\right\rangle+\left\langle\boldsymbol{u}_{\tau_{1}}^{(1)}, \boldsymbol{z}_{t-1}\right\rangle\right)\right)^{\top} \\
\stackrel{\text { def. }}{=} &amp;\phi\left(\left\langle W^{(1)}, \boldsymbol{x}_{t}\right\rangle+\left\langle U^{(1)}, \boldsymbol{z}_{t-1}\right\rangle\right)
\end{aligned}
\]</span>
å…¶ä¸­ç¬¬ <span class="math inline">\(1 \leq j \leq \tau_{1}\)</span> ä¸ªç¥ç»å…ƒçš„ç»“æ„ä¸ºï¼š<br />
<span class="math display">\[\phi\left(\left\langle\boldsymbol{w}_{j}^{(1)}, \boldsymbol{x}_{t}\right\rangle+\left\langle\boldsymbol{u}_{j}^{(1)}, \boldsymbol{z}_{t-1}\right\rangle\right)=\phi\left(w_{j, 0}^{(1)}+\sum_{l=1}^{\tau_{0}} w_{j, l}^{(1)} x_{t, l}+\sum_{l=1}^{\tau_{1}} u_{j, l}^{(1)} z_{t-1, l}\right)\]</span></p>
<ul>
<li><span class="math inline">\(\phi: \mathbb{R} \rightarrow \mathbb{R}\)</span> æ˜¯éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆactivation functionï¼‰</li>
<li>ç½‘ç»œå‚æ•°ï¼ˆnetwork parametersï¼‰ä¸º <span class="math display">\[W^{(1)}=\left(\boldsymbol{w}_{j}^{(1)}\right)_{1 \leq j \leq \tau_{1}}^{\top} \in \mathbb{R}^{\tau \times\left(\tau_{0}+1\right)} \text{(including an intercept)}\]</span> <span class="math display">\[U^{(1)}=\left(\boldsymbol{u}_{j}^{(1)}\right)_{1 \leq j \leq \tau_{1}}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}} \text{(excluding an intercept)}\]</span></li>
</ul>
<p>é™¤äº†ä¸Šè¿°å•éšå±‚çš„ç»“æ„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è½»æ¾åœ°è®¾è®¡å¤šéšå±‚çš„RNN.</p>
<p>ä¾‹å¦‚ï¼ŒåŒéšå±‚çš„RNNç»“æ„å¯ä»¥ä¸º:</p>
<ul>
<li><p><strong>1st variant</strong> : ä»…å…è®¸åŒçº§éšå±‚ä¹‹é—´çš„å¾ªç¯
<span class="math display">\[
\begin{aligned}
\boldsymbol{z}_{t}^{(1)} &amp;=\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right) \\
\boldsymbol{z}_{t}^{(2)} &amp;=\boldsymbol{z}^{(2)}\left(\boldsymbol{z}_{t}^{(1)}, \boldsymbol{z}_{t-1}^{(2)}\right)
\end{aligned}
\]</span></p></li>
<li><p><strong>2nd variant</strong> : å…è®¸è·¨çº§éšå±‚å¾ªç¯
<span class="math display">\[
\begin{aligned}
\boldsymbol{z}_{t}^{(1)} &amp;=\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}, \boldsymbol{z}_{t-1}^{(2)}\right) \\
\boldsymbol{z}_{t}^{(2)} &amp;=\boldsymbol{z}^{(2)}\left(\boldsymbol{z}_{t}^{(1)}, \boldsymbol{z}_{t-1}^{(2)}\right)
\end{aligned}
\]</span></p></li>
<li><p><strong>3rd variant</strong> : å…è®¸äºŒçº§éšå±‚ä¸è¾“å…¥å±‚ <span class="math inline">\(\boldsymbol{x}_{t}\)</span> è¿›è¡Œå¾ªç¯
<span class="math display">\[
\begin{aligned}
\boldsymbol{z}_{t}^{(1)} &amp;=\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}, \boldsymbol{z}_{t-1}^{(2)}\right) \\
\boldsymbol{z}_{t}^{(2)} &amp;=\boldsymbol{z}^{(2)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t}^{(1)}, \boldsymbol{z}_{t-1}^{(2)}\right)
\end{aligned}
\]</span></p></li>
</ul>
</div>
<div id="é•¿çŸ­æœŸè®°å¿†ç¥ç»ç½‘ç»œlong-short-term-memory" class="section level2">
<h2><span class="header-section-number">6.3</span> é•¿çŸ­æœŸè®°å¿†ç¥ç»ç½‘ç»œï¼ˆLong short-term memoryï¼‰</h2>
<p>ä»¥ä¸Šplain vanilla RNN æ— æ³•å¤„ç†é•¿è·ç¦»ä¾èµ–å’Œä¸”æœ‰æ¢¯åº¦æ¶ˆæ•£çš„é—®é¢˜ã€‚ä¸ºæ­¤ï¼ŒHochreiter-Schmidhuber (1997)æå‡ºäº†é•¿çŸ­æœŸè®°å¿†ç¥ç»ç½‘ç»œ(Long Short Term Memory Network, LSTM)ã€‚</p>
<div id="æ¿€æ´»å‡½æ•°activation-functions" class="section level3">
<h3><span class="header-section-number">6.3.1</span> æ¿€æ´»å‡½æ•°ï¼ˆActivation functionsï¼‰</h3>
<p>LSTM ç”¨åˆ°3ç§ä¸åŒçš„ <strong>æ¿€æ´»å‡½æ•°ï¼ˆactivation functionsï¼‰</strong>:</p>
<ol style="list-style-type: decimal">
<li><p>Sigmoidå‡½æ•°ï¼ˆSigmoid functionï¼‰<br />
<span class="math display">\[\phi_{\sigma}(x)=\frac{1}{1+e^{-x}} \in(0,1)\]</span></p></li>
<li><p>åŒæ›²æ­£åˆ‡å‡½æ•°ï¼ˆHyberbolic tangent functionï¼‰
<span class="math display">\[\phi_{\tanh }(x)=\frac{e^{x}-e^{-x}}{e^{x}+e^{-x}}=2 \phi_{\sigma}(2 x)-1 \in(-1,1)\]</span></p></li>
<li><p>ä¸€èˆ¬çš„æ¿€æ´»å‡½æ•°ï¼ˆGeneral activation functionï¼‰
<span class="math display">\[\phi: \mathbb{R} \rightarrow \mathbb{R}\]</span></p></li>
</ol>
</div>
<div id="gates-and-cell-state" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Gates and cell state</h3>
<p>ä»¤ <span class="math inline">\(\boldsymbol{z}_{t-1}^{(1)} \in \mathbb{R}^{\tau_{1}}\)</span> è¡¨ç¤ºæ—¶é—´ <span class="math inline">\((t-1)\)</span> æ—¶çš„<strong>æ´»åŒ–çŠ¶æ€ï¼ˆneuron activationsï¼‰</strong>. æˆ‘ä»¬å®šä¹‰3ä¸­ä¸åŒçš„ <strong>é—¨ï¼ˆgatesï¼‰</strong>, ç”¨æ¥å†³å®šä¼ æ’­åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´çš„ä¿¡æ¯é‡ï¼š</p>
<ul>
<li><p><strong>é—å¿˜é—¨ï¼ˆForget gateï¼‰</strong> (loss of memory rate):
<span class="math display">\[\boldsymbol{f}_{t}^{(1)}=\boldsymbol{f}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right)=\phi_{\sigma}\left(\left\langle W_{f}, \boldsymbol{x}_{t}\right\rangle+\left\langle U_{f}, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in(0,1)^{\tau_{1}}\]</span>
for network parameters <span class="math inline">\(W_{f}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept) <span class="math inline">\(, U_{f}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}}\)</span> (excluding an intercept <span class="math inline">\(),\)</span> and where the activation function is evaluated element wise.</p></li>
<li><p><strong>è¾“å…¥é—¨ï¼ˆInput gateï¼‰</strong> (memory update rate):
<span class="math display">\[\boldsymbol{i}_{t}^{(1)}=\boldsymbol{i}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right)=\phi_{\sigma}\left(\left\langle W_{i}, \boldsymbol{x}_{t}\right\rangle+\left\langle U_{i}, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in(0,1)^{\tau_{1}}\]</span>
for network parameters <span class="math inline">\(W_{i}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept), <span class="math inline">\(U_{i}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}}\)</span>.</p></li>
<li><p><strong>è¾“å‡ºé—¨ï¼ˆOutput gateï¼‰</strong> (release of memory information rate):
<span class="math display">\[\boldsymbol{o}_{t}^{(1)}=\boldsymbol{o}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right)=\phi_{\sigma}\left(\left\langle W_{o}, \boldsymbol{x}_{t}\right\rangle+\left\langle U_{o}, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in(0,1)^{\tau_{1}}\]</span>
for network parameters <span class="math inline">\(W_{o}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept) <span class="math inline">\(, U_{o}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}}\)</span>.</p></li>
</ul>
<p>æ³¨æ„ï¼šä»¥ä¸Šä¸‰ç§é—¨çš„åå­—å¹¶ä¸ä»£è¡¨ç€å®ƒä»¬åœ¨å®é™…ä¸­çš„ä½œç”¨ï¼Œå®ƒä»¬çš„ä½œç”¨ç”±ç½‘ç»œå‚æ•°å†³å®šï¼Œè€Œç½‘ç»œå‚æ•°æ˜¯ä»æ•°æ®ä¸­å­¦åˆ°çš„ã€‚</p>
<p>ä»¤ <span class="math inline">\(\left(\boldsymbol{c}_{t}^{(1)}\right)_{t}\)</span> è¡¨ç¤º <strong>ç»†èƒçŠ¶æ€ï¼ˆcell stateï¼‰</strong> , ç”¨ä»¥å‚¨å­˜å·²è·å¾—çš„ç›¸å…³ä¿¡æ¯.</p>
<p>ç»†èƒçŠ¶æ€çš„æ›´æ–°è§„åˆ™å¦‚ä¸‹ï¼š<br />
<span class="math display">\[\begin{aligned}
\boldsymbol{c}_{t}^{(1)}&amp;=\boldsymbol{c}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}, \boldsymbol{c}_{t-1}^{(1)}\right)\\&amp;=\boldsymbol{f}_{t}^{(1)} \circ \boldsymbol{c}_{t-1}^{(1)}+\boldsymbol{i}_{t}^{(1)} \circ \phi_{\tanh }\left(\left\langle W_{c}, \boldsymbol{x}_{t}\right\rangle+\left\langle U_{c}, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in \mathbb{R}^{\tau_{1}}
\end{aligned}\]</span>
for network parameters <span class="math inline">\(W_{c}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept), <span class="math inline">\(U_{c}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}},\)</span> and <span class="math inline">\(\circ\)</span>
denotes the Hadamard product (element wise product).</p>
<p>æœ€åï¼Œæˆ‘ä»¬æ›´æ–°æ—¶åˆ» <span class="math inline">\(t\)</span> æ—¶çš„æ´»åŒ–çŠ¶æ€ <span class="math inline">\(\boldsymbol{z}_{t}^{(1)} \in \mathbb{R}^{\tau_{1}}\)</span>.<br />
<span class="math display">\[\boldsymbol{z}_{t}^{(1)}=\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}, \boldsymbol{c}_{t-1}^{(1)}\right)=\boldsymbol{o}_{t}^{(1)} \circ \phi\left(\boldsymbol{c}_{t}^{(1)}\right) \in \mathbb{R}^{\tau_{1}}\]</span></p>
<p>è‡³æ­¤ï¼Œ</p>
<ul>
<li><p>æ¶‰åŠçš„å…¨éƒ¨ç½‘ç»œå‚æ•°æœ‰: <span class="math display">\[W_{f}^{\top}, W_{i}^{\top}, W_{o}^{\top}, W_{c}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}ï¼Œ~~ U_{f}^{\top}, U_{i}^{\top}, U_{o}^{\top}, U_{c}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}} .\]</span></p></li>
<li><p>ä¸€ä¸ªLSTMå±‚éœ€è¦ <span class="math inline">\(4\left(\left(\tau_{0}+1\right) \tau_{1}+\tau_{1}^{2}\right)\)</span> ä¸ªç½‘ç»œå‚æ•°ã€‚</p></li>
<li><p>ä»¥ä¸Šå®šä¹‰çš„å¤æ‚æ˜ å°„åœ¨kerasé€šè¿‡å‡½æ•°<code>layer_lstm()</code>å³å¯å®ç°ã€‚</p></li>
<li><p>è¿™äº›å‚æ•°å‡ç”±æ¢¯åº¦ä¸‹é™çš„å˜å¼ç®—æ³•ï¼ˆa variant of the gradient descent algorithmï¼‰å­¦ä¹ å¾—.</p></li>
</ul>
</div>
<div id="output-function" class="section level3">
<h3><span class="header-section-number">6.3.3</span> Output Function</h3>
<p>åŸºäº <span class="math inline">\(\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{T}\right)\)</span> , æˆ‘ä»¬æ¥é¢„æµ‹å®šä¹‰åœ¨ <span class="math inline">\(\mathcal{Y} \subset \mathbb{R}\)</span> çš„éšæœºå˜é‡ <span class="math inline">\(Y_{T}\)</span> .</p>
<p><span class="math display">\[\widehat{Y}_{T}=\widehat{Y}_{T}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{T}\right)=\varphi\left\langle\boldsymbol{w}, \boldsymbol{z}_{T}^{(1)}\right\rangle \in \mathcal{Y}\]</span>
å…¶ä¸­ï¼Œ</p>
<ul>
<li><p><span class="math inline">\(z_{T}^{(1)}\)</span> æ˜¯æœ€æ–°çš„éšå±‚ç¥ç»å…ƒæ´»åŒ–çŠ¶æ€ï¼ˆhidden neuron activationï¼‰</p></li>
<li><p><span class="math inline">\(\boldsymbol{w} \in \mathbb{R}^{\tau_{1}+1}\)</span> æ˜¯è¾“å‡ºæƒé‡(again including an intercept component)</p></li>
<li><p><span class="math inline">\(\varphi: \mathbb{R} \rightarrow \mathcal{Y}\)</span> æ˜¯ä¸€ä¸ªæ°å½“çš„è¾“å‡ºæ¿€æ´»å‡½æ•°ï¼Œé€‰æ‹©æ—¶éœ€è¦è€ƒè™‘<span class="math inline">\(y\)</span>çš„å–å€¼èŒƒå›´ã€‚</p></li>
</ul>
</div>
<div id="time-distributed-layer" class="section level3">
<h3><span class="header-section-number">6.3.4</span> Time-distributed Layer</h3>
<p>ä»¥ä¸Šåªè€ƒè™‘äº†æ ¹æ®æœ€æ–°çš„çŠ¶æ€ <span class="math inline">\(\boldsymbol{z}_{T}^{(1)}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{T}\right)\)</span> æ‰€ç¡®å®šçš„å•ä¸€çš„è¾“å‡º <span class="math inline">\(Y_{T}\)</span>.</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è€ƒè™‘ <strong>æ‰€æœ‰</strong> éšå±‚ç¥ç»å…ƒçŠ¶æ€:<br />
<span class="math display">\[\boldsymbol{z}_{1}^{(1)}\left(\boldsymbol{x}_{1}\right), \boldsymbol{z}_{2}^{(1)}\left(\boldsymbol{x}_{1}, \boldsymbol{x}_{2}\right), \boldsymbol{z}_{3}^{(1)}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{3}\right), \ldots, \boldsymbol{z}_{T}^{(1)}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{T}\right)\]</span>
æ¯ä¸€ä¸ªçŠ¶æ€ <span class="math inline">\(\boldsymbol{z}_{t}^{(1)}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{t}\right)\)</span> éƒ½å¯ä»¥ä½œä¸ºè§£é‡Šå˜é‡ï¼Œç”¨ä»¥ä¼°è®¡ <span class="math inline">\(t\)</span> æ—¶æ‰€å¯¹åº”çš„ <span class="math inline">\(Y_{t}\)</span> :</p>
<p><span class="math display">\[\widehat{Y}_{t}=\widehat{Y}_{t}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{t}\right)=\varphi\left\langle\boldsymbol{w}, \boldsymbol{z}_{t}^{(1)}\right\rangle=\varphi\left\langle\boldsymbol{w}, \boldsymbol{z}_{t}^{(1)}\left(\boldsymbol{x}_{1}, \ldots, \boldsymbol{x}_{t}\right)\right\rangle\]</span>
å…¶ä¸­è¿‡æ»¤å™¨ï¼ˆfilterï¼‰ <span class="math inline">\(\varphi\langle\boldsymbol{w}, \cdot\rangle\)</span> å¯¹æ‰€æœ‰æ—¶é—´ <span class="math inline">\(t\)</span> å–ç›¸åŒå‡½æ•°.</p>
<p><strong>å°ç»“ï¼šLSTMçš„ä¼˜åŠ¿</strong></p>
<ul>
<li><p>æ—¶é—´åºåˆ—ç»“æ„å’Œå› æœå…³ç³»éƒ½å¯ä»¥å¾—åˆ°æ­£ç¡®çš„ååº”</p></li>
<li><p>ç”±äºå‚æ•°ä¸ä¾èµ–æ—¶é—´ï¼ŒLSTMå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‹“å±•åˆ°æœªæ¥æ—¶é—´æ®µ</p></li>
</ul>
</div>
</div>
<div id="é—¨æ§å¾ªç¯ç¥ç»ç½‘ç»œgated-recurrent-unit" class="section level2">
<h2><span class="header-section-number">6.4</span> é—¨æ§å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆGated Recurrent Unitï¼‰</h2>
<p>å¦ä¸€ä¸ªæ¯”è¾ƒçƒ­é—¨çš„RNNç»“æ„æ˜¯ï¼šé—¨æ§å¾ªç¯å•å…ƒï¼ˆgated recurrent unit, GRU), ç”±Cho et al.Â (2014) æå‡ºï¼Œå®ƒæ¯”LSTMæ›´åŠ ç®€æ´ï¼Œä½†åŒæ ·å¯ä»¥ç¼“è§£plain vanilla RNNä¸­æ¢¯åº¦æ¶ˆæ•£çš„é—®é¢˜ã€‚</p>
<div id="gates" class="section level3">
<h3><span class="header-section-number">6.4.1</span> Gates</h3>
<p>GRUåªä½¿ç”¨2ä¸ªä¸åŒçš„<strong>é—¨ï¼ˆgatesï¼‰</strong>. ä»¤ <span class="math inline">\(\boldsymbol{z}_{t-1}^{(1)} \in \mathbb{R}^{\tau_{1}}\)</span> è¡¨ç¤º <span class="math inline">\((t-1)\)</span> æ—¶ç¥ç»å…ƒæ´»åŒ–çŠ¶æ€.</p>
<ul>
<li><p><strong>Reset gate</strong>: ç±»ä¼¼äºLSTMä¸­çš„é—å¿˜é—¨
<span class="math display">\[\boldsymbol{r}_{t}^{(1)}=\boldsymbol{r}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right)=\phi_{\sigma}\left(\left\langle W_{r}, \boldsymbol{x}_{t}\right\rangle+\left\langle U_{r}, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in(0,1)^{\tau_{1}}\]</span>
for network parameters <span class="math inline">\(W_{r}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept), <span class="math inline">\(U_{r}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}}\)</span>.</p></li>
<li><p><strong>Update gate</strong>: ç±»ä¼¼äºLSTMä¸­çš„è¾“å…¥é—¨
<span class="math display">\[\boldsymbol{u}_{t}^{(1)}=\boldsymbol{u}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right)=\phi_{\sigma}\left(\left\langle W_{u}, \boldsymbol{x}_{t}\right\rangle+\left\langle U_{u}, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in(0,1)^{\tau_{1}}\]</span>
for network parameters <span class="math inline">\(W_{u}^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept), <span class="math inline">\(U_{u}^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}}\)</span></p></li>
</ul>
</div>
<div id="neuron-activations" class="section level3">
<h3><span class="header-section-number">6.4.2</span> Neuron Activations</h3>
<p>ä»¥ä¸Šé—¨å˜é‡çš„ä½œç”¨æ˜¯ï¼Œå·²çŸ¥ <span class="math inline">\(t-1\)</span> æ—¶ç¥ç»å…ƒæ´»åŒ–çŠ¶æ€ <span class="math inline">\(\boldsymbol{z}_{t-1}^{(1)}\)</span>, è®¡ç®— <span class="math inline">\(t\)</span> æ—¶ç¥ç»å…ƒæ´»åŒ–çŠ¶æ€ <span class="math inline">\(\boldsymbol{z}_{t}^{(1)} \in \mathbb{R}^{\tau_{1}}\)</span> . æˆ‘ä»¬é€‰ç”¨å¦‚ä¸‹ç»“æ„ï¼š
<span class="math display">\[\boldsymbol{z}_{t}^{(1)}=\boldsymbol{z}^{(1)}\left(\boldsymbol{x}_{t}, \boldsymbol{z}_{t-1}^{(1)}\right)=\boldsymbol{r}_{t}^{(1)} \circ \boldsymbol{z}_{t-1}^{(1)}+\left(\mathbf{1}-\boldsymbol{r}_{t}^{(1)}\right) \circ \phi\left(\left\langle W, \boldsymbol{x}_{t}\right\rangle+\boldsymbol{u}_{t} \circ\left\langle U, \boldsymbol{z}_{t-1}^{(1)}\right\rangle\right) \in \mathbb{R}^{\tau_{1}}\]</span>
for network parameters <span class="math inline">\(W^{\top} \in \mathbb{R}^{\tau_{1} \times\left(\tau_{0}+1\right)}\)</span> (including an intercept) <span class="math inline">\(, U^{\top} \in \mathbb{R}^{\tau_{1} \times \tau_{1}},\)</span> and where <span class="math inline">\(\circ\)</span> denotes the Hadamard product.</p>
<p>GRUç½‘ç»œæ¯”LSTMç½‘ç»œçš„ç»“æ„æ›´ç®€æ´ï¼Œè€Œä¸”ä¼šäº§ç”Ÿç›¸è¿‘çš„ç»“æœã€‚
ä½†æ˜¯ï¼ŒGRUåœ¨ç¨³å¥æ€§ä¸Šæœ‰è¾ƒå¤§ç¼ºé™·ï¼Œå› æ­¤ç°é˜¶æ®µLSTMçš„ä½¿ç”¨æ›´ä¸ºå¹¿æ³›.</p>
</div>
</div>
<div id="æ¡ˆä¾‹åˆ†æcase-study" class="section level2">
<h2><span class="header-section-number">6.5</span> æ¡ˆä¾‹åˆ†æï¼ˆCase studyï¼‰</h2>
<p>æœ¬æ¡ˆä¾‹çš„æ•°æ®æ¥æºäºHuman Mortality Database (HMD)ä¸­çš„æ•°æ®ï¼Œé€‰æ‹©ç‘å£«äººå£æ•°æ®(HMDä¸­æ ‡è®°ä¸ºâ€œCHEâ€)ä½œä¸ºç¤ºä¾‹ã€‚</p>
<div id="æ•°æ®æè¿°-1" class="section level3">
<h3><span class="header-section-number">6.5.1</span> æ•°æ®æè¿°</h3>
<p>æ•°æ®åŒ…å«7ä¸ªå˜é‡ï¼Œå„å˜é‡è¯´æ˜å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr class="header">
<th align="center">å˜é‡</th>
<th align="center">ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Gender</td>
<td align="center">factor</td>
<td>ä¸¤ç§æ€§åˆ«â€”â€”ç”·æ€§å’Œå¥³æ€§</td>
</tr>
<tr class="even">
<td align="center">Year</td>
<td align="center">int</td>
<td>æ—¥å†å¹´ï¼Œ1950å¹´åˆ°2016å¹´</td>
</tr>
<tr class="odd">
<td align="center">Age</td>
<td align="center">int</td>
<td>å¹´é¾„èŒƒå›´0-99å²</td>
</tr>
<tr class="even">
<td align="center">Country</td>
<td align="center">chr</td>
<td>â€œCHEâ€ï¼Œä»£è¡¨ç‘å£«</td>
</tr>
<tr class="odd">
<td align="center">imputed_flag</td>
<td align="center">logi</td>
<td>åŸå§‹æ­»äº¡ç‡ä¸º0ï¼Œç”¨HMDä¸­å…¶ä½™å›½å®¶åŒæ—¥å†å¹´åŒå¹´é¾„çš„å¹³å‡æ­»äº¡ç‡ä»£æ›¿ï¼Œåˆ™è¯¥å˜é‡ä¸ºTRUE</td>
</tr>
<tr class="even">
<td align="center">mx</td>
<td align="center">num</td>
<td>æ­»äº¡ç‡</td>
</tr>
<tr class="odd">
<td align="center">logmx</td>
<td align="center">num</td>
<td>å¯¹æ•°æ­»äº¡ç‡</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>path.data &lt;-<span class="st"> &quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CHE_mort.csv&quot;</span>           <span class="co"># path and name of data file</span></span>
<span id="cb82-2"><a href="#cb82-2"></a>region &lt;-<span class="st"> &quot;CHE&quot;</span>                    <span class="co"># country to be loaded (code is for one selected country)</span></span>
<span id="cb82-3"><a href="#cb82-3"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_a package - load data.R&quot;</span>)</span>
<span id="cb82-4"><a href="#cb82-4"></a><span class="kw">str</span>(all_mort)</span>
<span id="cb82-5"><a href="#cb82-5"></a><span class="kw">length</span>(<span class="kw">unique</span>(all_mort<span class="op">$</span>Age))</span>
<span id="cb82-6"><a href="#cb82-6"></a><span class="kw">length</span>(<span class="kw">unique</span>(all_mort<span class="op">$</span>Year))</span>
<span id="cb82-7"><a href="#cb82-7"></a><span class="dv">67</span><span class="op">*</span><span class="dv">2</span><span class="op">*</span><span class="dv">100</span></span></code></pre></div>
</div>
<div id="æ­»äº¡ç‡çƒ­åŠ›å›¾" class="section level3">
<h3><span class="header-section-number">6.5.2</span> æ­»äº¡ç‡çƒ­åŠ›å›¾</h3>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>gender &lt;-<span class="st"> &quot;Male&quot;</span></span>
<span id="cb83-2"><a href="#cb83-2"></a><span class="co">#gender &lt;- &quot;Female&quot;</span></span>
<span id="cb83-3"><a href="#cb83-3"></a>m0 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(all_mort<span class="op">$</span>logmx), <span class="kw">max</span>(all_mort<span class="op">$</span>logmx))</span>
<span id="cb83-4"><a href="#cb83-4"></a><span class="co"># rows are calendar year t, columns are ages x</span></span>
<span id="cb83-5"><a href="#cb83-5"></a>logmx &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">matrix</span>(<span class="kw">as.matrix</span>(all_mort[<span class="kw">which</span>(all_mort<span class="op">$</span>Gender<span class="op">==</span>gender),<span class="st">&quot;logmx&quot;</span>]), <span class="dt">nrow=</span><span class="dv">100</span>, <span class="dt">ncol=</span><span class="dv">67</span>))</span>
<span id="cb83-6"><a href="#cb83-6"></a><span class="co"># png(&quot;./plots/6/heat.png&quot;)</span></span>
<span id="cb83-7"><a href="#cb83-7"></a><span class="kw">image</span>(<span class="dt">z=</span>logmx, <span class="dt">useRaster=</span><span class="ot">TRUE</span>,  <span class="dt">zlim=</span>m0, <span class="dt">col=</span><span class="kw">rev</span>(<span class="kw">rainbow</span>(<span class="dt">n=</span><span class="dv">60</span>, <span class="dt">start=</span><span class="dv">0</span>, <span class="dt">end=</span>.<span class="dv">72</span>)), <span class="dt">xaxt=</span><span class="st">&#39;n&#39;</span>, <span class="dt">yaxt=</span><span class="st">&#39;n&#39;</span>, <span class="dt">main=</span><span class="kw">list</span>(<span class="kw">paste</span>(<span class="st">&quot;Swiss &quot;</span>,gender, <span class="st">&quot; raw log-mortality rates&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">cex.lab=</span><span class="fl">1.5</span>, <span class="dt">ylab=</span><span class="st">&quot;age x&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;calendar year t&quot;</span>)</span>
<span id="cb83-8"><a href="#cb83-8"></a><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at=</span><span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2016-1950</span>))<span class="op">/</span>(<span class="dv">2016-1950</span>), <span class="kw">c</span>(<span class="dv">1950</span><span class="op">:</span><span class="dv">2016</span>))                   </span>
<span id="cb83-9"><a href="#cb83-9"></a><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">at=</span><span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">49</span>)<span class="op">/</span><span class="dv">50</span>, <span class="dt">labels=</span><span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">49</span>)<span class="op">*</span><span class="dv">2</span>)                   </span>
<span id="cb83-10"><a href="#cb83-10"></a><span class="kw">lines</span>(<span class="dt">x=</span><span class="kw">rep</span>((<span class="dv">1999-1950</span><span class="fl">+0.5</span>)<span class="op">/</span>(<span class="dv">2016-1950</span>), <span class="dv">2</span>), <span class="dt">y=</span><span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="dv">2</span>)</span>
<span id="cb83-11"><a href="#cb83-11"></a><span class="kw">dev.off</span>()</span></code></pre></div>
<p>å›¾@ref(fig:heatplot)æ˜¾ç¤ºäº†ç”·å¥³æ€§å¯¹æ•°æ­»äº¡ç‡éšæ—¶é—´çš„æ”¹å–„:</p>
<ul>
<li><p>å·¦å³ä¸¤å¹…å›¾çš„è‰²æ ‡ç›¸åŒï¼Œè“è‰²è¡¨ç¤ºæ­»äº¡ç‡å°ï¼Œçº¢è‰²è¡¨ç¤ºæ­»äº¡ç‡å¤§</p></li>
<li><p>è¯¥å›¾æ˜¾ç¤ºè¿‡å»å‡ åå¹´å…¸å‹çš„æ­»äº¡ç‡æ”¹å–„â€”â€”çƒ­å›¾ä¸­é¢œè‰²å‘ˆç•¥å¾®å‘ä¸Šçš„å¯¹è§’çº¿ç»“æ„</p></li>
<li><p>å¹³å‡è€Œè¨€ï¼Œå¥³æ€§æ­»äº¡ç‡ä½äºç”·æ€§</p></li>
<li><p>å›¾ä¸­ä½äº2000å¹´çš„å‚ç›´é»‘çº¿è¡¨ç¤ºå¯¹äºè®­ç»ƒæ•°æ®<span class="math inline">\(\mathcal{T}\)</span>å’ŒéªŒè¯æ•°æ®<span class="math inline">\(\mathcal{V}\)</span>çš„åˆ’åˆ†:åç»­æ¨¡å‹å°†ä½¿ç”¨æ—¥å†å¹´<span class="math inline">\(t=1950, \ldots, 1999\)</span>ä½œä¸ºè®­ç»ƒæ•°æ®<span class="math inline">\(\mathcal{T}\)</span>è¿›è¡Œå­¦ä¹ ï¼Œç”¨<span class="math inline">\(2000, \ldots, 2016\)</span>ä½œä¸ºéªŒè¯æ•°æ®<span class="math inline">\(\mathcal{V}\)</span>å¯¹æ­»äº¡ç‡åšæ ·æœ¬å¤–éªŒè¯ã€‚</p></li>
</ul>
<div class="figure" style="text-align: center">
<img src="./plots/6/heat.png" alt="ç‘å£«ç”·å¥³æ€§æ­»äº¡ç‡çƒ­åŠ›å›¾" width="60%" />
<p class="caption">
(#fig:heatplot)ç‘å£«ç”·å¥³æ€§æ­»äº¡ç‡çƒ­åŠ›å›¾
</p>
</div>
</div>
<div id="lee-carter-æ¨¡å‹" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Lee-Carter æ¨¡å‹</h3>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>ObsYear &lt;-<span class="st"> </span><span class="dv">1999</span></span>
<span id="cb84-2"><a href="#cb84-2"></a>gender &lt;-<span class="st"> &quot;Female&quot;</span></span>
<span id="cb84-3"><a href="#cb84-3"></a>train &lt;-<span class="st"> </span>all_mort[Year<span class="op">&lt;=</span>ObsYear][Gender <span class="op">==</span><span class="st"> </span>gender]</span>
<span id="cb84-4"><a href="#cb84-4"></a><span class="kw">min</span>(train<span class="op">$</span>Year)</span>
<span id="cb84-5"><a href="#cb84-5"></a>    </span>
<span id="cb84-6"><a href="#cb84-6"></a><span class="co">### fit via SVD</span></span>
<span id="cb84-7"><a href="#cb84-7"></a>train[,ax<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">mean</span>(logmx), by =<span class="st"> </span>(Age)]</span>
<span id="cb84-8"><a href="#cb84-8"></a>train[,mx_adj<span class="op">:</span><span class="er">=</span><span class="st"> </span>logmx<span class="op">-</span>ax]  </span>
<span id="cb84-9"><a href="#cb84-9"></a>rates_mat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dcast.data.table</span>(Age<span class="op">~</span>Year, <span class="dt">value.var =</span> <span class="st">&quot;mx_adj&quot;</span>, sum))[,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb84-10"><a href="#cb84-10"></a><span class="kw">dim</span>(rates_mat)</span>
<span id="cb84-11"><a href="#cb84-11"></a>svd_fit &lt;-<span class="st"> </span><span class="kw">svd</span>(rates_mat)</span>
<span id="cb84-12"><a href="#cb84-12"></a>    </span>
<span id="cb84-13"><a href="#cb84-13"></a>ax &lt;-<span class="st"> </span>train[,<span class="kw">unique</span>(ax)]</span>
<span id="cb84-14"><a href="#cb84-14"></a>bx &lt;-<span class="st"> </span>svd_fit<span class="op">$</span>u[,<span class="dv">1</span>]<span class="op">*</span>svd_fit<span class="op">$</span>d[<span class="dv">1</span>]</span>
<span id="cb84-15"><a href="#cb84-15"></a>kt &lt;-<span class="st"> </span>svd_fit<span class="op">$</span>v[,<span class="dv">1</span>]</span>
<span id="cb84-16"><a href="#cb84-16"></a>      </span>
<span id="cb84-17"><a href="#cb84-17"></a>c1 &lt;-<span class="st"> </span><span class="kw">mean</span>(kt)</span>
<span id="cb84-18"><a href="#cb84-18"></a>c2 &lt;-<span class="st"> </span><span class="kw">sum</span>(bx)</span>
<span id="cb84-19"><a href="#cb84-19"></a>ax &lt;-<span class="st"> </span>ax<span class="op">+</span>c1<span class="op">*</span>bx</span>
<span id="cb84-20"><a href="#cb84-20"></a>bx &lt;-<span class="st"> </span>bx<span class="op">/</span>c2</span>
<span id="cb84-21"><a href="#cb84-21"></a>kt &lt;-<span class="st"> </span>(kt<span class="op">-</span>c1)<span class="op">*</span>c2</span>
<span id="cb84-22"><a href="#cb84-22"></a>    </span>
<span id="cb84-23"><a href="#cb84-23"></a><span class="co">### extrapolation and forecast</span></span>
<span id="cb84-24"><a href="#cb84-24"></a>vali  &lt;-<span class="st"> </span>all_mort[Year<span class="op">&gt;</span>ObsYear][Gender <span class="op">==</span><span class="st"> </span>gender]    </span>
<span id="cb84-25"><a href="#cb84-25"></a>t_forecast &lt;-<span class="st"> </span>vali[,<span class="kw">unique</span>(Year)] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">length</span>()</span>
<span id="cb84-26"><a href="#cb84-26"></a>forecast_kt  =kt <span class="op">%&gt;%</span><span class="st"> </span>forecast<span class="op">::</span><span class="kw">rwf</span>(t_forecast, <span class="dt">drift =</span> T)</span>
<span id="cb84-27"><a href="#cb84-27"></a>kt_forecast =<span class="st"> </span>forecast_kt<span class="op">$</span>mean</span>
<span id="cb84-28"><a href="#cb84-28"></a> </span>
<span id="cb84-29"><a href="#cb84-29"></a><span class="co"># illustration selected drift</span></span>
<span id="cb84-30"><a href="#cb84-30"></a>plot_data &lt;-<span class="st"> </span><span class="kw">c</span>(kt, kt_forecast)</span>
<span id="cb84-31"><a href="#cb84-31"></a><span class="kw">plot</span>(plot_data, <span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">cex=</span><span class="dv">2</span>, <span class="dt">cex.lab=</span><span class="fl">1.5</span>, <span class="dt">xaxt=</span><span class="st">&#39;n&#39;</span>, <span class="dt">ylab=</span><span class="st">&quot;values k_t&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;calendar year t&quot;</span>, <span class="dt">main=</span><span class="kw">list</span>(<span class="kw">paste</span>(<span class="st">&quot;estimated process k_t for &quot;</span>,gender, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">cex=</span><span class="fl">1.5</span>)) </span>
<span id="cb84-32"><a href="#cb84-32"></a><span class="kw">points</span>(kt, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">pch=</span><span class="dv">20</span>, <span class="dt">cex=</span><span class="dv">2</span>)</span>
<span id="cb84-33"><a href="#cb84-33"></a><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(plot_data)), <span class="dt">labels=</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(plot_data))<span class="op">+</span><span class="dv">1949</span>)                   </span>
<span id="cb84-34"><a href="#cb84-34"></a><span class="kw">abline</span>(<span class="dt">v=</span>(<span class="kw">length</span>(kt)<span class="op">+</span><span class="fl">0.5</span>), <span class="dt">lwd=</span><span class="dv">2</span>)</span>
<span id="cb84-35"><a href="#cb84-35"></a><span class="co"># in-sample and out-of-sample analysis    </span></span>
<span id="cb84-36"><a href="#cb84-36"></a>fitted =<span class="st"> </span>(ax<span class="op">+</span>(bx)<span class="op">%*%</span><span class="kw">t</span>(kt)) <span class="op">%&gt;%</span><span class="st"> </span>melt</span>
<span id="cb84-37"><a href="#cb84-37"></a>train<span class="op">$</span>pred_LC_svd =<span class="st"> </span>fitted<span class="op">$</span>value <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb84-38"><a href="#cb84-38"></a>fitted_vali =<span class="st"> </span>(ax<span class="op">+</span>(bx)<span class="op">%*%</span><span class="kw">t</span>(kt_forecast)) <span class="op">%&gt;%</span><span class="st"> </span>melt</span>
<span id="cb84-39"><a href="#cb84-39"></a>vali<span class="op">$</span>pred_LC_svd =<span class="st">   </span>fitted_vali<span class="op">$</span>value <span class="op">%&gt;%</span><span class="st"> </span>exp</span>
<span id="cb84-40"><a href="#cb84-40"></a><span class="kw">round</span>(<span class="kw">c</span>((<span class="kw">mean</span>((train<span class="op">$</span>mx<span class="op">-</span>train<span class="op">$</span>pred_LC_svd)<span class="op">^</span><span class="dv">2</span>)<span class="op">*</span><span class="dv">10</span><span class="op">^</span><span class="dv">4</span>) , (<span class="kw">mean</span>((vali<span class="op">$</span>mx<span class="op">-</span>vali<span class="op">$</span>pred_LC_svd)<span class="op">^</span><span class="dv">2</span>)<span class="op">*</span><span class="dv">10</span><span class="op">^</span><span class="dv">4</span>)),<span class="dv">4</span>)</span></code></pre></div>
<p>ç”¨å¸¦æ¼‚ç§»é¡¹çš„éšæœºæ¸¸èµ°é¢„æµ‹<span class="math inline">\(t \in \mathcal{V}=\{2000, \ldots, 2016\}\)</span>çš„<span class="math inline">\(\hat{k}_{t}\)</span>ï¼Œä¸‹å›¾è¯´æ˜äº†ç»“æœã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/6/kt.png" alt="ç‘å£«ç”·å¥³æ€§ktçš„ä¼°è®¡ä¸é¢„æµ‹å€¼" width="60%"  />
<p class="caption">
(#fig:kt)ç‘å£«ç”·å¥³æ€§ktçš„ä¼°è®¡ä¸é¢„æµ‹å€¼
</p>
</div>
<p>å›¾@ref(fig:kt)æ˜¾ç¤ºå¯¹äºå¥³æ€§æ¥è¯´é¢„æµ‹ç»“æœæ˜¯ç›¸å¯¹åˆç†çš„ï¼Œä½†æ˜¯å¯¹äºç”·æ€§è€Œè¨€ï¼Œç”±æ­¤äº§ç”Ÿçš„æ¼‚ç§»å¯èƒ½éœ€è¦è¿›ä¸€æ­¥çš„æ¢ç´¢ï¼Œä¸‹é¢<strong>ç”·å¥³æ€§æ ·æœ¬å†…å¤–çš„MSEæŸå¤±</strong>ç»“æœä¹Ÿè¡¨æ˜äº†è¿™ä¸€ç‚¹ï¼šç”·æ€§æ ·æœ¬å¤–æŸå¤±è¾ƒå¤§</p>
<p><span class="math display">\[
\begin{array}{|c|cc|cc|}
\hline &amp; \ {\text { in-sample loss }} &amp; \ {\text { in-sample loss }}  &amp; \ {\text { out-of-sample loss }} &amp; \ {\text { out-of-sample loss }}\\
&amp; \text { female } &amp; \text { male } &amp; \text { female } &amp; \text { male } \\
\hline \text { LC model with SVD } &amp; 3.7573 &amp; 8.8110 &amp; 0.6045 &amp; 1.8152 \\
\hline
\end{array}
\]</span></p>
</div>
<div id="åˆè¯•rnn" class="section level3">
<h3><span class="header-section-number">6.5.4</span> åˆè¯•RNN</h3>
<ol style="list-style-type: decimal">
<li>æ•°æ®è¯´æ˜</li>
</ol>
<ul>
<li><p>é€‰æ‹©æ€§åˆ«ä¸ºâ€œå¥³æ€§â€ï¼Œæå–<span class="math inline">\(1990, \ldots, 2001\)</span>å¹´çš„å¯¹æ•°æ­»äº¡ç‡ï¼Œå¹´é¾„ä¸º<span class="math inline">\(0 \leq x \leq 99\)</span></p></li>
<li><p>è¶…å‚æ•°è®¾ç½®ï¼šå›é¡¾å‘¨æœŸ<span class="math inline">\(T=10\)</span>ï¼›<span class="math inline">\(\tau_{0}=3\)</span></p></li>
<li><p>å®šä¹‰è§£é‡Šå˜é‡å’Œå“åº”å˜é‡ï¼š</p>
<p>å¯¹äº<span class="math inline">\(1 \leq x \leq 98\)</span>ï¼Œ<span class="math inline">\(1 \leq t \leq T\)</span>ï¼Œæœ‰</p>
<p><strong>è§£é‡Šå˜é‡</strong><span class="math inline">\(\boldsymbol{x}_{t, x}=\left(\log \left(M_{1999-(T-t), x-1}\right), \log \left(M_{1999-(T-t), x}\right), \log \left(M_{1999-(T-t), x+1}\right)\right)^{\top} \in \mathbb{R}^{\tau_{0}}\)</span></p>
<p><strong>å“åº”å˜é‡</strong><span class="math inline">\(\boldsymbol{Y}_{T, x}=\log(M_{2000,x}) =\log \left(M_{1999-(T-T)+1, x}\right) \in \mathbb{R}_{-}\)</span></p>
<p>åŒæ—¶è€ƒè™‘<span class="math inline">\((x-1,x,x+1)\)</span>ç›®çš„æ˜¯ç”¨é‚»è¿‘çš„å¹´é¾„æ¥å¹³æ»‘è¾“å…¥ã€‚</p></li>
<li><p>é€‰æ‹©è®­ç»ƒæ•°æ®å’ŒéªŒè¯æ•°æ®ï¼š</p>
<p><strong>è®­ç»ƒæ•°æ®</strong><span class="math inline">\(\mathcal{T}=\{(\boldsymbol{x}_{1,x}, \ldots,\boldsymbol{x}_{T,x};\boldsymbol{Y}_{T, x});1 \leq x \leq 98\}\)</span></p>
<p><strong>éªŒè¯æ•°æ®</strong><span class="math inline">\(\mathcal{V}=\{(\boldsymbol{x}_{2,x}, \ldots,\boldsymbol{x}_{T+1,x};\boldsymbol{Y}_{T+1, x});1 \leq x \leq 98\}\)</span>ï¼Œåœ¨è®­ç»ƒæ•°æ®åŸºç¡€ä¸Šæ—¶ç§»äº†ä¸€ä¸ªæ—¥å†å¹´</p></li>
<li><p>æ•°æ®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></li>
</ul>
<div class="figure" style="text-align: center">
<img src="./plots/6/datatoy.png" alt="RNNåˆè¯•ä¸­é€‰æ‹©çš„æ•°æ®" width="60%"  />
<p class="caption">
(#fig:unnamed-chunk-1)RNNåˆè¯•ä¸­é€‰æ‹©çš„æ•°æ®
</p>
</div>
<p>é»‘çº¿è¡¨ç¤ºé€‰å®šçš„è§£é‡Šå˜é‡<span class="math inline">\(\boldsymbol{x}_{t, x}\)</span>;è“è‰²çš„ç‚¹æ˜¯è®­ç»ƒæ•°æ®ä¸­çš„çš„å“åº”å˜é‡<span class="math inline">\(\boldsymbol{Y}_{T, x}\)</span>ï¼›éªŒè¯æ•°æ®ä¸­å“åº”å˜é‡<span class="math inline">\(\boldsymbol{Y}_{T+1, x}=\log(M_{2001,x})\)</span>ç”¨çº¢è‰²çš„ç‚¹è¡¨ç¤º</p>
<ol start="2" style="list-style-type: decimal">
<li>æ•°æ®é¢„å¤„ç†</li>
</ol>
<ul>
<li><p>å¯¹è§£é‡Šå˜é‡åº”ç”¨MinMaxScalerè¿›è¡Œæ ‡å‡†åŒ–å¤„ç†</p></li>
<li><p>åˆ‡æ¢å“åº”å˜é‡çš„ç¬¦å·</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>æ¯”è¾ƒLSTMså’ŒGRUs</li>
</ol>
<ul>
<li><p>åœ¨éªŒè¯é›†<span class="math inline">\(\mathcal{V}\)</span>ä¸Šè·Ÿè¸ªè¿‡æ‹Ÿåˆ</p></li>
<li><p>æ¢¯åº¦ä¸‹é™ä¼˜åŒ–ç®—æ³•é€‰ç”¨çš„æ˜¯<code>nadam</code></p></li>
<li><p>ä¸‹å›¾æ˜¾ç¤ºäº†5ä¸ªæ¨¡å‹çš„æ”¶æ•›è¡Œä¸º</p></li>
</ul>
<div class="figure" style="text-align: center">
<img src="./plots/6/loss1.png" alt="æ¨¡å‹çš„æ ·æœ¬å†…å¤–æŸå¤±" width="60%"  />
<p class="caption">
(#fig:loss1)æ¨¡å‹çš„æ ·æœ¬å†…å¤–æŸå¤±
</p>
</div>
<ul>
<li>æ ¹æ®è¿‡æ‹Ÿåˆç¡®å®šçš„åœæ­¢æ—¶é—´çš„æ¨¡å‹æ ¡å‡†ç»“æœå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</li>
</ul>
<p><span class="math display">\[
\begin{array}{|l|ccc|cc|}
\hline &amp; \# \text { param. } &amp; \text { epochs } &amp; \text { run time } &amp; \text { in-sample loss } &amp; \text { out-of-sample loss } \\
\hline \text { LSTM1 } &amp; 186 &amp; 150 &amp; 8 \mathrm{sec} &amp; 0.0655 &amp; 0.0936 \\
\text { LSTM2 } &amp; 345 &amp; 200 &amp; 15 \mathrm{sec} &amp; 0.0603 &amp; 0.0918 \\
\hline \text { GRU1 } &amp; 141 &amp; 100 &amp; 5 \mathrm{sec} &amp; 0.0671 &amp; 0.0860 \\
\text { GRU2 } &amp; 260 &amp; 200 &amp; 14 \mathrm{sec} &amp; 0.0651 &amp; 0.0958 \\
\hline \text { deep FNN } &amp; 184 &amp; 200 &amp; 5 \mathrm{sec} &amp; 0.0485 &amp; 0.1577 \\
\hline
\end{array}
\]</span></p>
<ul>
<li>è¡¨ä¸­æ‰€ç¤ºæ¨¡å‹çš„è¶…å‚æ•°è®¾ç½®</li>
</ul>
<ol style="list-style-type: lower-alpha">
<li><p>LSTM1å’ŒGRU1è¡¨ç¤ºåªæœ‰ä¸€ä¸ªéšè—å±‚çš„RNNï¼Œè¯¥éšè—å±‚çš„ç¥ç»å…ƒä¸ªæ•°<span class="math inline">\(\tau_{1}=5\)</span></p></li>
<li><p>LSTM2å’ŒGRU2è¡¨ç¤ºæœ‰ä¸¤ä¸ªéšè—å±‚çš„RNNï¼Œç¬¬ä¸€ä¸ªéšè—å±‚ç¥ç»å…ƒä¸ªæ•°<span class="math inline">\(\tau_{1}=5\)</span>ï¼›ç¬¬äºŒä¸ªéšè—å±‚ç¥ç»å…ƒä¸ªæ•°<span class="math inline">\(\tau_{2}=4\)</span></p></li>
<li><p>deep FNNè¡¨ç¤ºæœ‰ä¸¤ä¸ªéšè—å±‚çš„å‰é¦ˆç¥ç»ç½‘ç»œç»“æ„ï¼Œå…¶ä¸­<span class="math inline">\((q1,q2)=(5,4)\)</span></p></li>
</ol>
<ul>
<li>ç»“è®º</li>
</ul>
<ol style="list-style-type: lower-alpha">
<li><p>LSTM2ä¸LSTM1æ¨¡å‹é¢„æµ‹è´¨é‡ç›¸å½“ï¼Œä½†LSTM2æœ‰æ›´å¤šå‚æ•°åŠæ›´é•¿çš„è¿è¡Œæ—¶é—´</p></li>
<li><p>LTSMä¸GRUè¶…å‚æ•°é€‰æ‹©ç›¸åŒæ—¶ï¼Œæ™®éçš„è§‚å¯Ÿç»“æœæ˜¯GRUæ¯”LSTMæ›´å¿«çš„è¿‡æ‹Ÿåˆï¼Œä½†GRUä¸ç¨³å®š</p></li>
<li><p>å‰é¦ˆç¥ç»ç½‘ç»œä¸RNNç›¸æ¯”æ²¡æœ‰ç«äº‰åŠ›</p></li>
</ol>
<ul>
<li>åœ¨æœ¬æ–‡å»ºæ¨¡ä¸­<strong>æœªå¼•å…¥å¹´é¾„å˜é‡çš„åŸå› </strong>ï¼š</li>
</ul>
<p>åå˜é‡æ ‡å‡†åŒ–åˆ°ï¼ˆ-1,1ï¼‰çš„è¿‡ç¨‹æ˜¯åœ¨æ‰€æœ‰å¹´é¾„ä¸ŠåŒæ—¶è¿›è¡Œçš„ï¼Œå› æ­¤åå˜é‡ä¿¡æ¯ä¿ç•™äº†æ­»äº¡ç‡æ°´å¹³ï¼Œè¿™å’Œå¼•å…¥å¹´é¾„å˜é‡å…·æœ‰ç›¸åŒçš„ä¿¡æ¯è´¨é‡ã€‚</p>
<ol start="4" style="list-style-type: decimal">
<li>è¶…å‚æ•°é€‰æ‹©</li>
</ol>
<ul>
<li>åˆ†åˆ«æ”¹å˜<span class="math inline">\(Tã€\tau_{0}ã€\tau_{1}\)</span>çš„å€¼ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</li>
</ul>
<p><span class="math display">\[
\begin{array}{|l|ccc|cc|}
\hline &amp; \text { # param. } &amp; \text { epochs } &amp; \text { run time } &amp; \text { in-sample } &amp; \text { out-of-sample } \\
\hline \text { base case: } &amp; &amp; &amp; &amp; &amp; \\
\text { LSTM1 }\left(T=10, \tau_{0}=3, \tau_{1}=5\right) &amp; 186 &amp; 150 &amp; 8 \mathrm{sec} &amp; 0.0655 &amp; 0.0936 \\
\hline \text { LSTM1 }\left(T=10, \tau_{0}=1, \tau_{1}=5\right) &amp; 146 &amp; 100 &amp; 5 \mathrm{sec} &amp; 0.0647 &amp; 0.1195 \\
\text { LSTM1 }\left(T=10, \tau_{0}=5, \tau_{1}=5\right) &amp; 226 &amp; 150 &amp; 15 \mathrm{sec} &amp; 0.0583 &amp; 0.0798 \\
\hline \text { LSTM1 }\left(T=5, \tau_{0}=3, \tau_{1}=5\right) &amp; 186 &amp; 100 &amp; 4 \mathrm{sec} &amp; 0.0753 &amp; 0.1028 \\
\text { LSTM1 }\left(T=20, \tau_{0}=3, \tau_{1}=5\right) &amp; 186 &amp; 200 &amp; 16 \mathrm{sec} &amp; 0.0626 &amp; 0.0968 \\
\hline \text { LSTM1 }\left(T=10, \tau_{0}=3, \tau_{1}=3\right) &amp; 88 &amp; 200 &amp; 10 \mathrm{sec} &amp; 0.0694 &amp; 0.0987 \\
\text { LSTM1 }\left(T=10, \tau_{0}=3, \tau_{1}=10\right) &amp; 571 &amp; 100 &amp; 5 \mathrm{sec} &amp; 0.0626 &amp; 0.0883 \\
\hline
\end{array}
\]</span></p>
<ul>
<li>ç»“è®º</li>
</ul>
<ol style="list-style-type: lower-alpha">
<li><p>åˆ†åˆ«ä»¤<span class="math inline">\(\tau_{0}=1,3,5\)</span>,éœ€è¦æ›´é•¿çš„è¿è¡Œæ—¶é—´å¹¶æä¾›æ›´å¥½çš„æ ·æœ¬å¤–ç»“æœï¼›</p></li>
<li><p>åˆ†åˆ«ä»¤<span class="math inline">\(T=5,10,20\)</span>ï¼Œç»“è®ºåŒä¸Šï¼›</p></li>
<li><p>åˆ†åˆ«ä»¤<span class="math inline">\(\tau_{1}=3,5,10\)</span>ï¼Œå¯¼è‡´æ›´å¿«çš„æ”¶æ•›ï¼Œå› ä¸ºæ¢¯åº¦ä¸‹é™ç®—æ³•æœ‰æ›´å¤šçš„è‡ªç”±åº¦</p></li>
<li><p>æœ€å¤§çš„å½±å“æ˜¯é€šè¿‡è®¾å®šä¸€ä¸ªæ›´å¤§çš„<span class="math inline">\(\tau_{0}\)</span>è€Œäº§ç”Ÿçš„ï¼Œå› æ­¤åé¢RNNç¤ºä¾‹ä¸­è®¾å®š<span class="math inline">\(\tau_{0}=5\)</span></p></li>
</ol>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="co"># load corresponding data</span></span>
<span id="cb85-2"><a href="#cb85-2"></a>path.data &lt;-<span class="st"> &quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CHE_mort.csv&quot;</span>           <span class="co"># path and name of data file</span></span>
<span id="cb85-3"><a href="#cb85-3"></a>region &lt;-<span class="st"> &quot;CHE&quot;</span>                    <span class="co"># country to be loaded (code is for one selected country)</span></span>
<span id="cb85-4"><a href="#cb85-4"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_a package - load data.R&quot;</span>)</span>
<span id="cb85-5"><a href="#cb85-5"></a><span class="kw">str</span>(all_mort)</span>
<span id="cb85-6"><a href="#cb85-6"></a><span class="co"># LSTMs and GRUs</span></span>
<span id="cb85-7"><a href="#cb85-7"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_b package - network definitions.R&quot;</span>)</span>
<span id="cb85-8"><a href="#cb85-8"></a>T0 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb85-9"><a href="#cb85-9"></a>tau0 &lt;-<span class="st"> </span><span class="dv">3</span></span>
<span id="cb85-10"><a href="#cb85-10"></a>tau1 &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb85-11"><a href="#cb85-11"></a>tau2 &lt;-<span class="st"> </span><span class="dv">4</span></span>
<span id="cb85-12"><a href="#cb85-12"></a><span class="kw">summary</span>(<span class="kw">LSTM1</span>(T0, tau0, tau1, <span class="dv">0</span>, <span class="st">&quot;nadam&quot;</span>))</span>
<span id="cb85-13"><a href="#cb85-13"></a><span class="kw">summary</span>(<span class="kw">LSTM2</span>(T0, tau0, tau1, tau2, <span class="dv">0</span>, <span class="st">&quot;nadam&quot;</span>))</span>
<span id="cb85-14"><a href="#cb85-14"></a><span class="kw">summary</span>(<span class="kw">LSTM_TD</span>(T0, tau0, tau1, <span class="dv">0</span>, <span class="st">&quot;nadam&quot;</span>))</span>
<span id="cb85-15"><a href="#cb85-15"></a><span class="kw">summary</span>(<span class="kw">GRU1</span>(T0, tau0, tau1, <span class="dv">0</span>, <span class="st">&quot;nadam&quot;</span>))</span>
<span id="cb85-16"><a href="#cb85-16"></a><span class="kw">summary</span>(<span class="kw">GRU2</span>(T0, tau0, tau1, tau2, <span class="dv">0</span>, <span class="st">&quot;nadam&quot;</span>))</span>
<span id="cb85-17"><a href="#cb85-17"></a><span class="kw">summary</span>(<span class="kw">FNN</span>(T0, tau0, tau1, tau2, <span class="dv">0</span>, <span class="st">&quot;nadam&quot;</span>))</span>
<span id="cb85-18"><a href="#cb85-18"></a><span class="co"># Bringing the data in the right structure for a toy example</span></span>
<span id="cb85-19"><a href="#cb85-19"></a>gender &lt;-<span class="st"> &quot;Female&quot;</span></span>
<span id="cb85-20"><a href="#cb85-20"></a>ObsYear &lt;-<span class="st"> </span><span class="dv">2000</span></span>
<span id="cb85-21"><a href="#cb85-21"></a>mort_rates &lt;-<span class="st"> </span>all_mort[<span class="kw">which</span>(all_mort<span class="op">$</span>Gender<span class="op">==</span>gender), <span class="kw">c</span>(<span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Age&quot;</span>, <span class="st">&quot;logmx&quot;</span>)] </span>
<span id="cb85-22"><a href="#cb85-22"></a>mort_rates &lt;-<span class="st"> </span><span class="kw">dcast</span>(mort_rates, Year <span class="op">~</span><span class="st"> </span>Age, <span class="dt">value.var=</span><span class="st">&quot;logmx&quot;</span>)</span>
<span id="cb85-23"><a href="#cb85-23"></a><span class="kw">dim</span>(mort_rates)</span>
<span id="cb85-24"><a href="#cb85-24"></a>T0 &lt;-<span class="st"> </span><span class="dv">10</span>     <span class="co"># lookback period</span></span>
<span id="cb85-25"><a href="#cb85-25"></a>tau0 &lt;-<span class="st"> </span><span class="dv">3</span>    <span class="co"># dimension of x_t (should be odd for our application)</span></span>
<span id="cb85-26"><a href="#cb85-26"></a>delta0 &lt;-<span class="st"> </span>(tau0<span class="dv">-1</span>)<span class="op">/</span><span class="dv">2</span></span>
<span id="cb85-27"><a href="#cb85-27"></a>toy_rates &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(mort_rates[<span class="kw">which</span>(mort_rates<span class="op">$</span>Year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>((ObsYear<span class="op">-</span>T0)<span class="op">:</span>(ObsYear<span class="op">+</span><span class="dv">1</span>))),])</span>
<span id="cb85-28"><a href="#cb85-28"></a><span class="kw">dim</span>(toy_rates)</span>
<span id="cb85-29"><a href="#cb85-29"></a>xt &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="kw">c</span>(<span class="dv">2</span>,<span class="kw">ncol</span>(toy_rates)<span class="op">-</span>tau0, T0, tau0))</span>
<span id="cb85-30"><a href="#cb85-30"></a>YT &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="kw">c</span>(<span class="dv">2</span>,<span class="kw">ncol</span>(toy_rates)<span class="op">-</span>tau0))</span>
<span id="cb85-31"><a href="#cb85-31"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>){<span class="cf">for</span> (a0 <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(<span class="kw">ncol</span>(toy_rates)<span class="op">-</span>tau0)){ </span>
<span id="cb85-32"><a href="#cb85-32"></a>    xt[i,a0,,] &lt;-<span class="st"> </span>toy_rates[<span class="kw">c</span>(i<span class="op">:</span>(T0<span class="op">+</span>i<span class="dv">-1</span>)),<span class="kw">c</span>((a0<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(a0<span class="op">+</span>tau0))]</span>
<span id="cb85-33"><a href="#cb85-33"></a>    YT[i,a0] &lt;-<span class="st"> </span>toy_rates[T0<span class="op">+</span>i,a0<span class="op">+</span><span class="dv">1</span><span class="op">+</span>delta0]</span>
<span id="cb85-34"><a href="#cb85-34"></a>}}</span>
<span id="cb85-35"><a href="#cb85-35"></a><span class="kw">dim</span>(xt)</span>
<span id="cb85-36"><a href="#cb85-36"></a><span class="kw">dim</span>(YT)</span>
<span id="cb85-37"><a href="#cb85-37"></a><span class="kw">plot</span>(<span class="dt">x=</span>toy_rates[<span class="dv">1</span><span class="op">:</span>T0,<span class="dv">1</span>], <span class="dt">y=</span>toy_rates[<span class="dv">1</span><span class="op">:</span>T0,<span class="dv">2</span>], <span class="dt">col=</span><span class="st">&quot;white&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;calendar years&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;raw log-mortality rates&quot;</span>, <span class="dt">cex.lab=</span><span class="fl">1.5</span>, <span class="dt">cex=</span><span class="fl">1.5</span>, <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;data toy example&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>), <span class="dt">xlim=</span><span class="kw">range</span>(toy_rates[,<span class="dv">1</span>]), <span class="dt">ylim=</span><span class="kw">range</span>(toy_rates[,<span class="op">-</span><span class="dv">1</span>]), <span class="dt">type=</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb85-38"><a href="#cb85-38"></a><span class="cf">for</span> (a0 <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(toy_rates)){</span>
<span id="cb85-39"><a href="#cb85-39"></a>  <span class="cf">if</span> (a0 <span class="op">%in%</span><span class="st"> </span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>)<span class="op">*</span><span class="dv">3</span>)){</span>
<span id="cb85-40"><a href="#cb85-40"></a>    <span class="kw">lines</span>(<span class="dt">x=</span>toy_rates[<span class="dv">1</span><span class="op">:</span>T0,<span class="dv">1</span>], <span class="dt">y=</span>toy_rates[<span class="dv">1</span><span class="op">:</span>T0,a0])    </span>
<span id="cb85-41"><a href="#cb85-41"></a>    <span class="kw">points</span>(<span class="dt">x=</span>toy_rates[(T0<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(T0<span class="op">+</span><span class="dv">2</span>),<span class="dv">1</span>], <span class="dt">y=</span>toy_rates[(T0<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(T0<span class="op">+</span><span class="dv">2</span>),a0], <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">pch=</span><span class="dv">20</span>)</span>
<span id="cb85-42"><a href="#cb85-42"></a>    <span class="kw">lines</span>(<span class="dt">x=</span>toy_rates[(T0)<span class="op">:</span>(T0<span class="op">+</span><span class="dv">1</span>),<span class="dv">1</span>], <span class="dt">y=</span>toy_rates[(T0)<span class="op">:</span>(T0<span class="op">+</span><span class="dv">1</span>),a0], <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb85-43"><a href="#cb85-43"></a>    <span class="kw">lines</span>(<span class="dt">x=</span>toy_rates[(T0<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(T0<span class="op">+</span><span class="dv">2</span>),<span class="dv">1</span>], <span class="dt">y=</span>toy_rates[(T0<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(T0<span class="op">+</span><span class="dv">2</span>),a0], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb85-44"><a href="#cb85-44"></a>    }}</span>
<span id="cb85-45"><a href="#cb85-45"></a><span class="co"># LSTMs and GRUs</span></span>
<span id="cb85-46"><a href="#cb85-46"></a>x.train &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">2</span><span class="op">*</span>(xt[<span class="dv">1</span>,,,]<span class="op">-</span><span class="kw">min</span>(xt))<span class="op">/</span>(<span class="kw">max</span>(xt)<span class="op">-</span><span class="kw">min</span>(xt))<span class="op">-</span><span class="dv">1</span>, <span class="kw">c</span>(<span class="kw">ncol</span>(toy_rates)<span class="op">-</span>tau0, T0, tau0))</span>
<span id="cb85-47"><a href="#cb85-47"></a>x.vali  &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">2</span><span class="op">*</span>(xt[<span class="dv">2</span>,,,]<span class="op">-</span><span class="kw">min</span>(xt))<span class="op">/</span>(<span class="kw">max</span>(xt)<span class="op">-</span><span class="kw">min</span>(xt))<span class="op">-</span><span class="dv">1</span>, <span class="kw">c</span>(<span class="kw">ncol</span>(toy_rates)<span class="op">-</span>tau0, T0, tau0))</span>
<span id="cb85-48"><a href="#cb85-48"></a>y.train &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span>YT[<span class="dv">1</span>,]</span>
<span id="cb85-49"><a href="#cb85-49"></a>(y0 &lt;-<span class="st"> </span><span class="kw">mean</span>(y.train))</span>
<span id="cb85-50"><a href="#cb85-50"></a>y.vali  &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span>YT[<span class="dv">2</span>,]</span>
<span id="cb85-51"><a href="#cb85-51"></a><span class="kw">dim</span>(x.train)</span>
<span id="cb85-52"><a href="#cb85-52"></a><span class="kw">length</span>(y.train);<span class="kw">length</span>(y.vali)</span>
<span id="cb85-53"><a href="#cb85-53"></a><span class="co"># x.age.train&lt;-as.matrix(0:0)</span></span>
<span id="cb85-54"><a href="#cb85-54"></a><span class="co"># x.training&lt;-list(x.train,x.age.train)</span></span>
<span id="cb85-55"><a href="#cb85-55"></a><span class="co"># x.age.valid&lt;-as.matrix(0:0)</span></span>
<span id="cb85-56"><a href="#cb85-56"></a><span class="co"># x.validation&lt;-list(x.vali,x.age.valid)</span></span>
<span id="cb85-57"><a href="#cb85-57"></a><span class="co">### examples</span></span>
<span id="cb85-58"><a href="#cb85-58"></a>tau1 &lt;-<span class="st"> </span><span class="dv">5</span>    <span class="co"># dimension of the outputs z_t^(1) first RNN layer</span></span>
<span id="cb85-59"><a href="#cb85-59"></a>tau2 &lt;-<span class="st"> </span><span class="dv">4</span>    <span class="co"># dimension of the outputs z_t^(2) second RNN layer</span></span>
<span id="cb85-60"><a href="#cb85-60"></a>CBs &lt;-<span class="st"> </span><span class="kw">callback_model_checkpoint</span>(<span class="st">&quot;./6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CallBack/best_model&quot;</span>, <span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">verbose =</span> <span class="dv">0</span>,  <span class="dt">save_best_only =</span> <span class="ot">TRUE</span>, <span class="dt">save_weights_only =</span> <span class="ot">TRUE</span>,<span class="dt">save_freq =</span> <span class="ot">NULL</span>)</span>
<span id="cb85-61"><a href="#cb85-61"></a>model &lt;-<span class="st"> </span><span class="kw">LSTM2</span>(T0, tau0, tau1, tau2, y0, <span class="st">&quot;nadam&quot;</span>)     </span>
<span id="cb85-62"><a href="#cb85-62"></a><span class="kw">summary</span>(model)</span>
<span id="cb85-63"><a href="#cb85-63"></a><span class="co"># takes 40 seconds on my laptop</span></span>
<span id="cb85-64"><a href="#cb85-64"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb85-65"><a href="#cb85-65"></a>  fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="dt">x=</span>x.train, <span class="dt">y=</span>y.train, <span class="dt">validation_data=</span><span class="kw">list</span>(x.vali, y.vali), <span class="dt">batch_size=</span><span class="dv">10</span>, <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">verbose=</span><span class="dv">1</span>, <span class="dt">callbacks=</span>CBs)</span>
<span id="cb85-66"><a href="#cb85-66"></a> <span class="kw">proc.time</span>()<span class="op">-</span>t1}</span>
<span id="cb85-67"><a href="#cb85-67"></a><span class="kw">plot</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>val_loss,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span>), <span class="dt">main=</span><span class="kw">list</span>(<span class="st">&quot;early stopping rule&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>),<span class="dt">xlab=</span><span class="st">&quot;epochs&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;MSE loss&quot;</span>, <span class="dt">cex=</span><span class="fl">1.5</span>, <span class="dt">cex.lab=</span><span class="fl">1.5</span>)</span>
<span id="cb85-68"><a href="#cb85-68"></a><span class="kw">lines</span>(fit[[<span class="dv">2</span>]]<span class="op">$</span>loss,<span class="dt">col=</span><span class="st">&quot;blue&quot;</span>)</span>
<span id="cb85-69"><a href="#cb85-69"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="fl">0.1</span>, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb85-70"><a href="#cb85-70"></a><span class="kw">legend</span>(<span class="dt">x=</span><span class="st">&quot;bottomleft&quot;</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;red&quot;</span>), <span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">lwd=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="dt">pch=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;in-sample loss&quot;</span>, <span class="st">&quot;out-of-sample loss&quot;</span>))</span>
<span id="cb85-71"><a href="#cb85-71"></a><span class="kw">load_model_weights_hdf5</span>(model, <span class="st">&quot;./6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CallBack/best_model&quot;</span>)</span>
<span id="cb85-72"><a href="#cb85-72"></a>Yhat.train1 &lt;-<span class="st"> </span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(x.train))</span>
<span id="cb85-73"><a href="#cb85-73"></a>Yhat.vali1 &lt;-<span class="st"> </span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(x.vali))</span>
<span id="cb85-74"><a href="#cb85-74"></a><span class="kw">c</span>(<span class="kw">round</span>(<span class="kw">mean</span>((Yhat.train1<span class="op">-</span>y.train)<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>), <span class="kw">round</span>(<span class="kw">mean</span>((Yhat.vali1<span class="op">-</span>y.vali)<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>))</span></code></pre></div>
</div>
<div id="rnn-1" class="section level3">
<h3><span class="header-section-number">6.5.5</span> RNN</h3>
<ol style="list-style-type: decimal">
<li>æ•°æ®é¢„å¤„ç†</li>
</ol>
<ul>
<li><p>è§‚å¯Ÿå€¼ï¼š1950-1999å¹´æ•°æ®ï¼›é¢„æµ‹å€¼ï¼š2000-2016å¹´å¯¹æ•°æ­»äº¡ç‡</p></li>
<li><p>åˆ†åˆ«å¯¹ç”·æ€§å’Œå¥³æ€§å»ºç«‹æ¨¡å‹ï¼Œå…ˆé€‰å®šä¸€ä¸ªæ€§åˆ«</p></li>
<li><p>å‚æ•°è®¾ç½®ï¼šå›é¡¾å‘¨æœŸ<span class="math inline">\(T=10\)</span>ï¼›<span class="math inline">\(\tau_{0}=5\)</span></p></li>
<li><p>å®šä¹‰è§£é‡Šå˜é‡ï¼ˆéœ€æ‰©å……å¹´é¾„ç•Œé™â€”â€”å¤åˆ¶è¾¹ç¼˜ç‰¹å¾å€¼ï¼‰ï¼š</p>
<p>å¯¹äº<span class="math inline">\(0 \leq x \leq 99\)</span>ï¼Œ<span class="math inline">\(1950 \leq t \leq 1999\)</span>ï¼Œæœ‰</p>
<p><strong>è§£é‡Šå˜é‡</strong><span class="math inline">\(\boldsymbol{x}_{t, x}=\left(\log \left(M_{t,(x-2) \vee 0}\right), \log \left(M_{t,(x-1) \vee 0}\right), \log \left(M_{t, x}\right), \log \left(M_{t,(x+1) \wedge 99}\right), \log \left(M_{t,(x+2) \wedge 99}\right)\right)^{\top} \in \mathbb{R}^{5}\)</span></p>
<p>è¯¥å¼ä¸­ï¼š<span class="math inline">\(x_{0}\vee x_{1}=\text {max}\{x_{0},x_{1}\}\)</span>;<span class="math inline">\(x_{0}\wedge x_{1}=\text {min}\{x_{0},x_{1}\}\)</span></p></li>
<li><p>å®šä¹‰è®­ç»ƒæ•°æ®<span class="math inline">\(\mathcal{T}\)</span>å’ŒéªŒè¯æ•°æ®<span class="math inline">\(\mathcal{V}\)</span>ï¼š</p>
<p><strong>è®­ç»ƒæ•°æ®</strong><span class="math inline">\(\mathcal{T}=\{(\boldsymbol{x}_{t-T,x}, \ldots,\boldsymbol{x}_{t-1,x},\boldsymbol{Y}_{t, x});0 \leq x \leq 99\ , 1950+T \leq t \leq 1999\}\)</span></p>
<p>å…¶ä¸­ï¼Œ<span class="math inline">\(\boldsymbol{Y}_{t, x}=\text {log}(M_{t,x})\)</span></p>
<p><strong>éªŒè¯æ•°æ®</strong>:</p>
<p><span class="math inline">\(s&gt;1999\)</span>çš„ç‰¹å¾å€¼è¦ç”¨ç›¸åº”çš„é¢„æµ‹å€¼æ›¿ä»£</p></li>
</ul>
<p><span class="math display">\[
\widehat{\boldsymbol{x}}_{s, x}=\left(\log \left(\widehat{M}_{s,(x-2) \vee 0}\right), \log \left(\widehat{M}_{s,(x-1) \vee 0}\right), \log \left(\widehat{M}_{s, x}\right), \log \left(\widehat{M}_{s,(x+1) \wedge 99}\right), \log \left(\widehat{M}_{s,(x+2) \wedge 99}\right)\right)^{\top} \in \mathbb{R}^{5}
\]</span></p>
<p>å› æ­¤éªŒè¯æ•°æ®<span class="math inline">\(\mathcal{V}=\{(\boldsymbol{x}_{t-T,x}, \ldots,\boldsymbol{x}_{1999,x},\widehat{\boldsymbol{x}}_{2000,x}, \ldots,\widehat{\boldsymbol{x}}_{t-1,x},\boldsymbol{Y}_{t, x});0 \leq x \leq 99\ , 2000 \leq t \leq 2016\}\)</span></p>
<ul>
<li><p>åŸºäº<strong>è®­ç»ƒæ•°æ®</strong>æ‰€æœ‰ç‰¹å¾å€¼çš„æœ€å¤§æœ€å°å€¼å¯¹è®­ç»ƒæ•°æ®å’ŒéªŒè¯æ•°æ®åº”ç”¨<code>MinMaxScaler</code></p></li>
<li><p>åˆ‡æ¢å“åº”å˜é‡ç¬¦å·</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>å»ºç«‹å•ä¸ªæ€§åˆ«çš„RNN</li>
</ol>
<ul>
<li><p>å°†è®­ç»ƒæ•°æ®<span class="math inline">\(\mathcal T\)</span>éšæœºåˆ’åˆ†å­¦ä¹ é›†<span class="math inline">\(\mathcal T_{0}\)</span>(åŒ…å«80%æ•°æ®)ä»¥åŠæµ‹è¯•é›†<span class="math inline">\(\mathcal T_{1}\)</span>(åŒ…å«20%æ•°æ®)<span class="math inline">\(\mathcal T_{0}\)</span>ç”¨äºè¿½è¸ªæ ·æœ¬å†…è¿‡æ‹Ÿåˆï¼›</p></li>
<li><p>å»ºç«‹å…·æœ‰ä¸‰ä¸ªéšè—å±‚çš„LSTM3å’ŒGRU3ï¼›</p></li>
<li><p>è¶…å‚æ•°è®¾ç½®ï¼š<span class="math inline">\(T=10\)</span>ï¼›<span class="math inline">\(\tau_{0}=5\)</span>ï¼›<span class="math inline">\(\tau_{1}=20\)</span>ï¼›<span class="math inline">\(\tau_{2}=15\)</span>ï¼›<span class="math inline">\(\tau_{3}=10\)</span>ï¼›</p></li>
<li><p>ä¸‹å›¾æ˜¾ç¤ºäº†åˆ†åˆ«å¯¹ç”·æ€§å’Œå¥³æ€§å»ºç«‹ä¸¤ä¸ªæ¨¡å‹çš„æ”¶æ•›è¡Œä¸º</p></li>
</ul>
<div class="figure" style="text-align: center">
<img src="./plots/6/loss2.png" alt="æ¨¡å‹çš„æ ·æœ¬å†…å¤–æŸå¤±" width="60%"  />
<p class="caption">
(#fig:loss2)æ¨¡å‹çš„æ ·æœ¬å†…å¤–æŸå¤±
</p>
</div>
<p>è¯¥å›¾æ˜¾ç¤ºï¼šGRUç»“æ„ä¼šå¯¼è‡´æ›´å¿«çš„æ”¶æ•›ï¼Œä½†åç»­ä¼šè¯å®GRUç»“æ„ä¸ç¨³å®šï¼Œå› æ­¤LSTMä¼šæ›´å—æ¬¢è¿</p>
<ul>
<li>ä¸‹è¡¨ç»™å‡ºä¸‰ä¸ªæ¨¡å‹(LSTM3/GRU3/LC)åˆ†æ€§åˆ«çš„æ ·æœ¬å†…å¤–æŸå¤±</li>
</ul>
<p><span class="math display">\[
\begin{array}{|l|cc|cc|cc|}
\hline &amp;  {\text { in-sample }} &amp; {\text { in-sample }}  &amp; {\text { out-of-sample }} &amp; {\text { out-of-sample }}&amp;  {\text { run times }}&amp;  {\text { run times }} \\
&amp; \text { female } &amp; \text { male } &amp; \text { female } &amp; \text { male } &amp; \text { female } &amp; \text { male } \\
\hline \hline \text { LSTM3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 2.5222 &amp; 6.9458 &amp; 0.3566 &amp; 1.3507 &amp; 225 \mathrm{s} &amp; 203 \mathrm{s} \\
\text { GRU3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 2.8370 &amp; 7.0907 &amp; 0.4788 &amp; 1.2435 &amp; 185 \mathrm{s} &amp; 198 \mathrm{s} \\
\hline \hline \text { LC model with SVD } &amp; 3.7573 &amp; 8.8110 &amp; 0.6045 &amp; 1.8152 &amp; - &amp; - \\
\hline
\end{array}
\]</span></p>
<p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œæ‰€æœ‰è¢«é€‰æ‹©RNNæ¨¡å‹éƒ½ä¼˜äºLCæ¨¡å‹çš„é¢„æµ‹</p>
<ol start="3" style="list-style-type: decimal">
<li>æ¢ç´¢RNNçš„é¢„æµ‹ä¸­éšå«çš„æ¼‚ç§»é¡¹</li>
</ol>
<ol style="list-style-type: lower-alpha">
<li>ä¸­å¿ƒåŒ–RNNé¢„æµ‹çš„å¯¹æ•°æ­»äº¡ç‡</li>
</ol>
<p><span class="math display">\[
\log \left(\widehat{M}_{t, x}^{\circ}\right)=\log(\widehat M_{t,x})-\widehat a_{x}
\]</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>åˆ©ç”¨ä¸‹å¼æ±‚å¾—<span class="math inline">\(2000 \leq t \leq 2016\)</span>å¯¹åº”çš„<span class="math inline">\(k_{t}\)</span></li>
</ol>
<p><span class="math display">\[
\underset{k_{t}}{\arg \min } \sum_{x}\left(\log \left(\widehat{M}_{t, x}^{\circ}\right)-\widehat{b}_{x} k_{t}\right)^{2}
\]</span></p>
<p>å¼ä¸­ï¼Œ<span class="math inline">\((\widehat{b}_{x})_{x}\)</span>æ˜¯ä»LCæ¨¡å‹ä¼°è®¡å¾—åˆ°çš„ã€‚</p>
<ol start="3" style="list-style-type: lower-alpha">
<li>ä¼°è®¡ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º</li>
</ol>
<div class="figure" style="text-align: center">
<img src="./plots/6/kt2.png" alt="ä¸‰ç§æ¨¡å‹ä¸‹ktçš„ä¼°è®¡ä¸é¢„æµ‹å€¼" width="60%"  />
<p class="caption">
(#fig:kt2)ä¸‰ç§æ¨¡å‹ä¸‹ktçš„ä¼°è®¡ä¸é¢„æµ‹å€¼
</p>
</div>
<p>è¯¥å›¾æ˜¾ç¤ºï¼šå¯¹äºå¥³æ€§ï¼ŒLSTM3çš„é¢„æµ‹ä¸LCçš„é¢„æµ‹åŸºæœ¬ä¸€è‡´ï¼›è€Œå¯¹äºç”·æ€§ï¼ŒLSTM3çš„é¢„æµ‹çš„æ–œç‡ç•¥å¤§äºLCçš„é¢„æµ‹å¹¶æ”¶æ•›ä¸LCçš„é¢„æµ‹ï¼›ä½†æ˜¯GRU3çš„ç»“æœå¹¶ä¸ä»¤äººä¿¡æœï¼Œå¯èƒ½æ˜¯å› ä¸ºä»LCæ¨¡å‹ä¸­å¾—åˆ°çš„ä¸éšæ—¶é—´å˜åŒ–çš„å‚æ•°bxçš„ä¼°è®¡ä¸GRU3æ¨¡å‹äº§ç”Ÿçš„é¢„æµ‹ä¸ç¬¦ã€‚</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a><span class="co"># load corresponding data</span></span>
<span id="cb86-2"><a href="#cb86-2"></a>path.data &lt;-<span class="st"> &quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CHE_mort.csv&quot;</span>           <span class="co"># path and name of data file</span></span>
<span id="cb86-3"><a href="#cb86-3"></a>region &lt;-<span class="st"> &quot;CHE&quot;</span>                    <span class="co"># country to be loaded (code is for one selected country)</span></span>
<span id="cb86-4"><a href="#cb86-4"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_a package - load data.R&quot;</span>)</span>
<span id="cb86-5"><a href="#cb86-5"></a><span class="kw">str</span>(all_mort)</span>
<span id="cb86-6"><a href="#cb86-6"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_b package - network definitions.R&quot;</span>)</span>
<span id="cb86-7"><a href="#cb86-7"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_c package - data preparation RNNs.R&quot;</span>)</span>
<span id="cb86-8"><a href="#cb86-8"></a><span class="co"># choice of parameters</span></span>
<span id="cb86-9"><a href="#cb86-9"></a>T0 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb86-10"><a href="#cb86-10"></a>tau0 &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb86-11"><a href="#cb86-11"></a>gender &lt;-<span class="st"> &quot;Female&quot;</span></span>
<span id="cb86-12"><a href="#cb86-12"></a>ObsYear &lt;-<span class="st"> </span><span class="dv">1999</span></span>
<span id="cb86-13"><a href="#cb86-13"></a><span class="co"># training data pre-processing </span></span>
<span id="cb86-14"><a href="#cb86-14"></a>data1 &lt;-<span class="st"> </span><span class="kw">data.preprocessing.RNNs</span>(all_mort, gender, T0, tau0, ObsYear)</span>
<span id="cb86-15"><a href="#cb86-15"></a><span class="kw">dim</span>(data1[[<span class="dv">1</span>]])</span>
<span id="cb86-16"><a href="#cb86-16"></a><span class="kw">dim</span>(data1[[<span class="dv">2</span>]])</span>
<span id="cb86-17"><a href="#cb86-17"></a><span class="co"># validation data pre-processing</span></span>
<span id="cb86-18"><a href="#cb86-18"></a>all_mort2 &lt;-<span class="st"> </span>all_mort[<span class="kw">which</span>((all_mort<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>(ObsYear<span class="dv">-10</span>))<span class="op">&amp;</span>(Gender<span class="op">==</span>gender)),]</span>
<span id="cb86-19"><a href="#cb86-19"></a>all_mortV &lt;-<span class="st"> </span>all_mort2</span>
<span id="cb86-20"><a href="#cb86-20"></a>vali.Y &lt;-<span class="st"> </span>all_mortV[<span class="kw">which</span>(all_mortV<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>ObsYear),]</span>
<span id="cb86-21"><a href="#cb86-21"></a> </span>
<span id="cb86-22"><a href="#cb86-22"></a><span class="co"># MinMaxScaler data pre-processing</span></span>
<span id="cb86-23"><a href="#cb86-23"></a>x.min &lt;-<span class="st"> </span><span class="kw">min</span>(data1[[<span class="dv">1</span>]])</span>
<span id="cb86-24"><a href="#cb86-24"></a>x.max &lt;-<span class="st"> </span><span class="kw">max</span>(data1[[<span class="dv">1</span>]])</span>
<span id="cb86-25"><a href="#cb86-25"></a>x.train &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">2</span><span class="op">*</span>(data1[[<span class="dv">1</span>]]<span class="op">-</span>x.min)<span class="op">/</span>(x.min<span class="op">-</span>x.max)<span class="op">-</span><span class="dv">1</span>, <span class="kw">dim</span>(data1[[<span class="dv">1</span>]]))</span>
<span id="cb86-26"><a href="#cb86-26"></a>y.train &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span>data1[[<span class="dv">2</span>]]</span>
<span id="cb86-27"><a href="#cb86-27"></a>y0 &lt;-<span class="st"> </span><span class="kw">mean</span>(y.train)</span>
<span id="cb86-28"><a href="#cb86-28"></a><span class="co"># LSTM architectures</span></span>
<span id="cb86-29"><a href="#cb86-29"></a><span class="co"># network architecture deep 3 network</span></span>
<span id="cb86-30"><a href="#cb86-30"></a>tau1 &lt;-<span class="st"> </span><span class="dv">20</span></span>
<span id="cb86-31"><a href="#cb86-31"></a>tau2 &lt;-<span class="st"> </span><span class="dv">15</span></span>
<span id="cb86-32"><a href="#cb86-32"></a>tau3 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb86-33"><a href="#cb86-33"></a>optimizer &lt;-<span class="st"> &#39;adam&#39;</span></span>
<span id="cb86-34"><a href="#cb86-34"></a><span class="co"># choose either LSTM or GRU network</span></span>
<span id="cb86-35"><a href="#cb86-35"></a>RNN.type &lt;-<span class="st"> &quot;LSTM&quot;</span></span>
<span id="cb86-36"><a href="#cb86-36"></a><span class="co">#RNN.type &lt;- &quot;GRU&quot;</span></span>
<span id="cb86-37"><a href="#cb86-37"></a>{<span class="cf">if</span> (RNN.type<span class="op">==</span><span class="st">&quot;LSTM&quot;</span>){model &lt;-<span class="st"> </span><span class="kw">LSTM3</span>(T0, tau0, tau1, tau2, tau3, y0, optimizer)}<span class="cf">else</span>{model &lt;-<span class="st"> </span><span class="kw">GRU3</span>(T0, tau0, tau1, tau2, tau3, y0, optimizer)}</span>
<span id="cb86-38"><a href="#cb86-38"></a> name.model &lt;-<span class="st"> </span><span class="kw">paste</span>(RNN.type,<span class="st">&quot;3_&quot;</span>, tau0, <span class="st">&quot;_&quot;</span>, tau1, <span class="st">&quot;_&quot;</span>, tau2, <span class="st">&quot;_&quot;</span>, tau3, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb86-39"><a href="#cb86-39"></a> file.name &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;./6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CallBack/best_model_&quot;</span>, name.model,<span class="st">&quot;_&quot;</span>, gender, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb86-40"><a href="#cb86-40"></a> <span class="kw">summary</span>(model)}</span>
<span id="cb86-41"><a href="#cb86-41"></a><span class="co"># define callback</span></span>
<span id="cb86-42"><a href="#cb86-42"></a>CBs &lt;-<span class="st"> </span><span class="kw">callback_model_checkpoint</span>(file.name, <span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">verbose =</span> <span class="dv">0</span>,  <span class="dt">save_best_only =</span> <span class="ot">TRUE</span>, <span class="dt">save_weights_only =</span> <span class="ot">TRUE</span>, <span class="dt">save_freq =</span> <span class="ot">NULL</span>)</span>
<span id="cb86-43"><a href="#cb86-43"></a><span class="co"># gradient descent fitting: takes roughly 200 seconds on my laptop</span></span>
<span id="cb86-44"><a href="#cb86-44"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb86-45"><a href="#cb86-45"></a>  fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="dt">x=</span>x.train, <span class="dt">y=</span>y.train, <span class="dt">validation_split=</span><span class="fl">0.2</span>,</span>
<span id="cb86-46"><a href="#cb86-46"></a>                                        <span class="dt">batch_size=</span><span class="dv">100</span>, <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">verbose=</span><span class="dv">1</span>, <span class="dt">callbacks=</span>CBs)                                        </span>
<span id="cb86-47"><a href="#cb86-47"></a><span class="kw">proc.time</span>()<span class="op">-</span>t1}</span>
<span id="cb86-48"><a href="#cb86-48"></a><span class="co"># plot loss figures</span></span>
<span id="cb86-49"><a href="#cb86-49"></a><span class="kw">plot.losses</span>(name.model, gender, fit[[<span class="dv">2</span>]]<span class="op">$</span>val_loss, fit[[<span class="dv">2</span>]]<span class="op">$</span>loss)</span>
<span id="cb86-50"><a href="#cb86-50"></a><span class="co"># calculating in-sample loss: LC is c(Female=3.7573, Male=8.8110)</span></span>
<span id="cb86-51"><a href="#cb86-51"></a><span class="kw">load_model_weights_hdf5</span>(model, file.name)</span>
<span id="cb86-52"><a href="#cb86-52"></a><span class="kw">round</span>(<span class="dv">10</span><span class="op">^</span><span class="dv">4</span><span class="op">*</span><span class="kw">mean</span>((<span class="kw">exp</span>(<span class="op">-</span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(x.train)))<span class="op">-</span><span class="kw">exp</span>(<span class="op">-</span>y.train))<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>)</span>
<span id="cb86-53"><a href="#cb86-53"></a><span class="co"># calculating out-of-sample loss: LC is c(Female=0.6045, Male=1.8152)</span></span>
<span id="cb86-54"><a href="#cb86-54"></a>pred.result &lt;-<span class="st"> </span><span class="kw">recursive.prediction</span>(ObsYear, all_mort2, gender, T0, tau0, x.min, x.max, model)</span>
<span id="cb86-55"><a href="#cb86-55"></a>vali &lt;-<span class="st"> </span>pred.result[[<span class="dv">1</span>]][<span class="kw">which</span>(all_mort2<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>ObsYear),]</span>
<span id="cb86-56"><a href="#cb86-56"></a><span class="kw">round</span>(<span class="dv">10</span><span class="op">^</span><span class="dv">4</span><span class="op">*</span><span class="kw">mean</span>((vali<span class="op">$</span>mx<span class="op">-</span>vali.Y<span class="op">$</span>mx)<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>)</span></code></pre></div>
</div>
<div id="å¼•å…¥æ€§åˆ«åå˜é‡" class="section level3">
<h3><span class="header-section-number">6.5.6</span> å¼•å…¥æ€§åˆ«åå˜é‡</h3>
<ol style="list-style-type: decimal">
<li>æ•°æ®é¢„å¤„ç†</li>
</ol>
<ul>
<li><p>æ·»åŠ æ€§åˆ«æŒ‡ç¤ºå˜é‡ï¼š0è¡¨ç¤ºå¥³æ€§ï¼›1è¡¨ç¤ºç”·æ€§</p></li>
<li><p>åœ¨è®­ç»ƒæ•°æ®æ—¶äº¤æ›¿ä½¿ç”¨æ€§åˆ«</p></li>
<li><p>åº”ç”¨MinMaxScaleræ—¶çš„æœ€å¤§æœ€å°å€¼æ˜¯åŒæ—¶è€ƒè™‘ä¸¤ç§æ€§åˆ«æ‰€æœ‰è®­ç»ƒæ•°æ®çš„æƒ…å†µä¸‹å¾—åˆ°çš„ã€‚</p></li>
<li><p>æ¨¡å‹ç»“æ„åŠè¶…å‚æ•°è®¾ç½®ä¸å•ä¸ªæ€§åˆ«RNNç›¸åŒ</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>å»ºç«‹æ¨¡å‹</li>
</ol>
<ul>
<li>åŸºäºä½¿å¾—æµ‹è¯•æŸå¤±æœ€å°çš„LSTM3å’ŒGRUæ¨¡å‹ï¼Œé¢„æµ‹1999å¹´ä¹‹åçš„æ­»äº¡ç‡ï¼Œå¹¶åœ¨ç‰¹å¾å˜é‡ä¸­åŠ å…¥æ€§åˆ«æŒ‡æ ‡ï¼Œä¸‹è¡¨åˆ—å‡ºäº†ç›¸åº”çš„æŸå¤±</li>
</ul>
<p><span class="math display">\[
\begin{array}{|l|c|cc|c|}
\hline &amp;  {\text { in-sample }} &amp; {\text { out-of-sample }} &amp; {\text { out-of-sample }}&amp;  {\text { run times }}\\
&amp; \text {both genders} &amp; \text { female } &amp; \text { male } &amp; \text {both genders} \\
\hline \hline \text { LSTM3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 4.7643 &amp; 0.3402 &amp; 1.1346 &amp; 404 \mathrm{s}\\
\text { GRU3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 4.6311 &amp; 0.4646 &amp; 1.2571 &amp;  379 \mathrm{s} \\
\hline \hline \text { LC model with SVD } &amp; 6.2841 &amp; 0.6045 &amp;1.8152 &amp;  - \\
\hline
\end{array}
\]</span></p>
<p>ä¸LCæ¨¡å‹ç›¸æ¯”ï¼Œå¾—åˆ°äº†ä¸€ä¸ªæœ‰å¾ˆå¤§æ”¹è¿›çš„æ¨¡å‹ï¼Œè‡³å°‘å¯¹æœªæ¥16å¹´çš„é¢„æµ‹æ˜¯è¿™æ ·çš„ï¼›æ­¤å¤–ï¼Œå¼•å…¥æ€§åˆ«åå˜é‡çš„LSTMæ¨¡å‹ä¹Ÿä¼˜äºå•ä¸ªæ€§åˆ«çš„æ¨¡å‹ã€‚</p>
<ol start="3" style="list-style-type: decimal">
<li>éšå«çš„æ¼‚ç§»é¡¹</li>
</ol>
<div class="figure" style="text-align: center">
<img src="./plots/6/kt3.png" alt="å¼•å…¥æ€§åˆ«åå˜é‡å»ºæ¨¡çš„ktçš„ä¼°è®¡ä¸é¢„æµ‹å€¼" width="60%"  />
<p class="caption">
(#fig:kt3)å¼•å…¥æ€§åˆ«åå˜é‡å»ºæ¨¡çš„ktçš„ä¼°è®¡ä¸é¢„æµ‹å€¼
</p>
</div>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a><span class="co"># load corresponding data</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>path.data &lt;-<span class="st"> &quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CHE_mort.csv&quot;</span>           <span class="co"># path and name of data file</span></span>
<span id="cb87-3"><a href="#cb87-3"></a>region &lt;-<span class="st"> &quot;CHE&quot;</span>                    <span class="co"># country to be loaded (code is for one selected country)</span></span>
<span id="cb87-4"><a href="#cb87-4"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_a package - load data.R&quot;</span>)</span>
<span id="cb87-5"><a href="#cb87-5"></a><span class="kw">str</span>(all_mort)</span>
<span id="cb87-6"><a href="#cb87-6"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_b package - network definitions.R&quot;</span>)</span>
<span id="cb87-7"><a href="#cb87-7"></a><span class="kw">source</span>(<span class="dt">file=</span><span class="st">&quot;6 - Lee and Carter go Machine Learning Recurrent Neural Networks/00_c package - data preparation RNNs.R&quot;</span>)</span>
<span id="cb87-8"><a href="#cb87-8"></a><span class="co"># choice of parameters</span></span>
<span id="cb87-9"><a href="#cb87-9"></a>T0 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb87-10"><a href="#cb87-10"></a>tau0 &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb87-11"><a href="#cb87-11"></a>ObsYear &lt;-<span class="st"> </span><span class="dv">1999</span></span>
<span id="cb87-12"><a href="#cb87-12"></a><span class="co"># training data pre-processing </span></span>
<span id="cb87-13"><a href="#cb87-13"></a>data1 &lt;-<span class="st"> </span><span class="kw">data.preprocessing.RNNs</span>(all_mort, <span class="st">&quot;Female&quot;</span>, T0, tau0, ObsYear)</span>
<span id="cb87-14"><a href="#cb87-14"></a>data2 &lt;-<span class="st"> </span><span class="kw">data.preprocessing.RNNs</span>(all_mort, <span class="st">&quot;Male&quot;</span>, T0, tau0, ObsYear)</span>
<span id="cb87-15"><a href="#cb87-15"></a>xx &lt;-<span class="st"> </span><span class="kw">dim</span>(data1[[<span class="dv">1</span>]])[<span class="dv">1</span>]</span>
<span id="cb87-16"><a href="#cb87-16"></a>x.train &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">2</span><span class="op">*</span>xx, <span class="kw">dim</span>(data1[[<span class="dv">1</span>]])[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)]))</span>
<span id="cb87-17"><a href="#cb87-17"></a>y.train &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">2</span><span class="op">*</span>xx))</span>
<span id="cb87-18"><a href="#cb87-18"></a>gender.indicator &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), xx)</span>
<span id="cb87-19"><a href="#cb87-19"></a><span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>xx){</span>
<span id="cb87-20"><a href="#cb87-20"></a>   x.train[(l<span class="dv">-1</span>)<span class="op">*</span><span class="dv">2</span><span class="op">+</span><span class="dv">1</span>,,] &lt;-<span class="st"> </span>data1[[<span class="dv">1</span>]][l,,]</span>
<span id="cb87-21"><a href="#cb87-21"></a>   x.train[(l<span class="dv">-1</span>)<span class="op">*</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span>,,] &lt;-<span class="st"> </span>data2[[<span class="dv">1</span>]][l,,]</span>
<span id="cb87-22"><a href="#cb87-22"></a>   y.train[(l<span class="dv">-1</span>)<span class="op">*</span><span class="dv">2</span><span class="op">+</span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="op">-</span>data1[[<span class="dv">2</span>]][l]</span>
<span id="cb87-23"><a href="#cb87-23"></a>   y.train[(l<span class="dv">-1</span>)<span class="op">*</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="op">-</span>data2[[<span class="dv">2</span>]][l]</span>
<span id="cb87-24"><a href="#cb87-24"></a>          }</span>
<span id="cb87-25"><a href="#cb87-25"></a><span class="co"># MinMaxScaler data pre-processing</span></span>
<span id="cb87-26"><a href="#cb87-26"></a>x.min &lt;-<span class="st"> </span><span class="kw">min</span>(x.train)</span>
<span id="cb87-27"><a href="#cb87-27"></a>x.max &lt;-<span class="st"> </span><span class="kw">max</span>(x.train)</span>
<span id="cb87-28"><a href="#cb87-28"></a>x.train &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">array</span>(<span class="dv">2</span><span class="op">*</span>(x.train<span class="op">-</span>x.min)<span class="op">/</span>(x.min<span class="op">-</span>x.max)<span class="op">-</span><span class="dv">1</span>, <span class="kw">dim</span>(x.train)), gender.indicator)</span>
<span id="cb87-29"><a href="#cb87-29"></a>y0 &lt;-<span class="st"> </span><span class="kw">mean</span>(y.train)</span>
<span id="cb87-30"><a href="#cb87-30"></a><span class="co"># validation data pre-processing</span></span>
<span id="cb87-31"><a href="#cb87-31"></a>all_mort2.Female &lt;-<span class="st"> </span>all_mort[<span class="kw">which</span>((all_mort<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>(ObsYear<span class="dv">-10</span>))<span class="op">&amp;</span>(Gender<span class="op">==</span><span class="st">&quot;Female&quot;</span>)),]</span>
<span id="cb87-32"><a href="#cb87-32"></a>all_mortV.Female &lt;-<span class="st"> </span>all_mort2.Female</span>
<span id="cb87-33"><a href="#cb87-33"></a>vali.Y.Female &lt;-<span class="st"> </span>all_mortV.Female[<span class="kw">which</span>(all_mortV.Female<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>ObsYear),]</span>
<span id="cb87-34"><a href="#cb87-34"></a>all_mort2.Male &lt;-<span class="st"> </span>all_mort[<span class="kw">which</span>((all_mort<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>(ObsYear<span class="dv">-10</span>))<span class="op">&amp;</span>(Gender<span class="op">==</span><span class="st">&quot;Male&quot;</span>)),]</span>
<span id="cb87-35"><a href="#cb87-35"></a>all_mortV.Male &lt;-<span class="st"> </span>all_mort2.Male</span>
<span id="cb87-36"><a href="#cb87-36"></a>vali.Y.Male &lt;-<span class="st"> </span>all_mortV.Male[<span class="kw">which</span>(all_mortV.Male<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>ObsYear),]</span>
<span id="cb87-37"><a href="#cb87-37"></a><span class="co"># LSTM architectures</span></span>
<span id="cb87-38"><a href="#cb87-38"></a><span class="co"># network architecture deep 3 network</span></span>
<span id="cb87-39"><a href="#cb87-39"></a>tau1 &lt;-<span class="st"> </span><span class="dv">20</span></span>
<span id="cb87-40"><a href="#cb87-40"></a>tau2 &lt;-<span class="st"> </span><span class="dv">15</span></span>
<span id="cb87-41"><a href="#cb87-41"></a>tau3 &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb87-42"><a href="#cb87-42"></a>optimizer &lt;-<span class="st"> &#39;adam&#39;</span></span>
<span id="cb87-43"><a href="#cb87-43"></a><span class="co"># choose either LSTM or GRU network</span></span>
<span id="cb87-44"><a href="#cb87-44"></a>RNN.type &lt;-<span class="st"> &quot;LSTM&quot;</span></span>
<span id="cb87-45"><a href="#cb87-45"></a><span class="co">#RNN.type &lt;- &quot;GRU&quot;</span></span>
<span id="cb87-46"><a href="#cb87-46"></a>{<span class="cf">if</span> (RNN.type<span class="op">==</span><span class="st">&quot;LSTM&quot;</span>){model &lt;-<span class="st"> </span><span class="kw">LSTM3.Gender</span>(T0, tau0, tau1, tau2, tau3, y0, optimizer)}<span class="cf">else</span>{model &lt;-<span class="st"> </span><span class="kw">GRU3.Gender</span>(T0, tau0, tau1, tau2, tau3, y0, optimizer)}</span>
<span id="cb87-47"><a href="#cb87-47"></a> name.model &lt;-<span class="st"> </span><span class="kw">paste</span>(RNN.type,<span class="st">&quot;3_&quot;</span>, tau0, <span class="st">&quot;_&quot;</span>, tau1, <span class="st">&quot;_&quot;</span>, tau2, <span class="st">&quot;_&quot;</span>, tau3, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb87-48"><a href="#cb87-48"></a> <span class="co">#file.name &lt;- paste(&quot;./Model_Full_Param/best_model_&quot;, name.model, sep=&quot;&quot;)</span></span>
<span id="cb87-49"><a href="#cb87-49"></a> file.name &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;./6 - Lee and Carter go Machine Learning Recurrent Neural Networks/CallBack/best_model_&quot;</span>, name.model, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb87-50"><a href="#cb87-50"></a> <span class="kw">summary</span>(model)}</span>
<span id="cb87-51"><a href="#cb87-51"></a><span class="co"># define callback</span></span>
<span id="cb87-52"><a href="#cb87-52"></a>CBs &lt;-<span class="st"> </span><span class="kw">callback_model_checkpoint</span>(file.name, <span class="dt">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="dt">verbose =</span> <span class="dv">0</span>,  <span class="dt">save_best_only =</span> <span class="ot">TRUE</span>, <span class="dt">save_weights_only =</span> <span class="ot">TRUE</span>,<span class="dt">save_freq =</span> <span class="ot">NULL</span>)</span>
<span id="cb87-53"><a href="#cb87-53"></a><span class="co"># gradient descent fitting: takes roughly 400 seconds on my laptop</span></span>
<span id="cb87-54"><a href="#cb87-54"></a>{t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb87-55"><a href="#cb87-55"></a>  fit &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(<span class="dt">x=</span>x.train, <span class="dt">y=</span>y.train, <span class="dt">validation_split=</span><span class="fl">0.2</span>,</span>
<span id="cb87-56"><a href="#cb87-56"></a>                                        <span class="dt">batch_size=</span><span class="dv">100</span>, <span class="dt">epochs=</span><span class="dv">500</span>, <span class="dt">verbose=</span><span class="dv">1</span>, <span class="dt">callbacks=</span>CBs)                                        </span>
<span id="cb87-57"><a href="#cb87-57"></a><span class="kw">proc.time</span>()<span class="op">-</span>t1}</span>
<span id="cb87-58"><a href="#cb87-58"></a><span class="co"># plot loss figures</span></span>
<span id="cb87-59"><a href="#cb87-59"></a><span class="kw">plot.losses</span>(name.model, <span class="st">&quot;Both&quot;</span>, fit[[<span class="dv">2</span>]]<span class="op">$</span>val_loss, fit[[<span class="dv">2</span>]]<span class="op">$</span>loss)</span>
<span id="cb87-60"><a href="#cb87-60"></a><span class="co"># calculating in-sample loss: LC is c(Female=3.7573, Male=8.8110)</span></span>
<span id="cb87-61"><a href="#cb87-61"></a><span class="kw">load_model_weights_hdf5</span>(model, file.name)</span>
<span id="cb87-62"><a href="#cb87-62"></a><span class="kw">round</span>(<span class="dv">10</span><span class="op">^</span><span class="dv">4</span><span class="op">*</span><span class="kw">mean</span>((<span class="kw">exp</span>(<span class="op">-</span><span class="kw">as.vector</span>(model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(x.train)))<span class="op">-</span><span class="kw">exp</span>(<span class="op">-</span>y.train))<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>)</span>
<span id="cb87-63"><a href="#cb87-63"></a><span class="co"># calculating out-of-sample loss: LC is c(Female=0.6045, Male=1.8152)</span></span>
<span id="cb87-64"><a href="#cb87-64"></a><span class="co"># Female</span></span>
<span id="cb87-65"><a href="#cb87-65"></a>pred.result &lt;-<span class="st"> </span><span class="kw">recursive.prediction.Gender</span>(ObsYear, all_mort2.Female, <span class="st">&quot;Female&quot;</span>, T0, tau0, x.min, x.max, model)</span>
<span id="cb87-66"><a href="#cb87-66"></a>vali &lt;-<span class="st"> </span>pred.result[[<span class="dv">1</span>]][<span class="kw">which</span>(all_mort2.Female<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>ObsYear),]</span>
<span id="cb87-67"><a href="#cb87-67"></a><span class="kw">round</span>(<span class="dv">10</span><span class="op">^</span><span class="dv">4</span><span class="op">*</span><span class="kw">mean</span>((vali<span class="op">$</span>mx<span class="op">-</span>vali.Y.Female<span class="op">$</span>mx)<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>)</span>
<span id="cb87-68"><a href="#cb87-68"></a><span class="co"># Male</span></span>
<span id="cb87-69"><a href="#cb87-69"></a>pred.result &lt;-<span class="st"> </span><span class="kw">recursive.prediction.Gender</span>(ObsYear, all_mort2.Male, <span class="st">&quot;Male&quot;</span>, T0, tau0, x.min, x.max, model)</span>
<span id="cb87-70"><a href="#cb87-70"></a>vali &lt;-<span class="st"> </span>pred.result[[<span class="dv">1</span>]][<span class="kw">which</span>(all_mort2.Male<span class="op">$</span>Year <span class="op">&gt;</span><span class="st"> </span>ObsYear),]</span>
<span id="cb87-71"><a href="#cb87-71"></a><span class="kw">round</span>(<span class="dv">10</span><span class="op">^</span><span class="dv">4</span><span class="op">*</span><span class="kw">mean</span>((vali<span class="op">$</span>mx<span class="op">-</span>vali.Y.Male<span class="op">$</span>mx)<span class="op">^</span><span class="dv">2</span>),<span class="dv">4</span>)</span></code></pre></div>
</div>
<div id="ç¨³å¥æ€§" class="section level3">
<h3><span class="header-section-number">6.5.7</span> ç¨³å¥æ€§</h3>
<p>ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•çš„æ—©æœŸåœæ­¢è§£å†³æ–¹æ¡ˆçš„ä¸€ä¸ªé—®é¢˜æ˜¯ç”±æ­¤äº§ç”Ÿçš„æ ¡å‡†ä¾èµ–äºç®—æ³•ç§å­ç‚¹ï¼ˆèµ·å§‹å€¼ï¼‰çš„é€‰æ‹©</p>
<p>ä¸‹å›¾å±•ç¤ºä½¿ç”¨ç›¸åŒRNNç»“æ„ã€ç›¸åŒè¶…å‚æ•°å’Œç›¸åŒæ ¡å‡†ç­–ç•¥ï¼Œé’ˆå¯¹100ä¸ªä¸åŒç§å­ç‚¹çš„é€‰æ‹©æ‰€ç”»çš„æŸå¤±çš„ç®±çº¿å›¾</p>
<div class="figure" style="text-align: center">
<img src="./plots/6/Box.png" alt="100ä¸ªä¸åŒç§å­ä¸‹çš„æŸå¤±ç®±çº¿å›¾" width="60%"  />
<p class="caption">
(#fig:Box)100ä¸ªä¸åŒç§å­ä¸‹çš„æŸå¤±ç®±çº¿å›¾
</p>
</div>
<ul>
<li><p>çº¢è‰²è¡¨ç¤ºè”åˆæ€§åˆ«çš„LSTMç»“æ„ä¸­çš„é¢„æµ‹ç»“æœï¼›è“è‰²è¡¨ç¤ºè”åˆæ€§åˆ«çš„GRUç»“æ„ä¸­çš„é¢„æµ‹ï¼›æ©™è‰²æ°´å¹³çº¿è¡¨ç¤ºçš„æ˜¯LCçš„é¢„æµ‹</p></li>
<li><p>ç»“è®ºï¼š</p></li>
</ul>
<ol style="list-style-type: lower-alpha">
<li><p>å·¦ä¾§ç»™å‡ºäº†æ ·æœ¬å†…æŸå¤±ï¼Œä¸LCæ¨¡å‹ç›¸æ¯”ï¼Œä¸¤ç§RNNç»“æ„çš„æ ·æœ¬å†…æŸå¤±éƒ½æœ‰æ˜¾è‘—å‡å°‘ï¼Œå¹³å‡è€Œè¨€ï¼ŒLSTMçš„æŸå¤±æ¯”GRUçš„å°ï¼Œæ³¢åŠ¨æ€§ä¹Ÿæ›´å°ï¼›</p></li>
<li><p>ä¸­é—´å’Œå³è¾¹åˆ†åˆ«è¡¨ç¤ºå¥³æ€§å’Œç”·æ€§çš„æ ·æœ¬å¤–æŸå¤±ï¼šä¸è®ºç”·æ€§è¿˜æ˜¯å¥³æ€§ï¼ŒLSTMåœ¨å‡ ä¹æ‰€æœ‰çš„100æ¬¡è¿­ä»£ä¸­éƒ½æ¯”LCæ¨¡å‹å¥½ï¼›GRUç»“æ„å°½åœ¨å¤§çº¦ä¸€åŠæ¬¡æ•°çš„è¿­ä»£ä¸­æ¯”LCæ¨¡å‹è¡¨ç°å¥½ã€‚</p></li>
</ol>
<ul>
<li><strong>æ”¹è¿›æ–¹æ³•</strong>ï¼šå°†ä¸åŒç§å­ç‚¹ä¸‹å¾—åˆ°çš„é¢„æµ‹å€¼è¿›è¡Œå¹³å‡ï¼Œç»“æœå¦‚ä¸‹:</li>
</ul>
<p><span class="math display">\[
\begin{array}{|l|c|cc|c|}
\hline &amp;  {\text { in-sample }} &amp; {\text { out-of-sample }} &amp; {\text { out-of-sample }}&amp;  {\text { run times }}\\
&amp; \text {both genders} &amp; \text { female } &amp; \text { male } &amp; \text {both genders} \\
\hline \hline \text { LSTM3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 4.7643 &amp; 0.3402 &amp; 1.1346 &amp; 404 \mathrm{s}\\
\text { GRU3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 4.6311 &amp; 0.4646 &amp; 1.2571 &amp;  379 \mathrm{s} \\
\hline\hline \text { LSTM3 averaged over 100 different seeds} &amp; - &amp; 0.2451 &amp; 1.2093 &amp; 100 \cdot 404\mathrm{s}\\
\text { GRU3 averaged over 100 different seeds } &amp; - &amp; 0.2341&amp; 1.2746 &amp;  100 \cdot 379 \mathrm{s} \\
\hline \hline \text { LC model with SVD } &amp; 6.2841 &amp; 0.6045 &amp;1.8152 &amp;  - \\
\hline
\end{array}
\]</span></p>
<p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œå¹³å‡ä¹‹åå¾—åˆ°äº†æ›´ç¨³å¥çš„è§£å†³æ–¹æ¡ˆï¼Œé¢„æµ‹ç»“æœä¹Ÿå¾ˆå¥½ï¼Œç®±çº¿å›¾ä¸­ç»¿è‰²æ°´å¹³çº¿è¡¨ç¤ºçš„å°±æ˜¯å¹³å‡ä¹‹åçš„é¢„æµ‹æŸå¤±ï¼Œæ˜¾ç¤ºä»…æœ‰æå°‘æ•°çš„åœ¨ç»¿è‰²æ°´å¹³çº¿ä¹‹ä¸‹çš„ç§å­ç‚¹çš„é€‰æ‹©åœ¨å•ç‹¬è¿›è¡Œæ ¡å‡†æ—¶æ•ˆæœä¼šæ›´å¥½ã€‚</p>
</div>
<div id="é¢„æµ‹ç»“æœå›¾" class="section level3">
<h3><span class="header-section-number">6.5.8</span> é¢„æµ‹ç»“æœå›¾</h3>
<div class="figure" style="text-align: center">
<img src="./plots/6/mortality.png" alt="å¯¹æ•°æ­»äº¡ç‡çš„è§‚å¯Ÿä¸é¢„æµ‹å€¼" width="60%"  />
<p class="caption">
(#fig:unnamed-chunk-2)å¯¹æ•°æ­»äº¡ç‡çš„è§‚å¯Ÿä¸é¢„æµ‹å€¼
</p>
</div>
<p>ç»“è®ºï¼š</p>
<ol style="list-style-type: lower-alpha">
<li><p>20-40å²ä¹‹é—´LSTMæ–¹æ³•èƒ½å¤Ÿæ›´å¥½çš„æ•æ‰åˆ°æ­»äº¡ç‡çš„æ”¹å–„ï¼Œå·¦è¾¹è§‚å¯Ÿå€¼æ¸…æ¥šçš„è¡¨æ˜LSTMè¿™æ ·çš„æ”¹å–„æ˜¯åˆç†çš„ï¼›</p></li>
<li><p>å¹´é¾„è¾ƒå°äººç¾¤çš„æ­»äº¡ç‡å®é™…æ”¹å–„æƒ…å†µæ¯”æŒ‰ç…§æœ¬æ–‡æ–¹æ³•é¢„æµ‹çš„å¤§ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºè®­ç»ƒæ•°æ®çš„é’å¹´æ­»äº¡ç‡æ”¹å–„æƒ…å†µæ— æ³•ä»£è¡¨2000å¹´ä¹‹åçš„é’å¹´æ­»äº¡ç‡æ”¹å–„æƒ…å†µã€‚</p></li>
</ol>
<!--chapter:end:06-rnn.Rmd-->
</div>
</div>
</div>
<div id="nlp" class="section level1">
<h1><span class="header-section-number">7</span> è‡ªç„¶è¯­è¨€å¤„ç†</h1>
<p><em>é™ˆç¾æ˜†ã€è’‹æ…§åã€é«˜å…‰è¿œ</em></p>
<div class="figure" style="text-align: center">
<img src="./plots/7/history.png" alt="NLPå†å²ï¼ˆ2000å¹´ä»¥åï¼‰" width="70%" />
<p class="caption">
(#fig:history)NLPå†å²ï¼ˆ2000å¹´ä»¥åï¼‰
</p>
</div>
<p>åœ¨ä¿é™©ä¸šï¼Œå¤§é‡çš„ä¹¦é¢è¯æ®ï¼Œå¦‚ä¿å•åˆåŒæˆ–ç´¢èµ”é€šçŸ¥ï¼Œä»¥åŠå®¢æˆ·ä¸ä¼ä¸šå¯¹è¯åŠ©ç†äº’åŠ¨çš„è®°å½•ï¼Œä¸ºæ•°æ®ç§‘å­¦å®¶å’Œç²¾ç®—å¸ˆæä¾›äº†è¶Šæ¥è¶Šå¤šçš„å¯ä¾›åˆ†æçš„æ–‡æœ¬ä¿¡æ¯ã€‚</p>
<p>NLPåœ¨ä¿é™©è¡Œä¸šä¸­çš„åº”ç”¨ï¼š</p>
<ul>
<li><p>æ ¹æ®æ–‡å­—æè¿°çš„ç´¢èµ”ç±»å‹å’Œä¸¥é‡ç¨‹åº¦å¯¹ç´¢èµ”è¿›è¡Œåˆ†ç±»</p></li>
<li><p>å¯¹ç”µå­é‚®ä»¶ã€ä¿å•ã€åˆåŒçš„åˆ†ç±»</p></li>
<li><p>ä»æ–‡æœ¬æ•°æ®ä¸­è¯†åˆ«æ¬ºè¯ˆæ¡ˆä¾‹ç­‰</p></li>
</ul>
<p><strong>ä¼ ç»Ÿæ–¹æ³•çš„åŸºæœ¬è¿‡ç¨‹</strong></p>
<ol style="list-style-type: decimal">
<li><p>æ–‡æœ¬é¢„å¤„ç†</p></li>
<li><p><strong>æ˜ å°„åˆ°å®æ•°é›†</strong>: bag-of-words, bag-of-POS, pre-trained word embedding</p></li>
<li><p>æœ‰ç›‘ç£æœºå™¨å­¦ä¹ ç®—æ³•: AdaBoost, random forest, XGBoost</p></li>
</ol>
<p><strong>å¾ªç¯ç¥ç»ç½‘ç»œçš„åŸºæœ¬è¿‡ç¨‹</strong></p>
<ol style="list-style-type: decimal">
<li><p>æ–‡æœ¬é¢„å¤„ç†</p></li>
<li><p>å¾ªç¯ç¥ç»ç½‘ç»œ: RNN, GRU, LSTM</p></li>
</ol>
<p><strong>åŒºåˆ«</strong></p>
<ol style="list-style-type: decimal">
<li><p>ä¼ ç»Ÿæ–¹æ³•éå¸¸ä¾èµ–ç¬¬äºŒæ­¥ç‰¹å¾å·¥ç¨‹çš„æ•ˆæœ,ç¥ç»ç½‘ç»œä¸éœ€è¦ç‰¹å¾å·¥ç¨‹,å®ƒé€šè¿‡ç›‘ç£å­¦ä¹ .è¿›è¡Œè‡ªåŠ¨ç‰¹å¾å·¥ç¨‹.</p></li>
<li><p>ä¼ ç»Ÿæ–¹æ³•æ²¡æœ‰è€ƒè™‘æ–‡æœ¬çš„æ—¶é—´åºåˆ—ç‰¹å¾, å¾ªç¯ç¥ç»ç½‘ç»œè€ƒè™‘äº†æ–‡æœ¬çš„æ—¶é—´åºåˆ—ç‰¹å¾.</p></li>
</ol>
<div id="é¢„å¤„ç†" class="section level2">
<h2><span class="header-section-number">7.1</span> é¢„å¤„ç†</h2>
<ol style="list-style-type: decimal">
<li><p>è¾“å…¥åŸå§‹æ–‡æœ¬å’Œæ ¼å¼</p></li>
<li><p>å°†æ–‡æœ¬è½¬åŒ–ä¸ºå°å†™</p></li>
<li><p>åˆ†è¯ï¼ˆ tokenization ï¼‰</p></li>
<li><p>åˆ é™¤åœç”¨è¯ï¼ˆ stopwords ï¼‰</p></li>
<li><p>è¯æ€§æ ‡æ³¨ï¼ˆPOS tagging, è¿™æ­¥åœ¨ bag-of-POSéœ€è¦, å¦‚æœåªæ˜¯ bag-of-wordsï¼Œæ­¤æ­¥ä¸éœ€è¦)</p></li>
<li><p>è¯å¹²æå–æˆ–è¯å½¢è¿˜åŸï¼ˆStemming or Lemmatizationï¼‰</p></li>
</ol>
</div>
<div id="bag-of-words" class="section level2">
<h2><span class="header-section-number">7.2</span> Bag of words</h2>
<p>Bag-of-wordsæ¨¡å‹æ˜¯ä¿¡æ¯æ£€ç´¢é¢†åŸŸå¸¸ç”¨çš„æ–‡æ¡£è¡¨ç¤ºæ–¹æ³•ã€‚åœ¨ä¿¡æ¯æ£€ç´¢ä¸­ï¼ŒBOWæ¨¡å‹å‡å®šå¯¹äºä¸€ä¸ªæ–‡æ¡£ï¼Œå¿½ç•¥å®ƒçš„å•è¯é¡ºåºå’Œè¯­æ³•ã€å¥æ³•ç­‰è¦ç´ ï¼Œå°†å…¶ä»…ä»…çœ‹ä½œæ˜¯è‹¥å¹²ä¸ªè¯æ±‡çš„é›†åˆï¼Œæ–‡æ¡£ä¸­æ¯ä¸ªå•è¯çš„å‡ºç°éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–äºå…¶å®ƒå•è¯æ˜¯å¦å‡ºç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡æ¡£ä¸­ä»»æ„ä¸€ä¸ªä½ç½®å‡ºç°çš„ä»»ä½•å•è¯ï¼Œéƒ½ä¸å—è¯¥æ–‡æ¡£è¯­æ„å½±å“è€Œç‹¬ç«‹é€‰æ‹©çš„ã€‚ä¾‹å¦‚æœ‰å¦‚ä¸‹ä¸¤ä¸ªæ–‡æ¡£ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>Bob likes to play basketball, Jim likes too.</p></li>
<li><p>Bob also likes to play football games.</p></li>
</ol>
<p>åŸºäºè¿™ä¸¤ä¸ªæ–‡æœ¬æ–‡æ¡£ï¼Œæ„é€ ä¸€ä¸ªè¯å…¸ï¼š</p>
<p>Dictionary = {1:â€œBobâ€, 2. â€œlikeâ€, 3. â€œtoâ€, 4. â€œplayâ€, 5. â€œbasketballâ€, 6. â€œalsoâ€, 7. â€œfootballâ€, 8. â€œgamesâ€, 9. â€œJimâ€, 10. â€œtooâ€}</p>
<p>è¿™ä¸ªè¯å…¸ä¸€å…±åŒ…å«<span class="math inline">\(10\)</span>ä¸ªä¸åŒçš„å•è¯ï¼Œåˆ©ç”¨è¯å…¸çš„ç´¢å¼•å·ï¼Œä¸Šé¢ä¸¤ä¸ªæ–‡æ¡£æ¯ä¸€ä¸ªéƒ½å¯ä»¥ç”¨ä¸€ä¸ª<span class="math inline">\(10\)</span>ç»´å‘é‡è¡¨ç¤ºï¼ˆç”¨æ•´æ•°æ•°å­—<span class="math inline">\(0:n\)</span>ï¼ˆ<span class="math inline">\(n\)</span>ä¸ºæ­£æ•´æ•°ï¼‰è¡¨ç¤ºæŸä¸ªå•è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ï¼‰ï¼š</p>
<p>1ï¼š<span class="math inline">\([1, 2, 1, 1, 1, 0, 0, 0, 1, 1]\)</span></p>
<p>2ï¼š<span class="math inline">\([1, 1, 1, 1 ,0, 1, 1, 1, 0, 0]\)</span></p>
<p>å‘é‡ä¸­æ¯ä¸ªå…ƒç´ è¡¨ç¤ºè¯å…¸ä¸­ç›¸å…³å…ƒç´ åœ¨æœ¬æ–‡æœ¬æ ·æœ¬ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚ä¸è¿‡ï¼Œåœ¨æ„é€ æ–‡æ¡£å‘é‡çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è¡¨è¾¾å•è¯åœ¨åŸæ¥å¥å­ä¸­å‡ºç°çš„æ¬¡åºï¼ˆè¿™æ˜¯æœ¬Bag-of-wordsæ¨¡å‹çš„ç¼ºç‚¹ä¹‹ä¸€ï¼Œä¸è¿‡ç‘•ä¸æ©ç‘œç”šè‡³åœ¨æ­¤å¤„æ— å…³ç´§è¦ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨<code>TfidfVectorizer</code>è¿›è¡ŒBOW,å®ƒä¸ä½¿ç”¨è¯å‡ºç°çš„æ¬¡æ•°,è€Œè®¡ç®—term frequency - inverse document frequency (tf-idf)ã€‚ç ”ç©¶è¡¨æ˜tf-idfæ›´èƒ½åæ˜ æ–‡æœ¬çš„ç‰¹å¾ã€‚</p>
</div>
<div id="bag-of-part-of-speech" class="section level2">
<h2><span class="header-section-number">7.3</span> Bag of part-of-speech</h2>
<p>ç›¸è¾ƒäºBOWï¼Œbag of POSä»…ä»…å¤šäº†ä¸€æ­¥ï¼Œå³å¯¹æ¯ä¸ªè¯è¯­è¿›è¡Œè¯æ€§æ ‡æ³¨ï¼Œç„¶åä½¿ç”¨<code>TfidfVectorizer</code>ã€‚å¯çŸ¥bag of POSå¯ä»¥è¾¾åˆ°é™ç»´çš„ç›®çš„ï¼Œä½†å®ƒæ•£å¤±äº†åŸæ–‡æœ¬çš„è¯è¯­çš„ä¿¡æ¯ï¼Œåªè€ƒè™‘äº†è¯æ€§ã€‚</p>
</div>
<div id="word-embeddings" class="section level2">
<h2><span class="header-section-number">7.4</span> Word embeddings</h2>
<p>è¯åµŒå…¥è€ƒè™‘æŠŠæ¯ä¸ªè¯è¯­æ˜ å°„åˆ°ç”¨å¤šç»´å®æ•°ç©ºé—´ä¸­ï¼Œæœ‰å¾ˆå¤šé¢„è®­ç»ƒçš„æ˜ å°„å¯ä¾›é€‰æ‹©ï¼Œè¿™äº›æ˜ å°„é€šå¸¸è€ƒè™‘äº†è¯è¯­çš„å…ˆåé¡ºåºå’ŒåŒä¹‰è¯åä¹‰è¯ç­‰ã€‚å¸¸ç”¨çš„è¯åµŒå…¥æ¨¡å‹åŒ…æ‹¬ï¼š</p>
<ul>
<li><p>Neural probabilistic language model</p></li>
<li><p>word2vec</p></li>
<li><p>Global vectors for word representation</p></li>
</ul>
<div id="pre-trained-word-embeddings" class="section level3">
<h3><span class="header-section-number">7.4.1</span> Pre-trained word embeddings</h3>
<p>æˆ‘ä»¬ä½¿ç”¨<code>en_core_web_sm</code>è¿›è¡Œè¯åµŒå…¥ï¼Œå®ƒå¯ä»¥æŠŠä»»æ„çš„è¯æ˜ å°„åˆ°<span class="math inline">\(\mathbb{R}^{96}\)</span>ã€‚å¦å¤–ï¼Œ<code>en_core_web_mb</code>ä¸ºæ›´å¤æ‚çš„æ˜ å°„ï¼Œå¯ä»¥æŠŠä»»æ„çš„è¯æ˜ å°„åˆ°<span class="math inline">\(\mathbb{R}^{300}\)</span>ã€‚å¯¹äºä¸€ä¸ªåŒ…å«å¤šä¸ªè¯è¯­çš„æ–‡æœ¬ï¼Œæˆ‘ä»¬ç”¨æ‰€æœ‰è¯è¯­çš„è¯åµŒå…¥å¹³å‡å€¼æ¥è¡¨ç¤ºè¿™ä¸ªæ–‡æœ¬</p>
</div>
</div>
<div id="æœºå™¨å­¦ä¹ ç®—æ³•" class="section level2">
<h2><span class="header-section-number">7.5</span> æœºå™¨å­¦ä¹ ç®—æ³•</h2>
<p>é€šè¿‡bag-of-words, bag-of-POSï¼Œword embedding æˆ‘ä»¬æŠŠæ¯ä¸ªæ–‡æœ¬è½¬å˜ä¸ºä¸€ä¸ªå‘é‡ã€‚è¿™æ ·å¯ä»¥åˆ©ç”¨å¦‚ä¸‹å‡ ç§æœºå™¨å­¦ä¹ ç®—æ³•è¿›è¡Œæ–‡æœ¬åˆ†ç±»ç­‰ç›‘ç£å­¦ä¹ ã€‚</p>
<ul>
<li><p>AdaBoost</p></li>
<li><p>Random Forest</p></li>
<li><p>XGBoost</p></li>
</ul>
</div>
<div id="ç¥ç»ç½‘ç»œ" class="section level2">
<h2><span class="header-section-number">7.6</span> ç¥ç»ç½‘ç»œ</h2>
<div id="æ•°æ®é¢„å¤„ç†-4" class="section level3">
<h3><span class="header-section-number">7.6.1</span> æ•°æ®é¢„å¤„ç†</h3>
<p>åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œä»¥ä¸Šbag-of-words, bag-of-POS, word embeddingç­‰äººå·¥ç‰¹å¾å·¥ç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨å®æ•°æŠŠæ–‡æœ¬ä¸­<strong>è¯è¯­çš„é¡ºåº</strong>è¡¨å¾å‡ºæ¥å³å¯ï¼Œç¥ç»ç½‘ç»œå¯ä»¥åŒæ­¥è¿›è¡Œç‰¹å¾å·¥ç¨‹å’Œæœ‰ç›‘ç£è®­ç»ƒã€‚</p>
<p>åœ¨pythonä¸­å¯ä»¥ä½¿ç”¨Keras ä¸­çš„<code>Tokenizer</code>æ¨¡å—æŠŠè¯è¯­æ˜ å°„åˆ°éè´Ÿæ•´æ•°ä¸Šï¼Œæ­¤æ–¹æ³•ä¿æŒäº†ä¿æŒäº†è¯è¯­çš„é¡ºåºï¼Œæ˜¯å‰é¢å‡ ç§æ–¹æ³•æ²¡æœ‰è¾¾åˆ°çš„ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ç¥ç»ç½‘ç»œæ—¶ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦è¿›è¡Œå¾ˆå°‘çš„ç‰¹å¾å·¥ç¨‹ï¼Œè¯è¯­çš„æ„ä¹‰å°†ç”±ç¥ç»ç½‘ç»œåœ¨ç›‘ç£å­¦ä¹ ä¸­å­¦åˆ°ã€‚æ–‡æœ¬æ˜¯æ—¶é—´åºåˆ—æ•°æ®ï¼Œå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æçš„æ¨¡å‹åŒ…æ‹¬</p>
<ul>
<li><p>LSTM</p></li>
<li><p>GRU</p></li>
</ul>
</div>
</div>
<div id="case-study-1" class="section level2">
<h2><span class="header-section-number">7.7</span> Case study</h2>
<div class="figure" style="text-align: center">
<img src="./plots/7/files.png" alt="æ–‡æ¡£ç»“æ„" width="70%"  />
<p class="caption">
(#fig:files)æ–‡æ¡£ç»“æ„
</p>
</div>
<div class="figure" style="text-align: center">
<img src="./plots/7/procedure.png" alt="nlp4class_exerciseæ­¥éª¤" width="70%"  />
<p class="caption">
(#fig:procedure)nlp4class_exerciseæ­¥éª¤
</p>
</div>
<ul>
<li><p>ä»»åŠ¡æè¿°ï¼šæ ¹æ®ç”µå½±è¯„è®ºæ–‡æœ¬åˆ¤æ–­è¯¥è¯„è®ºæ˜¯â€œå¥½è¯„â€è¿˜æ˜¯â€œå·®è¯„â€</p></li>
<li><p>æ•°æ®æ¥æºï¼š Internet Movie Database (IMDb)</p></li>
<li><p>æ•°æ®é‡ï¼šæ¡ˆä¾‹ä¸­å…±æœ‰5000æ¡å«åˆ†ç±»ä¿¡æ¯ï¼ˆpos/negï¼‰çš„åŸå§‹æ•°æ®ï¼Œä»è®¡ç®—èµ„æºæ˜¯è¿è¡Œæ—¶é—´è€ƒè™‘ï¼Œæˆ‘ä»¬ä»åŸå§‹æ•°æ®ä¸­éšæœºæŠ½å–äº†1%ï¼Œå³500æ¡æ•°æ®è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ•°æ®åœ¨toymdbæ–‡ä»¶å¤¹ä¸‹ï¼Œæ–‡ä»¶ç»“æ„å’ŒåŸå§‹æ•°æ®ä¸€è‡´ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ toymdbæ–‡ä»¶å¤¹åŒ…å«trainå’Œtestä¸¤ä¸ªæ–‡ä»¶ï¼Œä½†å¹¶ä¸æ˜¯å®é™…å¤„ç†æ—¶çš„â€œè®­ç»ƒé›†â€å’Œâ€œæµ‹è¯•é›†â€ï¼Œå®é™…è®­ç»ƒæ—¶è¯»å–æ‰€æœ‰æ•°æ®å¹¶é‡æ–°åˆ’åˆ†â€œè®­ç»ƒé›†â€å’Œâ€œæµ‹è¯•é›†â€ ï¼Œæ‰€ä»¥å®é™…ä¸Štrainå’Œtestä¸­çš„æ–‡ä»¶æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æ²¿è¢­äº†åŸå§‹æ•°æ®çš„å­˜å‚¨ç»“æ„ï¼‰ã€‚</p></li>
<li><p>æ•°æ®ç»“æ„ï¼šè¯„è®ºä½ç½®ä»£è¡¨ç±»åˆ«ï¼Œä¸€ä¸ªtxtå­˜å‚¨ä¸€ä¸ªè¯„è®ºæ•°æ®ã€‚</p></li>
</ul>
<div id="å‡½æ•°è¯´æ˜" class="section level3">
<h3><span class="header-section-number">7.7.1</span> å‡½æ•°è¯´æ˜</h3>
</div>
<div id="å¯èƒ½é‡åˆ°çš„é—®é¢˜" class="section level3">
<h3><span class="header-section-number">7.7.2</span> å¯èƒ½é‡åˆ°çš„é—®é¢˜</h3>
<ul>
<li>è¯æ€§æ ‡æ³¨</li>
</ul>
<pre><code>  import nltk
  from nltk import pos_tag, word_tokenize
  å‡ºç°LookupError</code></pre>
<pre><code>  è§£å†³æ–¹æ³•ï¼šæŠŠ&#39;nltk_data.zip&#39;é‡Œçš„æ–‡ä»¶å…¨éƒ¨æ‹·è´è‡³&#39;/Users/huihuajiang/nltk_data/&#39;         
  ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä½ çš„ nltk_data æ–‡ä»¶å¤¹è·¯å¾„ï¼š             import nltk             
  print(nltk.data.path)</code></pre>
<ul>
<li>è¯åµŒå…¥</li>
</ul>
<pre><code>  import spacy
nlp = spacy.load(â€˜en_core_web_smâ€™) 
é”™è¯¯1ï¼šOSError: [E050] Can&#39;t find model &#39;en_core_web_sm&#39;.
é”™è¯¯2ï¼šnumpy.core.multiarray failed to import</code></pre>
<pre><code>  é”™è¯¯1è§£å†³æ–¹æ³•1ï¼ˆå¯èƒ½ä¸è¡Œï¼‰ï¼š
  å‘½ä»¤è¡Œè¿è¡Œå‘½ä»¤â€python -m spacy download en_core_web_smâ€
  é”™è¯¯1è§£å†³æ–¹æ³•2ï¼šæŠŠæ¨¡å‹ä¸‹è½½åˆ°æœ¬åœ°è¿›è¡Œå®‰è£…
  å…·ä½“æ“ä½œè¯·å‚è€ƒ https://www.freesion.com/article/73801416523/
  é”™è¯¯2è§£å†³æ–¹æ³•ï¼šé‡å¯ä¸€ä¸‹ç»ˆç«¯</code></pre>
</div>
<div id="ç»“æœæ¯”è¾ƒ" class="section level3">
<h3><span class="header-section-number">7.7.3</span> ç»“æœæ¯”è¾ƒ</h3>
<p><em>ä»¥ä¸‹ä»…ä¸ºè¡¨ä¾‹</em></p>
<p><span class="math display">\[
\begin{array}{|l|c|cc|c|}
\hline &amp;  {\text { in-sample }} &amp; {\text { out-of-sample }} &amp; {\text { out-of-sample }}&amp;  {\text { run times }}\\
&amp; \text {both genders} &amp; \text { female } &amp; \text { male } &amp; \text {both genders} \\
\hline \hline \text { LSTM3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 4.7643 &amp; 0.3402 &amp; 1.1346 &amp; 404 \mathrm{s}\\
\text { GRU3 }\left(T=10,\left(\tau_{0}, \tau_{1}, \tau_{2}, \tau_{3}\right)=(5,20,15,10)\right) &amp; 4.6311 &amp; 0.4646 &amp; 1.2571 &amp;  379 \mathrm{s} \\
\hline\hline \text { LSTM3 averaged over 100 different seeds} &amp; - &amp; 0.2451 &amp; 1.2093 &amp; 100 \cdot 404\mathrm{s}\\
\text { GRU3 averaged over 100 different seeds } &amp; - &amp; 0.2341&amp; 1.2746 &amp;  100 \cdot 379 \mathrm{s} \\
\hline \hline \text { LC model with SVD } &amp; 6.2841 &amp; 0.6045 &amp;1.8152 &amp;  - \\
\hline
\end{array}
\]</span></p>
</div>
</div>
<div id="ç»“è®º-1" class="section level2">
<h2><span class="header-section-number">7.8</span> ç»“è®º</h2>
<p>æˆ‘ä»¬ç”¨bag of words, bag of POS, word embeddingsä¸‰ç§NLPæ¨¡å‹å¯¹è¯„è®ºæ–‡æœ¬è¿›è¡Œäº†å‘é‡åŒ–ï¼Œå¹¶ç”¨ADA, RF, XGBä¸‰ç§æœºå™¨å­¦ä¹ æ–¹æ³•å¯¹æ–‡æ¡£è¿›è¡Œäº†åˆ†ç±»ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼•å…¥äº†NLPç®¡é“æ¥é¢„å¤„ç†æ–‡æœ¬æ•°æ® ã€‚æœ€åï¼Œè¿˜é‡‡ç”¨RNNæ¨¡å‹å¯¹æ–‡æ¡£è¿›è¡Œäº†åˆ†ç±»ã€‚</p>
<p>å®éªŒç»“æœè¡¨æ˜ï¼Œ</p>
<ul>
<li><p>bag of wordsæ€»ä½“ä¸Šå˜ç°æ›´å¥½ï¼Œ bag of POSçš„è¡¨ç°ä¸ä½³ã€‚</p></li>
<li><p>ä¸bag of wordsç›¸æ¯”ï¼Œ word embeddingæ¨¡å‹çš„æ•ˆç‡æ›´é«˜ã€‚</p></li>
<li><p>Deep LSTMæ¨¡å‹è¡¨ç°è¦æ¯”Single LSTMå’Œæ›´å¥½ã€‚</p></li>
<li><p>ä¸NLPæ¨¡å‹ç›¸æ¯”ï¼ŒRNNæ¨¡å‹æ€§èƒ½æ›´å¥½ï¼Œè¾¾åˆ°ç›¸åŒæ ‡å‡†çš„æ—¶é—´æ›´çŸ­ã€‚</p></li>
<li><p>å¦‚æœç”¨RNNçš„è¾“å…¥æ•°æ®æ¥æ‹ŸåˆMlæ¨¡å‹ï¼Œç²¾åº¦è¿œä¸åŠRNNæ¨¡å‹ï¼Œå¯è§RNNæ¨¡å‹åœ¨è¯¥ä»»åŠ¡ä¸Šèƒ½åˆ©ç”¨æ›´å°‘çš„ä¿¡æ¯å®ç°æ›´å‡†ç¡®çš„åˆ†ç±»ã€‚</p></li>
</ul>
<!--chapter:end:07-nlp.Rmd-->
</div>
</div>
<div id="flashlight" class="section level1">
<h1><span class="header-section-number">8</span> é€šç”¨æ¨¡å‹è§£é‡Šæ–¹æ³•</h1>
<p><em>é¾šé½ç¿”ã€å¼ è°¦ã€æ®µè¯—æ‚¦ã€é«˜å…‰è¿œ</em></p>
<blockquote>
<p>the blackness of a model box seems no longer to be caused by the obscurity of the model itself but rather depends on the modeler switching on the light of the box. ï¼ˆæ‰‹ç”µç­’çš„ä¸–ç•Œæ²¡æœ‰é»‘ç›’å­ï¼‰</p>
</blockquote>
<p><strong>ç›®çš„</strong>ï¼šä»ç²¾ç®—çš„è§’åº¦åŸºäºæœ‰ç›‘ç£çš„æœºå™¨å­¦ä¹ è®²è¿°äº†è§£é‡Šæ€§æœºå™¨å­¦ä¹ å’Œè§£é‡Šæ€§äººå·¥æ™ºèƒ½ä¸€äº›æ–¹æ³•çš„åº”ç”¨ã€‚</p>
<ol style="list-style-type: decimal">
<li><p>ä½¿æˆ‘ä»¬æ›´ç›¸ä¿¡æ‰€ä½¿ç”¨çš„æ¨¡å‹</p></li>
<li><p>å‘ç°æ¨¡å‹çš„å±€é™æ€§</p></li>
<li><p>æ”¹è¿›ç°æœ‰çš„æ¨¡å‹</p></li>
<li><p>ä½¿æ¨¡å‹ä¸ä»…å¯ä»¥ç”¨æ¥é¢„æµ‹ï¼Œè¿˜å¯ä»¥æä¾›ä¿¡æ¯å’ŒéªŒè¯æ¨¡å‹å‡è®¾</p></li>
</ol>
<p><strong>ä¸»è¦å†…å®¹</strong></p>
<ol style="list-style-type: decimal">
<li><p>å˜é‡é‡è¦æ€§</p></li>
<li><p>è¾¹ç¼˜æ•ˆåº”ï¼ˆä¸»æ•ˆåº”ï¼‰ã€äº¤äº’æ•ˆåº”</p></li>
<li><p>æ¯ä¸ªç‰¹å¾å¯¹å•ä¸€é¢„æµ‹å€¼çš„è´¡çŒ®</p></li>
</ol>
<div id="æ•°æ®" class="section level2">
<h2><span class="header-section-number">8.1</span> æ•°æ®</h2>
<p>æ•°æ®é›†åˆ’åˆ†ï¼š80%è®­ç»ƒé›†ï¼Œ20%æµ‹è¯•é›†ã€‚æœ‰ç€ç›¸åŒ<code>group_id</code>çš„æ•°æ®ä¼šè¢«åŒæ—¶åˆ’åˆ†åˆ°è®­ç»ƒé›†æˆ–è€…æµ‹è¯•é›†ä¸­ä»¥å‡å°‘åå·®å’Œé€‰æ‹©åˆé€‚çš„å‚æ•°ã€‚</p>
</div>
<div id="æ¨¡å‹" class="section level2">
<h2><span class="header-section-number">8.2</span> æ¨¡å‹</h2>
<p>ä»¥ä¸‹è€ƒè™‘ä¸‰ç§æ¨¡å‹ï¼šGLMï¼ŒXGBoostï¼ŒNeural Networkã€‚è¿™ä¸‰ç§æ¨¡å‹æœ€å…·æœ‰ä»£è¡¨æ€§ï¼ŒGLMæ˜¯ä¿é™©æŸå¤±é¢„æµ‹ä¸­æœ€ç»å…¸çš„æ¨¡å‹ï¼ŒXGBoostæ˜¯åœ¨æ•°æ®åˆ†æç«èµ›ä¸­å¸¸ç”¨çš„æœºå™¨å­¦ä¹ æ–¹æ³•ï¼Œå®ƒä¸å®¹æ˜“è¿‡æ‹Ÿåˆï¼Œç¥ç»ç½‘ç»œåŒ…å«äº†å¾ˆå¤šç§layerï¼Œåœ¨å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†ä¸­å‘æŒ¥äº†å·¨å¤§çš„ä½œç”¨ã€‚</p>
<div id="glm" class="section level3">
<h3><span class="header-section-number">8.2.1</span> GLM</h3>
<p>GLMçš„ä¼˜ç‚¹:</p>
<ul>
<li><p>è§£é‡Šæ€§å¼ºï¼Œç»Ÿè®¡æ£€éªŒè¯†åˆ«å‚æ•°æ˜¾è‘—æ€§ã€‚</p></li>
<li><p>æ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥åŠ å…¥äº¤äº’é¡¹ã€å˜å½¢åçš„è§£é‡Šå˜é‡ã€å¯ä»¥ç”¨éçº¿æ€§ç»“æ„ï¼ˆæ ·æ¡æ›²çº¿å¹³æ»‘ï¼‰ã€‚</p></li>
</ul>
<p>è€ƒè™‘ä¸å¸¦äº¤å‰é¡¹çš„æ³Šæ¾GLMæ¨¡å‹ï¼š<code>VehAge</code>å’Œ<code>DrivAge</code>éƒ½ç”¨äº†è‡ªç„¶ä¸‰æ¬¡æ ·æ¡è¿›è¡Œå¹³æ»‘ã€‚</p>
<p><span class="math display">\[N_i \sim \text{Poi} (e_i\lambda(\boldsymbol{x_i}))\]</span>
æœ‰ä¸¤ç§ç­‰ä»·å»ºæ¨¡æ–¹å¼ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>æŠŠ<span class="math inline">\(\ln e_i\)</span>çš„ç³»æ•°å›ºå®šä¸º1ã€‚<code>glm (N ~ x + offset (log (e)), family = poisson (link=log) )</code></p></li>
<li><p>æŠŠ<span class="math inline">\(N_i/e_i\)</span>å½“ä½œå› å˜é‡ï¼Œæ¯ä¸ªæ ·æœ¬çš„æƒé‡ä¸º<span class="math inline">\(e_i\)</span>ã€‚<code>glm ( I(N/e) ~ x, weights = e, family = poisson (link=log) )</code></p></li>
</ol>
</div>
<div id="xgboost-1" class="section level3">
<h3><span class="header-section-number">8.2.2</span> XGBoost</h3>
<p>ç”¨è®­ç»ƒé›†ä¸Šäº”æŠ˜äº¤å‰éªŒè¯æ¥é€‰æ‹©è¶…å‚æ•°ã€‚</p>
</div>
<div id="ç¥ç»ç½‘ç»œ-1" class="section level3">
<h3><span class="header-section-number">8.2.3</span> ç¥ç»ç½‘ç»œ</h3>
<p>é€‰å–çš„ç¥ç»ç½‘ç»œæœ‰ä»¥ä¸‹ç»“æ„ï¼š</p>
<ul>
<li><p>å‰é¦ˆå…¨è¿æ¥ç¥ç»ç½‘ç»œï¼Œå«æœ‰ä¸‰ä¸ªéšè—å±‚ï¼Œç¥ç»å…ƒæ•°é‡<span class="math inline">\(20-15-10\)</span>ï¼ŒåŒæ›²æ­£åˆ‡æ¿€æ´»å‡½æ•°ã€‚</p></li>
<li><p>è¾“å‡ºç¥ç»å…ƒï¼ˆç´¢èµ”é¢‘ç‡ï¼‰çš„æ¿€æ´»å‡½æ•°ä½¿ç”¨å¹‚å‡½æ•°ï¼Œå³ä½¿ç”¨æ³Šæ¾æ¨¡å‹ä¸­çš„è§„èŒƒè¿æ¥å‡½æ•°ï¼ˆcanonical link functionï¼‰ã€‚</p></li>
<li><p>è®­ç»ƒæ¨¡å‹çš„å‚æ•°ä½¿ç”¨Nesterov Adam optimizerï¼Œé€‰æ‹©<code>batch sizes=10000, epochs=300ï¼Œlearning rate=0.002</code>ã€‚</p></li>
<li><p>ä¸ºäº†æ¶ˆé™¤åœ¨è®­ç»ƒé›†ä¸Šçš„æ€»ä½“ç´¢èµ”é¢‘ç‡åå·®ï¼ˆportfolio unbiasedï¼‰ï¼Œåœ¨æœ€åç¬¬ä¸‰ä¸ªéšè—å±‚çš„10ä¸ªç¥ç»å…ƒä¸Šå»ºç«‹Poisson-GLMæ¨¡å‹ã€‚ç”±äºPoisson-GLMçš„å‚æ•°ä¼°è®¡ä¸ºæå¤§ä¼¼ç„¶ï¼Œå…¶æ€»ä½“é¢„æµ‹ç´¢èµ”é¢‘ç‡ç­‰äºæ ·æœ¬çš„æ€»ç»éªŒç´¢èµ”é¢‘ç‡ã€‚</p></li>
</ul>
</div>
</div>
<div id="æ¨¡å‹æ•´ä½“è¡¨ç°-model-performance" class="section level2">
<h2><span class="header-section-number">8.3</span> æ¨¡å‹æ•´ä½“è¡¨ç° ï¼ˆmodel performanceï¼‰</h2>
<p><strong>æ€§èƒ½æŒ‡æ ‡ï¼ŒæŸå¤±å‡½æ•°</strong></p>
<p>æ³Šæ¾åå·®æŸå¤±
<span class="math display">\[D(\boldsymbol{y},\hat{\boldsymbol{y}})=\frac{\sum_{i=1}^n e_iL(y_i,\hat{y}_i)}{\sum_{i=1}^n e_i}\]</span></p>
<p>å…¶ä¸­<span class="math inline">\(y_i=N_i/e_i\)</span>, <span class="math inline">\(\hat{y}_i\)</span> ä¸º<span class="math inline">\(y_i\)</span>çš„é¢„æµ‹å€¼ï¼Œå•ä½æ³Šæ¾åå·®<span class="math inline">\(L(y_i,\hat{y_i})\)</span>ä¸ºï¼š
<span class="math display">\[\begin{equation}
L(y_i,\hat{y}_i)=2(y_i\ln y_i-y_i\ln\hat{y}_i-y_i+\hat{y}_i). (\#eq:loss)
\end{equation}\]</span></p>
<p>Note that the Poisson deviance @ref(eq:loss) is a strictly consistent scoring function for the expectation <span class="math inline">\(\mathbb{E}(Y)\)</span>.</p>
<p><strong>Pseudo <span class="math inline">\(R^2\)</span></strong></p>
<p><span class="math display">\[\text{Pseudo}~~ R^2=1-\frac{D(\boldsymbol{y},\hat{\boldsymbol{y}})}{D(\boldsymbol{y},\bar{\boldsymbol{y}})}\]</span></p>
<p>Pseudo <span class="math inline">\(R^2\)</span>ä¸ºåå·®æŸå¤±å‡å°‘çš„ç›¸å¯¹å€¼ï¼Œè¡¡é‡äº†å¯ä»¥è¢«æ¨¡å‹è§£é‡Šçš„åå·®æ¯”ä¾‹ã€‚</p>
</div>
<div id="å˜é‡é‡è¦æ€§variable-importance" class="section level2">
<h2><span class="header-section-number">8.4</span> å˜é‡é‡è¦æ€§ï¼ˆvariable importanceï¼‰</h2>
<p>å®ƒæä¾›äº†é¢å¤–çš„ä¿¡æ¯ï¼Œä»è€Œä½¿æˆ‘ä»¬èƒ½æ›´æ·±å…¥çš„äº†è§£æ¨¡å‹ã€‚å¯ä»¥é€šè¿‡åˆ æ‰å¯¹æ¨¡å‹ä¸é‡è¦çš„å˜é‡ä»è€Œç®€åŒ–æ¨¡å‹ã€‚å¯ä»¥å‘ç°æ•°æ®ç»“æ„ä¸­çš„é—®é¢˜ï¼šå¦‚æœä¸€ä¸ªåå˜é‡æ˜¾ç¤ºå‡ºéå¸¸ç›¸å…³è€Œå…¶ä»–å˜é‡éå¸¸ä¸ç›¸å…³ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå“åº”å˜é‡å‘ç”Ÿäº†ä¿¡æ¯æ³„éœ²ã€‚</p>
<p>GLMæ¨¡å‹å¯ä»¥ç”¨ä¼¼ç„¶æ¯”æ£€éªŒç»Ÿè®¡é‡ã€<span class="math inline">\(t\)</span>-æ£€éªŒã€‚åŸºäºæ ‘çš„æ¨¡å‹å¯ä»¥ç”¨å˜é‡çš„æ‹†åˆ†æ•°é‡ã€split gainsã€‚</p>
<div id="permutation-importance" class="section level3">
<h3><span class="header-section-number">8.4.1</span> Permutation importance</h3>
<p>å¯¹äºä¸€ä¸ªåå˜é‡ï¼Œå®ƒçš„å€¼è¢«éšæœºç½®æ¢ï¼Œç„¶ååœ¨æ–°çš„åå˜é‡æ¡ä»¶ä¸‹é¢„æµ‹<span class="math inline">\(\tilde{\boldsymbol{y}}\)</span>ï¼Œè¿›è€Œè®¡ç®—D(,)ã€‚è¯¥å˜é‡çš„é‡è¦æ€§å¯ä»¥é€šè¿‡<span class="math inline">\(D(\boldsymbol{y},\tilde{\boldsymbol{y}})-D(\boldsymbol{y},\hat{\boldsymbol{y}})\)</span>åº¦é‡ã€‚</p>
<p>å¯¹äºæ•°æ®é‡å¤§çš„æ ·æœ¬ï¼Œä¸€æ¬¡ç½®æ¢å³å¯å¾—åˆ°å¹³ç¨³çš„ç»“æœï¼›å¯¹äºæ•°æ®é‡å°çš„æ ·æœ¬ï¼Œéœ€è¦ç½®æ¢å¤šæ¬¡å¹¶è®¡ç®—å¹³å‡ã€‚</p>
</div>
</div>
<div id="è¾¹ç¼˜æ•ˆåº”ä¸»æ•ˆåº”" class="section level2">
<h2><span class="header-section-number">8.5</span> è¾¹ç¼˜æ•ˆåº”ï¼ˆä¸»æ•ˆåº”ï¼‰</h2>
<p>å¦‚ä½•è¡¡é‡å…·æœ‰å¤æ‚éçº¿æ€§é¡¹å’Œé«˜é˜¶äº¤äº’ä½œç”¨çš„GLMæ¨¡å‹ï¼Œæˆ–é»‘ç®±æ¨¡å‹ä¸­åå˜é‡å¯¹å“åº”å˜é‡çš„æ•ˆåº”ï¼Ÿ</p>
<p><strong>åŸºæœ¬æ€è·¯</strong>ï¼šå½“åå˜é‡åœ¨å…¶å–å€¼èŒƒå›´å†…å˜åŠ¨æ—¶ï¼Œé¢„æµ‹å€¼æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚</p>
<p><strong>ä½¿ç”¨è®­ç»ƒé›†è¿˜æ˜¯æµ‹è¯•é›†ï¼Ÿ</strong> å¦‚æœåªä½¿ç”¨æ¨¡å‹çš„é¢„æµ‹å€¼ï¼Œåˆ™è®­ç»ƒé›†æˆ–æµ‹è¯•é›†éƒ½å¯ä»¥ã€‚å¦‚æœä½¿ç”¨å› å˜é‡çš„å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨æµ‹è¯•é›†ã€‚</p>
<p>ä»¥ä¸‹è€ƒè™‘ä¸‰ç§model agnostic methods: individual conditional expectations (ICE), partial dependence profiles (PD), accumulated local effects profiles (ALE)ã€‚å…¶ä¸­ï¼Œç¬¬ä¸€ç§æ˜¯åä¸¤ç§çš„åŸºç¡€ã€‚</p>
<div id="individual-conditional-expectationsice" class="section level3">
<h3><span class="header-section-number">8.5.1</span> Individual conditional expectationsï¼ˆICEï¼‰</h3>
<p>å¯¹äºæ¯ä¸ªæ ·æœ¬<span class="math inline">\((N_i,e_i,\boldsymbol{x}_i), i=1,\ldots,n\)</span>, ä½¿å…¶åå˜é‡<span class="math inline">\(x_{i,p}\)</span>åœ¨å–å€¼èŒƒå›´å†…å˜åŒ–ï¼Œi.e., <span class="math inline">\(\{a_1,a_2,\ldots,a_m\}\)</span>ï¼Œæ ¹æ®æ¨¡å‹é¢„æµ‹åœ¨ä¸åŒåå˜é‡å€¼ä¸‹çš„ç´¢èµ”é¢‘ç‡ï¼Œ<span class="math display">\[y_i^{(ice)}=\{\hat{y}_i(\boldsymbol{x}_{i,-p},x_{i,p}=a):a=a_1,\dots,a_m\}\]</span></p>
<p>ä»¥<span class="math inline">\(x_p\)</span>ä¸ºæ¨ªè½´ï¼Œ<span class="math inline">\(y^{(ice)}\)</span>ä¸ºçºµè½´ï¼Œå¯¹äºæ¯ä¸ªæ ·æœ¬éƒ½å¯ä»¥ç”»å‡ºä¸€æ¡ICEæ›²çº¿ã€‚ICE profileså›¾åƒæœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<ul>
<li><p>å¦‚æœåå˜é‡æ˜¯ä»¥ç›¸åŠ çš„æ¨¡å¼åœ¨æ¨¡å‹ä¸­ï¼ˆçº¿æ€§æ¨¡å‹ï¼‰ï¼Œåˆ™ä¸åŒæ ·æœ¬ICEæ›²çº¿åº”è¯¥æ˜¯å¹³è¡Œçš„ã€‚</p></li>
<li><p><span class="math inline">\(x_p\)</span>ä¸å…¶ä»–å˜é‡çš„äº¤äº’ä½œç”¨è¶Šå¼ºï¼Œä¸åŒæ ·æœ¬çš„ICEæ›²çº¿ä¼šç›¸äº¤ã€‚</p></li>
<li><p>ä¸ºäº†æ›´å¥½è§£è¯»ICEå›¾åƒï¼Œå¯ä»¥å‚ç›´ç§»åŠ¨ICEæ›²çº¿ä½¿å¾—å®ƒä»¬åœ¨ä¸€ä¸ªç‚¹é‡åˆã€‚</p></li>
</ul>
<p><strong>Remark</strong>ï¼šä¸€äº›ä¸»è¦çš„boostingç®—æ³•ï¼Œå¦‚XGBoostã€LightGBMæˆ–è€…CatBoostï¼Œåœ¨å»ºæ¨¡æ—¶å¯ä»¥çº¦æŸåå˜é‡çš„å•è°ƒæ€§ï¼Œè¿™æ ·å¯ä»¥å¢åŠ æ¨¡å‹çš„å¯è§£é‡Šæ€§ã€‚åœ¨ç²¾ç®—ä¸­ï¼Œå¸¸å¸¸ä½¿ç”¨çš„çº¦æŸå¦‚é«˜å…èµ”é¢çš„ç´¢èµ”é¢‘ç‡ä½äºä½å…èµ”é¢çš„ç´¢èµ”é¢‘ç‡ã€‚XGBoostçš„ç›¸åº”ä»£ç ä¸º<code>monotone_constraints = c(0,-1,0,0,0,0,0)</code>ã€‚</p>
</div>
<div id="partial-dependence-profiles" class="section level3">
<h3><span class="header-section-number">8.5.2</span> Partial dependence profiles</h3>
<p>Partial dependence profileå®šä¹‰ä¸ºICEçš„å¹³å‡å€¼<span class="math display">\[\bar{f}_l(a)=\frac{1}{n}\sum_{i=1}^n\hat{y}_i(\boldsymbol{x}_{i,-p},x_{i,p}=a)\]</span>
å®ƒåæ˜ äº†åå˜é‡åœ¨è¿™ä¸ªæ ·æœ¬ä¸Šçš„å¹³å‡æ•ˆåº”ï¼Œå’Œæ ·æœ¬ä¸­å…¶ä»–åå˜é‡çš„åˆ†å¸ƒæœ‰å…³ã€‚</p>
<p>ICEå’Œpartial dependence profileséƒ½å¯ä»¥æ¨å¹¿åˆ°å¤šä¸ªåå˜é‡ã€‚</p>
</div>
<div id="accumulated-local-effects-profiles-ale" class="section level3">
<h3><span class="header-section-number">8.5.3</span> Accumulated local effects profiles (ALE)</h3>
<p>ICEå’Œpartial dependence profile å‡å®šæŸä¸ªåå˜é‡å˜åŒ–è€Œæ ·æœ¬çš„å…¶ä»–å˜é‡ä¿æŒä¸å˜ï¼ˆCeteris Paribus assumptionï¼‰ã€‚è¿™ä¸ªå‡è®¾åœ¨å®é™…ä¸­å¸¸å¸¸æ˜¯ä¸æˆç«‹çš„ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å›ºå®šåœ°åŒºè€Œè®©äººå£å¯†åº¦å˜åŒ–ã€‚</p>
<p>ALEä¸€å®šç¨‹åº¦ä¸Šå…‹æœäº†ä»¥ä¸Šç¼ºç‚¹ï¼Œå®ƒè€ƒè™‘äº†å±€éƒ¨æ•ˆåº”ï¼Œåœ¨è¾ƒå¼ºç›¸å…³æ€§çš„åå˜é‡çš„æƒ…å†µä¸‹èƒ½è·å¾—æ›´è‡ªç„¶ã€å°‘åçš„ç»“æœã€‚ALE profileä¸º</p>
<p><span class="math display">\[\tilde{f}_l(a)=\frac{1}{|\mathcal{I}_{x_p}(a)|}\sum_{i\in\mathcal{I}_{x_p}(a)}\hat{y}_i(\boldsymbol{x}_{i,-p},x_{i,p}=a)\]</span>
å…¶ä¸­<span class="math inline">\(\mathcal{I}_{x_p}(a)=\{i:x_{i,p}\in[a-\epsilon,a+\epsilon]\}\)</span>ã€‚å³ALEä¸ºå±€éƒ¨ICEçš„å¹³å‡ï¼ˆpartial dependence profileä¸ºæ‰€æœ‰ICEçš„å¹³å‡ï¼‰ã€‚
å¦‚æœåå˜é‡çš„äº¤äº’ä½œç”¨ä¸å¼ºæˆ–è€…ä¸å…¶ä»–åå˜é‡ç›¸å…³æ€§å¼ºï¼Œåˆ™ALEå›¾ä¼šæ¥è¿‘äºpartial dependence profileå›¾ã€‚</p>
<p><strong>Further profile plots</strong></p>
<p>ä»¥ä¸‹æ–¹æ³•æ¥è‡ªçº¿æ€§æ¨¡å‹çš„ä¼ ç»Ÿè¯Šæ–­æ–¹æ³•ã€‚</p>
<ol style="list-style-type: decimal">
<li><p>å“åº”å˜é‡-åå˜é‡å›¾ï¼šAverages (or boxplots) of responses are plotted against a covariableã€‚è¯¥æ–¹æ³•æ²¡æœ‰ä½¿ç”¨æ¨¡å‹ï¼Œåªæ˜¯æ•°æ®çš„ä¸€ç§å¯è§†åŒ–å·¥å…·ã€‚</p></li>
<li><p>é¢„æµ‹å€¼-åå˜é‡å›¾ï¼ˆè¾¹é™…æ•ˆåº”å›¾ï¼‰ï¼šAverages of predicted values are plotted against a covariableï¼ˆmarginal plot or M-plotï¼‰ã€‚</p></li>
<li><p>æ®‹å·®-åå˜é‡å›¾ï¼š Averages (or boxplots) of residuals are plotted against a covariableã€‚å¹³å‡æ®‹å·®åº”è¯¥å……åˆ†åœ°æ¥è¿‘é›¶ï¼Œå¦‚æœå¹³å‡æ®‹å·®ç³»ç»Ÿçš„ä¸ä¸ºé›¶ï¼Œè¯´æ˜æ¨¡å‹æ‹Ÿåˆçš„ä¸å¥½ã€‚å¦‚æœè®­ç»ƒé›†ä¸Šå¹³å‡æ®‹å·®æ¥è¿‘é›¶ä½†æµ‹è¯•é›†ä¸Šå¹³å‡æ®‹å·®ä¸ä¸ºé›¶ï¼Œåˆ™è¯´æ˜æœ‰è¿‡æ‹Ÿåˆé—®é¢˜ã€‚</p></li>
</ol>
</div>
</div>
<div id="äº¤äº’æ•ˆåº”" class="section level2">
<h2><span class="header-section-number">8.6</span> äº¤äº’æ•ˆåº”</h2>
<p>åå˜é‡<span class="math inline">\(x_l,x_k\)</span>çš„äº¤äº’ä½œç”¨å¯ä»¥ç”¨ä¸¤ä¸ªå˜é‡çš„Friedmanâ€™s H-statisticåº¦é‡ï¼š
<span class="math display">\[H^2_{kl}=\frac{\sum_1^n\left[\bar{f}_{kl}(x_{i,k},x_{i,l})-\bar{f}_{k}(x_{i,k})-\bar{f}_{l}(x_{i,l})\right]^2}{\sum_i^n\left[\bar{f}_{kl}(x_{i,k},x_{i,l})\right]^2}\]</span></p>
<p>ä¸Šå¼åˆ†å­ä¸ºäº¤äº’æ•ˆåº”ï¼Œåˆ†æ¯ä¸ºè”åˆæ•ˆåº”ï¼Œå¯ä»¥è¿‘ä¼¼è®¤ä¸ºè”åˆæ•ˆåº” = è¾¹ç¼˜ï¼ˆä¸»ï¼‰æ•ˆåº” + äº¤äº’æ•ˆåº”ã€‚
å¦‚æœ<span class="math inline">\(x_k,x_l\)</span>æ— äº¤äº’ä½œç”¨ï¼Œåˆ™Friedmanâ€™s H-statisticä¸º<span class="math inline">\(0\)</span>ï¼›å¦‚æœå®ƒä»¬æœ‰å¼ºçƒˆçš„äº¤äº’ä½œç”¨ï¼Œåˆ™Friedmanâ€™s H-statisticæ¥è¿‘<span class="math inline">\(1\)</span>ã€‚</p>
<p>äº¤äº’æ•ˆåº”çš„ç»å¯¹åº¦é‡å®šä¹‰ä¸º<span class="math inline">\(H^2_{kl}\)</span>åˆ†å­çš„æ­£å¹³æ–¹æ ¹ï¼š
<span class="math display">\[H_{kl}=\sqrt{\sum_1^n\left[\bar{f}_{kl}(x_{i,k},x_{i,l})-\bar{f}_{k}(x_{i,k})-\bar{f}_{l}(x_{i,l})\right]^2}\]</span>
å®ƒå¯ä»¥ç”¨æ¥å¯¹äº¤äº’æ•ˆåº”æ’åºã€‚</p>
<p>äº¤äº’æ•ˆåº”çš„å¯è§†åŒ–æœ‰ä¸¤ç§åŸºæœ¬æ–¹æ³•ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>éƒ½ä¸ºè¿ç»­å‹åå˜é‡ï¼š<span class="math inline">\(\bar{f}_{kl}(x_k,x_l)\)</span>çš„ç­‰é«˜çº¿å›¾ã€‚</p></li>
<li><p>åˆ†ç±»å˜é‡<span class="math inline">\(x_k\)</span>å’Œè¿ç»­å‹å˜é‡<span class="math inline">\(x_l\)</span>ï¼šåœ¨<span class="math inline">\(x_k\)</span>çš„æŸä¸€æ°´å¹³<span class="math inline">\(a\)</span>ä¸‹ï¼Œç”»<span class="math inline">\(\bar{f}_{kl}(x_k=a,x_l)\)</span>éš<span class="math inline">\(x_l\)</span>çš„å˜åŒ–è¶‹åŠ¿å›¾ã€‚</p></li>
</ol>
<p><strong>äº¤äº’é¡¹çº¦æŸ</strong></p>
<p>æœ‰æ—¶åŸºäºæŠ€æœ¯æˆ–ç›‘ç®¡çš„ç°å®æƒ…å†µï¼Œäº¤äº’é¡¹åœ¨æ¨¡å‹ä¸­ä¼šè¢«ç¦ç”¨ã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œå¯ä»¥å°†ä¸è€ƒè™‘äº¤äº’æ•ˆåº”çš„å˜é‡ç›´æ¥è¿æ¥åˆ°è¾“å‡ºç¥ç»å…ƒã€‚åœ¨XGBoostä¸­ï¼Œå¯ä»¥é€šè¿‡æ”¹å˜<code>interaction_constraints</code>å®ç°äº¤äº’é¡¹çº¦æŸã€‚</p>
</div>
<div id="å…¨å±€ä»£ç†æ¨¡å‹global-surrogate-models" class="section level2">
<h2><span class="header-section-number">8.7</span> å…¨å±€ä»£ç†æ¨¡å‹ï¼ˆGlobal surrogate modelsï¼‰</h2>
<p>å¯¹é¢„æµ‹å€¼é‡æ–°ä½¿ç”¨æ˜“äºè§£é‡Šçš„æ¨¡å‹è¿›è¡Œå»ºæ¨¡ï¼Œå¦‚ä½¿ç”¨å•æ£µå†³ç­–æ ‘ã€‚ç„¶åå†ç”¨è¿™ä¸ªglobal surrogate model (tree) æ¥è¿›è¡Œè§£é‡Šã€‚
ä¸ºäº†è¯„åˆ¤æ›¿ä»£æ¨¡å‹çš„è¿‘ä¼¼æ•ˆæœï¼Œæœ‰å­¦è€…å»ºè®®ä½¿ç”¨<span class="math inline">\(R^2\)</span>ã€‚</p>
</div>
<div id="å±€éƒ¨è§£é‡Šæ ·æœ¬è§£é‡Š" class="section level2">
<h2><span class="header-section-number">8.8</span> å±€éƒ¨è§£é‡Šï¼ˆæ ·æœ¬è§£é‡Šï¼Ÿï¼‰</h2>
<p>ä»¥ä¸‹ä¸»è¦è€ƒè™‘å››ç§model agnostic methodsï¼šLIMEï¼ŒLIVEï¼ŒSHAPï¼ŒBreakdownã€‚</p>
<div id="limeå’Œlive" class="section level3">
<h3><span class="header-section-number">8.8.1</span> LIMEå’ŒLIVE</h3>
<p>LIMEå…¨ç§°Local Interpretable Model-agnostic Explanationsï¼Œå³æ¨¡å‹çš„å±€éƒ¨è§£é‡Šå™¨ã€‚è™½ç„¶æ— æ³•ä½¿ç”¨çº¿æ€§æ¨¡å‹å®Œå…¨â€œæ¨¡ä»¿â€å‡ºSVMã€ç¥ç»ç½‘ç»œç­‰æ¨¡å‹çš„â€œè¡Œä¸ºâ€ï¼Œä½†å¯ä»¥åœ¨æŸä¸ªå±€éƒ¨æ ·æœ¬ç‚¹ä¸Šæ¥è¿‘.</p>
<p>LIMEå’ŒLIVEä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>æ„é€ å¯è§£é‡Šçš„æ•°æ®ç‰¹å¾ï¼š??æ˜¯åŸå§‹ç”¨äºæ¨¡å‹é¢„æµ‹çš„ç‰¹å¾ï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨??æ¥è¡¨ç¤ºæŸä¸ªå¯è§£é‡Šç‰¹å¾æ˜¯å¦å­˜åœ¨çš„äºŒå…ƒå˜é‡ã€‚</p></li>
<li><p>æ„é€ ç›®æ ‡å‡½æ•°ï¼š<span class="math display">\[\xi(x)=\underset{g\in G}{\arg\min}~\mathcal{L(f,g,\pi_x)+\Omega(g)}\]</span></p></li>
<li><p>é‡‡æ ·ï¼š</p></li>
</ol>
<p>LIMEçš„ä¼˜ç‚¹æ˜¯åŸç†ç®€å•ï¼Œé€‚ç”¨èŒƒå›´å¹¿ï¼Œå¯è§£é‡Šæ‰€æœ‰é»‘ç®±æ¨¡å‹ã€‚ä½†ä¹Ÿå­˜åœ¨ä¸€å®šçš„é—®é¢˜ï¼Œä¾‹å¦‚å±€éƒ¨èŒƒå›´å¤§å°ä¸åŒï¼Œæœ€ç»ˆçš„è§£é‡Šä¹Ÿä¼šä¸åŒç”šè‡³ç›¸æ‚–ã€‚</p>
<div class="figure" style="text-align: center">
<img src="./plots/8/lime.png" alt="LIME" width="50%" />
<p class="caption">
(#fig:lime)LIME
</p>
</div>
</div>
<div id="shapshapley-additive-explanations" class="section level3">
<h3><span class="header-section-number">8.8.2</span> SHAP(Shapley Additive Explanations)</h3>
<p>SHAPçš„ç›®çš„ï¼šä¸LIMEç›¸ä¼¼ï¼Œæ‰¾åˆ°æŸä¸ªæ ·æœ¬ç‚¹ä¸Šå„ä¸ªç‰¹å¾çš„é‡è¦æ€§</p>
<p>Shapleyå€¼æ¥è‡ªåˆä½œåšå¼ˆè®ºï¼Œä»ä¸åŒçš„åˆä½œç»„åˆä¸­è®¡ç®—å‡ºå•ä¸ªä¸ªä½“çš„è´¡çŒ®ï¼Œå®ƒåº¦é‡äº†å•ä¸ªä¸ªä½“å¯¹æ€»ä½“çš„è¾¹é™…è´¡çŒ®ã€‚SHAPçš„ä¸»è¦æ€æƒ³æ¥æºäºShapleyå€¼</p>
<p>Shapleyå€¼çš„è®¡ç®—</p>
<p><strong>ä»Shapleyå€¼åˆ°SHAP</strong></p>
<ul>
<li><p>SHAPå¯¹é¢„æµ‹çš„åˆ†è§£ï¼š</p></li>
<li><p>SHAPä¸­ç‰¹å¾è´¡çŒ®çš„è®¡ç®—</p></li>
</ul>
<p>SHAPæŠŠé»‘ç®±ä¸­å¤æ‚çš„æ˜ å°„å…³ç³»è¡¨è¾¾æˆä¸€ä¸ªç®€å•çº¿æ€§æ˜ å°„ï¼Œä¾¿äºæŠŠä¿è´¹çš„æ„æˆè§£é‡Šç»™è¢«ä¿é™©äººã€‚ä½†æ˜¯ï¼Œå¯¹äºä¸åŒè¢«ä¿é™©äººï¼ŒåŒä¸€ä¸ªåå˜é‡å€¼çš„æ•ˆåº”ï¼ˆSHAPï¼‰å¯èƒ½ä¸åŒï¼Œè¿™æ˜¯SHAPçš„ç¼ºç‚¹ã€‚ï¼ˆï¼Ÿæˆ‘ä¸å¤ªç¡®å®šæœ€åä¸€å¥è¯ï¼‰</p>
</div>
<div id="breakdown-and-approximate-shap" class="section level3">
<h3><span class="header-section-number">8.8.3</span> Breakdown and approximate SHAP</h3>
<p>å¯¹äºä¸€ç»„ç»™å®šè¿›å…¥é¡ºåºçš„å˜é‡<span class="math inline">\(x_{(1)},x_{(2)},\ldots,x_{(p)}\)</span>ï¼Œè§£æ„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol style="list-style-type: decimal">
<li>åˆå§‹é¢„æµ‹<span class="math inline">\(\hat{y}^{(0)}_i\)</span>ä¸ºè®­ç»ƒé›†çš„ç´¢èµ”é¢‘ç‡å‡å€¼</li>
</ol>
<p>å¯¹äº<span class="math inline">\(l=1,\ldots,p\)</span>ï¼Œè¿›è¡Œä»¥ä¸‹ä¸¤æ­¥ï¼š</p>
<ol start="2" style="list-style-type: decimal">
<li><p>æŠŠæ‰€æœ‰æ ·æœ¬çš„<span class="math inline">\(x_{(l)}\)</span>å˜ä¸º<span class="math inline">\(x_{i,(l)}\)</span>ï¼Œè®¡ç®—æ‰€æœ‰æ ·æœ¬ä¸Šé¢„æµ‹ç´¢èµ”é¢‘ç‡å‡å€¼<span class="math inline">\(\hat{y}^{(l)}_i\)</span>.</p></li>
<li><p>è®¡ç®—<span class="math inline">\(x_{(l)}\)</span>çš„æ•ˆåº”ï¼š<span class="math inline">\(\hat{y}^{(l)}_i-\hat{y}^{(l-1)}_i\)</span></p></li>
</ol>
<p>å¯è§Breakdownæ–¹æ³•å¾—å‡ºçš„ç»“æœæ˜¯å’Œé¡ºåº<span class="math inline">\(x_{(1)},x_{(2)},\ldots,x_{(p)}\)</span>ç›¸å…³çš„ã€‚å¯¹äº<span class="math inline">\(p\)</span>ä¸ªå˜é‡ï¼Œæœ‰<span class="math inline">\(p!\)</span>ç§æ’åˆ—æ–¹å¼ã€‚ä¸€ç§å¤„ç†æ–¹æ³•æ˜¯é‡‡å–å°‘é‡çš„æ’åˆ—æ–¹å¼ï¼Œå¦‚20ç§ï¼Œå–å¹³å‡ã€‚å¦ä¸€ç§æ˜¯æŒ‰ç…§å˜é‡é‡è¦æ€§é™åºè¿›å…¥ï¼Œè¿™é‡Œå°†å‰è€…ç§°ä¸º<strong>approximate SHAP</strong>ï¼Œå°†åè€…ç§°ä¸º<strong>breakdown</strong>ã€‚</p>
</div>
<div id="from-local-to-global-properties" class="section level3">
<h3><span class="header-section-number">8.8.4</span> From local to global properties</h3>
<p>å°†å¤šä¸ªæ ·æœ¬ä½¿ç”¨SHAPæˆ–breakdownè¿›è¡Œåˆ†è§£ï¼Œç„¶åä¹Ÿå¯ä»¥å¾—åˆ°ä¸€äº›æ¨¡å‹çš„å…¨å±€æ€§è´¨ï¼š</p>
<ol style="list-style-type: decimal">
<li><p>å˜é‡é‡è¦æ€§</p></li>
<li><p>ä¸»æ•ˆåº”</p></li>
<li><p>äº¤äº’æ•ˆåº”</p></li>
</ol>
</div>
</div>
<div id="improving-the-glm-by-interpretable-machine-learning" class="section level2">
<h2><span class="header-section-number">8.9</span> Improving the GLM by interpretable machine learning</h2>
<p>é€šè¿‡ä¹‹å‰çš„ç»“æœæ”¹è¿›GLMæ¨¡å‹ï¼š</p>
<p>1.å»ºç«‹ç®€å•çš„GLMæ¨¡å‹å’Œè°ƒä¼˜çš„MLæ¨¡å‹</p>
<p>2.æ¯”è¾ƒæ€§èƒ½ï¼Œå¦‚æœGLMæ¨¡å‹æ²¡æœ‰æ”¹è¿›ç©ºé—´å°±åœæ­¢</p>
<p>3.ç ”ç©¶å˜é‡é‡è¦æ€§å†³å®šä¿ç•™å“ªäº›å˜é‡</p>
<p>4.é€šè¿‡å¯¹é¢„æµ‹çš„å½±å“æ•ˆæœï¼Œæ‰¾å‡ºæœ€å¼ºçš„é¢„æµ‹å› ç´ ï¼Œä»¥è°ƒæ•´å˜é‡ï¼ˆå¹³æ–¹é¡¹ã€æ ·æ¡ã€åˆ å»éƒ¨åˆ†ç±»ç­‰ï¼‰</p>
<p>5.æ ¹æ®ç›¸äº’ä½œç”¨å¼ºåº¦æ”¹è¿›äº¤äº’é¡¹</p>
<p>6.åˆ©ç”¨ä»¥ä¸Šå› ç´ æ”¹è¿›GLMï¼Œç„¶åå›åˆ°ç¬¬äºŒæ­¥</p>
<ul>
<li><p>æ ¹æ®Variable importanceï¼Œä¸åˆ é™¤å˜é‡</p></li>
<li><p>æ ¹æ®Partial dependence profilesï¼ŒlogDensityç”¨ä¸‰æ¬¡æ ·æ¡å‡½æ•°è¡¨ç¤º</p></li>
<li><p>æ ¹æ®Interaction strengthï¼Œå¢åŠ VehAge:VehBrandï¼ŒVehBrand:VehGasçš„äº¤äº’ä½œç”¨</p></li>
</ul>
<p>åŸºäºä»¥ä¸Šæ”¹è¿›å»ºç«‹æ–°çš„glm</p>
</div>
<div id="æ¡ˆä¾‹åˆ†æ" class="section level2">
<h2><span class="header-section-number">8.10</span> æ¡ˆä¾‹åˆ†æ</h2>
<div id="å¯¼å…¥åŒ…" class="section level3">
<h3><span class="header-section-number">8.10.1</span> å¯¼å…¥åŒ…</h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a><span class="kw">library</span>(CASdatasets)      <span class="co"># 1.0.6</span></span>
<span id="cb92-2"><a href="#cb92-2"></a><span class="kw">library</span>(dplyr)            <span class="co"># 0.8.5</span></span>
<span id="cb92-3"><a href="#cb92-3"></a><span class="kw">library</span>(forcats)          <span class="co"># 0.5.0</span></span>
<span id="cb92-4"><a href="#cb92-4"></a><span class="kw">library</span>(reshape2)         <span class="co"># 1.4.3</span></span>
<span id="cb92-5"><a href="#cb92-5"></a><span class="kw">library</span>(corrplot)         <span class="co"># 0.84</span></span>
<span id="cb92-6"><a href="#cb92-6"></a><span class="kw">library</span>(ggplot2)          <span class="co"># 3.3.0</span></span>
<span id="cb92-7"><a href="#cb92-7"></a><span class="kw">library</span>(splines)          <span class="co"># 3.6.3</span></span>
<span id="cb92-8"><a href="#cb92-8"></a><span class="kw">library</span>(splitTools)       <span class="co"># 0.2.0</span></span>
<span id="cb92-9"><a href="#cb92-9"></a><span class="kw">library</span>(xgboost)          <span class="co"># 1.0.0.2</span></span>
<span id="cb92-10"><a href="#cb92-10"></a><span class="kw">library</span>(keras)            <span class="co"># 2.2.5.0</span></span>
<span id="cb92-11"><a href="#cb92-11"></a><span class="kw">library</span>(MetricsWeighted)  <span class="co"># 0.5.0</span></span>
<span id="cb92-12"><a href="#cb92-12"></a><span class="kw">library</span>(flashlight)       <span class="co"># 0.7.2</span></span></code></pre></div>
</div>
<div id="é¢„å¤„ç†-1" class="section level3">
<h3><span class="header-section-number">8.10.2</span> é¢„å¤„ç†</h3>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="kw">data</span>(freMTPL2freq)</span>
<span id="cb93-2"><a href="#cb93-2"></a></span>
<span id="cb93-3"><a href="#cb93-3"></a>distinct &lt;-<span class="st"> </span>freMTPL2freq <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-4"><a href="#cb93-4"></a><span class="st">  </span><span class="kw">distinct_at</span>(<span class="kw">vars</span>(<span class="op">-</span><span class="kw">c</span>(IDpol, Exposure, ClaimNb))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-5"><a href="#cb93-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group_id =</span> <span class="kw">row_number</span>())</span>
<span id="cb93-6"><a href="#cb93-6"></a></span>
<span id="cb93-7"><a href="#cb93-7"></a>dat &lt;-<span class="st"> </span>freMTPL2freq <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-8"><a href="#cb93-8"></a><span class="st">  </span><span class="kw">left_join</span>(distinct) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-9"><a href="#cb93-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Exposure =</span> <span class="kw">pmin</span>(<span class="dv">1</span>, Exposure),</span>
<span id="cb93-10"><a href="#cb93-10"></a>         <span class="dt">Freq =</span> <span class="kw">pmin</span>(<span class="dv">15</span>, ClaimNb <span class="op">/</span><span class="st"> </span>Exposure),</span>
<span id="cb93-11"><a href="#cb93-11"></a>         <span class="dt">VehPower =</span> <span class="kw">pmin</span>(<span class="dv">12</span>, VehPower),</span>
<span id="cb93-12"><a href="#cb93-12"></a>         <span class="dt">VehAge =</span> <span class="kw">pmin</span>(<span class="dv">20</span>, VehAge),</span>
<span id="cb93-13"><a href="#cb93-13"></a>         <span class="dt">VehGas =</span> <span class="kw">factor</span>(VehGas),</span>
<span id="cb93-14"><a href="#cb93-14"></a>         <span class="dt">DrivAge =</span> <span class="kw">pmin</span>(<span class="dv">85</span>, DrivAge),</span>
<span id="cb93-15"><a href="#cb93-15"></a>         <span class="dt">logDensity =</span> <span class="kw">log</span>(Density),</span>
<span id="cb93-16"><a href="#cb93-16"></a>         <span class="dt">VehBrand =</span> <span class="kw">factor</span>(VehBrand, <span class="dt">levels =</span> </span>
<span id="cb93-17"><a href="#cb93-17"></a>                             <span class="kw">paste0</span>(<span class="st">&quot;B&quot;</span>, <span class="kw">c</span>(<span class="dv">12</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">14</span>))),</span>
<span id="cb93-18"><a href="#cb93-18"></a>         <span class="dt">PolicyRegion =</span> <span class="kw">relevel</span>(Region, <span class="st">&quot;Ile-de-France&quot;</span>),</span>
<span id="cb93-19"><a href="#cb93-19"></a>         <span class="dt">AreaCode =</span> Area)</span>
<span id="cb93-20"><a href="#cb93-20"></a></span>
<span id="cb93-21"><a href="#cb93-21"></a><span class="co"># Covariables, Response, Weight</span></span>
<span id="cb93-22"><a href="#cb93-22"></a>x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;VehPower&quot;</span>, <span class="st">&quot;VehAge&quot;</span>,  <span class="st">&quot;VehBrand&quot;</span>, <span class="st">&quot;VehGas&quot;</span>, <span class="st">&quot;DrivAge&quot;</span>,</span>
<span id="cb93-23"><a href="#cb93-23"></a>       <span class="st">&quot;logDensity&quot;</span>, <span class="st">&quot;PolicyRegion&quot;</span>)</span>
<span id="cb93-24"><a href="#cb93-24"></a>y &lt;-<span class="st"> &quot;Freq&quot;</span></span>
<span id="cb93-25"><a href="#cb93-25"></a>w &lt;-<span class="st"> &quot;Exposure&quot;</span></span></code></pre></div>
</div>
<div id="æè¿°æ€§ç»Ÿè®¡" class="section level3">
<h3><span class="header-section-number">8.10.3</span> æè¿°æ€§ç»Ÿè®¡</h3>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># Univariate description</span></span>
<span id="cb94-2"><a href="#cb94-2"></a></span>
<span id="cb94-3"><a href="#cb94-3"></a>melted &lt;-<span class="st"> </span>dat[<span class="kw">c</span>(<span class="st">&quot;Freq&quot;</span>, <span class="st">&quot;Exposure&quot;</span>, <span class="st">&quot;DrivAge&quot;</span>, <span class="st">&quot;VehAge&quot;</span>, <span class="st">&quot;VehPower&quot;</span>, <span class="st">&quot;logDensity&quot;</span>)] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-4"><a href="#cb94-4"></a><span class="st">  </span><span class="kw">stack</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-5"><a href="#cb94-5"></a><span class="st">  </span><span class="kw">filter</span>(ind <span class="op">!=</span><span class="st"> &quot;Freq&quot;</span> <span class="op">|</span><span class="st"> </span>values <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-6"><a href="#cb94-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ind =</span> <span class="kw">fct_recode</span>(ind, </span>
<span id="cb94-7"><a href="#cb94-7"></a>                          <span class="st">`</span><span class="dt">Driver&#39;s age</span><span class="st">`</span> =<span class="st"> &quot;DrivAge&quot;</span>, </span>
<span id="cb94-8"><a href="#cb94-8"></a>                          <span class="st">`</span><span class="dt">Vehicle&#39;s age</span><span class="st">`</span> =<span class="st"> &quot;VehAge&quot;</span>, </span>
<span id="cb94-9"><a href="#cb94-9"></a>                          <span class="st">`</span><span class="dt">Vehicle power</span><span class="st">`</span> =<span class="st"> &quot;VehPower&quot;</span>, </span>
<span id="cb94-10"><a href="#cb94-10"></a>                          <span class="st">`</span><span class="dt">Logarithmic density</span><span class="st">`</span> =<span class="st"> &quot;logDensity&quot;</span>))</span>
<span id="cb94-11"><a href="#cb94-11"></a></span>
<span id="cb94-12"><a href="#cb94-12"></a><span class="kw">ggplot</span>(melted, <span class="kw">aes</span>(<span class="dt">x=</span>values)) <span class="op">+</span></span>
<span id="cb94-13"><a href="#cb94-13"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">19</span>, <span class="dt">fill =</span> <span class="st">&quot;#E69F00&quot;</span>) <span class="op">+</span></span>
<span id="cb94-14"><a href="#cb94-14"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ind, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span></span>
<span id="cb94-15"><a href="#cb94-15"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">element_blank</span>(), <span class="dt">y =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></span>
<span id="cb94-16"><a href="#cb94-16"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.title.y =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb94-17"><a href="#cb94-17"></a>        <span class="dt">axis.text.y =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb94-18"><a href="#cb94-18"></a>        <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>())</span>
<span id="cb94-19"><a href="#cb94-19"></a></span>
<span id="cb94-20"><a href="#cb94-20"></a><span class="co"># Bivariate description</span></span>
<span id="cb94-21"><a href="#cb94-21"></a></span>
<span id="cb94-22"><a href="#cb94-22"></a>cor_mat &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-23"><a href="#cb94-23"></a><span class="st">  </span><span class="kw">select_at</span>(<span class="kw">c</span>(x, <span class="st">&quot;BonusMalus&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-24"><a href="#cb94-24"></a><span class="st">  </span><span class="kw">select_if</span>(is.numeric) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-25"><a href="#cb94-25"></a><span class="st">  </span><span class="kw">cor</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-26"><a href="#cb94-26"></a><span class="st">  </span><span class="kw">round</span>(<span class="dv">2</span>)</span>
<span id="cb94-27"><a href="#cb94-27"></a><span class="kw">corrplot</span>(cor_mat, <span class="dt">method =</span> <span class="st">&quot;square&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;lower&quot;</span>, <span class="dt">diag =</span> <span class="ot">FALSE</span>, <span class="dt">title =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb94-28"><a href="#cb94-28"></a>         <span class="dt">addCoef.col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">tl.col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb94-29"><a href="#cb94-29"></a></span>
<span id="cb94-30"><a href="#cb94-30"></a></span>
<span id="cb94-31"><a href="#cb94-31"></a><span class="co"># Boxplots</span></span>
<span id="cb94-32"><a href="#cb94-32"></a>th &lt;-<span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">45</span>, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">vjust =</span> <span class="dv">1</span>))</span>
<span id="cb94-33"><a href="#cb94-33"></a></span>
<span id="cb94-34"><a href="#cb94-34"></a><span class="co"># BonusMalus nach DrivAge</span></span>
<span id="cb94-35"><a href="#cb94-35"></a>dat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-36"><a href="#cb94-36"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DrivAge =</span> <span class="kw">cut</span>(DrivAge, <span class="kw">c</span>(<span class="dv">17</span><span class="op">:</span><span class="dv">24</span>, <span class="kw">seq</span>(<span class="dv">25</span>, <span class="dv">85</span>, <span class="dv">10</span>)), </span>
<span id="cb94-37"><a href="#cb94-37"></a>                       <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">18</span><span class="op">:</span><span class="dv">25</span>, <span class="st">&quot;26-35&quot;</span>, <span class="st">&quot;36-45&quot;</span>, <span class="st">&quot;46-55&quot;</span>, <span class="st">&quot;56-65&quot;</span>, <span class="st">&quot;66-75&quot;</span>, <span class="st">&quot;76+&quot;</span>),</span>
<span id="cb94-38"><a href="#cb94-38"></a>                       <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>),</span>
<span id="cb94-39"><a href="#cb94-39"></a>         <span class="dt">DrivAge =</span> <span class="kw">fct_recode</span>(DrivAge)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-40"><a href="#cb94-40"></a><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> DrivAge, <span class="dt">y =</span> BonusMalus)) <span class="op">+</span></span>
<span id="cb94-41"><a href="#cb94-41"></a><span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">outlier.shape =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">&quot;#E69F00&quot;</span>) <span class="op">+</span></span>
<span id="cb94-42"><a href="#cb94-42"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">125</span>))</span>
<span id="cb94-43"><a href="#cb94-43"></a></span>
<span id="cb94-44"><a href="#cb94-44"></a><span class="co"># Brand/vehicle age</span></span>
<span id="cb94-45"><a href="#cb94-45"></a>dat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-46"><a href="#cb94-46"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> VehBrand, <span class="dt">y =</span> VehAge)) <span class="op">+</span></span>
<span id="cb94-47"><a href="#cb94-47"></a><span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">outlier.shape =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">&quot;#E69F00&quot;</span>) <span class="op">+</span></span>
<span id="cb94-48"><a href="#cb94-48"></a><span class="st">  </span>th</span>
<span id="cb94-49"><a href="#cb94-49"></a></span>
<span id="cb94-50"><a href="#cb94-50"></a><span class="co"># Density/Area</span></span>
<span id="cb94-51"><a href="#cb94-51"></a>dat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-52"><a href="#cb94-52"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> AreaCode, <span class="dt">y =</span> logDensity)) <span class="op">+</span></span>
<span id="cb94-53"><a href="#cb94-53"></a><span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">fill =</span> <span class="st">&quot;#E69F00&quot;</span>) <span class="op">+</span></span>
<span id="cb94-54"><a href="#cb94-54"></a><span class="st">  </span>th</span>
<span id="cb94-55"><a href="#cb94-55"></a></span>
<span id="cb94-56"><a href="#cb94-56"></a><span class="co"># Density/Region</span></span>
<span id="cb94-57"><a href="#cb94-57"></a>dat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-58"><a href="#cb94-58"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Region, <span class="dt">y =</span> logDensity)) <span class="op">+</span></span>
<span id="cb94-59"><a href="#cb94-59"></a><span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">outlier.shape =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">&quot;#E69F00&quot;</span>) <span class="op">+</span></span>
<span id="cb94-60"><a href="#cb94-60"></a><span class="st">  </span>th</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/8/hist.png" alt="LIME" width="50%"  />
<p class="caption">
(#fig:hist)LIME
</p>
</div>
</div>
<div id="å»ºæ¨¡" class="section level3">
<h3><span class="header-section-number">8.10.4</span> å»ºæ¨¡</h3>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>ind &lt;-<span class="st"> </span><span class="kw">partition</span>(dat[[<span class="st">&quot;group_id&quot;</span>]], <span class="dt">p =</span> <span class="kw">c</span>(<span class="dt">train =</span> <span class="fl">0.8</span>, <span class="dt">test =</span> <span class="fl">0.2</span>), </span>
<span id="cb95-2"><a href="#cb95-2"></a>                 <span class="dt">seed =</span> <span class="dv">22</span>, <span class="dt">type =</span> <span class="st">&quot;grouped&quot;</span>)</span>
<span id="cb95-3"><a href="#cb95-3"></a>train &lt;-<span class="st"> </span>dat[ind<span class="op">$</span>train, ]</span>
<span id="cb95-4"><a href="#cb95-4"></a>test &lt;-<span class="st"> </span>dat[ind<span class="op">$</span>test, ]</span></code></pre></div>
<div id="glm-1" class="section level4">
<h4><span class="header-section-number">8.10.4.1</span> glm</h4>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>fit_glm &lt;-<span class="st"> </span><span class="kw">glm</span>(Freq <span class="op">~</span><span class="st"> </span>VehPower <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(VehAge, <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">+</span></span>
<span id="cb96-2"><a href="#cb96-2"></a><span class="st">                 </span>VehGas <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(DrivAge, <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span>logDensity <span class="op">+</span><span class="st"> </span>PolicyRegion,</span>
<span id="cb96-3"><a href="#cb96-3"></a>               <span class="dt">data =</span> train,</span>
<span id="cb96-4"><a href="#cb96-4"></a>               <span class="dt">family =</span> <span class="kw">quasipoisson</span>(),</span>
<span id="cb96-5"><a href="#cb96-5"></a>               <span class="dt">weights =</span> train[[w]])</span></code></pre></div>
</div>
<div id="xgboost-2" class="section level4">
<h4><span class="header-section-number">8.10.4.2</span> XGBoost</h4>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="co"># Input maker</span></span>
<span id="cb97-2"><a href="#cb97-2"></a>prep_xgb &lt;-<span class="st"> </span><span class="cf">function</span>(dat, x) {</span>
<span id="cb97-3"><a href="#cb97-3"></a>  <span class="kw">data.matrix</span>(dat[, x, <span class="dt">drop =</span> <span class="ot">FALSE</span>])</span>
<span id="cb97-4"><a href="#cb97-4"></a>}</span>
<span id="cb97-5"><a href="#cb97-5"></a></span>
<span id="cb97-6"><a href="#cb97-6"></a><span class="co"># Data interface to XGBoost</span></span>
<span id="cb97-7"><a href="#cb97-7"></a>dtrain &lt;-<span class="st"> </span><span class="kw">xgb.DMatrix</span>(<span class="kw">prep_xgb</span>(train, x), </span>
<span id="cb97-8"><a href="#cb97-8"></a>                      <span class="dt">label =</span> train[[y]], </span>
<span id="cb97-9"><a href="#cb97-9"></a>                      <span class="dt">weight =</span> train[[w]])</span>
<span id="cb97-10"><a href="#cb97-10"></a></span>
<span id="cb97-11"><a href="#cb97-11"></a><span class="co"># Parameters chosen by 5-fold grouped CV</span></span>
<span id="cb97-12"><a href="#cb97-12"></a>params_freq &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">learning_rate =</span> <span class="fl">0.2</span>,</span>
<span id="cb97-13"><a href="#cb97-13"></a>                    <span class="dt">max_depth =</span> <span class="dv">5</span>,</span>
<span id="cb97-14"><a href="#cb97-14"></a>                    <span class="dt">alpha =</span> <span class="dv">3</span>, <span class="co">#æƒé‡çš„l1æ­£åˆ™é¡¹</span></span>
<span id="cb97-15"><a href="#cb97-15"></a>                    <span class="dt">lambda =</span> <span class="fl">0.5</span>, <span class="co">#æƒé‡çš„l2æ­£åˆ™é¡¹</span></span>
<span id="cb97-16"><a href="#cb97-16"></a>                    <span class="dt">max_delta_step =</span> <span class="dv">2</span>, <span class="co">#æƒé‡æ”¹å˜æœ€å¤§æ­¥é•¿ï¼Œdefaultä¸º0</span></span>
<span id="cb97-17"><a href="#cb97-17"></a>                    <span class="dt">min_split_loss =</span> <span class="dv">0</span>, <span class="co">#èŠ‚ç‚¹åˆ†è£‚æ‰€éœ€çš„æœ€å°æŸå¤±å‡½æ•°ä¸‹é™å€¼ï¼Œdefaultä¸º0</span></span>
<span id="cb97-18"><a href="#cb97-18"></a>                    <span class="dt">colsample_bytree =</span> <span class="dv">1</span>, <span class="co">#æ§åˆ¶æ¯æ£µéšæœºé‡‡æ ·çš„åˆ—æ•°çš„å æ¯”(æ¯ä¸€åˆ—æ˜¯ä¸€ä¸ªç‰¹å¾)ï¼Œdefaultä¸º1</span></span>
<span id="cb97-19"><a href="#cb97-19"></a>                    <span class="dt">subsample =</span> <span class="fl">0.9</span> <span class="co">#æ§åˆ¶æ ‘çš„æ¯çº§çš„æ¯æ¬¡åˆ†è£‚ï¼Œå¯¹åˆ—æ•°çš„é‡‡æ ·çš„å æ¯”,defaultä¸º1,å’Œcolsample_bytreeåŠŸèƒ½é‡å </span></span>
<span id="cb97-20"><a href="#cb97-20"></a>                    )</span>
<span id="cb97-21"><a href="#cb97-21"></a></span>
<span id="cb97-22"><a href="#cb97-22"></a><span class="co"># Fit</span></span>
<span id="cb97-23"><a href="#cb97-23"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb97-24"><a href="#cb97-24"></a>fit_xgb &lt;-<span class="st"> </span><span class="kw">xgb.train</span>(params_freq, </span>
<span id="cb97-25"><a href="#cb97-25"></a>                     <span class="dt">data =</span> dtrain,</span>
<span id="cb97-26"><a href="#cb97-26"></a>                     <span class="dt">nrounds =</span> <span class="dv">580</span>,</span>
<span id="cb97-27"><a href="#cb97-27"></a>                     <span class="dt">objective =</span> <span class="st">&quot;count:poisson&quot;</span>,</span>
<span id="cb97-28"><a href="#cb97-28"></a>                     <span class="dt">watchlist =</span> <span class="kw">list</span>(<span class="dt">train =</span> dtrain),</span>
<span id="cb97-29"><a href="#cb97-29"></a>                     <span class="dt">print_every_n =</span> <span class="dv">10</span>)</span></code></pre></div>
</div>
<div id="ä¸ºåæ–‡è®­ç»ƒå¯å˜å•è°ƒæ€§çº¦æŸå’Œäº¤äº’é¡¹çº¦æŸçš„xgboostä½¿ç”¨è¾ƒå°çš„nrounds" class="section level4">
<h4><span class="header-section-number">8.10.4.3</span> ä¸ºåæ–‡è®­ç»ƒå¯å˜å•è°ƒæ€§çº¦æŸå’Œäº¤äº’é¡¹çº¦æŸçš„xgboostï¼Œä½¿ç”¨è¾ƒå°çš„nrounds</h4>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>params_freq_constraints &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">learning_rate =</span> <span class="fl">0.2</span>,</span>
<span id="cb98-2"><a href="#cb98-2"></a>                    <span class="dt">max_depth =</span> <span class="dv">5</span>,</span>
<span id="cb98-3"><a href="#cb98-3"></a>                    <span class="dt">alpha =</span> <span class="dv">3</span>,</span>
<span id="cb98-4"><a href="#cb98-4"></a>                    <span class="dt">lambda =</span> <span class="fl">0.5</span>,</span>
<span id="cb98-5"><a href="#cb98-5"></a>                    <span class="dt">max_delta_step =</span> <span class="dv">2</span>,</span>
<span id="cb98-6"><a href="#cb98-6"></a>                    <span class="dt">min_split_loss =</span> <span class="dv">0</span>,</span>
<span id="cb98-7"><a href="#cb98-7"></a>                    <span class="dt">monotone_constraints =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="co">#å¯å˜å•è°ƒæ€§çš„çº¦æŸ</span></span>
<span id="cb98-8"><a href="#cb98-8"></a>                    <span class="dt">colsample_bytree =</span> <span class="dv">1</span>,</span>
<span id="cb98-9"><a href="#cb98-9"></a>                    <span class="dt">subsample =</span> <span class="fl">0.9</span>)</span>
<span id="cb98-10"><a href="#cb98-10"></a></span>
<span id="cb98-11"><a href="#cb98-11"></a>fit_xgb_constraints &lt;-<span class="st"> </span><span class="kw">xgb.train</span>(params_freq_constraints, </span>
<span id="cb98-12"><a href="#cb98-12"></a>                     <span class="dt">data =</span> dtrain,</span>
<span id="cb98-13"><a href="#cb98-13"></a>                     <span class="dt">nrounds =</span> <span class="dv">80</span>,</span>
<span id="cb98-14"><a href="#cb98-14"></a>                     <span class="dt">objective =</span> <span class="st">&quot;count:poisson&quot;</span>,</span>
<span id="cb98-15"><a href="#cb98-15"></a>                     <span class="dt">watchlist =</span> <span class="kw">list</span>(<span class="dt">train =</span> dtrain),</span>
<span id="cb98-16"><a href="#cb98-16"></a>                     <span class="dt">print_every_n =</span> <span class="dv">10</span>)</span>
<span id="cb98-17"><a href="#cb98-17"></a></span>
<span id="cb98-18"><a href="#cb98-18"></a>params_freq_interaction_constraints &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">learning_rate =</span> <span class="fl">0.2</span>,</span>
<span id="cb98-19"><a href="#cb98-19"></a>                    <span class="dt">max_depth =</span> <span class="dv">5</span>,</span>
<span id="cb98-20"><a href="#cb98-20"></a>                    <span class="dt">alpha =</span> <span class="dv">3</span>,</span>
<span id="cb98-21"><a href="#cb98-21"></a>                    <span class="dt">lambda =</span> <span class="fl">0.5</span>,</span>
<span id="cb98-22"><a href="#cb98-22"></a>                    <span class="dt">max_delta_step =</span> <span class="dv">2</span>,</span>
<span id="cb98-23"><a href="#cb98-23"></a>                    <span class="dt">min_split_loss =</span> <span class="dv">0</span>,</span>
<span id="cb98-24"><a href="#cb98-24"></a>                    <span class="dt">interaction_constraints =</span> <span class="kw">list</span>(<span class="dv">4</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>)), <span class="co">#äº¤äº’é¡¹çº¦æŸï¼Œçº¦æŸä»¥åµŒå¥—åˆ—è¡¨çš„å½¢å¼æŒ‡å®š</span></span>
<span id="cb98-25"><a href="#cb98-25"></a>                    <span class="dt">colsample_bytree =</span> <span class="dv">1</span>,</span>
<span id="cb98-26"><a href="#cb98-26"></a>                    <span class="dt">subsample =</span> <span class="fl">0.9</span>)</span>
<span id="cb98-27"><a href="#cb98-27"></a></span>
<span id="cb98-28"><a href="#cb98-28"></a>fit_xgb_interaction_constraints &lt;-<span class="st"> </span><span class="kw">xgb.train</span>(params_freq_interaction_constraints, </span>
<span id="cb98-29"><a href="#cb98-29"></a>                     <span class="dt">data =</span> dtrain,</span>
<span id="cb98-30"><a href="#cb98-30"></a>                     <span class="dt">nrounds =</span> <span class="dv">80</span>,</span>
<span id="cb98-31"><a href="#cb98-31"></a>                     <span class="dt">objective =</span> <span class="st">&quot;count:poisson&quot;</span>,</span>
<span id="cb98-32"><a href="#cb98-32"></a>                     <span class="dt">watchlist =</span> <span class="kw">list</span>(<span class="dt">train =</span> dtrain),</span>
<span id="cb98-33"><a href="#cb98-33"></a>                     <span class="dt">print_every_n =</span> <span class="dv">10</span>)</span></code></pre></div>
</div>
<div id="ç¥ç»ç½‘ç»œ-2" class="section level4">
<h4><span class="header-section-number">8.10.4.4</span> ç¥ç»ç½‘ç»œ</h4>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a>prep_nn &lt;-<span class="st"> </span><span class="cf">function</span>(dat, x, <span class="dt">cat_cols =</span> <span class="kw">c</span>(<span class="st">&quot;PolicyRegion&quot;</span>, <span class="st">&quot;VehBrand&quot;</span>)) {</span>
<span id="cb99-2"><a href="#cb99-2"></a>  dense_cols &lt;-<span class="st"> </span><span class="kw">setdiff</span>(x, cat_cols)</span>
<span id="cb99-3"><a href="#cb99-3"></a>  <span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">dense1 =</span> <span class="kw">data.matrix</span>(dat[, dense_cols])), </span>
<span id="cb99-4"><a href="#cb99-4"></a>    <span class="kw">lapply</span>(dat[, cat_cols], <span class="cf">function</span>(z) <span class="kw">as.integer</span>(z) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb99-5"><a href="#cb99-5"></a>}</span>
<span id="cb99-6"><a href="#cb99-6"></a></span>
<span id="cb99-7"><a href="#cb99-7"></a><span class="co"># Initialize neural net</span></span>
<span id="cb99-8"><a href="#cb99-8"></a>new_neural_net &lt;-<span class="st"> </span><span class="cf">function</span>() {</span>
<span id="cb99-9"><a href="#cb99-9"></a>  <span class="kw">k_clear_session</span>()</span>
<span id="cb99-10"><a href="#cb99-10"></a>  <span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb99-11"><a href="#cb99-11"></a>  <span class="cf">if</span> (<span class="st">&quot;set_seed&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(tensorflow<span class="op">::</span>tf<span class="op">$</span>random)) {</span>
<span id="cb99-12"><a href="#cb99-12"></a>    tensorflow<span class="op">::</span>tf<span class="op">$</span>random<span class="op">$</span><span class="kw">set_seed</span>(<span class="dv">0</span>)</span>
<span id="cb99-13"><a href="#cb99-13"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">&quot;set_random_seed&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(tensorflow<span class="op">::</span>tf<span class="op">$</span>random)) {</span>
<span id="cb99-14"><a href="#cb99-14"></a>    tensorflow<span class="op">::</span>tf<span class="op">$</span>random<span class="op">$</span><span class="kw">set_random_seed</span>(<span class="dv">0</span>)</span>
<span id="cb99-15"><a href="#cb99-15"></a>  } <span class="cf">else</span> {</span>
<span id="cb99-16"><a href="#cb99-16"></a>    <span class="kw">print</span>(<span class="st">&quot;Check tf version&quot;</span>)</span>
<span id="cb99-17"><a href="#cb99-17"></a>  }</span>
<span id="cb99-18"><a href="#cb99-18"></a>  </span>
<span id="cb99-19"><a href="#cb99-19"></a>  <span class="co"># Model architecture</span></span>
<span id="cb99-20"><a href="#cb99-20"></a>  dense_input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dv">5</span>, <span class="dt">name =</span> <span class="st">&quot;dense1&quot;</span>, <span class="dt">dtype =</span> <span class="st">&quot;float32&quot;</span>)</span>
<span id="cb99-21"><a href="#cb99-21"></a>  PolicyRegion_input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&quot;PolicyRegion&quot;</span>, <span class="dt">dtype =</span> <span class="st">&quot;int8&quot;</span>)</span>
<span id="cb99-22"><a href="#cb99-22"></a>  VehBrand_input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dv">1</span>, <span class="dt">name =</span> <span class="st">&quot;VehBrand&quot;</span>, <span class="dt">dtype =</span> <span class="st">&quot;int8&quot;</span>)</span>
<span id="cb99-23"><a href="#cb99-23"></a></span>
<span id="cb99-24"><a href="#cb99-24"></a>  PolicyRegion_emb &lt;-<span class="st"> </span>PolicyRegion_input <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-25"><a href="#cb99-25"></a><span class="st">    </span><span class="kw">layer_embedding</span>(<span class="dv">22</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-26"><a href="#cb99-26"></a><span class="st">    </span><span class="kw">layer_flatten</span>()</span>
<span id="cb99-27"><a href="#cb99-27"></a>  </span>
<span id="cb99-28"><a href="#cb99-28"></a>  VehBrand_emb &lt;-<span class="st"> </span>VehBrand_input <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-29"><a href="#cb99-29"></a><span class="st">    </span><span class="kw">layer_embedding</span>(<span class="dv">11</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-30"><a href="#cb99-30"></a><span class="st">    </span><span class="kw">layer_flatten</span>()</span>
<span id="cb99-31"><a href="#cb99-31"></a></span>
<span id="cb99-32"><a href="#cb99-32"></a>  outputs &lt;-<span class="st"> </span><span class="kw">list</span>(dense_input, PolicyRegion_emb, VehBrand_emb) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-33"><a href="#cb99-33"></a><span class="st">    </span><span class="kw">layer_concatenate</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-34"><a href="#cb99-34"></a><span class="st">    </span><span class="kw">layer_dense</span>(<span class="dv">20</span>, <span class="dt">activation =</span> <span class="st">&quot;tanh&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb99-35"><a href="#cb99-35"></a><span class="st">    </span><span class="kw">layer_dense</span>(<span class="dv">15</span>, <span class="dt">activation =</span> <span class="st">&quot;tanh&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb99-36"><a href="#cb99-36"></a><span class="st">    </span><span class="kw">layer_dense</span>(<span class="dv">10</span>, <span class="dt">activation =</span> <span class="st">&quot;tanh&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-37"><a href="#cb99-37"></a><span class="st">    </span><span class="kw">layer_dense</span>(<span class="dv">1</span>, <span class="dt">activation =</span> <span class="st">&quot;exponential&quot;</span>)</span>
<span id="cb99-38"><a href="#cb99-38"></a>  </span>
<span id="cb99-39"><a href="#cb99-39"></a>  inputs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">dense1 =</span> dense_input, </span>
<span id="cb99-40"><a href="#cb99-40"></a>                 <span class="dt">PolicyRegion =</span> PolicyRegion_input, </span>
<span id="cb99-41"><a href="#cb99-41"></a>                 <span class="dt">VehBrand =</span> VehBrand_input)</span>
<span id="cb99-42"><a href="#cb99-42"></a>  </span>
<span id="cb99-43"><a href="#cb99-43"></a>  model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(inputs, outputs)</span>
<span id="cb99-44"><a href="#cb99-44"></a>  </span>
<span id="cb99-45"><a href="#cb99-45"></a>  model <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-46"><a href="#cb99-46"></a><span class="st">    </span><span class="kw">compile</span>(<span class="dt">loss =</span> loss_poisson,</span>
<span id="cb99-47"><a href="#cb99-47"></a>            <span class="dt">optimizer =</span> <span class="kw">optimizer_nadam</span>(),</span>
<span id="cb99-48"><a href="#cb99-48"></a>            <span class="dt">weighted_metrics =</span> <span class="st">&quot;poisson&quot;</span>)</span>
<span id="cb99-49"><a href="#cb99-49"></a>  </span>
<span id="cb99-50"><a href="#cb99-50"></a>  <span class="kw">return</span>(model)</span>
<span id="cb99-51"><a href="#cb99-51"></a>}</span>
<span id="cb99-52"><a href="#cb99-52"></a></span>
<span id="cb99-53"><a href="#cb99-53"></a>neural_net &lt;-<span class="st"> </span><span class="kw">new_neural_net</span>()</span>
<span id="cb99-54"><a href="#cb99-54"></a></span>
<span id="cb99-55"><a href="#cb99-55"></a>neural_net <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-56"><a href="#cb99-56"></a><span class="st">  </span><span class="kw">summary</span>()</span>
<span id="cb99-57"><a href="#cb99-57"></a></span>
<span id="cb99-58"><a href="#cb99-58"></a>history &lt;-<span class="st"> </span>neural_net <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb99-59"><a href="#cb99-59"></a><span class="st">  </span><span class="kw">fit</span>(<span class="dt">x =</span> <span class="kw">prep_nn</span>(train, x), </span>
<span id="cb99-60"><a href="#cb99-60"></a>      <span class="dt">y =</span> train[, y], </span>
<span id="cb99-61"><a href="#cb99-61"></a>      <span class="dt">sample_weight =</span> train[, w],</span>
<span id="cb99-62"><a href="#cb99-62"></a>      <span class="dt">batch_size =</span> <span class="fl">1e4</span>, </span>
<span id="cb99-63"><a href="#cb99-63"></a>      <span class="dt">epochs =</span> <span class="dv">300</span>,</span>
<span id="cb99-64"><a href="#cb99-64"></a>      <span class="dt">verbose =</span> <span class="dv">2</span>)  </span>
<span id="cb99-65"><a href="#cb99-65"></a>    </span>
<span id="cb99-66"><a href="#cb99-66"></a><span class="kw">plot</span>(history)</span></code></pre></div>
<p>åœ¨æœ€åä¸€ä¸ªéšè—å±‚çš„åç»´è¾“å‡ºä¸Šè®­ç»ƒæ³Šæ¾GLM</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a><span class="co"># Calibrate by using last hidden layer activations as GLM input encoder</span></span>
<span id="cb100-2"><a href="#cb100-2"></a>encoder &lt;-<span class="st"> </span><span class="kw">keras_model</span>(<span class="dt">inputs =</span> neural_net<span class="op">$</span>input, </span>
<span id="cb100-3"><a href="#cb100-3"></a>                       <span class="dt">outputs =</span> <span class="kw">get_layer</span>(neural_net, <span class="st">&quot;dense_2&quot;</span>)<span class="op">$</span>output)</span>
<span id="cb100-4"><a href="#cb100-4"></a></span>
<span id="cb100-5"><a href="#cb100-5"></a><span class="co"># Creates input for calibration GLM (extends prep_nn)</span></span>
<span id="cb100-6"><a href="#cb100-6"></a>prep_nn_calib &lt;-<span class="st"> </span><span class="cf">function</span>(dat, x, <span class="dt">cat_cols =</span> <span class="kw">c</span>(<span class="st">&quot;PolicyRegion&quot;</span>, <span class="st">&quot;VehBrand&quot;</span>), </span>
<span id="cb100-7"><a href="#cb100-7"></a>                          <span class="dt">enc =</span> encoder) {</span>
<span id="cb100-8"><a href="#cb100-8"></a>  <span class="kw">prep_nn</span>(dat, x, cat_cols) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb100-9"><a href="#cb100-9"></a><span class="st">    </span><span class="kw">predict</span>(enc, ., <span class="dt">batch_size =</span> <span class="fl">1e4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb100-10"><a href="#cb100-10"></a><span class="st">    </span><span class="kw">data.frame</span>()</span>
<span id="cb100-11"><a href="#cb100-11"></a>}</span>
<span id="cb100-12"><a href="#cb100-12"></a></span>
<span id="cb100-13"><a href="#cb100-13"></a><span class="co"># Calibration GLM</span></span>
<span id="cb100-14"><a href="#cb100-14"></a>fit_nn &lt;-<span class="st"> </span><span class="kw">glm</span>(Freq <span class="op">~</span><span class="st"> </span>.,</span>
<span id="cb100-15"><a href="#cb100-15"></a>              <span class="dt">data =</span> <span class="kw">cbind</span>(train[<span class="st">&quot;Freq&quot;</span>], <span class="kw">prep_nn_calib</span>(train, x)), </span>
<span id="cb100-16"><a href="#cb100-16"></a>              <span class="dt">family =</span> <span class="kw">quasipoisson</span>(), </span>
<span id="cb100-17"><a href="#cb100-17"></a>              <span class="dt">weights =</span> train[[w]])</span></code></pre></div>
</div>
</div>
<div id="è§£é‡Š" class="section level3">
<h3><span class="header-section-number">8.10.5</span> è§£é‡Š</h3>
<div id="ä¸ºæ¨¡å‹å»ºç«‹è§£é‡Šå™¨flashlightå¹¶å°†å®ƒä»¬ç»„åˆä¸ºmultiflashlight" class="section level4">
<h4><span class="header-section-number">8.10.5.1</span> ä¸ºæ¨¡å‹å»ºç«‹è§£é‡Šå™¨(flashlight)ï¼Œå¹¶å°†å®ƒä»¬ç»„åˆä¸ºmultiflashlight</h4>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb101-2"><a href="#cb101-2"></a></span>
<span id="cb101-3"><a href="#cb101-3"></a>fillc &lt;-<span class="st"> &quot;#E69F00&quot;</span></span>
<span id="cb101-4"><a href="#cb101-4"></a></span>
<span id="cb101-5"><a href="#cb101-5"></a>fl_glm &lt;-<span class="st"> </span><span class="kw">flashlight</span>(</span>
<span id="cb101-6"><a href="#cb101-6"></a>  <span class="dt">model =</span> fit_glm, <span class="dt">label =</span> <span class="st">&quot;GLM&quot;</span>, </span>
<span id="cb101-7"><a href="#cb101-7"></a>  <span class="dt">predict_function =</span> <span class="cf">function</span>(fit, X) <span class="kw">predict</span>(fit, X, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb101-8"><a href="#cb101-8"></a>)</span>
<span id="cb101-9"><a href="#cb101-9"></a></span>
<span id="cb101-10"><a href="#cb101-10"></a>fl_nn &lt;-<span class="st"> </span><span class="kw">flashlight</span>(</span>
<span id="cb101-11"><a href="#cb101-11"></a>  <span class="dt">model =</span> fit_nn, <span class="dt">label =</span> <span class="st">&quot;NNet&quot;</span>, </span>
<span id="cb101-12"><a href="#cb101-12"></a>  <span class="dt">predict_function =</span> <span class="cf">function</span>(fit, X) </span>
<span id="cb101-13"><a href="#cb101-13"></a>    <span class="kw">predict</span>(fit, <span class="kw">prep_nn_calib</span>(X, x), <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb101-14"><a href="#cb101-14"></a>)</span>
<span id="cb101-15"><a href="#cb101-15"></a></span>
<span id="cb101-16"><a href="#cb101-16"></a>fl_xgb &lt;-<span class="st"> </span><span class="kw">flashlight</span>(</span>
<span id="cb101-17"><a href="#cb101-17"></a>  <span class="dt">model =</span> fit_xgb, <span class="dt">label =</span> <span class="st">&quot;XGBoost&quot;</span>, </span>
<span id="cb101-18"><a href="#cb101-18"></a>  <span class="dt">predict_function =</span> <span class="cf">function</span>(fit, X) <span class="kw">predict</span>(fit, <span class="kw">prep_xgb</span>(X, x))</span>
<span id="cb101-19"><a href="#cb101-19"></a>)</span>
<span id="cb101-20"><a href="#cb101-20"></a></span>
<span id="cb101-21"><a href="#cb101-21"></a>fl_xgb_constraints &lt;-<span class="st"> </span><span class="kw">flashlight</span>(</span>
<span id="cb101-22"><a href="#cb101-22"></a>  <span class="dt">model =</span> fit_xgb_constraints, <span class="dt">label =</span> <span class="st">&quot;XGBoost_constraints&quot;</span>, </span>
<span id="cb101-23"><a href="#cb101-23"></a>  <span class="dt">predict_function =</span> <span class="cf">function</span>(fit, X) <span class="kw">predict</span>(fit, <span class="kw">prep_xgb</span>(X, x))</span>
<span id="cb101-24"><a href="#cb101-24"></a>)</span>
<span id="cb101-25"><a href="#cb101-25"></a></span>
<span id="cb101-26"><a href="#cb101-26"></a>fl_xgb_interaction_constraints &lt;-<span class="st"> </span><span class="kw">flashlight</span>(</span>
<span id="cb101-27"><a href="#cb101-27"></a>  <span class="dt">model =</span> fit_xgb_interaction_constraints, <span class="dt">label =</span> <span class="st">&quot;XGBoost_interaction_constraints&quot;</span>, </span>
<span id="cb101-28"><a href="#cb101-28"></a>  <span class="dt">predict_function =</span> <span class="cf">function</span>(fit, X) <span class="kw">predict</span>(fit, <span class="kw">prep_xgb</span>(X, x))</span>
<span id="cb101-29"><a href="#cb101-29"></a>)</span>
<span id="cb101-30"><a href="#cb101-30"></a></span>
<span id="cb101-31"><a href="#cb101-31"></a><span class="co"># Combine them and add common elements like reference data</span></span>
<span id="cb101-32"><a href="#cb101-32"></a>metrics &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">`</span><span class="dt">Average deviance</span><span class="st">`</span> =<span class="st"> </span>deviance_poisson, </span>
<span id="cb101-33"><a href="#cb101-33"></a>                <span class="st">`</span><span class="dt">Relative deviance reduction</span><span class="st">`</span> =<span class="st"> </span>r_squared_poisson)</span>
<span id="cb101-34"><a href="#cb101-34"></a>fls &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(<span class="kw">list</span>(fl_glm, fl_nn, fl_xgb), <span class="dt">data =</span> test, </span>
<span id="cb101-35"><a href="#cb101-35"></a>                       <span class="dt">y =</span> y, <span class="dt">w =</span> w, <span class="dt">metrics =</span> metrics)</span>
<span id="cb101-36"><a href="#cb101-36"></a></span>
<span id="cb101-37"><a href="#cb101-37"></a>fls_xgb_constraints &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(<span class="kw">list</span>(fl_xgb,fl_xgb_constraints), <span class="dt">data =</span> test, </span>
<span id="cb101-38"><a href="#cb101-38"></a>                       <span class="dt">y =</span> y, <span class="dt">w =</span> w, <span class="dt">metrics =</span> metrics)</span>
<span id="cb101-39"><a href="#cb101-39"></a></span>
<span id="cb101-40"><a href="#cb101-40"></a>fls_xgb_interaction_constraints &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(<span class="kw">list</span>(fl_xgb_interaction_constraints), <span class="dt">data =</span> test, </span>
<span id="cb101-41"><a href="#cb101-41"></a>                       <span class="dt">y =</span> y, <span class="dt">w =</span> w, <span class="dt">metrics =</span> metrics)</span>
<span id="cb101-42"><a href="#cb101-42"></a></span>
<span id="cb101-43"><a href="#cb101-43"></a>fls_interaction_constraints &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(<span class="kw">list</span>(fl_glm, fl_nn, fl_xgb,fl_xgb_interaction_constraints), <span class="dt">data =</span> test, </span>
<span id="cb101-44"><a href="#cb101-44"></a>                       <span class="dt">y =</span> y, <span class="dt">w =</span> w, <span class="dt">metrics =</span> metrics)</span>
<span id="cb101-45"><a href="#cb101-45"></a></span>
<span id="cb101-46"><a href="#cb101-46"></a><span class="co"># Version on canonical scale</span></span>
<span id="cb101-47"><a href="#cb101-47"></a>fls_log &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(fls, <span class="dt">linkinv =</span> log)</span>
<span id="cb101-48"><a href="#cb101-48"></a>fls_xgb_interaction_constraints_log &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(fls_xgb_constraints, <span class="dt">linkinv =</span> log)</span>
<span id="cb101-49"><a href="#cb101-49"></a>fls_interaction_constraints_log &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(fls_interaction_constraints, <span class="dt">linkinv =</span> log)</span></code></pre></div>
</div>
<div id="å¯¹flashlightåº”ç”¨å¯è§£é‡Šæ€§å‡½æ•°" class="section level4">
<h4><span class="header-section-number">8.10.5.2</span> å¯¹flashlightåº”ç”¨å¯è§£é‡Šæ€§å‡½æ•°</h4>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a><span class="co">#æ¨¡å‹è¡¨ç°</span></span>
<span id="cb102-2"><a href="#cb102-2"></a></span>
<span id="cb102-3"><a href="#cb102-3"></a>perf &lt;-<span class="st"> </span><span class="kw">light_performance</span>(fls)</span>
<span id="cb102-4"><a href="#cb102-4"></a>perf</span>
<span id="cb102-5"><a href="#cb102-5"></a><span class="kw">plot</span>(perf, <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>) <span class="op">+</span></span>
<span id="cb102-6"><a href="#cb102-6"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">element_blank</span>(), <span class="dt">y =</span> <span class="kw">element_blank</span>())</span>
<span id="cb102-7"><a href="#cb102-7"></a></span>
<span id="cb102-8"><a href="#cb102-8"></a><span class="co">#å˜é‡é‡è¦æ€§</span></span>
<span id="cb102-9"><a href="#cb102-9"></a></span>
<span id="cb102-10"><a href="#cb102-10"></a>imp &lt;-<span class="st"> </span><span class="kw">light_importance</span>(fls, <span class="dt">v =</span> x)</span>
<span id="cb102-11"><a href="#cb102-11"></a><span class="kw">plot</span>(imp, <span class="dt">fill =</span> fillc, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
</div>
<div id="iceæ›²çº¿" class="section level4">
<h4><span class="header-section-number">8.10.5.3</span> ICEæ›²çº¿</h4>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a><span class="co">#driveageåŸºäºä¸­å¿ƒåŒ–ä¸éä¸­å¿ƒåŒ–å’Œæ˜¯å¦ä½¿ç”¨å¯¹æ•°è¢«è§£é‡Šå˜é‡ä½œä¸ºé¢„æµ‹ç»“æœ</span></span>
<span id="cb103-2"><a href="#cb103-2"></a></span>
<span id="cb103-3"><a href="#cb103-3"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>)</span>
<span id="cb103-4"><a href="#cb103-4"></a>     , <span class="dt">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb103-5"><a href="#cb103-5"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>, <span class="dt">center =</span> <span class="st">&quot;middle&quot;</span>)</span>
<span id="cb103-6"><a href="#cb103-6"></a>     , <span class="dt">alpha =</span> <span class="fl">0.03</span>)</span>
<span id="cb103-7"><a href="#cb103-7"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls_log, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>)</span>
<span id="cb103-8"><a href="#cb103-8"></a>     , <span class="dt">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb103-9"><a href="#cb103-9"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls_log, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>, <span class="dt">center =</span> <span class="st">&quot;middle&quot;</span>)</span>
<span id="cb103-10"><a href="#cb103-10"></a>     , <span class="dt">alpha =</span> <span class="fl">0.03</span>)</span>
<span id="cb103-11"><a href="#cb103-11"></a></span>
<span id="cb103-12"><a href="#cb103-12"></a><span class="co">#è€ƒè™‘å•è°ƒæ€§çº¦æŸçš„xgboost</span></span>
<span id="cb103-13"><a href="#cb103-13"></a></span>
<span id="cb103-14"><a href="#cb103-14"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls_xgb_constraints, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>)</span>
<span id="cb103-15"><a href="#cb103-15"></a>     , <span class="dt">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb103-16"><a href="#cb103-16"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls_xgb_constraints, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>, <span class="dt">center =</span> <span class="st">&quot;middle&quot;</span>)</span>
<span id="cb103-17"><a href="#cb103-17"></a>     , <span class="dt">alpha =</span> <span class="fl">0.03</span>)</span>
<span id="cb103-18"><a href="#cb103-18"></a></span>
<span id="cb103-19"><a href="#cb103-19"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls_xgb_constraints, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>)</span>
<span id="cb103-20"><a href="#cb103-20"></a>     , <span class="dt">alpha =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a><span class="co"># Partial dependence curves</span></span>
<span id="cb104-2"><a href="#cb104-2"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">pd_evaluate_at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">20</span>))</span>
<span id="cb104-3"><a href="#cb104-3"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_bins =</span> <span class="dv">25</span>))</span>
<span id="cb104-4"><a href="#cb104-4"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;logDensity&quot;</span>))</span>
<span id="cb104-5"><a href="#cb104-5"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;VehGas&quot;</span>))</span>
<span id="cb104-6"><a href="#cb104-6"></a></span>
<span id="cb104-7"><a href="#cb104-7"></a><span class="co"># ALE versus partial dependence</span></span>
<span id="cb104-8"><a href="#cb104-8"></a>ale_DrivAge &lt;-<span class="st"> </span><span class="kw">light_effects</span>(fls, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">counts_weighted =</span> <span class="ot">TRUE</span>,</span>
<span id="cb104-9"><a href="#cb104-9"></a>                             <span class="dt">v_labels =</span> <span class="ot">FALSE</span>, <span class="dt">n_bins =</span> <span class="dv">20</span>, <span class="dt">cut_type =</span> <span class="st">&quot;quantile&quot;</span>)</span>
<span id="cb104-10"><a href="#cb104-10"></a><span class="kw">plot</span>(ale_DrivAge, <span class="dt">use =</span> <span class="kw">c</span>(<span class="st">&quot;pd&quot;</span>, <span class="st">&quot;ale&quot;</span>), <span class="dt">show_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb104-11"><a href="#cb104-11"></a></span>
<span id="cb104-12"><a href="#cb104-12"></a><span class="co"># Classic diagnostic plots</span></span>
<span id="cb104-13"><a href="#cb104-13"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;predicted&quot;</span>))</span>
<span id="cb104-14"><a href="#cb104-14"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;residual&quot;</span>)) <span class="op">+</span></span>
<span id="cb104-15"><a href="#cb104-15"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb104-16"><a href="#cb104-16"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb104-17"><a href="#cb104-17"></a></span>
<span id="cb104-18"><a href="#cb104-18"></a></span>
<span id="cb104-19"><a href="#cb104-19"></a><span class="co"># Multiple aspects combined</span></span>
<span id="cb104-20"><a href="#cb104-20"></a>eff_DrivAge &lt;-<span class="st"> </span><span class="kw">light_effects</span>(fls, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">counts_weighted =</span> <span class="ot">TRUE</span>)</span>
<span id="cb104-21"><a href="#cb104-21"></a>p &lt;-<span class="st"> </span><span class="kw">plot</span>(eff_DrivAge, <span class="dt">show_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb104-22"><a href="#cb104-22"></a><span class="kw">plot_counts</span>(p, eff_DrivAge, <span class="dt">alpha =</span> <span class="fl">0.3</span>)</span></code></pre></div>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a><span class="co"># Interaction (relative)</span></span>
<span id="cb105-2"><a href="#cb105-2"></a>interact_rel &lt;-<span class="st"> </span><span class="kw">light_interaction</span>(</span>
<span id="cb105-3"><a href="#cb105-3"></a>  fls_interaction_constraints_log, </span>
<span id="cb105-4"><a href="#cb105-4"></a>  <span class="dt">v =</span> <span class="kw">most_important</span>(imp, <span class="dv">4</span>), </span>
<span id="cb105-5"><a href="#cb105-5"></a>  <span class="dt">take_sqrt =</span> <span class="ot">FALSE</span>,</span>
<span id="cb105-6"><a href="#cb105-6"></a>  <span class="dt">pairwise =</span> <span class="ot">TRUE</span>, </span>
<span id="cb105-7"><a href="#cb105-7"></a>  <span class="dt">use_linkinv =</span> <span class="ot">TRUE</span>,</span>
<span id="cb105-8"><a href="#cb105-8"></a>  <span class="dt">seed =</span> <span class="dv">61</span></span>
<span id="cb105-9"><a href="#cb105-9"></a>)</span>
<span id="cb105-10"><a href="#cb105-10"></a><span class="kw">plot</span>(interact_rel, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> fillc, <span class="dt">rotate_x =</span> <span class="ot">TRUE</span>)</span>
<span id="cb105-11"><a href="#cb105-11"></a></span>
<span id="cb105-12"><a href="#cb105-12"></a><span class="co"># Interaction (absolute)</span></span>
<span id="cb105-13"><a href="#cb105-13"></a>interact_abs &lt;-<span class="st"> </span><span class="kw">light_interaction</span>(</span>
<span id="cb105-14"><a href="#cb105-14"></a>  fls_interaction_constraints_log, </span>
<span id="cb105-15"><a href="#cb105-15"></a>  <span class="dt">v =</span> <span class="kw">most_important</span>(imp, <span class="dv">4</span>), </span>
<span id="cb105-16"><a href="#cb105-16"></a>  <span class="dt">normalize =</span> <span class="ot">FALSE</span>,</span>
<span id="cb105-17"><a href="#cb105-17"></a>  <span class="dt">pairwise =</span> <span class="ot">TRUE</span>, </span>
<span id="cb105-18"><a href="#cb105-18"></a>  <span class="dt">use_linkinv =</span> <span class="ot">TRUE</span>,</span>
<span id="cb105-19"><a href="#cb105-19"></a>  <span class="dt">seed =</span> <span class="dv">61</span></span>
<span id="cb105-20"><a href="#cb105-20"></a>)</span>
<span id="cb105-21"><a href="#cb105-21"></a><span class="kw">plot</span>(interact_abs, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> fillc, <span class="dt">rotate_x =</span> <span class="ot">TRUE</span>)</span>
<span id="cb105-22"><a href="#cb105-22"></a></span>
<span id="cb105-23"><a href="#cb105-23"></a><span class="co"># Filter on largest three brands</span></span>
<span id="cb105-24"><a href="#cb105-24"></a>sub_data &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb105-25"><a href="#cb105-25"></a><span class="st">  </span><span class="kw">filter</span>(VehBrand <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;B1&quot;</span>, <span class="st">&quot;B2&quot;</span>, <span class="st">&quot;B12&quot;</span>))</span>
<span id="cb105-26"><a href="#cb105-26"></a></span>
<span id="cb105-27"><a href="#cb105-27"></a><span class="co"># Strong interaction</span></span>
<span id="cb105-28"><a href="#cb105-28"></a>pdp_vehAge_Brand &lt;-<span class="st"> </span><span class="kw">light_profile</span>(fls_interaction_constraints_log, <span class="dt">v =</span> <span class="st">&quot;VehAge&quot;</span>, <span class="dt">by =</span> <span class="st">&quot;VehBrand&quot;</span>, </span>
<span id="cb105-29"><a href="#cb105-29"></a>                                  <span class="dt">pd_seed =</span> <span class="dv">50</span>, <span class="dt">data =</span> sub_data)</span>
<span id="cb105-30"><a href="#cb105-30"></a><span class="kw">plot</span>(pdp_vehAge_Brand)</span>
<span id="cb105-31"><a href="#cb105-31"></a></span>
<span id="cb105-32"><a href="#cb105-32"></a><span class="co"># Weak interaction</span></span>
<span id="cb105-33"><a href="#cb105-33"></a>pdp_DrivAge_Gas &lt;-<span class="st"> </span><span class="kw">light_profile</span>(fls_interaction_constraints_log, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, </span>
<span id="cb105-34"><a href="#cb105-34"></a>                                 <span class="dt">by =</span> <span class="st">&quot;VehGas&quot;</span>, <span class="dt">pd_seed =</span> <span class="dv">50</span>)</span>
<span id="cb105-35"><a href="#cb105-35"></a><span class="kw">plot</span>(pdp_DrivAge_Gas)</span>
<span id="cb105-36"><a href="#cb105-36"></a></span>
<span id="cb105-37"><a href="#cb105-37"></a></span>
<span id="cb105-38"><a href="#cb105-38"></a><span class="kw">plot</span>(<span class="kw">light_ice</span>(fls_xgb_interaction_constraints, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">n_max =</span> <span class="dv">200</span>, <span class="dt">seed =</span> <span class="dv">3</span>)</span>
<span id="cb105-39"><a href="#cb105-39"></a>     , <span class="dt">alpha =</span> <span class="fl">0.1</span>)</span></code></pre></div>
</div>
<div id="å…¨å±€ä»£ç†æ¨¡å‹" class="section level4">
<h4><span class="header-section-number">8.10.5.4</span> å…¨å±€ä»£ç†æ¨¡å‹</h4>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a>surr_nn &lt;-<span class="st"> </span><span class="kw">light_global_surrogate</span>(fls_log<span class="op">$</span>NNet, <span class="dt">v =</span> x)</span>
<span id="cb106-2"><a href="#cb106-2"></a><span class="kw">plot</span>(surr_nn)</span>
<span id="cb106-3"><a href="#cb106-3"></a></span>
<span id="cb106-4"><a href="#cb106-4"></a>surr_xgb &lt;-<span class="st"> </span><span class="kw">light_global_surrogate</span>(fls_log<span class="op">$</span>XGBoost, <span class="dt">v =</span> x)</span>
<span id="cb106-5"><a href="#cb106-5"></a><span class="kw">plot</span>(surr_xgb)</span></code></pre></div>
</div>
</div>
<div id="å±€éƒ¨æ€§è´¨" class="section level3">
<h3><span class="header-section-number">8.10.6</span> å±€éƒ¨æ€§è´¨</h3>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a><span class="co">#å±€éƒ¨æ€§è´¨</span></span>
<span id="cb107-2"><a href="#cb107-2"></a></span>
<span id="cb107-3"><a href="#cb107-3"></a>new_obs &lt;-<span class="st"> </span>test[<span class="dv">1</span>, ]</span>
<span id="cb107-4"><a href="#cb107-4"></a>new_obs[, x]</span>
<span id="cb107-5"><a href="#cb107-5"></a><span class="kw">unlist</span>(<span class="kw">predict</span>(fls, <span class="dt">data =</span> new_obs))</span>
<span id="cb107-6"><a href="#cb107-6"></a></span>
<span id="cb107-7"><a href="#cb107-7"></a><span class="co"># Breakdown</span></span>
<span id="cb107-8"><a href="#cb107-8"></a>bd &lt;-<span class="st"> </span><span class="kw">light_breakdown</span>(fls<span class="op">$</span>XGBoost, <span class="dt">new_obs =</span> new_obs, </span>
<span id="cb107-9"><a href="#cb107-9"></a>                      <span class="dt">v =</span> x, <span class="dt">n_max =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">20</span>)</span>
<span id="cb107-10"><a href="#cb107-10"></a><span class="kw">plot</span>(bd)</span>
<span id="cb107-11"><a href="#cb107-11"></a></span>
<span id="cb107-12"><a href="#cb107-12"></a><span class="co"># Extract same order of variables for visualization only</span></span>
<span id="cb107-13"><a href="#cb107-13"></a>v &lt;-<span class="st"> </span><span class="kw">setdiff</span>(bd<span class="op">$</span>data<span class="op">$</span>variable, <span class="kw">c</span>(<span class="st">&quot;baseline&quot;</span>, <span class="st">&quot;prediction&quot;</span>))</span>
<span id="cb107-14"><a href="#cb107-14"></a></span>
<span id="cb107-15"><a href="#cb107-15"></a><span class="co"># Approximate SHAP</span></span>
<span id="cb107-16"><a href="#cb107-16"></a>shap &lt;-<span class="st"> </span><span class="kw">light_breakdown</span>(fls<span class="op">$</span>XGBoost, new_obs, </span>
<span id="cb107-17"><a href="#cb107-17"></a>                        <span class="dt">visit_strategy =</span> <span class="st">&quot;permutation&quot;</span>,</span>
<span id="cb107-18"><a href="#cb107-18"></a>                        <span class="dt">v =</span> v, <span class="dt">n_max =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">20</span>)</span>
<span id="cb107-19"><a href="#cb107-19"></a><span class="kw">plot</span>(shap)</span>
<span id="cb107-20"><a href="#cb107-20"></a></span>
<span id="cb107-21"><a href="#cb107-21"></a>fl_with_shap &lt;-<span class="st"> </span><span class="kw">add_shap</span>(fls<span class="op">$</span>XGBoost, <span class="dt">v =</span> x, <span class="dt">n_shap =</span> <span class="dv">500</span>, </span>
<span id="cb107-22"><a href="#cb107-22"></a>                         <span class="dt">n_perm =</span> <span class="dv">12</span>, <span class="dt">n_max =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">100</span>)</span>
<span id="cb107-23"><a href="#cb107-23"></a></span>
<span id="cb107-24"><a href="#cb107-24"></a><span class="co">#ä»¥å±€éƒ¨æ€§è´¨ä¼°è®¡æ¨¡å‹çš„å…¨å±€æ€§è´¨</span></span>
<span id="cb107-25"><a href="#cb107-25"></a></span>
<span id="cb107-26"><a href="#cb107-26"></a><span class="kw">plot</span>(<span class="kw">light_importance</span>(fl_with_shap, <span class="dt">v =</span> x, <span class="dt">type =</span> <span class="st">&quot;shap&quot;</span>), </span>
<span id="cb107-27"><a href="#cb107-27"></a>     <span class="dt">fill =</span> fillc, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb107-28"><a href="#cb107-28"></a><span class="kw">plot</span>(<span class="kw">light_scatter</span>(fl_with_shap, <span class="dt">v =</span> <span class="st">&quot;DrivAge&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;shap&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.3</span>)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="./plots/8/age.png" alt="LIME" width="50%"  />
<p class="caption">
(#fig:age)LIME
</p>
</div>
</div>
<div id="æ”¹è¿›glm" class="section level3">
<h3><span class="header-section-number">8.10.7</span> æ”¹è¿›glm</h3>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1"></a>fit_glm2 &lt;-<span class="st"> </span><span class="kw">glm</span>(Freq <span class="op">~</span><span class="st"> </span>VehPower <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">*</span><span class="st"> </span>VehGas <span class="op">+</span><span class="st"> </span>PolicyRegion <span class="op">+</span><span class="st"> </span></span>
<span id="cb108-2"><a href="#cb108-2"></a><span class="st">                  </span><span class="kw">ns</span>(DrivAge, <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span>VehBrand <span class="op">*</span><span class="st"> </span><span class="kw">ns</span>(VehAge, <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb108-3"><a href="#cb108-3"></a><span class="st">                  </span><span class="kw">ns</span>(logDensity, <span class="dv">5</span>), </span>
<span id="cb108-4"><a href="#cb108-4"></a>                <span class="dt">data =</span> train, </span>
<span id="cb108-5"><a href="#cb108-5"></a>                <span class="dt">family =</span> <span class="kw">quasipoisson</span>(), </span>
<span id="cb108-6"><a href="#cb108-6"></a>                <span class="dt">weights =</span> train[[w]])</span>
<span id="cb108-7"><a href="#cb108-7"></a></span>
<span id="cb108-8"><a href="#cb108-8"></a><span class="co"># Setting up expainers</span></span>
<span id="cb108-9"><a href="#cb108-9"></a>fl_glm2 &lt;-<span class="st"> </span><span class="kw">flashlight</span>(</span>
<span id="cb108-10"><a href="#cb108-10"></a>  <span class="dt">model =</span> fit_glm2, <span class="dt">label =</span> <span class="st">&quot;Improved GLM&quot;</span>, </span>
<span id="cb108-11"><a href="#cb108-11"></a>  <span class="dt">predict_function =</span> <span class="cf">function</span>(fit, X) <span class="kw">predict</span>(fit, X, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb108-12"><a href="#cb108-12"></a>)</span>
<span id="cb108-13"><a href="#cb108-13"></a></span>
<span id="cb108-14"><a href="#cb108-14"></a><span class="co"># Combine them and add common elements like reference data</span></span>
<span id="cb108-15"><a href="#cb108-15"></a>fls2 &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(<span class="kw">list</span>(fl_glm, fl_glm2, fl_nn, fl_xgb), </span>
<span id="cb108-16"><a href="#cb108-16"></a>                        <span class="dt">metrics =</span> metrics, <span class="dt">data =</span> test, <span class="dt">y =</span> y, <span class="dt">w =</span> w)</span>
<span id="cb108-17"><a href="#cb108-17"></a>fls2_log &lt;-<span class="st"> </span><span class="kw">multiflashlight</span>(fls2, <span class="dt">linkinv =</span> log)</span>
<span id="cb108-18"><a href="#cb108-18"></a></span>
<span id="cb108-19"><a href="#cb108-19"></a><span class="co"># Some results</span></span>
<span id="cb108-20"><a href="#cb108-20"></a><span class="kw">plot</span>(<span class="kw">light_performance</span>(fls2), <span class="dt">geom =</span> <span class="st">&quot;point&quot;</span>, <span class="dt">rotate_x =</span> <span class="ot">TRUE</span>)</span>
<span id="cb108-21"><a href="#cb108-21"></a><span class="kw">plot</span>(<span class="kw">light_importance</span>(fls2, <span class="dt">v =</span> x), <span class="dt">fill =</span> fillc, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">top_m =</span> <span class="dv">4</span>)</span>
<span id="cb108-22"><a href="#cb108-22"></a><span class="kw">plot</span>(<span class="kw">light_profile</span>(fls2, <span class="dt">v =</span> <span class="st">&quot;logDensity&quot;</span>))</span>
<span id="cb108-23"><a href="#cb108-23"></a>interact_rel_improved &lt;-<span class="st"> </span><span class="kw">light_interaction</span>(</span>
<span id="cb108-24"><a href="#cb108-24"></a>  fls2_log, <span class="dt">v =</span> <span class="kw">most_important</span>(imp, <span class="dv">4</span>), <span class="dt">take_sqrt =</span> <span class="ot">FALSE</span>,</span>
<span id="cb108-25"><a href="#cb108-25"></a>  <span class="dt">pairwise =</span> <span class="ot">TRUE</span>,  <span class="dt">use_linkinv =</span> <span class="ot">TRUE</span>, <span class="dt">seed =</span> <span class="dv">61</span>)</span>
<span id="cb108-26"><a href="#cb108-26"></a><span class="kw">plot</span>(interact_rel_improved, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> fillc, <span class="dt">top_m =</span> <span class="dv">4</span>)</span></code></pre></div>
<!--chapter:end:08-flashlight.Rmd-->
</div>
</div>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
